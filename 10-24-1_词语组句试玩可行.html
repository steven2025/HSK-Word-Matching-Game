<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSK单词游戏 · HSK Word Game (Fixed v5)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2b;
      --neon1:#7afcff;
      --neon2:#b693ff;
      --neon3:#5cff9d;
      --btnDepth: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1000px 500px at 10% -20%, rgba(122,252,255,.12), transparent 60%),
                  radial-gradient(800px 400px at 90% 0%, rgba(182,147,255,.12), transparent 55%),
                  linear-gradient(180deg, #0b1220 0%, #0a0f1c 100%);
      color:#e9f1ff; overflow-x:hidden;
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 56px; }

    .hero{ position:relative; border-radius:18px; padding:32px 20px; margin-top:8px; margin-bottom:18px;
      background: linear-gradient(145deg, rgba(17,26,43,.92), rgba(15,23,39,.75));
      box-shadow: inset 0 0 0 1px rgba(122,252,255,.08), 0 30px 80px rgba(0,0,0,.45); overflow:hidden; }
    .hero::before{ content:""; position:absolute; inset:-2px; border-radius:20px;
      background: conic-gradient(from 210deg, rgba(122,252,255,.15), rgba(182,147,255,.18), rgba(92,255,157,.15), rgba(122,252,255,.15));
      filter: blur(26px); opacity:.55; pointer-events:none; mask: radial-gradient(120% 120% at 50% 0%, black 40%, transparent 55%); }
    .title-cn,.title-en{ text-align:center; margin:0; letter-spacing:2px; }
    .title-cn{ font-size:42px; font-weight:800; }
    .title-en{ font-size:28px; font-weight:700; opacity:.92; }
    .glowtext{ background: linear-gradient(90deg, #e9f1ff, #8ee7ff, #c4b5ff, #9bffcc, #e9f1ff); background-size:200% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hueMove 10s linear infinite, shimmer 3.6s ease-in-out infinite; text-shadow: 0 0 12px rgba(122,252,255,.15), 0 0 22px rgba(182,147,255,.12); }
    @keyframes hueMove{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
    @keyframes shimmer{ 0%,100%{filter:drop-shadow(0 0 0 rgba(0,0,0,0))} 50%{filter:drop-shadow(0 0 14px rgba(122,252,255,.35))} }

    .top-actions{ display:flex; gap:12px; align-items:center; padding:12px 4px 0; }
    .top-actions .spacer{ flex:1; }

    .btn{ --c1:var(--neon1); --c2:var(--neon2); position:relative; border:none; outline:none; cursor:pointer; user-select:none; font-weight:700; font-size:14px; letter-spacing:.3px; color:#0b1220; padding:12px 18px; border-radius:12px;
      background: linear-gradient(180deg, white, #dfe8ff);
      box-shadow: 0 var(--btnDepth) 0 rgba(0,0,0,.35), 0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.7), 0 0 0 1px rgba(122,252,255,.25), 0 0 24px rgba(182,147,255,.25);
      transition: transform .15s ease, box-shadow .15s ease;
      background-image: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,244,255,.95)), radial-gradient(120% 140% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(120% 140% at 110% 120%, var(--c2) 0%, transparent 45%);
    }
    .btn:hover{ transform:translateY(-3px); box-shadow: 0 calc(var(--btnDepth)+3px) 0 rgba(0,0,0,.36), 0 18px 36px rgba(0,0,0,.45), 0 0 36px rgba(122,252,255,.35); }
    .btn:active{ transform:translateY(2px); box-shadow: 0 calc(var(--btnDepth)-2px) 0 rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.35); }

    .sound-wrap{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .switch{ position:relative; width:54px; height:28px; background:#2a3652; border-radius:999px; cursor:pointer; box-shadow: inset 0 0 0 1px rgba(122,252,255,.2); }
    .switch::after{ content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background: linear-gradient(180deg, #fff, #e6eeff); box-shadow: 0 6px 12px rgba(0,0,0,.45); transition: left .2s ease; }
    .switch.on{ background: linear-gradient(90deg, rgba(122,252,255,.45), rgba(182,147,255,.45)); }
    .switch.on::after{ left:29px; }
    .volume{ accent-color:#7afcff; height:28px; }
    .label{ font-size:13px; opacity:.92; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:22px; margin-top:18px; }
    .grid .span2{ grid-column: span 2; }

    .card{ position:relative; border-radius:18px; padding:26px 24px; text-align:center; overflow:hidden; cursor:pointer; user-select:none; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 18px 60px rgba(0,0,0,.45); transition: transform .18s ease, box-shadow .18s ease, filter .18s ease; }
    .card:hover{ transform: translateY(-6px); filter:saturate(1.12); box-shadow: inset 0 0 0 1px rgba(122,252,255,.2), 0 24px 80px rgba(0,0,0,.55), 0 0 48px rgba(122,252,255,.28); }
    .card::before{ content:""; position:absolute; inset:0; background: radial-gradient(220px 120px at var(--mx,50%) var(--my,50%), rgba(122,252,255,.18), transparent 55%); pointer-events:none; transition: background .15s ease; }

    .cn{ font-size:26px; font-weight:800; margin-bottom:8px; text-shadow: 0 2px 0 rgba(0,0,0,.3), 0 0 18px rgba(122,252,255,.2); }
    .en{ font-size:16px; font-weight:700; opacity:.95; }

    .red{ background: linear-gradient(180deg, rgba(255,103,103,.15), rgba(255,103,103,.05)); }
    .green{ background: linear-gradient(180deg, rgba(76,252,169,.15), rgba(76,252,169,.05)); }
    .blue{ background: linear-gradient(180deg, rgba(91,157,255,.18), rgba(91,157,255,.06)); }
    .amber{ background: linear-gradient(180deg, rgba(255,199,95,.18), rgba(255,199,95,.06)); }
    .purple{ background: linear-gradient(180deg, rgba(208,143,255,.18), rgba(208,143,255,.06)); }
    .teal{ background: linear-gradient(180deg, rgba(86,236,255,.16), rgba(86,236,255,.06)); }

    .stage{ display:none; margin-top:18px; border-radius:20px; padding:28px 18px 34px; background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(235,243,255,.92)); color:#0e1422; box-shadow: inset 0 0 0 1px rgba(10,20,40,.08), 0 24px 80px rgba(0,0,0,.35); }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .module-title{ font-weight:900; font-size:28px; letter-spacing:.5px; background: linear-gradient(90deg, #1d2140, #193a59, #1d2140); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:none; }
    .subtitle{ font-size:14px; opacity:.7; }

    .stage-actions{ display:grid; grid-template-columns: repeat(3, 1fr); gap:22px; }
    
    .action-btn{ --c1:#00d4ff; --c2:#0077ff; color:#0a1020; font-weight:900; font-size:18px; padding:24px 18px; border-radius:18px; border:none; cursor:pointer; user-select:none; box-shadow: 0 14px 0 rgba(0,0,0,.25), 0 22px 54px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.7); background-image: linear-gradient(180deg, rgba(255,255,255,.94), rgba(242,248,255,.99)), radial-gradient(140% 160% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(140% 160% at 110% 120%, var(--c2) 0%, transparent 45%); transition: transform .15s ease, box-shadow .15s ease; }
    .action-btn:hover{ transform: translateY(-4px); box-shadow: 0 16px 0 rgba(0,0,0,.26), 0 26px 64px rgba(0,0,0,.35); }
    .action-btn:active{ transform: translateY(2px); box-shadow: 0 9px 0 rgba(0,0,0,.3), 0 18px 36px rgba(0,0,0,.32); }
    .act-demo{ --c1:#7afcff; --c2:#8ec5ff; }
    .act-import{ --c1:#ffd37a; --c2:#ffb36b; }

    .game{ position:relative; display:none; margin-top:18px; border-radius:22px; background: linear-gradient(180deg, #f9fbff, #edf4ff); color:#0f1430; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
    .game-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px 8px; border-bottom:1px dashed rgba(12,22,44,.12); }
    .game-left{ font-weight:900; font-size:18px; }
    .progress{ font-weight:800; font-size:14px; opacity:.85; }

    .lang-row{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px; }
    .lang-btn{ border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); transition:.15s; }
    .lang-btn.active{ outline:2px solid #0ea5e9; box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 22px 48px rgba(0,0,0,.22); }

    .jump{ display:flex; align-items:center; gap:8px; }
    .jump input{ width:86px; padding:8px 10px; border-radius:10px; border:1px solid rgba(12,22,44,.18); }

    .board{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; padding:18px; }
    .col{ display:grid; grid-template-rows: repeat(5, 64px); gap:12px; padding:12px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,245,255,.95)); box-shadow: inset 0 0 0 1px rgba(12,22,44,.08); }
    .col-cn{ --tileC:#ffb347; }
    .col-py{ --tileC:#7ee081; }
    .col-tr{ --tileC:#7ec8ff; }

    .tile{ display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; border-radius:12px; cursor:pointer; user-select:none; font-weight:900; color:#0b1220; background: linear-gradient(180deg, #fff, #eaf2ff); box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; border:2px solid rgba(0,0,0,.06); position:relative; z-index:0; }
    
/* Column-colored tiles (default, not only on click) */
.col-cn .tile{
  background: linear-gradient(180deg, #ffe0b3, #ffb347);
  color:#0b1220;
}
.col-py .tile{
  background: linear-gradient(180deg, #cfeedd, #7ee081);
  color:#0b1220;
}
.col-tr .tile{
  background: linear-gradient(180deg, #d8eeff, #7ec8ff);
  color:#0b1220;
}

/* Slightly stronger hover so color pops */
.col-cn .tile:hover, .col-py .tile:hover, .col-tr .tile:hover{
  filter: brightness(1.05) saturate(1.05);
}

/* Selected: brighten further and add subtle glow with column color */
.col-cn .tile.selected, .col-py .tile.selected, .col-tr .tile.selected{
  filter: brightness(1.2) saturate(1.15);
  box-shadow: 0 12px 0 rgba(0,0,0,.2), 0 26px 52px rgba(0,0,0,.25), 0 0 0 2px rgba(255,255,255,.9), 0 0 14px var(--tileC);
}
.tile::after{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 48px rgba(0,0,0,.12); opacity:.65; pointer-events:none; z-index:-1; }
    .tile:hover{ transform: translateY(-3px); box-shadow: 0 14px 0 rgba(0,0,0,.2), 0 28px 56px rgba(0,0,0,.26); }
    .tile.selected{ outline:3px solid var(--tileC); filter: brightness(1.25) saturate(1.2); }
    .tile.correct{ animation: flashOut .6s ease forwards; }
    .tile.wrong{ animation: shake .25s ease; }

    @keyframes flashOut{ 0%{ opacity:1; filter:brightness(1); } 50%{ opacity:.35; filter:brightness(1.6); } 100%{ opacity:0; transform: scale(.96); } }
    @keyframes shake{ 0%,100%{ transform:translateX(0); } 25%{ transform:translateX(-4px); } 75%{ transform:translateX(4px); } }

    .game-bottom{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px 20px; border-top:1px dashed rgba(12,22,44,.12); }
    .mini-btn{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }

    .finish-overlay{ display:none; position:absolute; inset:0; backdrop-filter: blur(4px); background: rgba(255,255,255,.6); align-items:center; justify-content:center; gap:14px; padding:16px; text-align:center; }
    .finish-overlay .btn{ font-size:16px; }

    .wrongpad{ position:fixed; right:18px; bottom:18px; width:320px; max-height:60vh; overflow:auto; 
  background:linear-gradient(180deg,#ffffff,#eef2ff); border-radius:14px; box-shadow: 0 18px 54px rgba(0,0,0,.35); 
  display:none; padding:14px; color:#0b1220; transition:all .25s ease; transform:scale(0.98); opacity:0; }
    .wrongpad h4{ margin:0 0 8px; }
    .wrongpad .witem{ 
  font-size:13px; padding:8px 10px; border-radius:10px; background:#f6f7ff; 
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.12); margin-bottom:8px; 
  border-left:4px solid #0077ff; font-weight:600; color:#0a1638; }

    @media (max-width: 900px){
      .stage-actions{ grid-template-columns: 1fr; }
      .board{ grid-template-columns: 1fr; }
      .col{ grid-template-rows: repeat(5, 58px); }
    }

    footer{ margin-top:28px; font-size:12px; opacity:.8; text-align:center; }
  .wrongpad.show{ transform:scale(1); opacity:1; } 
.tile.wrong{ animation: shake .25s ease; } 

/* Added for Start Game third button layout */
@media (max-width: 1100px){
  .stage-actions{ grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 700px){
  .stage-actions{ grid-template-columns: 1fr; }
}

/* Levels panel styling */
.levels-panel{ display:none; margin-top:16px; padding:16px; border-radius:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(238,244,255,.96));
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.08);
  color:#0b1220;
}
.levels-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.levels-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
@media (max-width: 700px){
  .levels-grid{ grid-template-columns: repeat(2, 1fr); }
}
.lv-btn{ border:none; cursor:pointer; padding:16px 12px; border-radius:14px; font-weight:900;
  box-shadow: 0 12px 0 rgba(0,0,0,.18), 0 20px 48px rgba(0,0,0,.22), inset 0 0 0 1px rgba(255,255,255,.8);
  background-image: linear-gradient(180deg, #ffffff, #eef4ff);
}


/* One-row lesson grid: 10 columns on wide screens, wraps on smaller widths */
.lessons-grid-10{ display:grid; grid-template-columns: repeat(10, 1fr); gap:12px; }
@media (max-width: 1400px){
  .lessons-grid-10{ grid-template-columns: repeat(5, 1fr); }
}
@media (max-width: 860px){
  .lessons-grid-10{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 560px){
  .lessons-grid-10{ grid-template-columns: repeat(2, 1fr); }
}


/* === Subflow (levels/lessons/game) UI cleanup === */
.subflow #btnRegister,
.subflow #btnLogin,
.subflow .sound-wrap { display: none !important; }

.levels-panel, .lessons-panel { max-width: 1200px; margin-left:auto; margin-right:auto; }
.levels-panel .levels-grid,
.lessons-panel .levels-grid { justify-items: center; }

/* One-row centered lessons grid */
.lessons-grid-10{ display:grid; grid-template-columns: repeat(10, 1fr); gap:12px; justify-items:center; }
@media (max-width: 1400px){
  .lessons-grid-10{ grid-template-columns: repeat(5, 1fr); }
}
@media (max-width: 860px){
  .lessons-grid-10{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 560px){
  .lessons-grid-10{ grid-template-columns: repeat(2, 1fr); }
}


.lang-chooser .mini-select{ padding:6px 8px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff; }


/* Center the levels/lessons panels */
#levelsPanel, #lessonsPanel{
  max-width: 1200px;
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 24px;
}
/* In single-view, ensure container centers content */
body.subflow section, body.subflow #app, body.subflow .container{
  margin-left:auto; margin-right:auto;
}

</style>
</head>
<body>
  <div class="container">
    <section class="hero" id="hero">
      <h1 class="title-cn glowtext">HSK单词游戏</h1>
      <h2 class="title-en glowtext">HSK Word Game</h2>
      <div class="top-actions">
        <div class="spacer"></div>
        <button class="btn" id="btnRegister" aria-haspopup="dialog">注册 Register</button>
        <button class="btn" id="btnLogin" aria-haspopup="dialog">登录 Login</button>
        <div class="sound-wrap" title="音效与音量">
          <span class="label">音效 Sound</span>
          <div id="soundSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="音量 Volume" />
        </div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">请选择级别 / Choose Level</div>
          <button class="mini-btn" id="levelsClose">关闭 / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">初级1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">初级2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">中级1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">中级2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">高级1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">高级2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">初级1 · 请选择课段 / Elementary 1 · Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">返回上一级 / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">第1-3课<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">第4-6课<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">第7-9课<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">第10-12课<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">第13-15课<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">第16-18课<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">第19-21课<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">第22-24课<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">第25-27课<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">第28-30课<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="grid" id="menu">
      <div class="card red" data-key="dev-cn">
        <div class="cn">发展汉语词汇</div>
        <div class="en">Developing Chinese Vocabulary</div>
      </div>
      <div class="card green" data-key="hsk">
        <div class="cn">HSK词汇</div>
        <div class="en">HSK Vocabulary</div>
      </div>
      <div class="card blue" data-key="fill">
        <div class="cn">选词填空</div>
        <div class="en">Fill in the Blanks</div>
      </div>
      <div class="card amber" data-key="build">
        <div class="cn">词语组句</div>
        <div class="en">Sentence Building</div>
      </div>
      <div class="card purple" data-key="order">
        <div class="cn">句子排序</div>
        <div class="en">Sentence Ordering</div>
      </div>
      <div class="card teal" data-key="banks">
        <div class="cn">获取词库和题库</div>
        <div class="en">Get Word & Question Banks</div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">请选择级别 / Choose Level</div>
          <button class="mini-btn" id="levelsClose">关闭 / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">初级1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">初级2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">中级1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">中级2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">高级1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">高级2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">初级1 · 请选择课段 / Elementary 1 · Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">返回上一级 / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">第1-3课<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">第4-6课<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">第7-9课<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">第10-12课<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">第13-15课<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">第16-18课<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">第19-21课<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">第22-24课<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">第25-27课<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">第28-30课<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="game" id="gameDemo" aria-hidden="true">
      <div class="game-top">
        <div class="game-left">
          <span id="levelInfo">关卡：<strong>1</strong></span>
          &nbsp;|&nbsp;
          <span class="progress">进度 <span id="passed">0</span>/<span id="total">0</span></span>
        </div>
        <div class="jump">
          <label>跳往第 <input type="number" id="jumpInput" min="1" value="1" /> 关</label>
          <button class="btn" id="jumpGo">Go</button>
        </div>
      </div>
      <div class="lang-row" id="langRow"></div>
      <div class="board" id="board">
        <div class="col col-cn" id="colCN" aria-label="中文列"></div>
        <div class="col col-py" id="colPY" aria-label="拼音列"></div>
        <div class="col col-tr" id="colTR" aria-label="翻译列"></div>
      </div>
      <div class="game-bottom">
        <button class="mini-btn" id="btnTip">提示 / Tips</button>
        <button class="mini-btn" id="btnShuffle">重排序 / Reshuffle</button>
        <button class="mini-btn" id="btnSave">保存 / Save</button>
        <button class="mini-btn" id="btnBack">返回上一级 / Back</button>
        <button class="mini-btn" id="btnWrong">错词本 / Wrong Book</button>
      </div>
      <div class="finish-overlay" id="finish">
        <div id="finishText" style="font-weight:800; margin-bottom:8px;">本关完成！</div>
        <div>
          <button class="btn" id="btnPrev">返回上一关</button>
          <button class="btn" id="btnNext">继续下一关</button>
        </div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">请选择级别 / Choose Level</div>
          <button class="mini-btn" id="levelsClose">关闭 / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">初级1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">初级2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">中级1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">中级2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">高级1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">高级2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">初级1 · 请选择课段 / Elementary 1 · Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">返回上一级 / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">第1-3课<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">第4-6课<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">第7-9课<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">第10-12课<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">第13-15课<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">第16-18课<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">第19-21课<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">第22-24课<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">第25-27课<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">第28-30课<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="stage" id="stage">
      <div class="stage-header">
        <div>
          <div class="module-title" id="modTitle">模块标题</div>
          <div class="subtitle" id="modSub">Module Subtitle</div>
        </div>
        <button class="btn" id="btnBackTop">返回主菜单 / Back</button>
      </div>
      <div class="stage-actions">
        <button class="action-btn" id="actStart" style="--c1:#9dffa8; --c2:#7ee081;">开始游戏<br><small>Start Game</small></button>
        <button class="action-btn act-demo" id="actDemo">试玩游戏<br><small>Demo (Built-in 20)</small></button>
        <button class="action-btn act-import" id="actImport">导入词库玩游戏<br><small>Import & Play</small></button>
        <input id="fileImport" type="file" accept=".csv,.txt" style="display:none" />
        <button class="action-btn" id="btnClearTrial" style="display:none; --c1:#ff9aa2; --c2:#ff6f91;">清除导入词库<br><small>Clear Imported Bank</small></button>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">请选择级别 / Choose Level</div>
          <button class="mini-btn" id="levelsClose">关闭 / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">初级1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">初级2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">中级1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">中级2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">高级1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">高级2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">翻译语言 / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">初级1 · 请选择课段 / Elementary 1 · Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">返回上一级 / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">第1-3课<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">第4-6课<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">第7-9课<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">第10-12课<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">第13-15课<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">第16-18课<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">第19-21课<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">第22-24课<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">第25-27课<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">第28-30课<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <footer>
      Copyright Held by: Mr. Yan Qinghua, Chongqing Technology and Business University (CTBU)<br/>
      Support by: Teaching and Research Section of TCFL, CTBU
    </footer>
  </div>

  <dialog id="dlgRegister">
    <form method="dialog" id="formRegister" style="min-width:300px">
      <h3>注册 Register</h3>
      <label>用户名 Username<br/>
        <input id="regName" required maxlength="24" />
      </label><br/><br/>
      <label>密码 Password<br/>
        <input id="regPass" type="password" required minlength="4" />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">取消 Cancel</button>
        <button class="btn" value="default">提交 Submit</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form method="dialog" id="formLogin" style="min-width:300px">
      <h3>登录 Login</h3>
      <label>用户名 Username<br/>
        <input id="logName" required />
      </label><br/><br/>
      <label>密码 Password<br/>
        <input id="logPass" type="password" required />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">取消 Cancel</button>
        <button class="btn" value="default">登录 Login</button>
      </menu>
    </form>
  </dialog>

  <div class="wrongpad" id="wrongPad">
    <h4>错词本 Wrong Book</h4>
    <div id="wrongList"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button class="mini-btn" id="wrongClose">关闭 / Close</button>
      <button class="mini-btn" id="wrongClear">清空 / Clear</button>
    </div>
  </div>

  <div id="toastStack"></div>

  <script>

    // === Global Single-View Navigation (fix for showSection not defined) ===
    (function(){
      const VIEWS = ['menu','stage','levelsPanel','lessonsPanel','gameDemo'];
      window.showSection = function(id){
        VIEWS.forEach(function(k){
          var el = document.getElementById(k);
          if(el){ el.style.display = (k===id)?'block':'none'; }
        });
        if(id==='menu'){ document.body.classList.remove('subflow'); }
        else { document.body.classList.add('subflow'); }
      };
      // ensure menu shows by default if nothing else has chosen
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', function(){ try{ showSection('menu'); }catch(e){} });
      }else{
        try{ showSection('menu'); }catch(e){}
      }
    })();


    /* Shim */
    (function(){
      if(typeof window.Intercom!=="function"){
        const q=[]; const shim=function(){ q.push(arguments); };
        shim.q=q; shim.boot=function(){}; shim.shutdown=shim.show=shim.hide=shim.update=function(){};
        window.Intercom=shim;
      }
      window.notifyNavigation = window.notifyNavigation || function(){};
      window.notifyIntrinsicHeight = window.notifyIntrinsicHeight || function(){};
      window.__hostApi = window.__hostApi || {};
      ["notifyNavigation","notifyIntrinsicHeight"].forEach(k=>{
        if(typeof window.__hostApi[k]!=="function") window.__hostApi[k]=function(){};
      });
      window.addEventListener("unhandledrejection", function(e){
        const msg = (e && e.reason && (e.reason.stack||e.reason.message||e.reason)) || "";
        if(String(msg).match(/Intercom|Host API|notifyNavigation|notifyIntrinsicHeight/)) e.preventDefault();
      });
    })();

    const $ = (q)=>document.querySelector(q);

    /* ===== Users & Trial store ===== */
    const store = {
      get users(){ return JSON.parse(localStorage.getItem('hsk_users')||'{}'); },
      set users(v){ localStorage.setItem('hsk_users', JSON.stringify(v)); },
      get session(){ return JSON.parse(localStorage.getItem('hsk_session')||'null'); },
      set session(v){ localStorage.setItem('hsk_session', JSON.stringify(v)); },
      get trial(){ return JSON.parse(localStorage.getItem('dev_trial_words')||'null'); },
      set trial(v){ localStorage.setItem('dev_trial_words', JSON.stringify(v)); }
    };

    const btnRegister = $('#btnRegister');
    const btnLogin = $('#btnLogin');
    const dlgRegister = $('#dlgRegister');
    const dlgLogin = $('#dlgLogin');

    function safeShowModal(d){
      if(!d.open){ try{ d.showModal(); }catch{ d.setAttribute('open',''); } }
    }
    function safeClose(d){
      if(d.open){ try{ d.close(); }catch{ d.removeAttribute('open'); } }
    }

    function refreshAuthUI(){
      const s = store.session;
      if(s && s.username){
        btnRegister.textContent = `👋 欢迎 ${s.username}`;
        btnRegister.disabled = true;
        btnLogin.textContent = '退出 Logout';
      }else{
        btnRegister.textContent = '注册 Register';
        btnRegister.disabled = false;
        btnLogin.textContent = '登录 Login';
      }
    }

    btnRegister.addEventListener('click', ()=>{ if(!store.session) safeShowModal(dlgRegister); });
    btnLogin.addEventListener('click', ()=>{
      if(store.session){ store.session = null; refreshAuthUI(); showToast('已退出 / Logged out','success'); return; }
      safeShowModal(dlgLogin);
    });

    document.getElementById('formRegister').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#regName').value.trim();
      const pass = $('#regPass').value;
      if(!name || !pass) return;
      const users = store.users;
      if(users[name]){ showToast('用户名已存在 / Username exists','error'); return; }
      users[name] = { password: pass };
      store.users = users;
      store.session = { username: name };
      safeClose(dlgRegister); refreshAuthUI();
      showToast('注册成功，已自动登录 / Registered & Signed in','success');
    });

    document.getElementById('formLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#logName').value.trim();
      const pass = $('#logPass').value;
      const users = store.users;
      if(!users[name] || users[name].password !== pass){ showToast('用户或密码错误 / Invalid credentials','error'); return; }
      store.session = { username: name };
      safeClose(dlgLogin); refreshAuthUI();
      showToast('登录成功 / Signed in','success');
    });

    refreshAuthUI();

    /* ===== Audio ===== */
    const soundSwitch = document.getElementById('soundSwitch');
    const volume = document.getElementById('volume');
    let audioCtx, masterGain, isOn = true;

    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volume.value || 0.6);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function applySwitchUI(){ soundSwitch.classList.toggle('on', isOn); soundSwitch.setAttribute('aria-checked', String(isOn)); }
    function toggleSound(){ isOn = !isOn; applySwitchUI(); }
    applySwitchUI();

    soundSwitch.addEventListener('click', ()=>{ ensureAudio(); toggleSound(); });
    soundSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); ensureAudio(); toggleSound(); } });
    volume.addEventListener('input', ()=>{ ensureAudio(); if(masterGain) masterGain.gain.value = Number(volume.value||0.6); });

    function playSfx(type='click'){
      if(!isOn) return;
      ensureAudio();
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = (type==='err') ? 'square' : 'sine';
      const cfg = {
        click: { f: 660, dur: 0.08 },
        ok:    { f: 880, dur: 0.14 },
        err:   { f: 180, dur: 0.18 },
        done:  { f: 520, dur: 0.24 },
        shuffle:{ f: 740, dur: 0.10 }
      }[type] || { f: 660, dur: 0.08 };
      osc.frequency.setValueAtTime(cfg.f, now);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + cfg.dur);
      osc.connect(gain).connect(masterGain);
      osc.start(now);
      osc.stop(now + cfg.dur + 0.02);
    }

    /* ===== Module Nav ===== */
    const menu = document.getElementById('menu');
    const stage = document.getElementById('stage');
    const modTitle = document.getElementById('modTitle');
    const modSub = document.getElementById('modSub');
    const btnBackTop = document.getElementById('btnBackTop');
    const actDemo = document.getElementById('actDemo');
    const actImport = document.getElementById('actImport');
    const fileImport = document.getElementById('fileImport');
    const btnClearTrial = document.getElementById('btnClearTrial');

    function openModule(key, titleCN, titleEN){
      modTitle.textContent = titleCN;
      modSub.textContent = titleEN;
      menu.style.display = 'none';
      stage.style.display = 'block';
      showToast('进入模块：' + titleCN, 'success');
      stage.dataset.key = key;
      btnClearTrial.style.display = store.trial ? 'inline-block':'none';
    }
    function backHome(){ stage.style.display='none'; menu.style.display='grid'; }

    document.querySelectorAll('#menu .card').forEach(c=>{
      c.addEventListener('mousemove',(e)=>{
        const r = c.getBoundingClientRect();
        const x = ((e.clientX - r.left)/r.width)*100;
        const y = ((e.clientY - r.top)/r.height)*100;
        c.style.setProperty('--mx', x+'%');
        c.style.setProperty('--my', y+'%');
      });
      c.addEventListener('click', ()=>{
        const key = c.getAttribute('data-key');
        if(key==='banks'){ showToast('“获取词库和题库”页面稍后提供 / Coming soon','info'); return; }
        if(!store.session){ showToast('以游客模式进入。可在右上角注册/登录以保存进度。','info'); }
        const cn = c.querySelector('.cn').textContent.trim();
        const en = c.querySelector('.en').textContent.trim();
        playSfx('click'); openModule(key, cn, en);
      });
    });

    btnBackTop.addEventListener('click', backHome);

    
    actDemo.addEventListener('click', ()=>{
      playSfx('click');
      const key = stage.dataset.key;
      if(key === 'dev-cn'){
        showSection('gameDemo');
        initDemo(false); // original demo
        showToast('发展汉语·试玩（内置 20 个词）开始','success');
      } else if (key === 'hsk'){
        startHSKDemo(); // reuse same engine with swapped dataset
      } else if (key === 'fill') { startFillDemo(); } else {
        showToast('【'+modTitle.textContent+'】试玩模式启动 / Demo starting…','info');
      }
    });
actImport.addEventListener('click', ()=>{
      playSfx('click'); fileImport.click();
    });

    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){
          showToast('导入失败：未解析到有效条目。','error'); return;
        }
        const uniq = [];
        const seen = new Set();
        for(const w of parsed){
          const k = (w.cn||'') + '|' + (w.py||'');
          if(!seen.has(k)){ seen.add(k); uniq.push(w); }
          if(uniq.length>=20) break;
        }
        if(uniq.length<5){
          showToast('导入条目太少，至少需要 5 条。','error'); return;
        }
        store.trial = uniq;
        btnClearTrial.style.display = 'inline-block';
        showToast(`成功导入 ${uniq.length} 条。该词库将用于“导入词库玩游戏”模式。`,'success');
      }catch(err){
        console.error(err);
        showToast('导入出错：文件读取或解析失败。','error');
      }finally{
        fileImport.value = '';
      }
    });

    btnClearTrial.addEventListener('click', ()=>{
      store.trial = null;
      btnClearTrial.style.display = 'none';
      showToast('已清除导入词库。','success');
    });

    /* ===== Toast ===== */

    const actStart = document.getElementById('actStart');
    const levelsPanel = document.getElementById('levelsPanel');
    const levelsClose = document.getElementById('levelsClose');

    if (actStart){
      actStart.addEventListener('click', ()=>{
        if(stage.dataset.key === 'fill'){ FillLevel.open(); showToast && showToast('请选择级别 / Choose a level','success'); return; }
        playSfx('click');
        if(stage.dataset.key !== 'dev-cn'){
          showToast('“开始游戏 / Start Game”目前仅用于【发展汉语词汇】模块。','info');
          return;
        }
        showSection('levelsPanel');
        showToast('请选择级别 / Choose a level','success');
      });
    }
    if (levelsClose){
      levelsClose.addEventListener('click', ()=>{
        levelsPanel.style.display = 'none';
      });
    }
    levelsPanel?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lv-btn');
      if(!btn) return;
      const lv = btn.getAttribute('data-level');
      playSfx('click');
      // Placeholder: future hookup to real datasets per level.
    // --- Start Game -> Levels -> Lessons wiring ---
    const lessonsPanel = document.getElementById('lessonsPanel');
    const lessonsBack = document.getElementById('lessonsBack');

    // Open lessons under Elementary 1
    levelsPanel?.addEventListener('click', (e)=>{
      const b = e.target.closest('.lv-btn');
      if(!b) return;
      const level = b.getAttribute('data-level');
      if(level==='beg1'){ // Elementary 1
        levelsPanel.style.display='none';
        lessonsPanel.style.display='block';
      }
    });

    lessonsBack?.addEventListener('click', ()=>{
      showSection('levelsPanel');
    });

    // Map of lesson -> raw file URL (we wire 1-3 now; others to be provided)
    const LESSON_URL = {
      "1-3": "https://raw.githubusercontent.com/steven2025/gif2025/43159a799eee708cb6cb85521d988b68160663e0/%E5%88%9D%E7%BA%A71-Lesson%201-3_multilingual.txt",
      "4-6": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A7%201-Lesson%204-6_multilingual.txt",
      "10-12": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2010-12_multilingual.txt",
      "13-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2013-15_multilingual.txt",
      "16-18": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2016-18_multilingual.txt",
      "19-21": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2019-21_multilingual.txt",
      "22-24": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2022-24_multilingual.txt",
      "25-27": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2025-27_multilingual.txt",
      "28-30": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2028-30_multilingual.txt",
      "7-9": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%207-9_multilingual.txt",
      "beg2-1-5": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%201-5_multilingual.txt",
      "beg2-11-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2011-15_multilingual.txt",
      "beg2-16-20": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2016-20_multilingual.txt",
      "beg2-21-25": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2021-25_multilingual.txt",
      "beg2-6-10": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%206-10_multilingual.txt",
      "int1-1-3": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson1-3_multilingual.txt",
      "int1-10-12": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson10-12_multilingual.txt",
      "int1-13-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson13-15_multilingual.txt",
      "int1-4-6": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson4-6_multilingual.txt",
      "int1-7-9": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson7-9_multilingual.txt"
    };

    
    
    // === Unified Single-View Navigation ===
    const VIEWS = ['menu','stage','levelsPanel','lessonsPanel','gameDemo'];
    function showSection(id){
      VIEWS.forEach(k=>{ const el = document.getElementById(k); if(el) el.style.display = (k===id)?'block':'none'; });
      // hide header controls in any sub-level
      if(id==='menu'){ document.body.classList.remove('subflow'); }
      else { document.body.classList.add('subflow'); }
    }
    // Ensure on load we show menu only
    window.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('langChooser')?.remove(); showSection('menu'); });

// --- Subflow: hide welcome/logout/sound in levels/lessons/game ---

    // Language selection for translations in subflow
    const langSelect = document.getElementById('langSelect');
    if(langSelect){
      const saved = localStorage.getItem('trLang') || 'en';
      langSelect.value = saved;
      langSelect.addEventListener('change', ()=>{
        localStorage.setItem('trLang', langSelect.value);
        showToast('已切换翻译语言：' + langSelect.options[langSelect.selectedIndex].text, 'info');
        // If a dataset is loaded, remap TR and refresh board
        if (Array.isArray(store.trial) && store.trial.length){
          const remapped = store.trial.map(o=>{
            const tr = (o[langSelect.value] && String(o[langSelect.value]).trim()) || o.en || o.tr || '';
            return Object.assign({}, o, { tr });
          });
          store.trial = remapped;
          if (typeof resetAndStartFromTrial === 'function'){
            resetAndStartFromTrial();
          }
        }
      });
    }

    // prefer user-chosen lang over detection
    function detectUILangCode(){
      const chosen = (document.getElementById('langSelect')?.value) || localStorage.getItem('trLang');
      if (chosen) return chosen.toLowerCase();
      // fallback detection map (unchanged below)
      const map = {
        cn:['中文','chinese','cn','zh','zh-cn','汉语','汉字'],
        py:['拼音','pinyin','py'],
        en:['英语','english','en','eng'],
        th:['泰','thai','th','泰语'],
        vi:['越','vietnamese','vi','越南语'],
        lo:['老','lao','lo','老挝语'],
        fr:['法','french','fr','法语'],
        ja:['日','japanese','ja','日语','日本语'],
        ko:['韩','korean','ko','韩语'],
        ru:['俄','russian','ru','俄语'],
        de:['德','german','de','德语'],
        es:['西','spanish','es','西语','西班牙语']
      };
      const candidates = [
        (localStorage.getItem('uiLang')||''),
        (localStorage.getItem('lang')||''),
        (window.uiLang||''),
        (document.documentElement.getAttribute('lang')||''),
        (stage?.dataset?.lang||'')
      ].map(s=>String(s).toLowerCase().trim()).filter(Boolean);
      for(const raw of candidates){
        for(const code in map){
          if(map[code].some(k=>raw.includes(k))) return code;
        }
        if(map[raw]) return raw;
      }
      return 'en';
    }

    function enterSubflow(){ document.body.classList.add('subflow'); }

    function resetAndStartFromTrial(){
      if(!Array.isArray(store.trial) || !store.trial.length) return;
      // route to demo game engine with current trial
      stage.style.display='none';
      document.getElementById('gameDemo').style.display='block';
      initDemo(true);
    }
    
    function exitSubflow(){ document.body.classList.remove('subflow'); }

    // === Hook your existing language buttons ===
    const LANG_MAP = {
      '英语': 'en','English':'en',
      '泰语':'th','Thai':'th',
      '越南语':'vi','Vietnamese':'vi',
      '老挝语':'lo','Lao':'lo',
      '法语':'fr','French':'fr',
      '日语':'ja','Japanese':'ja',
      '韩语':'ko','Korean':'ko',
      '俄语':'ru','Russian':'ru',
      '德语':'de','German':'de',
      '西班牙语':'es','Spanish':'es'
    };
    window.setTranslationLang = function(code){ try{ localStorage.setItem('trLang', code); }catch{} };
    document.addEventListener('click',(e)=>{
      const t = (e.target.closest('button, .btn, .card, .lang, [role="button"]')?.textContent||'').trim();
      for(const k in LANG_MAP){
        if(t.includes(k)){ localStorage.setItem('trLang', LANG_MAP[k]); break; }
      }
    }, true);


    // enter subflow when levels open
    if (actStart){
      actStart.addEventListener('click', ()=>{ enterSubflow(); });
    }
    // back button that returns to main stage should exit subflow (if exists)
    const stageBack = document.getElementById('stageBack');
    stageBack?.addEventListener('click', ()=>{ exitSubflow(); });

    // robust UI language detection for external wordbanks
    function detectUILangCode(){
      const map = {
        cn:['中文','chinese','cn','zh','zh-cn','汉语','汉字'],
        py:['拼音','pinyin','py'],
        en:['英语','english','en','eng'],
        th:['泰','thai','th','泰语'],
        vi:['越','vietnamese','vi','越南语'],
        lo:['老','lao','lo','老挝语'],
        fr:['法','french','fr','法语'],
        ja:['日','japanese','ja','日语','日本语'],
        ko:['韩','korean','ko','韩语'],
        ru:['俄','russian','ru','俄语'],
        de:['德','german','de','德语'],
        es:['西','spanish','es','西语','西班牙语']
      };
      const candidates = [
        (localStorage.getItem('uiLang')||''),
        (localStorage.getItem('lang')||''),
        (window.uiLang||''),
        (document.documentElement.getAttribute('lang')||''),
        (stage?.dataset?.lang||'')
      ].map(s=>String(s).toLowerCase().trim()).filter(Boolean);

      for(const raw of candidates){
        for(const code in map){
          if(map[code].some(k=>raw.includes(k))) return code;
        }
        // direct code match
        if(map[raw]) return raw;
      }
      return 'en'; // fallback
    }

    function mapParsedToTarget(parsed){
      const code = detectUILangCode();
      return parsed.map(o=>{
        const tr = (o[code] && String(o[code]).trim()) || o.en || '';
        return Object.assign({}, o, { tr });
      });
    }

    async function startFromExternal(url){
      try{
        showToast('正在加载词库… / Loading word bank…','info');
        const resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok){ throw new Error('HTTP ' + resp.status); }
        const text = await resp.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){ throw new Error('No valid entries parsed'); }
        const patched = mapParsedToTarget(parsed);
        store.trial = patched;
        // enter game screen with imported dataset
        showSection('gameDemo');
        initDemo(true); enterSubflow();
        showToast('已加载外部词库并开始游戏 / Loaded external word bank.','success');
      }catch(err){
        console.error(err);
        showToast('加载失败：' + (err.message||err),'error');
      }
    }

    lessonsPanel?.addEventListener('click', (e)=>{
      const b = e.target.closest('.lesson-btn');
      if(!b) return;
      const key = b.getAttribute('data-lesson');
      playSfx('click');
      if(!LESSON_URL[key]){
        showToast('该课段的词库稍后接入 / Coming soon for ' + key, 'info');
        return;
      }
      startFromExternal(LESSON_URL[key]);
    });

      showToast('已选择：' + btn.textContent.replace(/\s+/g,'' ) + '（即将接入词库）','success');
      // Keep panel open for now; you can hide it if preferred:
      // levelsPanel.style.display = 'none';
    });

    
function showToast(msg, type='info') {
  try {
    var t = (type || 'info').toString().toLowerCase();
    var message = (typeof msg === 'string') ? msg : String(msg);
    // Only show if it's error/warn or message contains allowed success keywords
    var allowLight = /(加载成功|上传成功|保存成功|成功|已保存)/.test(message);
    if (t !== 'error' && t !== 'warn' && t !== 'warning' && !allowLight) {
      return;
    }
  } catch (e) {}
  var box = document.getElementById('toastBoxMini');
  if (!box) {
    box = document.createElement('div');
    box.id = 'toastBoxMini';
    box.style.position = 'fixed';
    box.style.left = '50%';
    box.style.top = '24px';
    box.style.transform = 'translateX(-50%)';
    box.style.maxWidth = '80%';
    box.style.padding = '10px 14px';
    box.style.borderRadius = '10px';
    box.style.backdropFilter = 'blur(6px)';
    box.style.boxShadow = '0 6px 18px rgba(0,0,0,.2)';
    box.style.fontSize = '14px';
    box.style.zIndex = '9999';
    box.style.background = 'rgba(0,0,0,.75)';
    box.style.color = '#fff';
    document.body.appendChild(box);
  }
  box.textContent = message;
  box.style.opacity = '1';
  if (window.__toastMiniTimer) clearTimeout(window.__toastMiniTimer);
  window.__toastMiniTimer = setTimeout(function () {
    box.style.opacity = '0';
  }, 1800);
}

    /* ===== Built-in Demo Data (your uploaded 20 words) ===== */
    const DEMO_TXT = `你,nǐ,you (singular),คุณ,bạn,ເຈົ້າ,tu/vous,あなた,너/당신,ты,du,tú
好,hǎo,good/fine/nice,ดี,tốt,ດີ,bon,いい,좋은,хороший,gut,bueno
你们,nǐ men,you (plural),พวกคุณ,các bạn,ພວກເຈົ້າ,vous,あなたたち,너희/당신들,вы,ihr,vosotros/ustedes
老师,lǎo shī,teacher,ครู,giáo viên,ຄູ,professeur/enseignant,先生,선생님,учитель,Lehrer,profesor/maestro
早上,zǎo shang,morning/early morning,ตอนเช้า,buổi sáng,ຕອນເຊົ້າ,matin,朝,아침,утро,Morgen,mañana
是,shì,be,คือ,là,ແມ່ນ,être,です,이다,быть,sein,ser/estar
国,guó,country/state/nation,ประเทศ/ชาติ,quốc gia,ປະເທດ,pays/état/nation,国,나라/국가,страна/государство,Land/Staat/Nation,país/estado/nación
人,rén,people/human being,คน,người,ຄົນ,personne/humain,人,사람,человек/люди,Mensch/Person,persona/humano
我,wǒ,I/me,ฉัน,tôi,ຂ້ອຍ,je/moi,私,나/저,я,ich,yo
他,tā,he/him,เขา,anh ấy,ລາວ,il/lui,彼,그,он,er,él
请问,qǐng wèn,excuse me/may I ask,ขอถาม,xin hỏi,ຂໍຖາມ,excusez-moi/puis-je demander,すみません,실례합니다/여쭤보겠습니다,извините/могу я спросить,entschuldigen Sie/darf ich fragen,disculpe/¿puedo preguntar?
什么,shén me,what,อะไร,gì,ຫຍັງ,quoi/que,何,무엇/뭐,что,was,qué
名字,míng zi,name/given or personal name,ชื่อ,tên,ຊື່,nom,名前,이름,имя,Name,nombre
姓,xìng,be surnamed,นามสกุล,họ,ຊື່ສະກຸນ,nom de famille,苗字/姓,성,фамилия,Nachname,apellido
高兴,gāo xìng,glad/happy,ดีใจ,vui mừng,ດີໃຈ,content/heureux,嬉しい,기쁜,рад/счастливый,froh/glücklich,contento/feliz
大学生,dà xué shēng,college or university student,นักศึกษา,sinh viên đại học,ນັກສຶກສາມະຫາວິທະຍາໄລ,étudiant universitaire,大学生,대학생,студент университета,Universitätsstudent,estudiante universitario
几,jǐ,how many,กี่,mấy,ກີ່,combien,いくつ,몇,сколько,wie viele,cuántos
工作,gōng zuò,job/work/task,งาน,công việc,ວຽກ,travail/emploi,仕事,일/작업,работа,Arbeit/Job,trabajo/empleo
律师,lǜ shī,lawyer/attorney,ทนายความ,luật sư,ທະນາຍຄວາມ,avocat,弁護士,변호사,адвокат,Anwalt,abogado
医生,yīs hēng,doctor/medical practitioner,หมอ/แพทย์,bác sĩ,ຫມໍ/ແພດ,médecin/docteur,医者,의사,врач/доктор,Arzt,médico/doctor`;

    
    

    // ===== Embedded HSK Trial Text (from uploaded HSK试玩单词库.txt) =====
    const HSK_TXT = `阿姨,ā yí,aunt,ป้า,dì,ປ້າ,tante,おば,이모,тётя,Tante,tía  
矮,ǎi,short,เตี้ย,thấp,ຕ່ຳ,petit,低い,작은,низкий,klein,bajo  
爱好,ài hào,hobby,งานอดิเรก,sở thích,ຄວາມມັກ,passe-temps,趣味,취미,хобби,Hobby,pasatiempo  
安静,ān jìng,quiet,เงียบ,yên tĩnh,ງຽບ,calme,静かな,조용한,тихий,ruhig,tranquilo  
把,bǎ,hold,จับ,cầm,ຖິດ,tenir,持つ,잡다,держать,halten,sostener  
班,bān,class,ชั้นเรียน,lớp,ຊັ້ນຮຽນ,classe,クラス,반,класс,Klasse,clase  
搬,bān,move,ย้าย,di chuyển,ຍ້າຍ,déménager,引っ越す,이사하다,переезжать,umziehen,mudar  
半,bàn,half,ครึ่ง,một nửa,ເຄິ່ງ,moitié,半分,반,половина,Hälfte,mitad  
办法,bàn fǎ,way; method,วิธี,cách,ວິທີ,méthode,方法,방법,способ,Methode,método  
办公室,bàn gōng shì,office,สำนักงาน,văn phòng,ຫ້ອງການ,bureau,オフィス,사무실,офис,Büro,oficina  
帮忙,bāng máng,help,ช่วย,giúp đỡ,ຊ່ວຍ,aider,手伝う,도와주다,помогать,helfen,ayudar  
包,bāo,package; bag,ห่อ,gói,ຫຸ້ມ,paquet,包み,포장,пакет,Paket,paquete  
北方,běi fāng,north,ทิศเหนือ,phía bắc,ທິດເໜືອ,nord,北,북쪽,север,Norden,norte  
鼻子,bí zi,nose,จมูก,mũi,ດັງ,nez,鼻,코,нос,Nase,nariz  
比较,bǐ jiào,compare,เปรียบเทียบ,so sánh,ປຽບທຽບ,comparer,比較する,비교하다,сравнивать,vergleichen,comparar  
比赛,bǐ sài,match; competition,การแข่งขัน,trận đấu,ການແຂ່ງຂັน,match,試合,경기,матч,Wettkampf,partido  
笔记本,bǐ jì běn,notebook,สมุดบันทึก,sổ tay,ສະໝຸດບັນທຶກ,carnet,ノート,공책,блокнот,Notizbuch,cuaderno  
必须,bì xū,must,ต้อง,phải,ຕ້ອງ,devoir,必須,필须,должен,müssen,deber  
变化,biàn huà,change,เปลี่ยนแปลง,thay đổi,ປ່ຽນແປງ,changer,変化する,변화하다,меняться,ändern,cambiar
面包,miàn bāo,bread,ขนมปัง,bánh mì,ຂນົມปัง,pain,パン,빵,хлеб,Brot,pan`;
function parseDemo(txt){
      if(!txt) return [];
      // Normalize
      txt = txt.replace(/\uFEFF/g, '');               // BOM
      txt = txt.replace(/，|；|;/g, ',');              // CN comma/semicolon -> comma
      txt = txt.replace(/\t/g, ',');                  // tabs -> comma
      txt = txt.replace(/\r\n?/g, '\n');              // CRLF/LF -> LF
      txt = txt.replace(/\n{2,}/g, '\n');             // collapse blank lines
      const lines0 = txt.split(/\n/).map(s=>s.trim()).filter(Boolean);
      // Drop header if present
      const hasHeader = lines0.length && /(中文|汉字|chinese|拼音|pinyin|英语|english|en)\b/i.test(lines0[0]);
      const lines = hasHeader ? lines0.slice(1) : lines0;
      const out = [];
      for(const line of lines){
        // split on commas; keep empties
        const parts = line.split(',').map(s=>s.trim());
        if(parts.length < 3) continue;                         // need cn/py/en
        while(parts.length < 12) parts.push('');               // pad
        const [cn, py, en] = parts;
        if(!cn || !py || !en) continue;                        // require first 3
        for(let i=3;i<12;i++){ if(!parts[i]) parts[i]=en; }    // fallback to English
        const [th,vi,lo,fr,ja,ko,ru,de,es] = parts.slice(3,12);
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
      }
      return out;
    }


    const demoDataFull = parseDemo(DEMO_TXT);
    const BUILTIN_LIMIT = 20;
    const demoData = demoDataFull.slice(0, BUILTIN_LIMIT); // exactly 20

    // Language list (default English)
    const LANGS = [
      {code:'en', name:'英语 English',     idx:0, color:'#ffffff'},
      {code:'th', name:'泰语 Thai',        idx:1, color:'#ffd37a'},
      {code:'vi', name:'越南语 Vietnamese',idx:2, color:'#7afcff'},
      {code:'lo', name:'老挝语 Lao',       idx:3, color:'#8ec5ff'},
      {code:'fr', name:'法语 Français',    idx:4, color:'#d6b7ff'},
      {code:'ja', name:'日语 日本語',      idx:5, color:'#ff91a9'},
      {code:'ko', name:'韩语 한국어',      idx:6, color:'#9dffa8'},
      {code:'ru', name:'俄语 Русский',     idx:7, color:'#ffc7a5'},
      {code:'de', name:'德语 Deutsch',     idx:8, color:'#c6ffef'},
      {code:'es', name:'西班牙语 Español', idx:9, color:'#fdd8ff'}
    ];

    
function parseTrial(text){
  if(!text) return [];
  var t = String(text)
    .replace(/\uFEFF/g,'')
    .replace(/\r\n?/g,'\n')
    .trim();
  var lines = t.split('\n').filter(Boolean);
  if (!lines.length) return [];

  var sep = ( (lines[0].match(/,/g)||[]).length >= (lines[0].match(/\t/g)||[]).length ) ? ',' : '\t';
  var split = function(s){ return s.split(sep).map(function(x){ return x.trim(); }); };

  var header = split(lines[0]).map(function(s){ return s.toLowerCase(); });
  var hasHeader = header.some(function(h){ return /中文|汉字|cn|拼音|pinyin|英语|english|en/.test(h); });
  var data = hasHeader ? lines.slice(1) : lines;

  var idx = { cn:0, py:1, en:2, th:3, vi:4, lo:5, fr:6, ja:7, ko:8, ru:9, de:10, es:11 };

  if(hasHeader){
    var map = {
      cn:['中文','汉字','chinese','cn'],
      py:['拼音','pinyin','py'],
      en:['英语','english','en'],
      th:['泰','thai','th','泰语'],
      vi:['越','vietnamese','vi','越南'],
      lo:['老','lao','lo','老挝'],
      fr:['法','french','fr','法语','français'],
      ja:['日','japanese','ja','日语','日本'],
      ko:['韩','korean','ko','韩语'],
      ru:['俄','russian','ru','俄语'],
      de:['德','german','de','德语','deutsch'],
      es:['西','spanish','es','西语','西班牙','español']
    };
    Object.keys(map).forEach(function(k){
      var arr = map[k], found = -1;
      for (var a=0; a<arr.length; a++){
        var i = header.findIndex(function(h){ return h.indexOf(arr[a]) >= 0; });
        if(i>=0){ found = i; break; }
      }
      if(found>=0) idx[k]=found;
    });
  } else {
    var sample = split(data[0]);
    if (sample.length >= 12){
      idx = { cn:0, py:1, en:2, th:3, vi:4, lo:5, fr:6, ja:7, ko:8, ru:9, de:10, es:11 };
    }
  }

  var out = [];
  for (var li=0; li<data.length; li++){
    var p = split(data[li]);
    var rec = {
      cn: p[idx.cn]||p[0]||'',
      py: p[idx.py]||p[1]||'',
      en: p[idx.en]||p[2]||'',
      th: idx.th>=0 && idx.th<p.length ? (p[idx.th]||'') : '',
      vi: idx.vi>=0 && idx.vi<p.length ? (p[idx.vi]||'') : '',
      lo: idx.lo>=0 && idx.lo<p.length ? (p[idx.lo]||'') : '',
      fr: idx.fr>=0 && idx.fr<p.length ? (p[idx.fr]||'') : '',
      ja: idx.ja>=0 && idx.ja<p.length ? (p[idx.ja]||'') : '',
      ko: idx.ko>=0 && idx.ko<p.length ? (p[idx.ko]||'') : '',
      ru: idx.ru>=0 && idx.ru<p.length ? (p[idx.ru]||'') : '',
      de: idx.de>=0 && idx.de<p.length ? (p[idx.de]||'') : '',
      es: idx.es>=0 && idx.es<p.length ? (p[idx.es]||'') : ''
    };
    out.push(rec);
  }
  return out;
}


    
    // Build HSK demoData (reuse Developing-Chinese demo engine)
    function buildHSKDemoData(){
      // parse lines
      const rows = HSK_TXT.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!rows.length) return [];
      // detect header
      const header = rows[0].split(/[,	]/).map(s=>s.trim().toLowerCase());
      const hasHeader = header.some(h=>/中文|汉字|cn|拼音|pinyin|英语|english|en/.test(h));
      const lines = hasHeader ? rows.slice(1) : rows;
      const out = [];
      for(const line of lines.slice(0,20)){ // only need first 20 for demo
        const p = line.split(/[,	]/).map(s=>s.trim());
        const cn = p[0]||'';
        const py = p[1]||'';
        const en = p[2]||'';
        const th = p[3]||en, vi = p[4]||en, lo = p[5]||en,
              fr = p[6]||en, ja = p[7]||en, ko = p[8]||en,
              ru = p[9]||en, de = p[10]||en, es = p[11]||en;
        if(cn && py && en){
          out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
        }
      }
      return out;
    }


    let state = {
      level: 1,
      N: 5,
      maxLevels: 1,
      passed: Number(localStorage.getItem('dev_demo_passed')||0),
      total: demoData.length, // 20
      langIdx: 0, // default English
      choice: { cn:null, py:null, tr:null },
      tiles: { cn:[], py:[], tr:[] },
      mapping: {},
      wrongBook: JSON.parse(localStorage.getItem('dev_demo_wrong')||'[]'),
      matchedCount: 0,
      usingTrial: false,
      trialWords: []
    };

    
    
    
    function updateHudDisplay(){
      try{
        const wordsPlayed = Math.min(state.total, Math.max(0, (state.level-1)*state.N + (state.matchedCount||0)));
        const levelInfo = document.getElementById('levelInfo');
        const passedEl = document.getElementById('passed');
        const totalEl = document.getElementById('total');
        if(levelInfo){ levelInfo.innerHTML = '关卡：<strong>' + state.level + '/' + (state.maxLevels||1) + '</strong>'; }
        if(passedEl){ passedEl.textContent = wordsPlayed; }
        if(totalEl){ totalEl.textContent = state.total; }
      }catch(e){}
    }

    function getTransById(id, langIdx){
      // langIdx: 0=en, 1=th, 2=vi, 3=lo, 4=fr, 5=ja, 6=ko, 7=ru, 8=de, 9=es
      if(state.usingTrial){
        const w = state.trialWords && state.trialWords[id];
        if(w && w.langs){ return w.langs[langIdx] || w.langs[0] || ''; }
        return '';
      }else{
        const w = demoData && demoData[id];
        if(w && w[2]){ return w[2][langIdx] || w[2][0] || ''; }
        return '';
      }
    }


    
    // Swap helpers for HSK demo
    window.__demoDataBackup = null;
    function startHSKDemo(){
      const hskData = buildHSKDemoData();
      if(!hskData.length){ showToast('HSK 试玩词库加载失败','error'); return; }
      window.__demoDataBackup = demoData.slice();
      demoData.splice(0, demoData.length, ...hskData); // swap to HSK (no const reassignment)
      // launch using the same demo engine
      state.usingTrial = false; // force demo path
      state.level = 1;
      try{ state.langIdx = codeToIdx(localStorage.getItem('trLang')); }catch{}
      stage.style.display='none';
      document.getElementById('gameDemo').style.display='block';
      initDemo(false);
      showToast('HSK·试玩（内嵌 20 词）开始','success');
    }
    function endAnyDemo(){
      // restore demoData if it was swapped
      if(Array.isArray(window.__demoDataBackup)){
        demoData.splice(0, demoData.length, ...window.__demoDataBackup);
        window.__demoDataBackup = null;
      }
    }


    function ensureBoardPopulated(){
      const hasTiles = document.querySelectorAll('.tile').length > 0;
      if(!hasTiles){
        if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      }
    }


    function shade(hex, k){
      const c = hex.replace('#','');
      const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
      const rr = Math.round(r*k+255*(1-k)), gg = Math.round(g*k+255*(1-k)), bb = Math.round(b*k+255*(1-k));
      return `rgb(${rr},${gg},${bb})`;
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

    
    function codeToIdx(code){
      code = String(code||'').toLowerCase();
      const idx = LANGS.findIndex(L=>L.code===code);
      return idx>=0 ? idx : 0;
    }

    function buildLangRow(){
      const row = document.getElementById('langRow');
      row.innerHTML = '';
      LANGS.forEach(L=>{
        const b = document.createElement('button');
        b.className = 'lang-btn';
        b.style.backgroundImage = `linear-gradient(180deg,#fff,${shade(L.color,0.9)})`;
        b.textContent = L.name;
        if(L.idx===state.langIdx) b.classList.add('active');
        b.addEventListener('click', ()=>{
          state.langIdx = L.idx;
          document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          updateTransTexts();
        });
        row.appendChild(b);
      });
      row.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });
    }

    function initDemo(useTrial=false){
      // useTrial can be: false | true (imported) | 'HSK' (built-in HSK)
      state.trialSource = (useTrial==='HSK') ? 'hsk' : (useTrial? 'import':'none');
      state.usingTrial = !!useTrial;
      state.level = 1;
      try{ state.langIdx = codeToIdx(localStorage.getItem('trLang')); }catch{}
      document.getElementById('total').textContent = state.total;
      updateHudDisplay();
      // Safety re-render: if for any reason tiles didn't mount, force a render on next tick
      setTimeout(()=>{
        if(!document.querySelector('.tile')){
          if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
        }
      }, 0);

      document.getElementById('passed').textContent = state.passed;
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      buildLangRow();
      // Prepare data source and totals
      if(useTrial==='HSK'){
        const parsedHSK = parseTrial(HSK_TXT) || [];
        state.trialWords = parsedHSK.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        makeRoundTrial();
        setTimeout(()=>{ renderBoard(); ensureBoardPopulated(); }, 0);
      }else if(!!useTrial){
        const tw = store.trial || [];
        const norm = tw.map(w=>{
          if(!w.langs){
            w.langs = LANGS.map(L=> (w[L.code]||'').trim ? (w[L.code]||'').trim() : (w[L.code]||''));
          }
          return w;
        });
        state.trialWords = norm.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        state.total = state.trialWords.length;
        updateHudDisplay();
      }else{
        state.total = demoData.length; // 20 built-in
      }
      document.getElementById('total').textContent = state.total;
      updateHudDisplay();
      if(useTrial){
        const tw = store.trial || [];
        const norm = tw.map(w=>{
          if(!w.langs){
            w.langs = LANGS.map(L=> (w[L.code]||'').trim ? (w[L.code]||'').trim() : (w[L.code]||''));
          }
          return w;
        });
        state.trialWords = norm.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        makeRoundTrial();
      }else{
        makeRoundBuiltin(); // built-in 4 groups of 5
      }
    }

    function makeRoundBuiltin(){
      const N = 5;
      const MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, '试玩单词已用完（内置 20 个，4 关）。');
        return;
      }
      const start = (state.level-1)*N; // fixed partition
      const slice = demoData.slice(start, start+N);
      const words = slice.map((w, idx)=>{
        const id = start+idx; // 0..19 stable id
        return { id, cn: w[0], py: w[1], tr: w[2][state.langIdx] };
      });
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      updateHudDisplay();
      renderBoard();
      setTimeout(ensureBoardPopulated, 0);
    }

    function makeRoundTrial(){
      const N = state.N;
      state.maxLevels = Math.ceil(state.trialWords.length / N);
      const MAX_LEVELS = state.maxLevels;
      if(state.level > MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, '本单元已完成，可进入下一个单元 / Unit complete! You can enter the next unit.');
        return;
      }
      const start = (state.level-1)*N;
      const slice = state.trialWords.slice(start, start+N);
      const words = slice.map((w)=>({ id:w.id, cn:w.cn, py:w.py, tr:(w.langs[state.langIdx]||w.langs[0]) }));
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      updateHudDisplay();
      renderBoard();
    }

    function renderBoard(){
      const cn = document.getElementById('colCN');
      const py = document.getElementById('colPY');
      const tr = document.getElementById('colTR');
      cn.innerHTML = py.innerHTML = tr.innerHTML = '';
      ['cn','py','tr'].forEach(kind=>{
        const col = kind==='cn'?cn:kind==='py'?py:tr;
        state.tiles[kind].forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tile'; el.textContent = t.text; el.dataset.id = t.id; el.dataset.kind = kind;
          el.addEventListener('click', ()=>onPick(el));
          col.appendChild(el);
        });
      });
      updateOverlay(false, '本关完成！');
      state.choice = {cn:null,py:null,tr:null};
    }

    function renderBoardEmpty(){
      ['colCN','colPY','colTR'].forEach(id=>{ document.getElementById(id).innerHTML=''; });
    }

    
    function updateTransTexts(){
      const trCol = document.getElementById('colTR');
      if(!trCol) return;
      const tiles = trCol.querySelectorAll('.tile');
      tiles.forEach(node=>{
        const id = Number(node.dataset.id);
        node.textContent = getTransById(id, state.langIdx);
      });
      state.tiles.tr = Array.from(trCol.querySelectorAll('.tile')).map(n=>({id:Number(n.dataset.id), text:n.textContent}));
    }



    function onPick(el){
      const kind = el.dataset.kind; const id = Number(el.dataset.id);
      if(el.classList.contains('selected')){ el.classList.remove('selected'); state.choice[kind]=null; return; }
      document.querySelectorAll(`.tile[data-kind="${kind}"]`).forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected'); state.choice[kind]=id;
      const {cn,py,tr} = state.choice;
      if(cn!==null && py!==null && tr!==null){
        const ok = (cn===py && py===tr);
        if(ok){
          playSfx('ok');
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${state.choice[k]}"]`);
            if(node){ node.classList.add('correct'); setTimeout(()=>node.remove(), 600); }
          });
          state.matchedCount += 1;
      updateHudDisplay();
          const targetCount = 5;
          if(state.matchedCount>=targetCount){
            state.passed += 1;
            localStorage.setItem('dev_demo_passed', state.passed);
            document.getElementById('passed').textContent = state.passed;
            setTimeout(()=>{ updateOverlay(true, '本关完成！'); playSfx('done'); }, 650);
          }
          state.choice = {cn:null,py:null,tr:null};
        }else{
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${state.choice[k]}"]`);
            if(node){ node.classList.add('wrong'); setTimeout(()=>node.classList.remove('wrong'), 260); }
          });
          playSfx('err');
          const anyId = cn ?? py ?? tr;
          if(Number.isFinite(anyId)){
            let wcn='', wpy='', wtr='';
            if(state.usingTrial){
              const w = state.trialWords[anyId]; if(w){ wcn=w.cn; wpy=w.py; wtr=w.langs[state.langIdx]||w.langs[0]; }
            }else{
              const w = demoData[anyId]; if(w){ wcn=w[0]; wpy=w[1]; wtr=w[2][state.langIdx]; }
            }
            if(wcn && wpy && wtr){
              const book = state.wrongBook || [];
              book.push({cn:wcn, py:wpy, tr:wtr, lang:state.langIdx});
              state.wrongBook = book;
              localStorage.setItem('dev_demo_wrong', JSON.stringify(book));
            }
          }
          showToast('配对不正确，请重试 / Not a match','error');
        }
      }
    }

    function updateOverlay(show, text){
      const f = document.getElementById('finish');
      const t = document.getElementById('finishText');
      if(typeof text==='string') t.textContent = text;
      f.style.display = show? 'flex':'none';
    }

    // Bottom buttons
    document.getElementById('btnTip').addEventListener('click', ()=>{
      playSfx('click');
      // find one id that is still present in DOM across any column
      const idsInDOM = new Set(Array.from(document.querySelectorAll('.tile')).map(n=>Number(n.dataset.id)));
      if(!idsInDOM.size){ showToast('所有单词已匹配完成','info'); return; }
      // pick a random remaining id
      const arr = Array.from(idsInDOM); const pick = arr[Math.floor(Math.random()*arr.length)];
      // flash the correct triple
      ['cn','py','tr'].forEach(k=>{
        const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${pick}"]`);
        if(node){
          node.classList.add('selected');
          node.style.boxShadow = `0 0 18px var(--tileC)`;
          setTimeout(()=>{ node.classList.remove('selected'); node.style.boxShadow=''; }, 1000);
        }
      });
      showToast('已为你高亮一个正确组合','success');
    });
    document.getElementById('btnShuffle').addEventListener('click', ()=>{
      playSfx('shuffle'); ['cn','py','tr'].forEach(k=>{ state.tiles[k]=state.tiles[k].sort(()=>Math.random()-0.5); });
      renderBoard();
    });
    document.getElementById('btnSave').addEventListener('click', ()=>{
      localStorage.setItem('dev_demo_wrong', JSON.stringify(state.wrongBook));
      localStorage.setItem('dev_demo_passed', state.passed);
      playSfx('click'); showToast('进度已保存 / Progress saved','success');
    });
    document.getElementById('btnBack').addEventListener('click', ()=>{ endAnyDemo();
      playSfx('click');
      document.getElementById('gameDemo').style.display='none';
      stage.style.display='block';
    });

    document.getElementById('btnPrev').addEventListener('click', ()=>{
      if(state.level>1){ state.level--; }
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
    });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      state.level++;
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
      if(!state.usingTrial && state.level>4){ showToast('内置试玩仅 4 关，共 20 个词。','info'); }
    });

    document.getElementById('jumpGo').addEventListener('click', ()=>{
      const v = parseInt(document.getElementById('jumpInput').value||'1',10);
      state.level = Math.max(1, Math.min(4, v)); // bound to 1..4 for built-in demo
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
    });

    // Wrong book
    const wrongPad = document.getElementById('wrongPad');
    document.getElementById('btnWrong').addEventListener('click', ()=>{ renderWrong(); wrongPad.style.display='block'; requestAnimationFrame(()=> wrongPad.classList.add('show')); });
    document.getElementById('wrongClose').addEventListener('click', ()=>{ wrongPad.classList.remove('show'); setTimeout(()=> wrongPad.style.display='none', 200); });
    document.getElementById('wrongClear').addEventListener('click', ()=>{ state.wrongBook=[]; localStorage.setItem('dev_demo_wrong','[]'); renderWrong(); });

    function renderWrong(){
      const list = document.getElementById('wrongList');
      list.innerHTML = '';
      if(!state.wrongBook.length){
        list.innerHTML = '<div class="witem">暂无记录 / Empty</div>';
        return;
      }
      state.wrongBook.slice().reverse().forEach((it)=>{
        const d = document.createElement('div');
        d.className = 'witem';
        d.textContent = `${it.cn} ｜ ${it.py} ｜ ${it.tr}`;
        list.appendChild(d);
      });
    }
  </script>

<script>
// 【1】发展汉语词汇按钮顺序调整
(function(){
  function reorderDevCnButtons(){
    const container = document.querySelector('#stage .stage-actions');
    const demo = document.getElementById('actDemo');
    const start = document.getElementById('actStart');
    const imp = document.getElementById('actImport');
    if(!container || !demo || !start || !imp) return;
    container.innerHTML = '';
    container.appendChild(demo);
    container.appendChild(start);
    container.appendChild(imp);
  }
  const oldOpen = window.openModule;
  if(typeof oldOpen === 'function'){
    window.openModule = function(key, cn, en){
      const r = oldOpen.apply(this, arguments);
      if(key === 'dev-cn') reorderDevCnButtons();
      return r;
    }
  }
})();
</script>

<script>
// 【2】“开始游戏”→级别选择页 返回上一级
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('levelsClose');
  if(btn){
    btn.textContent = '返回上一级 / Back';
    btn.onclick = (e)=>{
      e.preventDefault();
      if(typeof showSection === 'function') showSection('stage');
    };
  }
});
</script>

<script>
// 【3】正式游戏页 “返回上一级” → 回到课段选择
document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('btnBack');
  if(b){
    b.onclick = (e)=>{
      e.preventDefault();
      if(typeof showSection === 'function') showSection('lessonsPanel');
    };
  }
});
</script>


<script>
(function(){
  try {
    if (typeof console !== 'undefined') {
      console.log = function(){};
      console.debug = function(){};
    }
  } catch (e) {}
})();
</script>


<script>
(function(){
  function __buildLessonsFor(level){
    var panel = document.getElementById('lessonsPanel');
    if(!panel) return;
    var grid = panel.querySelector('.lessons-grid-10');
    if(!grid) return;
    var titleDiv = panel.querySelector('.levels-header div[style*="font-weight"]');
    function setTitle(txt){ if(titleDiv) titleDiv.textContent = txt; }

    if(level === 'beg1'){
      setTitle('初级1 · 请选择课段 / Elementary 1 · Choose Lessons');
      return;
    }
    if(level === 'beg2'){
      setTitle('初级2 · 请选择课段 / Elementary 2 · Choose Lessons');
      grid.innerHTML = [
        '<button class="lv-btn lesson-btn" data-lesson="beg2-1-5">第1-5课<br><small>Lesson 1-5</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-6-10">第6-10课<br><small>Lesson 6-10</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-11-15">第11-15课<br><small>Lesson 11-15</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-16-20">第16-20课<br><small>Lesson 16-20</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-21-25">第21-25课<br><small>Lesson 21-25</small></button>'
      ].join('\n');
      return;
    }
    if(level === 'int1'){
      setTitle('中级1 · 请选择课段 / Intermediate 1 · Choose Lessons');
      grid.innerHTML = [
        '<button class="lv-btn lesson-btn" data-lesson="int1-1-3">第1-3课<br><small>Lesson 1-3</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-4-6">第4-6课<br><small>Lesson 4-6</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-7-9">第7-9课<br><small>Lesson 7-9</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-10-12">第10-12课<br><small>Lesson 10-12</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-13-15">第13-15课<br><small>Lesson 13-15</small></button>'
      ].join('\n');
      return;
    }
  }
  // Attach once DOM is ready
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.lv-btn[data-level]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var level = btn.getAttribute('data-level');
        var levelsPanel = document.getElementById('levelsPanel');
        var lessonsPanel = document.getElementById('lessonsPanel');
        if(!level || !levelsPanel || !lessonsPanel) return;
        levelsPanel.style.display = 'none';
        lessonsPanel.style.display = 'block';
        __buildLessonsFor(level);
      });
    });
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP2: Strict router (HSK ↔ Dev-CN isolation) === -->
<script id="hotfix-20251021-step2-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }
  function moduleKey(){ var s=$id('stage'); return (s&&s.dataset&&s.dataset.key)||''; }
  function isHSK(){ return moduleKey()==='hsk'; }

  // ---------- Ensure Step1 overlay exists (reuse if present) ----------
  function ensureOverlay(){
    var ov=$id('hskOverlay');
    if(ov) return ov;
    // build minimal overlay if step1 not present
    ov=document.createElement('div'); ov.id='hskOverlay'; ov.style.cssText='position:fixed;inset:0;background:rgba(2,8,23,.84);display:none;z-index:9999;backdrop-filter:blur(4px)';
    ov.innerHTML = ''
      + '<div class="panel" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1024px,92vw);padding:24px;border-radius:18px;background:linear-gradient(180deg,#f4f7fb,#e9eef6);box-shadow:0 20px 60px rgba(0,0,0,.35)">'
      + '  <div class="head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'
      + '    <div class="title" style="font-weight:900;font-size:20px">请选择HSK级别 / Choose HSK Level</div>'
      + '    <button class="mini" id="hskOvClose" style="border:0;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer">返回 / Back</button>'
      + '  </div>'
      + '  <div class="grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px">'
      + '    <button class="btn" data-hsk="1" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#f5fbff,#eaf2ff)">HSK 1</button>'
      + '    <button class="btn" data-hsk="2" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#fff7ea,#ffe9cc)">HSK 2</button>'
      + '    <button class="btn" data-hsk="3" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#effff3,#dbffe7)">HSK 3</button>'
      + '    <button class="btn" data-hsk="4" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#f7efff,#e9dbff)">HSK 4</button>'
      + '    <button class="btn" data-hsk="5" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#fff0f2,#ffd8df)">HSK 5</button>'
      + '    <button class="btn" data-hsk="6" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#edf6ff,#d8ebff)">HSK 6</button>'
      + '  </div>'
      + '</div>';
    (document.body||document.documentElement).appendChild(ov);
    ov.querySelector('#hskOvClose').addEventListener('click', function(){ ov.style.display='none'; }, true);

    var HSK_URLS = {
      "1":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt",
      "2":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK2-multilingual.txt",
      "3":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK3-multilingual.txt",
      "4":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK4_multilingual.txt"
    };
    ov.addEventListener('click', function(e){
      var b=e.target.closest('.btn'); if(!b) return;
      var lv=b.getAttribute('data-hsk');
      if(lv==='5'||lv==='6'){ toast('正在准备中… / Coming soon…','info'); return; }
      var url=HSK_URLS[lv];
      if(!url){ toast('未配置的级别：HSK'+lv,'error'); return; }
      window.__ctx='hsk';
      window.__lastGameContext='hsk';
      if(typeof window.startFromExternal==='function'){ window.startFromExternal(url); }
      else{
        (async function(u){
          try{
            toast('正在加载词库… / Loading word bank…','info');
            var r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
            var text=await r.text();
            if(typeof window.parseTrial!=='function'||typeof window.mapParsedToTarget!=='function')
              throw new Error('parseTrial/mapParsedToTarget missing');
            var parsed=window.parseTrial(text);
            var patched=window.mapParsedToTarget(parsed||[]);
            window.store=window.store||{}; window.store.trial=patched;
            if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
            else{ var st=$id('stage'), gd=$id('gameDemo'); if(st) st.style.display='none'; if(gd) gd.style.display='block'; if(typeof window.initDemo==='function'){ window.initDemo(true); } }
            ov.style.display='none';
            toast('HSK 已开始。','success');
          }catch(err){ console.error(err); toast('加载失败：'+(err.message||err),'error'); }
        })(url);
      }
    }, true);

    return ov;
  }
  function openOverlay(){ var ov=ensureOverlay(); ov.style.display='block'; }

  // ---------- Context tracking ----------
  document.addEventListener('DOMContentLoaded', function(){
    // When user interacts with Dev-CN panels, mark context
    var levels=$id('levelsPanel');
    if(levels){
      levels.addEventListener('click', function(e){
        var btn=e.target.closest('.lv-btn'); if(!btn) return;
        if(moduleKey()==='dev-cn'){ window.__ctx='dev-cn'; }
      }, true);
    }
    var lessons=$id('lessonsPanel');
    if(lessons){
      lessons.addEventListener('click', function(e){
        var btn=e.target.closest('.lesson-btn'); if(!btn) return;
        if(moduleKey()==='dev-cn'){ window.__ctx='dev-cn'; window.__lastGameContext='dev-cn'; }
      }, true);
    }

    // Start in HSK: open overlay and mark context
    document.addEventListener('click', function(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      if(isHSK()){
        e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        window.__ctx='hsk'; openOverlay();
      }
    }, true);

    // Back button: route according to context
    document.addEventListener('click', function(e){
      var back=e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__lastGameContext==='hsk' || window.__ctx==='hsk'){
        e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        openOverlay(); return;
      }
      if(window.__lastGameContext==='dev-cn' || window.__ctx==='dev-cn'){
        // let original handlers return to Dev-CN lessons/levels; do not cross to HSK
        window.__ctx='dev-cn';
      }
    }, true);
  });

  // ---------- Guard showSection to prevent cross-module jumps ----------
  (function(){
    var prev = window.showSection;
    window.showSection = function(id){
      try{
        if(window.__ctx==='hsk' && (id==='levelsPanel' || id==='lessonsPanel')){
          // Prevent entering Dev-CN panels while in HSK context
          openOverlay(); return;
        }
        if(window.__ctx==='dev-cn' && (id==='hskPanel' || id==='hskOverlay')){
          // Prevent entering HSK panels while in Dev-CN context
          id = (id==='hskPanel' || id==='hskOverlay') ? 'levelsPanel' : id;
        }
      }catch(_){}
      if(typeof prev==='function'){ return prev(id); }
      // fallback: show the requested panel
      var el=$id(id); if(el){ el.style.display='block'; }
    };
  })();
})();
</script>

<!-- === Hotfix 2025-10-21 STEP3: Wire HSK1 to game engine with robust starter === -->
<script id="hotfix-20251021-step3-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";

  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  async function startHSK1(){
    window.__ctx = 'hsk';
    window.__lastGameContext = 'hsk';
    // Try a set of known engine entry points
    try{
      if(typeof window.startFromExternal === 'function'){
        window.startFromExternal(HSK1_URL); return;
      }
      if(typeof window.startHSKDemo === 'function'){
        // try with URL, fall back to no-arg
        try{ window.startHSKDemo(HSK1_URL); return; }catch(_){ window.startHSKDemo(); return; }
      }
      if(typeof window.loadWordBankAndStart === 'function'){
        window.loadWordBankAndStart(HSK1_URL); return;
      }
      if(typeof window.startDemoFromExternal === 'function'){
        window.startDemoFromExternal(HSK1_URL); return;
      }
    }catch(err){
      console.warn('Primary engine calls failed, trying fallback...', err);
    }

    // Fallback: fetch + parseTrial/mapParsedToTarget + resetAndStartFromTrial
    try{
      toast('正在加载HSK1词库… / Loading HSK1…','info');
      var resp = await fetch(HSK1_URL, {cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      var text = await resp.text();

      if(typeof window.parseTrial === 'function' && typeof window.mapParsedToTarget === 'function'){
        var parsed = window.parseTrial(text);
        var patched = window.mapParsedToTarget(parsed||[]);
        window.store = window.store || {};
        window.store.trial = patched;
        if(typeof window.resetAndStartFromTrial === 'function'){
          window.resetAndStartFromTrial();
        }else{
          var st=$id('stage'), gd=$id('gameDemo');
          if(st) st.style.display='none';
          if(gd) gd.style.display='block';
          if(typeof window.initDemo === 'function'){ window.initDemo(true); }
        }
        toast('HSK1 已启动','success');
        return;
      }else{
        toast('缺少解析函数 parseTrial/mapParsedToTarget；请在源码中暴露该函数或告诉我函数名以便接入。','error');
      }
    }catch(err){
      console.error(err);
      toast('HSK1 加载失败：'+(err.message||err),'error');
    }
  }

  // Wire both the overlay and (if present) the hskPanel buttons for HSK1
  document.addEventListener('DOMContentLoaded', function(){
    function handler(e){
      var el = e.target.closest('[data-hsk="1"]');
      if(!el) return;
      // limit to HSK UIs
      var inOverlay = el.closest('#hskOverlay');
      var inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault();
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      e.stopPropagation();
      // hide overlay if visible
      var ov = $id('hskOverlay'); if(ov) ov.style.display='none';
      startHSK1();
    }
    document.addEventListener('click', handler, true);
    document.addEventListener('touchend', handler, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP4: HSK1 full import (no 20-cap) + back-loop fix === -->
<script id="hotfix-20251021-step4-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // 1) Provide a generic startFromExternal if missing, so we always use unlimited loader
  if(typeof window.startFromExternal !== 'function'){
    window.startFromExternal = async function(url){
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        toast('正在加载词库… / Loading word bank…','info');
        var resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        var text = await resp.text();
        if(typeof window.parseTrial!=='function' || typeof window.mapParsedToTarget!=='function')
          throw new Error('缺少解析函数 parseTrial/mapParsedToTarget');
        var parsed = window.parseTrial(text);
        var patched = window.mapParsedToTarget(parsed||[]);
        window.store = window.store || {};
        window.store.trial = patched;              // <-- full list, no slicing
        if(typeof window.resetAndStartFromTrial==='function'){
          window.resetAndStartFromTrial();        // engine will page by N across full list
        }else{
          var st=$id('stage'), gd=$id('gameDemo');
          if(st) st.style.display='none';
          if(gd) gd.style.display='block';
          if(typeof window.initDemo==='function'){ window.initDemo(true); }
        }
        toast('词库已加载（'+(patched.length||parsed.length)+' 项）','success');
      }catch(err){
        console.error(err); toast('加载失败：'+(err.message||err),'error');
      }
    };
  }

  // 2) Override our Step3 startHSK1 to NEVER call startHSKDemo（那个函数有20条上限）
  (function(){
    var oldAdd = document.addEventListener;
    // Replace the global click handler for [data-hsk="1"] with a dedicated one
    document.removeEventListener && document.removeEventListener('click', window.__step3HSK1Handler || function(){}, true);
    function handler(e){
      var el = e.target.closest('[data-hsk="1"]');
      if(!el) return;
      var inOverlay = el.closest('#hskOverlay'), inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
      // Always use startFromExternal (our robust one above or the app's own)
      if(typeof window.startFromExternal==='function'){ window.startFromExternal(HSK1_URL); }
    }
    document.addEventListener('click', handler, true);
    window.__step3HSK1Handler = handler;
  })();

  // 3) Optional: if a demo builder exists and slices to 20, replace it with an unlimited one
  if(typeof window.buildHSKDemoData === 'function'){
    try{
      var original = window.buildHSKDemoData;
      window.buildHSKDemoData = function(){
        try{
          var HSK_TXT = window.HSK_TXT || '';
          const rows = String(HSK_TXT).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          if(!rows.length) return [];
          const header = rows[0].split(/[,	]/).map(s=>s.trim().toLowerCase());
          const hasHeader = header.some(h=>/中文|汉字|cn|拼音|pinyin|英语|english|en/.test(h));
          const lines = hasHeader ? rows.slice(1) : rows;
          const out = [];
          for(const line of lines){ // <-- no .slice(0,20)
            const p = line.split(/[,	]/).map(s=>s.trim());
            const cn = p[0]||''; const py = p[1]||''; const en = p[2]||'';
            const th = p[3]||en, vi=p[4]||en, lo=p[5]||en, fr=p[6]||en, ja=p[7]||en, ko=p[8]||en, ru=p[9]||en, de=p[10]||en, es=p[11]||en;
            if(cn && py && en){ out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]); }
          }
          return out;
        }catch(_){
          return original(); // fallback to original if anything goes wrong
        }
      };
    }catch(_){}
  }

  // 4) Fix back-loop: when showing HSK menu, clear lastGameContext so another back won't reopen game
  function showHSKMenu(){
    var ov=$id('hskOverlay');
    if(ov){ ov.style.display='block'; }
    window.__ctx='hsk';
    window.__lastGameContext=null; // prevent back-loop
  }

  document.addEventListener('DOMContentLoaded', function(){
    // ensure overlay close buttons clear lastGameContext and don't bubble
    document.addEventListener('click', function(e){
      var close = e.target.closest('#hskOvClose,#hskBack');
      if(!close) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      showHSKMenu();
    }, true);

    // global back handler: if in HSK flow, return to menu and clear context to break loops
    document.addEventListener('click', function(e){
      var back = e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__ctx==='hsk' || window.__lastGameContext==='hsk'){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        showHSKMenu();
      }
    }, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP4b: Remove parseTrial dependency; unlimited via startHSKDemo === -->
<script id="hotfix-20251021-step4b-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  function parseHSK(text){
    var rows = String(text).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!rows.length) return [];
    var sep = /\t/.test(rows[0]) ? '\t' : ',';
    var header = rows[0].split(sep).map(s=>s.trim().toLowerCase());
    var hasHeader = header.some(h=>/中文|汉字|chinese|cn|拼音|pinyin|英语|english|en/.test(h));
    var lines = hasHeader ? rows.slice(1) : rows;
    var out = [];
    for (var i=0;i<lines.length;i++){
      var cols = lines[i].split(sep).map(s=>s.trim());
      var cn = cols[0]||''; var py = cols[1]||''; var en = cols[2]||'';
      var th=cols[3]||en, vi=cols[4]||en, lo=cols[5]||en, fr=cols[6]||en, ja=cols[7]||en, ko=cols[8]||en, ru=cols[9]||en, de=cols[10]||en, es=cols[11]||en;
      if(cn && (py || en)){
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]); // shape used by demo builder
      }
    }
    return out;
  }

  async function robustStartFromURL(url){
    toast('正在加载词库… / Loading word bank…','info');
    var resp = await fetch(url, {cache:'no-store'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    var text = await resp.text();
    // Preferred path: startHSKDemo with our own unlimited builder
    if(typeof window.startHSKDemo === 'function'){
      window.HSK_TXT = text; // give raw text if demo uses it
      var parsed = parseHSK(text);
      window.buildHSKDemoData = function(){ return parsed; }; // unlimited
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        window.startHSKDemo(); // no cap, uses our parsed
        toast('HSK1 已启动（'+parsed.length+' 条）','success');
        return;
      }catch(err){ console.warn('startHSKDemo failed', err); }
    }
    // Fallback path: if engine supports resetAndStartFromTrial, map our data
    var parsed2 = parseHSK(text);
    window.store = window.store || {};
    window.store.trial = parsed2; // many engines accept this basic shape
    if(typeof window.resetAndStartFromTrial === 'function'){
      window.__ctx='hsk'; window.__lastGameContext='hsk';
      window.resetAndStartFromTrial();
      toast('HSK1 已启动（'+parsed2.length+' 条）','success');
      return;
    }
    // Last resort: toggle demo visibility
    var st=$id('stage'), gd=$id('gameDemo'); if(st) st.style.display='none'; if(gd) gd.style.display='block';
    if(typeof window.initDemo==='function'){ window.initDemo(true); }
    toast('HSK1 已启动（兼容模式）','success');
  }

  // Replace/define startFromExternal to use the robust starter (no parseTrial dependency)
  window.startFromExternal = function(url){
    robustStartFromURL(url).catch(function(err){
      console.error(err);
      toast('加载失败：'+(err.message||err),'error');
    });
  };
})();
</script>

<!-- === Hotfix 2025-10-21 STEP5: HSK Back fix + enable HSK2 === -->
<script id="hotfix-20251021-step5-script">
(function(){
  var HSK2_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK2-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // 1) Stop any previous auto-open of HSK panel after returning to HSK stage.
  (function guardOpenHSKPanel(){
    var _orig = window.openHSKPanel;
    window.openHSKPanel = function(){
      if(window.__hsk_no_auto_open){ return; }
      if(typeof _orig === 'function'){ return _orig(); }
      // If there's no original, fall back to showing overlay if present
      var ov=$id('hskOverlay'); if(ov){ ov.style.display='block'; }
    };
  })();

  // 2) Make Back on overlay/panel go to HSK stage and disable auto-open once.
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;          // prevent back loop
    window.__hsk_no_auto_open=true;         // block auto-open on title
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Back buttons on overlay/panel
    document.addEventListener('click', function(e){
      var back = e.target.closest('#hskOvClose,#hskBack');
      if(!back) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }, true);

    // When user clicks "Start Game" again under HSK, re-enable auto-open
    document.addEventListener('click', function(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      var s=$id('stage'); var isHSK = s && s.dataset && s.dataset.key==='hsk';
      if(isHSK){ window.__hsk_no_auto_open=false; }
    }, true);

    // 3) Wire HSK2 button to robust starter (capture-phase to override older "Next step" handlers)
    function startHSK2(e){
      var el = e.target.closest('[data-hsk="2"]'); if(!el) return;
      // limit to HSK overlay/panel UIs
      var inOverlay = el.closest('#hskOverlay'), inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      window.__ctx='hsk'; window.__lastGameContext='hsk';
      var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
      if(typeof window.startFromExternal==='function'){
        window.startFromExternal(HSK2_URL);
      }else{
        // If for some reason STEP4b wasn't injected, fallback minimal loader
        (async function(u){
          try{
            toast('正在加载HSK2… / Loading HSK2','info');
            var r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
            var t=await r.text();
            var rows=String(t).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            var sep=/\t/.test(rows[0])?'\t':',';
            var header=rows[0].split(sep).map(s=>s.trim().toLowerCase());
            var hasHeader=header.some(h=>/中文|汉字|chinese|cn|拼音|pinyin|英语|english|en/.test(h));
            var lines=hasHeader?rows.slice(1):rows;
            var parsed=[];
            for(var i=0;i<lines.length;i++){
              var c=lines[i].split(sep).map(s=>s.trim());
              var cn=c[0]||'', py=c[1]||'', en=c[2]||'';
              var th=c[3]||en, vi=c[4]||en, lo=c[5]||en, fr=c[6]||en, ja=c[7]||en, ko=c[8]||en, ru=c[9]||en, de=c[10]||en, es=c[11]||en;
              if(cn && (py||en)) parsed.push([cn,py,[en,th,vi,lo,fr,ja,ko,ru,de,es]]);
            }
            if(typeof window.startHSKDemo==='function'){
              window.HSK_TXT=t;
              window.buildHSKDemoData=function(){ return parsed; };
              window.startHSKDemo();
              toast('HSK2 已启动（'+parsed.length+' 条）','success');
            }else{
              window.store=window.store||{}; window.store.trial=parsed;
              if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
              toast('HSK2 已启动（兼容模式）','success');
            }
          }catch(err){ console.error(err); toast('加载失败：'+(err.message||err),'error'); }
        })(HSK2_URL);
      }
    }
    document.addEventListener('click', startHSK2, true);
    document.addEventListener('touchend', startHSK2, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP6: Back button fix + enable HSK3 & HSK4 (unlimited) === -->
<style id="hotfix-20251021-step6-style">
#hskOverlay, #hskPanel { z-index: 9999 !important; }
#hskOverlay button, #hskPanel button { pointer-events: auto !important; }
</style>
<script id="hotfix-20251021-step6-script">
(function(){
  var HSK3_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK3-multilingual.txt";
  var HSK4_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK4_multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // ---- Robust back from overlay/panel to HSK stage (and DO NOT auto-open again) ----
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Make the Back button always work, regardless of id used in UI (hskOvClose or hskBack)
    function backHandler(e){
      var el = e.target.closest('#hskOvClose,#hskBack');
      if(!el) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
    document.addEventListener('click', backHandler, true);
    document.addEventListener('touchend', backHandler, true);

    // When HSK Start is clicked again, allow auto-open
    function startHandler(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      var s=$id('stage'); var isHSK = s && s.dataset && s.dataset.key==='hsk';
      if(isHSK){ window.__hsk_no_auto_open=false; }
    }
    document.addEventListener('click', startHandler, true);

    // ---- Enable HSK3 and HSK4 (unlimited import like HSK1/2) ----
    async function robustStart(url){
      // Prefer previously defined robust startFromExternal (from step4b)
      if(typeof window.startFromExternal==='function'){
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
        return window.startFromExternal(url);
      }
      // Minimal fallback (if step4b not present)
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
        toast('正在加载词库…','info');
        var r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
        var t=await r.text();
        var rows=String(t).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        var sep=/\t/.test(rows[0])?'\t':',';
        var header=rows[0].split(sep).map(s=>s.trim().toLowerCase());
        var hasHeader=header.some(h=>/中文|汉字|chinese|cn|拼音|pinyin|英语|english|en/.test(h));
        var lines=hasHeader?rows.slice(1):rows;
        var parsed=[];
        for(var i=0;i<lines.length;i++){
          var c=lines[i].split(sep).map(s=>s.trim());
          var cn=c[0]||'', py=c[1]||'', en=c[2]||'';
          var th=c[3]||en, vi=c[4]||en, lo=c[5]||en, fr=c[6]||en, ja=c[7]||en, ko=c[8]||en, ru=c[9]||en, de=c[10]||en, es=c[11]||en;
          if(cn && (py||en)) parsed.push([cn,py,[en,th,vi,lo,fr,ja,ko,ru,de,es]]);
        }
        if(typeof window.startHSKDemo==='function'){
          window.HSK_TXT=t;
          window.buildHSKDemoData=function(){ return parsed; };
          window.startHSKDemo();
          toast('已启动（'+parsed.length+' 条）','success');
        }else{
          window.store=window.store||{}; window.store.trial=parsed;
          if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
          toast('已启动（兼容模式）','success');
        }
      }catch(err){ console.error(err); toast('加载失败：'+(err.message||err),'error'); }
    }

    function hsk34Handler(e){
      var btn3 = e.target.closest('[data-hsk="3"]');
      var btn4 = e.target.closest('[data-hsk="4"]');
      if(!btn3 && !btn4) return;
      // limit to overlay/panel only
      var scope = (btn3||btn4).closest('#hskOverlay,#hskPanel'); if(!scope) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      robustStart(btn3 ? HSK3_URL : HSK4_URL);
    }

    document.addEventListener('click', hsk34Handler, true);
    document.addEventListener('touchend', hsk34Handler, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP7: Back button hardening (text match) + outside click + ESC === -->
<style id="hotfix-20251021-step7-style">
#hskOverlay, #hskPanel { z-index: 99999 !important; }
#hskOverlay, #hskPanel { pointer-events: auto !important; }
#hskOverlay .panel { pointer-events: auto !important; }
</style>
<script id="hotfix-20251021-step7-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function isVisible(el){ if(!el) return false; var cs=getComputedStyle(el); return cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0'; }

  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Back by id (original buttons)
    function backById(e){
      var el = e.target.closest('#hskOvClose,#hskBack');
      if(!el) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
    document.addEventListener('click', backById, true);
    document.addEventListener('touchend', backById, true);

    // 2) Back by text (in case id/class changed)
    function backByText(e){
      var btn = e.target.closest('#hskOverlay button, #hskPanel button');
      if(!btn) return;
      var label = (btn.innerText || btn.textContent || '').replace(/\s+/g,' ').trim();
      if(/^(返回|Back)\b/i.test(label)){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', backByText, true);

    // 3) Click outside panel to go back
    function outsideClick(e){
      var ov=$id('hskOverlay'); if(!ov || !isVisible(ov)) return;
      if(e.target === ov){ // clicked on the dim backdrop
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', outsideClick, true);

    // 4) ESC to go back
    document.addEventListener('keydown', function(e){
      if(e.key !== 'Escape') return;
      var ov=$id('hskOverlay'); var pn=$id('hskPanel');
      if(isVisible(ov) || isVisible(pn)){
        e.preventDefault(); e.stopPropagation();
        gotoHSKStage();
      }
    }, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP8: Ultra-robust HSK Back === -->
<style id="hotfix-20251021-step8-style">
#hskOverlay, #hskPanel { z-index: 2147483647 !important; pointer-events:auto !important; }
#hskOverlay .panel, #hskPanel .levels-header { pointer-events:auto !important; }
#hskBack, #hskOvClose { pointer-events:auto !important; cursor:pointer !important; }
</style>
<script id="hotfix-20251021-step8-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function isVisible(el){ if(!el) return false; var cs=getComputedStyle(el); return cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0'; }
  function text(el){ return (el && (el.innerText||el.textContent)||'').replace(/\s+/g,' ').trim(); }
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  function bindBack(btn){
    if(!btn || btn.__hskBackBound) return;
    btn.__hskBackBound = true;
    btn.setAttribute('tabindex','0');
    btn.setAttribute('role','button');
    btn.style.pointerEvents='auto';
    var handler = function(e){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    };
    ['click','pointerdown','mousedown','touchend','keydown'].forEach(function(t){
      btn.addEventListener(t, function(e){
        if(t==='keydown' && !(e.key==='Enter' || e.key===' ')) return;
        handler(e);
      }, true);
    });
  }

  function scanAndBind(){
    var cand = [];
    var ov=$id('hskOverlay'), pn=$id('hskPanel');
    if(ov){
      cand = cand.concat([ov.querySelector('#hskBack'), ov.querySelector('#hskOvClose')]);
      // try header end button
      var headerBtn = ov.querySelector('.head button, .levels-header button');
      if(headerBtn) cand.push(headerBtn);
      // try any button whose text matches
      Array.prototype.forEach.call(ov.querySelectorAll('button, a, div'), function(el){
        var label = text(el);
        if(/^(返回|Back)\b/i.test(label)) cand.push(el);
      });
    }
    if(pn){
      cand = cand.concat([pn.querySelector('#hskBack'), pn.querySelector('#hskOvClose')]);
      var headerBtn2 = pn.querySelector('.head button, .levels-header button');
      if(headerBtn2) cand.push(headerBtn2);
      Array.prototype.forEach.call(pn.querySelectorAll('button, a, div'), function(el){
        var label = text(el);
        if(/^(返回|Back)\b/i.test(label)) cand.push(el);
      });
    }
    cand.forEach(bindBack);
  }

  // Global capture fallback (click anywhere on a "Back" labeled control)
  function globalBackByText(e){
    var target = e.target;
    var scope = target.closest && target.closest('#hskOverlay,#hskPanel');
    if(!scope) return;
    var el = target.closest('button, a, div, span');
    if(!el) return;
    var label = text(el);
    if(/^(返回|Back)\b/i.test(label)){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    scanAndBind();
    document.addEventListener('click', globalBackByText, true);
    document.addEventListener('pointerdown', globalBackByText, true);
    document.addEventListener('touchend', globalBackByText, true);

    // Close by clicking outside panel or pressing ESC (keep from Step7)
    function outside(e){
      var ov=$id('hskOverlay'); if(!ov || !isVisible(ov)) return;
      if(e.target === ov){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', outside, true);
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
        var ov=$id('hskOverlay'); var pn=$id('hskPanel');
        if(isVisible(ov) || isVisible(pn)){
          e.preventDefault(); e.stopPropagation();
          gotoHSKStage();
        }
      }
    }, true);

    // Observe DOM changes: if overlay/panel is rebuilt, re-bind
    var mo = new MutationObserver(function(){
      scanAndBind();
    });
    mo.observe(document.body, {subtree:true, childList:true});
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP9: HSK Back 3D + Dev-CN trial return fix === -->
<style id="hotfix-20251021-step9-style">
/* 3D Back button */
.hsk-back-3d {
  --tiltX: 0deg; --tiltY: 0deg; --glowX: 50%; --glowY: 50%;
  position: relative;
  padding: 10px 14px;
  border-radius: 14px;
  font-weight: 900;
  background: linear-gradient(180deg,#fdfdfd,#efefef);
  border: 0;
  color: #111;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    inset 0 -1px 0 rgba(0,0,0,.06),
    0 10px 18px rgba(0,0,0,.18);
  transform: perspective(800px) rotateX(var(--tiltX)) rotateY(var(--tiltY)) translateZ(0);
  transition: transform .12s ease, box-shadow .2s ease;
  will-change: transform;
  cursor: pointer;
}
.hsk-back-3d::before{
  content:'';
  position:absolute; inset:-1px;
  border-radius: 14px;
  background: radial-gradient(600px 600px at var(--glowX) var(--glowY), rgba(255,255,255,.65), rgba(255,255,255,0) 40%);
  pointer-events: none;
  mix-blend-mode: screen;
  transition: opacity .12s ease;
  opacity: .6;
}
.hsk-back-3d:hover{ box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    inset 0 -1px 0 rgba(0,0,0,.06),
    0 16px 28px rgba(0,0,0,.24);
}
/* ensure clickable */
#hskBack, #hskOvClose{ pointer-events:auto !important; }
</style>
<script id="hotfix-20251021-step9-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function moduleKey(){ var s=$id('stage'); return (s && s.dataset && s.dataset.key) || ''; }

  // --- HSK Back button 3D + cursor reactive ---
  function upgradeBack3D(btn){
    if(!btn || btn.__hsk3D) return;
    btn.__hsk3D = true;
    btn.classList.add('hsk-back-3d');
    btn.addEventListener('pointermove', function(e){
      var r = btn.getBoundingClientRect();
      var x = (e.clientX - r.left) / r.width;
      var y = (e.clientY - r.top) / r.height;
      var tiltX = (0.5 - y) * 10;   // [-5, 5] deg
      var tiltY = (x - 0.5) * 12;   // [-6, 6] deg
      btn.style.setProperty('--tiltX', tiltX.toFixed(2) + 'deg');
      btn.style.setProperty('--tiltY', tiltY.toFixed(2) + 'deg');
      btn.style.setProperty('--glowX', (x*100).toFixed(1) + '%');
      btn.style.setProperty('--glowY', (y*100).toFixed(1) + '%');
    }, {passive:true});
    btn.addEventListener('pointerleave', function(){
      btn.style.setProperty('--tiltX', '0deg');
      btn.style.setProperty('--tiltY', '0deg');
      btn.style.setProperty('--glowX', '50%');
      btn.style.setProperty('--glowY', '50%');
    });
  }
  function scanBackButtons(){
    var cand = [];
    var ov=$id('hskOverlay'), pn=$id('hskPanel');
    if(ov){
      if(ov.querySelector) cand = cand.concat([ov.querySelector('#hskBack'), ov.querySelector('#hskOvClose')]);
      ov.querySelectorAll && ov.querySelectorAll('button').forEach(function(b){
        var t=(b.innerText||b.textContent||'').trim();
        if(/^返回|^Back/i.test(t)) cand.push(b);
      });
    }
    if(pn){
      if(pn.querySelector) cand = cand.concat([pn.querySelector('#hskBack'), pn.querySelector('#hskOvClose')]);
      pn.querySelectorAll && pn.querySelectorAll('button').forEach(function(b){
        var t=(b.innerText||b.textContent||'').trim();
        if(/^返回|^Back/i.test(t)) cand.push(b);
      });
    }
    cand.forEach(upgradeBack3D);
  }

  // --- Dev-CN: trial back returns to last-opened level lessons, not fixed beg1 ---
  function installDevCNGuards(){
    var levels = $id('levelsPanel');
    if(levels){
      levels.addEventListener('click', function(e){
        var btn = e.target.closest('.lv-btn'); if(!btn) return;
        if(moduleKey() === 'dev-cn'){
          window.__devcn_lastLevel = btn.getAttribute('data-level') || window.__devcn_lastLevel || 'beg1';
          window.__lastGameContext = 'dev-cn';
        }
      }, true);
    }
    var lessons = $id('lessonsPanel');
    if(lessons){
      lessons.addEventListener('click', function(e){
        var btn = e.target.closest('.lesson-btn'); if(!btn) return;
        if(moduleKey() === 'dev-cn'){
          window.__lastGameContext = 'dev-cn';
        }
      }, true);
    }

    // Back routing for Dev-CN: go to levelsPanel then auto-click last level
    function goBackDevCN(){
      try{ if(typeof window.showSection==='function'){ window.showSection('levelsPanel'); } }catch(_){}
      setTimeout(function(){
        var lv = window.__devcn_lastLevel || 'beg1';
        var panel = $id('levelsPanel');
        if(panel){
          var target = panel.querySelector('[data-level="'+lv+'"]') || panel.querySelector('[data-level="beg1"]');
          if(target && target.click) target.click();
        }
      }, 0);
    }

    document.addEventListener('click', function(e){
      var back = e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__lastGameContext === 'dev-cn'){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        goBackDevCN();
      }
    }, true);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scanBackButtons();
    var mo = new MutationObserver(scanBackButtons);
    mo.observe(document.body, {subtree:true, childList:true});

    installDevCNGuards();
  });
})();
</script>

<!-- === Fill-in-the-Blank (Fill) — Overlay + Explain Drawer + Levels === -->
<style>
  #fillDemoScreen.fill-hidden{display:none}
  #fillDemoScreen{position:fixed;inset:0;background:rgba(10,14,25,.60);z-index:9999;display:flex;flex-direction:column;padding:16px;color:#0d1b2a;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial,sans-serif}
  #fillDemoHeader{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .fill-title{font-size:20px;font-weight:700;letter-spacing:.5px;color:#0b1b3a}
  .fill-controls{display:flex;gap:8px}
  .fill-btn{border:none;padding:10px 14px;border-radius:12px;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.5),0 6px 16px rgba(0,0,0,.20);color:#0b2545;transition:transform .06s ease, box-shadow .1s ease, background .2s ease}
  .fill-btn:hover{transform:translateY(-1px)}
  .fill-area{flex:1;display:flex;align-items:flex-start;justify-content:center;position:relative}
  #fillDemoArea{width:min(1000px,92vw);min-height:420px;border-radius:16px;padding:18px;background:linear-gradient(180deg,rgba(242,248,255,.96),rgba(224,236,255,.94)),radial-gradient(900px 500px at 20% -10%, rgba(120,160,255,.18), transparent 70%);box-shadow:0 20px 50px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.65)}
  .fill-hint{font-size:16px;color:#0b1b3a;margin:0 0 28px 2px;line-height:1.5;opacity:.92}
  .fill-sentence{display:flex;flex-direction:column;gap:10px;padding:12px 14px;background:#f0f6ff;border-radius:12px;margin-bottom:14px}
  .fill-choices{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .choice-pill{padding:10px 16px;border-radius:999px;background:#dbe6ff;color:#0b2545;cursor:pointer;user-select:none;border:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.60),inset 0 -1px 0 rgba(0,0,0,.10),0 10px 24px rgba(0,0,0,.15);transition:transform .12s ease,box-shadow .12s ease,filter .15s ease;will-change:transform,box-shadow;perspective:600px;transform-style:preserve-3d;font-size:16px}
  .choice-pill:hover{filter:brightness(1.06)}
  .tile-c0{background:linear-gradient(160deg,#4b7bff,#94b0ff)}
  .tile-c1{background:linear-gradient(160deg,#8c5bff,#c5adff)}
  .tile-c2{background:linear-gradient(160deg,#2cc8c3,#8fe7e4)}
  .tile-c3{background:linear-gradient(160deg,#ff8b4f,#ffc0a3)}
  .tile-c4{background:linear-gradient(160deg,#58d24f,#a6ebb0)}
  .tile-c5{background:linear-gradient(160deg,#ff5b94,#ffb3cc)}
  .drop-slot{display:inline-block;min-width:80px;padding:8px 12px;border-radius:8px;border:2px dashed #6e8fd6;color:#0b2545;margin:0 6px;background:#fff}
  .drop-slot.filled{background:#e8fff0;border-color:#4cd36a;color:#0b3a1b;box-shadow:inset 0 2px 0 rgba(255,255,255,.70),inset 0 -2px 0 rgba(0,0,0,.10)}
  .status-line{font-size:18px;opacity:.95;color:#0b1b3a}
  /* Drawer */
  #explainPanel{position:absolute;right:120px;top:12px;width:min(52vw,676px);height:50%;display:none;flex-direction:column;background:rgba(245,249,255,.92);backdrop-filter:blur(6px);border-left:1px solid rgba(10,40,120,.12);box-shadow:-10px 0 30px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.7);z-index:3;border-radius:14px}
  #explainHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;font-weight:700;color:#0b1b3a}
  #explainBody{flex:1;padding:12px 16px;overflow:auto;white-space:pre-wrap;color:#0b2545;line-height:1.6;font-size:15px}
  #explainFooter{display:flex;gap:10px;padding:8px 10px;justify-content:space-between;align-items:center;border-top:1px solid rgba(10,40,120,.12);background:linear-gradient(180deg,rgba(235,243,255,.85),rgba(225,238,255,.85));border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .explain-buttons{display:flex;gap:10px;flex-wrap:wrap}
  .explain-btn,.explain-close{border:none;padding:10px 14px;border-radius:12px;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.5),0 6px 16px rgba(0,0,0,.18);color:#0b2545;font-weight:600;transition:transform .06s ease,box-shadow .1s ease,background .2s ease,filter .15s ease}
  .explain-btn:hover,.explain-close:hover{transform:translateY(-1px);filter:brightness(1.04)}
  .explain-btn:disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
  /* Level Selector */
  #fillLevelScreen{position:fixed;inset:0;background:rgba(10,14,25,.55);z-index:9998;display:none;align-items:center;justify-content:center}
  #fillLevelBox{width:min(900px,92vw);padding:24px;border-radius:18px;background:linear-gradient(180deg,rgba(242,248,255,.97),rgba(224,236,255,.95));box-shadow:0 18px 50px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7)}
  #fillLevelTitle{font-size:20px;font-weight:800;letter-spacing:.6px;color:#0b1b3a;margin-bottom:12px;text-align:center}
  #fillLevels{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:14px}
  .level-btn{display:flex;align-items:center;justify-content:center;padding:18px;border:none;border-radius:16px;cursor:pointer;color:#0b1b3a;font-size:18px;font-weight:800;letter-spacing:.4px;box-shadow:inset 1px 1px 0 rgba(255,255,255,.6), 0 12px 28px rgba(0,0,0,.18);transition:transform .08s ease, filter .12s ease, box-shadow .12s ease}
  .level-btn:hover{transform:translateY(-2px);filter:brightness(1.05)}
  #L1{background:linear-gradient(160deg,#7ed957,#c8ffb4)}
  #L2{background:linear-gradient(160deg,#58c7ff,#b8e8ff)}
  #L3{background:linear-gradient(160deg,#a78bfa,#d7c6ff)}
  #L4{background:linear-gradient(160deg,#ff8fab,#ffd0db)}
  .level-btn.lv-disabled{opacity:.45;filter:grayscale(.3);pointer-events:auto}
  .level-btn.lv-disabled:after{content:' 未开放'; font-size:12px; margin-left:6px; opacity:.8}
  #fillLevelClose{margin-top:14px;display:block;margin-left:auto;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);color:#0b2545}
</style>

<div id="fillDemoScreen" class="fill-hidden" role="dialog" aria-modal="true">
  <div id="fillDemoHeader">
    <div class="fill-title">选词填空 · 试玩 DEMO</div>
    <div class="fill-controls">
      <button id="fillPrevBtn" class="fill-btn">上一题 / Prev</button>
      <button id="fillNextBtn" class="fill-btn">下一题 / Next</button>
      <button id="fillCloseBtn" class="fill-btn">返回 / Back</button>
      <button id="fillSaveBtn" class="fill-btn" style="margin-left:8px;display:none;">保存 / Save</button>
      <span id="fillProgress" style="margin-left:8px;font-weight:700;color:#0b1b3a;display:none;"></span>
      <button id="fillJumpBtn" class="fill-btn" style="margin-left:8px;display:none;">跳转 / Jump</button>
    </div>
  </div>
  <div class="fill-area">
    <div id="fillJumpPanel" style="position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px"></div>
    <div id="fillDemoArea"></div>
    <div id="explainPanel">
      <div id="explainHeader">
        <div>答案解析 · Explanation</div>
        <div style="opacity:.7;font-size:12px">中文 / English / Français / ไทย / Русский / ລາວ</div>
      </div>
      <div id="explainBody">（本题答对后可选择语言显示解析）</div>
      <div id="explainFooter">
        <div class="explain-buttons">
          <button class="explain-btn" data-lang="zh">中文</button>
          <button class="explain-btn" data-lang="en">English</button>
          <button class="explain-btn" data-lang="fr">Français</button>
          <button class="explain-btn" data-lang="th">ไทย</button>
          <button class="explain-btn" data-lang="ru">Русский</button>
          <button class="explain-btn" data-lang="lo">ລາວ</button>
        </div>
        <button class="explain-close">关闭</button>
      </div>
    </div>
  </div>
</div>

<div id="fillLevelScreen">
  <div id="fillLevelBox">
    <div id="fillLevelTitle">选词填空 · 开始游戏 / Start Game</div>
    <div id="fillLevels">
      <button id="L1" class="level-btn">Level 1</button>
      <button id="L2" class="level-btn">Level 2</button>
      <button id="L3" class="level-btn">Level 3</button>
      <button id="L4" class="level-btn">Level 4</button>
    </div>
    <button id="fillLevelClose">关闭 Close</button>
  </div>
</div>

<script>
// ===== Parsing core =====

function parseFillDemoText(text) {
  const out = [];
  const cleaned = (text||'')
    .replace(/^\uFEFF/, '')
    .replace(/\r\n/g, '\n');

  // Split blocks by multiple possible heading styles:
  // "第1题", "【第1题】", "[第1题]", "题1", "Q1"
  const trySplitters = [
    /(?=^第\s*\d+\s*题)/m,
    /(?=^[【\[]?\s*第\s*\d+\s*题\s*[】\]])/m,
    /(?=^题\s*\d+)/m,
    /(?=^Q\s*\d+)/mi
  ];

  let blocks = [];
  for (const re of trySplitters){
    blocks = cleaned.split(re).filter(b => b && b.trim());
    if (blocks.length) break;
  }
  if (!blocks.length) {
    // last resort: split by two or more blank lines, hope each block starts with choices
    blocks = cleaned.split(/\n{2,}(?=\S)/m).filter(b => b.trim());
  }

  for (const b of blocks) {
    const lines = b.trim().split('\n').map(s=>s.trim());
    if (lines.length < 3) continue;
    const choices = (lines[1] || '').split(/\s+/).filter(Boolean);
    const subs = [];
    for (let i=2;i<lines.length;i++) {
      const cur = lines[i];
      if (!cur) continue;
      if (/^(答案解析（|\[?句\s*\d+\]?|技巧[:：])/.test(cur)) break;
      if (/正确答案[:：]/.test(cur)) {
        const ans = cur.split(/正确答案[:：]\s*/)[1]?.trim();
        if (ans && subs.length>0 && !subs[subs.length-1].answer) subs[subs.length-1].answer = ans;
        continue;
      }
      const m = cur.match(/^(?:\[?句\s*(\d+)\]?|句\s*(\d+)|\((\d+)\)|（(\d+)）)?\s*(.*)$/);
      if (!m) continue;
      const sentence = m[5] || cur;
      subs.push({ sentence, answer: '' });
    }
    // If the last line contains a combined answers line
    const ansLine = lines.find(l=>/^正确答案[:：]/.test(l));
    if (ansLine) {
      const ans = ansLine.split(/正确答案[:：]\s*/)[1] || '';
      const arr = ans.split(/\s+/).filter(Boolean);
      arr.forEach((a,i)=> { if (subs[i] && !subs[i].answer) subs[i].answer = a; });
    }
    out.push({ choices, subQuestions: subs });
  }
  return out;
}
let ExplainData = []; // will set on start

// ---- Fill Demo (global) ----
window.FillDemo = (() => {
  let questions = [];
  let idx = 0;
  function syncState(){ window.__FILL_IDX__ = idx; window.__FILL_TOTAL__ = (questions?questions.length:0); if (typeof window.updateProgressUI==='function') window.updateProgressUI(); }

  function enableTileFX(el){
    function onMove(e){ const r = el.getBoundingClientRect(); const px = (e.clientX - r.left)/r.width - 0.5; const py = (e.clientY - r.top)/r.height - 0.5; const rx = (-py*12).toFixed(2); const ry = (px*14).toFixed(2); el.style.transform = 'translateY(-2px) rotateX(' + rx + 'deg) rotateY(' + ry + 'deg)'; el.style.boxShadow = '0 18px 30px rgba(0,0,0,0.18)'; }
    function reset(){ el.style.transform = ''; el.style.boxShadow = '0 10px 24px rgba(0,0,0,0.15)'; }
    el.addEventListener('mousemove', onMove); el.addEventListener('mouseleave', reset);
  }

  function show() { document.getElementById('fillDemoScreen').classList.remove('fill-hidden'); }
  function hide() { document.getElementById('fillDemoScreen').classList.add('fill-hidden'); }

  function checkAllFilled(container){ const slots = Array.from(container.querySelectorAll('.fill-sentence .drop-slot')); return slots.length>0 && slots.every(s => s.classList.contains('filled')); }

  function render() { syncState();
    const area = document.getElementById('fillDemoArea'); area.innerHTML = '';
    const hint = document.createElement('div'); hint.className = 'fill-hint'; hint.innerHTML = '请将正确的单词点击后填入句子空格中<br><span style="opacity:.85">Click the correct word to fill in the blank.</span>'; area.appendChild(hint);
    if (idx >= questions.length) { area.innerHTML += '<div style="text-align:center;padding:40px">所有试玩题目完成！</div>'; return; }
    const q = questions[idx];
    q.subQuestions.forEach((sub, sIdx) => {
      const box = document.createElement('div'); box.className = 'fill-sentence';
      const sentence = sub.sentence.replace(/[（(]([^）)]+)[）)]/, '<span class="drop-slot"></span>');
      const sLine = document.createElement('div'); sLine.className = 'status-line'; sLine.innerHTML = sentence;
      const slotInit = sLine.querySelector('.drop-slot'); if (slotInit) { slotInit.dataset.ans = (sub.answer || '').trim(); }
      box.appendChild(sLine);
      const row = document.createElement('div'); row.className = 'fill-choices';
      q.choices.forEach((word, i) => { const pill = document.createElement('span'); pill.className = 'choice-pill tile-c' + (i % 6); pill.textContent = word; enableTileFX(pill);
        pill.addEventListener('click', () => { const slot = box.querySelector('.drop-slot:not(.filled)'); if (!slot) return; const target = (slot.dataset.ans || '').trim(); const chosen = (word || '').trim(); if (chosen === target) { slot.textContent = word; slot.classList.add('filled'); if (checkAllFilled(area)) showExplainPanelFor(idx+1); } else { sLine.style.animation = 'shake .15s linear 1'; setTimeout(()=> sLine.style.animation = '', 160); } });
        row.appendChild(pill); });
      box.appendChild(row); area.appendChild(box);
    });
  }

  function startDemo(textOpt) {
    try {
      const sourceText = (typeof textOpt==='string' && textOpt.trim()) ? textOpt : (window.__FILL_OVERRIDE__ || '');
      if (!sourceText) { alert('未找到题库数据'); return; }
      // refresh explanations from the same source
      try { window.__FILL_EXPLAINS__ = sourceText; ExplainData = parseExplainBlocks(sourceText); } catch(e){ console.warn('Explain parse fail', e); }
      questions = parseFillDemoText(sourceText);
      if (!questions || !questions.length) {
        console.warn('Fill Demo parse returned 0 questions.');
        alert('未识别到题目，请检查题库格式是否含有“第1题 / 题1 / Q1”等题头。');
        return;
      }
      idx = 0; syncState(); show(); render();
    } catch (e) { console.error(e); alert('选词填空试玩初始化失败'); }
  }
  function next() { if (idx < questions.length - 1) { idx++; syncState(); render(); } }
  function prev() { if (idx > 0) { idx--; syncState(); render(); } }
  function back() { hide(); }

  window.addEventListener('DOMContentLoaded', () => { const prevBtn = document.getElementById('fillPrevBtn'); const nextBtn = document.getElementById('fillNextBtn'); const closeBtn = document.getElementById('fillCloseBtn'); if (prevBtn) prevBtn.addEventListener('click', prev); if (nextBtn) nextBtn.addEventListener('click', next); if (closeBtn) closeBtn.addEventListener('click', back); });

  function goto(i){ if (!questions) return; i=Math.max(0,Math.min(i,questions.length-1)); idx=i; syncState(); render(); }
  return { startDemo, next, prev, back, render, goto };
})();

function ensureExplainData() { return ExplainData || []; }
function showExplainPanelFor(questionIndex) {
  const panel = document.getElementById('explainPanel');
  const body  = document.getElementById('explainBody');
  const area = document.getElementById('fillDemoArea');
  const first = area && area.querySelector('.fill-sentence');
  if (first) panel.style.top = (first.offsetTop + 8) + 'px';
  panel.style.display = 'flex';

  const dataAll = ensureExplainData();
  const data = dataAll[questionIndex] || {};
  function md2html(s){
    if(!s) return '';
    const esc = String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return esc.replace(/\*\*([\s\S]+?)\*\*/g,'<strong>$1</strong>');
  }
  const setText = (txt) => { body.innerHTML = md2html((txt && txt.trim()) ? txt : '（该语言暂无解析）'); };

  const btns = panel.querySelectorAll('.explain-btn');
  btns.forEach(btn => {
    const lang = btn.dataset.lang;
    const has  = data && data[lang] && data[lang].trim().length > 0;
    btn.disabled = !has;
    btn.onclick = () => setText(data[lang] || '');
  });

  const defaultLang = (data.zh && 'zh') || (data.en && 'en') || (data.th && 'th') || (data.ru && 'ru') || (data.lo && 'lo') || null;
  if (defaultLang) { body.textContent = data[defaultLang]; } else { body.textContent = '（该题暂无解析）'; }

  panel.querySelector('.explain-close').onclick = () => { panel.style.display = 'none'; };
}

// ---- Level selector logic ----
window.FillLevel = (function(){
  const scr = () => document.getElementById('fillLevelScreen');
  function open(){ scr().style.display='flex'; }
  function close(){ scr().style.display='none'; }
  async function start(levelKey){
    if (levelKey === 'L1'){
      const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') {
          window.FillDemo.startDemo(text);
        } else if (window.startFillDemo) {
          window.__FILL_OVERRIDE__ = text; window.startFillDemo();
        }
        close();
        if (typeof showToast==='function') showToast('Level 1 数据已载入', 'success');
      }catch(e){
        console.error(e);
        alert('Level 1 题库加载失败，请稍后再试。');
      }
      return;
    }
    if (typeof showToast === 'function') showToast('Level 2/3/4 暂未开放', 'info');
  }
  window.addEventListener('DOMContentLoaded', () => {
    ['L1','L2','L3','L4'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', () => start(id));
      if (id !== 'L1') { el.classList.add('lv-disabled'); el.setAttribute('aria-disabled','true'); }
    });
    const closeBtn = document.getElementById('fillLevelClose');
    if (closeBtn) closeBtn.addEventListener('click', close);
  });
  return { open, close, start };
})();

// ---- Safe starter ----
window.startFillDemo = function(){
  if (window.FillDemo && window.FillDemo.startDemo){
    // If there is default embedded dataset, you could set window.__FILL_OVERRIDE__ before calling this.
    if (!window.__FILL_OVERRIDE__){
      // fallback to Level1 loader
      (async function(){try{const r=await fetch('https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%A1%AB%E7%A9%BA%E8%AF%95%E7%8E%A9-%E8%AF%95%E9%A2%98%E5%AF%BC%E5%85%A5%E6%A8%A1%E6%9D%BF-%E5%B8%A6%E8%A7%A3%E6%9E%90.txt'); if(r.ok){ const t=await r.text(); window.__FILL_OVERRIDE__=t; window.FillDemo&&window.FillDemo.startDemo&&window.FillDemo.startDemo(t); return; } }catch(_e){ console.warn('Demo FR fetch failed, fallback to Level1', _e); } window.FillLevel && window.FillLevel.start && window.FillLevel.start('L1'); })();
      return;
    }
    window.FillDemo.startDemo(window.__FILL_OVERRIDE__);
  }
};
</script>
<!-- === End Fill-in-the-Blank (Fill) === -->


<!-- ==== Fill module: overrides & UI enhancements ==== -->
<script>
(function(){
  // 1) Embedded DEMO dataset (3 questions)
  if (!window.__EMBEDDED_FILL__) {
    window.__EMBEDDED_FILL__ = `第1题
旁边 里面 上面

句子1. 钥匙就在桌子 (    )，你没看到吗？ 
正确答案: 上面

句子2. 我的宿舍在学校食堂 (   )，吃饭很方便。
正确答案: 旁边

句子3.我把新买的羽绒服放进了衣柜 (    )。 
正确答案: 里面

答案解析（中文）
[句1] 桌子是平面，东西放在表面→选上面。
[句2] 宿舍和食堂只是挨着，不在对方里→选旁边。
[句3] 有“放进/进到”，说明进入容器内部→选里面。
技巧：看关键词——“平面→上”，“相邻→旁边”，“进/入→里”。

答案解析（英文）
[S1] A table is a flat surface; things sit on the surface → choose 上面 (“on top”).
[S2] The dorm and the cafeteria are next to each other, not one inside the other → choose 旁边 (“beside”).
[S3] “Put in/into” shows movement into a container → choose 里面 (“inside”).
Test tip:Spot the cues — flat surface → 上面 (on top); adjacent → 旁边 (beside); into → 里面 (inside).

答案解析（泰语）
[ประโยค1] โต๊ะเป็นพื้นราบ วางของบนผิวหน้า → เลือก 上面 (บน)
[ประโยค2] หอพักกับโรงอาหารอยู่ติดกัน ไม่ได้อยู่ภายในกัน → เลือก 旁边 (ข้างๆ)
[ประโยค3] “ใส่เข้า/นำเข้า” หมายถึงการเคลื่อนไหวเข้าไปในภาชนะ → เลือก 里面 (ข้างใน)
เคล็ดลับ: ดูคำบอกตำแหน่ง — พื้นราบ → 上面；ติดกัน → 旁边；เข้าไป → 里面。

答案解析（俄语）
[П1]Стол — плоская поверхность; вещи лежат на ней → 上面 («наверху/на»)
[П2]Общежитие и столовая просто рядом, не одно внутри другого → 旁边 («рядом»)
[П3]«Положить в/внутрь» указывает на движение внутрь контейнера → 里面 («внутри»)
Подсказка: плоская поверхность → 上面; рядом → 旁边; внутрь → 里面.

答案解析（老挝语）
[ປະໂຫຍກ1]ໂຕະເປັນພື້ນຮາບ ຂອງຢູ່ເທິງຜິວໜ້າ → ເລືອກ 上面 (ເທິງ)
[ປະໂຫຍກ2]ຫໍພັກກັບໂຮງອາຫານຢູ່ຕິດກັນ ບໍ່ໄດ້ຢູ່ພາຍໃນກັນ → ເລືອກ 旁边 (ຂ້າງ)
[ປະໂຫຍກ3]“ໃສ່ເຂົ້າ/ນຳເຂົ້າ” ຊີ້ການເຂົ້າໄປໃນພາຊະນະ → ເລືອກ 里面 (ຂ້າງໃນ)
ເຄັດລັບ: ສັງເກດຄຳບອກຕຳແໜ່ງ—ພື້ນຮາບ→上面；ຢູ່ຕິດ→旁边；ເຂົ້າໄປ→里面。


第2题
冷 暖和 凉快

句子1. 冬天到了，天气很 (  )，你要多穿衣服。 
正确答案: 冷

句子2. 秋天的晚上很 (   )，特别适合散步。 
正确答案: 凉快

句子3.穿上这件厚毛衣，全身都感觉很 (   )。 
正确答案: 暖和


答案解析（中文）
[句1] 冬天+“很”=低温 → 冷（cold）
[句2] 秋夜舒适微凉 → 凉快（cool/pleasant）
[句3] 穿厚衣体感升温 → 暖和（warm）
技巧：严寒→冷；微凉舒服→凉快；温暖→暖和


答案解析（英文）
[S1] Winter + “very” → low temp → 冷 (cold)
[S2] Autumn night, pleasantly cool → 凉快 (cool)
[S3] Thick sweater → feels 暖和 (warm)
Tip: severe cold→冷; pleasantly cool→凉快; warm→暖和


答案解析（泰语）
[1] หน้าหนาว + “มาก” = อุณหภูมิต่ำ → 冷 (หนาว)
[2] ค่ำในฤดูใบไม้ร่วง เย็นสบาย → 凉快 (เย็นสบาย)
[3] ใส่เสื้อหนาแล้วอบอุ่น → 暖和 (อบอุ่น)
เคล็ดลับ: หนาวจัด→冷; เย็นสบาย→凉快; อบอุ่น→暖和


答案解析（俄语）
[П1] Зима + «очень» → низкая температура → 冷 («холодно»)
[П2] Осенним вечером приятно прохладно → 凉快 («прохладно»)
[П3] Толстый свитер → ощущается 暖和 («тепло/тёплый»)
Подсказка: сильный холод→冷; приятная прохлада→凉快; тепло→暖和

答案解析（老挝语）
[1] ລະດູຫນາວ + “ຫຼາຍ” → ອຸນຫະພູມຕ່ຳ → 冷 (ໜາວ)
[2] ຄ່ຳລະດູໃບໄມ້ຫຼົ່ນ ເຢັນສະບາຍ → 凉快 (ເຢັນສະບາຍ)
[3] ໃສ່ເສື້ອໜາ ຮູ້ສຶກອົບອຸ່ນ → 暖和 (ອົບອຸ່ນ)
ເຄັດລັບ:ໜາວຫຼາຍ→冷; ເຢັນສະບາຍ→凉快; ອົບອຸ່ນ→暖和

第3题
每 又 套
句子1. 我昨天去商场买了一 (  )新家具。 
正确答案: 套

句子2. 我 (  )天早上都六点半起床。 
正确答案: 每

句子3.今天的作业没做完，我明天 (  )要早起做练习。 
正确答案: 又

答案解析（中文）
[句1] 家具成“套”购买 → 量词用 套（set）
[句2] 频率固定“每天” → 每（every）
[句3] 再次发生/又一次（常带“又要…”语气）→ 又（again）
技巧：量词→套；频率→每；重复→又

答案解析（英文）
[S1] Furniture bought as a set → classifier 套 (set)
[S2] Fixed frequency “every day” → 每 (every)
[S3] Repeated action (often “again”) → 又 (again)
Tip: classifier→套; frequency→每; repetition→又

答案解析（泰语）
[1] เฟอร์นิเจอร์ซื้อเป็น “ชุด” → ลักษณนาม 套 (ชุด)
[2] ความถี่ประจำ “ทุกวัน” → 每 (ทุก...)
[3] การเกิดซ้ำ/อีกครั้ง (มักมีน้ำเสียง “อีกแล้ว”) → 又 (อีก/อีกครั้ง)
เคล็ดลับ: ลักษณนาม→套; ความถี่→每; ซ้ำ/อีก→又

答案解析（俄语）
[П1] Мебель покупают комплектом → счётное слово 套 («набор/комплект»)
[П2] Регулярность «каждый день» → 每 («каждый»)
[П3] Повтор действия (часто с оттенком «опять») → 又 («опять/снова»)
Подсказка: классификатор→套; частотность→每; повтор→又

答案解析（老挝语）
[1] ເຟີນີເຈີຊື້ເປັນ “ຊຸດ” → ລັກສະນະນາມ 套 (ຊຸດ)
[2] ຄວາມຖີ່ປະຈຳ “ທຸກມື້” → 每 (ທຸກ...)
[3] ເກີດຊ້ຳ/ອີກຄັ້ງ (ມັກມີນ້ຳໃຈ “ອີກແລ້ວ”) → 又 (ອີກ/ອີກຄັ້ງ)
ເຄັດລັບ: ລັກສະນະນາມ→套; ຄວາມຖີ່→每; ຊ້ຳ→又`;
  }

  // 2) Tolerant explain parser
  window.parseExplainBlocks = function(text) {
    const out = [];
    const blocks = (text || '').replace(/^\uFEFF/,'').split(/(?=^第\s*\d+\s*题\s*$)/m).filter(b => b.trim());
    for (const b of blocks) {
      const head = b.match(/^第\s*(\d+)\s*题/m);
      const idx = head ? parseInt(head[1], 10) : out.length + 1;

      const map = { zh: '', en: '', th: '', ru: '', lo: '' };
      const labels = [
        { key: 'zh', variants: ['中文','Chinese'] },
        { key: 'en', variants: ['英文','English'] },
        { key: 'th', variants: ['泰语','ไทย'] },
        { key: 'ru', variants: ['俄语','Русский'] },
        { key: 'lo', variants: ['老挝语','ລາວ'] },
      ];

      function headerRange(block, variant) {
        const patterns = [
          new RegExp('^\\s*答案解析（' + variant + '）\\s*$', 'm'),
          new RegExp('^\\s*答案' + variant + '解析\\s*$', 'm'),
          new RegExp('^\\s*解析（' + variant + '）\\s*$', 'm')
        ];
        for (const r of patterns) {
          const m = r.exec(block);
          if (m) return { start: m.index, end: m.index + m[0].length };
        }
        return null;
      }

      const headers = [];
      for (const { key, variants } of labels) {
        for (const v of variants) {
          const rng = headerRange(b, v);
          if (rng) { headers.push({ key, start: rng.start, end: rng.end }); break; }
        }
      }
      headers.sort((a, c) => a.start - c.start);

      for (let i = 0; i < headers.length; i++) {
        const h = headers[i];
        const nextStart = (i < headers.length - 1) ? headers[i + 1].start : b.length;
        let body = b.slice(h.end, nextStart);
        body = body.replace(/^\s*\r?\n/, '');
        map[h.key] = body.trim();
      }

      // Heuristic zh/en swap
      const hasCJK = s => /[\u4e00-\u9fff]/.test(s||'');
      const hasLatin = s => /[A-Za-z]/.test(s||'');
      if (map.zh && !hasCJK(map.zh) && hasLatin(map.zh) && (!map.en || map.en.trim()==='')) { map.en = map.zh; map.zh = ''; }
      if (map.en && hasCJK(map.en) && (!map.zh || map.zh.trim()==='')) { map.zh = map.en; map.en = ''; }

      out[idx] = map;
    }
    return out;
  };

  // 3) Override startFillDemo: Demo uses embedded set; Level passes text explicitly.
  const _origShow = (window.FillDemo && window.FillDemo.render) ? window.FillDemo.render : null;
  window.__FILL_IS_LEVEL__ = false;
  window.startFillDemo = function(textOpt){
    try{
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length > 0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const sourceText = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      if (!sourceText) { alert('未找到题库数据'); return; }

      try { window.__FILL_EXPLAINS__ = sourceText; window.ExplainData = parseExplainBlocks(sourceText); } catch(e){ console.warn('Explain parse fail', e); }

      const qs = (window.parseFillDemoText ? window.parseFillDemoText(sourceText) : []);
      if (!qs || !qs.length) { alert('题库为空或未识别，请检查题头格式（第1题/题1/Q1）'); return; }
      // Set globals used by FillDemo (depends on original code structure)
      window.questions = qs;
      window.idx = 0;

      // Show screen & render (use existing FillDemo API)
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') {
        // call the original start to reuse layout/bindings
        try { window.FillDemo.startDemo(sourceText); } catch(e) { console.warn(e); }
      }
      // Update progress UI after first render
      setTimeout(updateProgressUI, 0);
    }catch(e){ console.error(e); alert('选词填空初始化失败'); }
  };

  // 4) Progress + Jump UI injection (only visible in Level mode)
  document.addEventListener('DOMContentLoaded', () => {
    const hdr = document.getElementById('fillDemoHeader');
    if (!hdr) return;
    if (!document.getElementById('fillProgressWrap')){
      const wrap = document.createElement('div');
      wrap.id = 'fillProgressWrap';
      wrap.style.cssText = 'margin-left:auto;display:flex;align-items:center;gap:8px;visibility:hidden;';
      const span = document.createElement('span');
      span.id = 'fillProgress';
      span.style.cssText = 'font-weight:700;color:#0b1b3a';
      const btn = document.createElement('button');
      btn.id = 'fillJumpBtn';
      btn.className = 'fill-btn';
      btn.style.padding = '8px 12px';
      btn.textContent = '跳转';
      wrap.appendChild(span); wrap.appendChild(btn);
      hdr.appendChild(wrap);

      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      document.querySelector('.fill-area')?.appendChild(panel);
      btn.addEventListener('click', ()=>{
        panel.style.display = (panel.style.display==='grid' || panel.style.display==='block') ? 'none' : 'grid';
      });
    }
  });

  window.updateProgressUI = function(){
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    if (!show) return;
    const span = document.getElementById('fillProgress');
    const total = (typeof window.questions!=='undefined' && window.questions) ? window.questions.length : 0;
    const cur = (typeof window.idx!=='undefined' ? window.idx+1 : 1);
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total){
      panel.innerHTML='';
      for (let i=1;i<=total;i++){
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  // clear level flag on back (if original back exists it will still run)
  const backBtn = document.getElementById('fillCloseBtn');
  if (backBtn) backBtn.addEventListener('click', ()=>{ window.__FILL_IS_LEVEL__ = false; });

})();</script>


<!-- ==== Fill module: Progress+Jump+Save (append) ==== -->
<script>
(function(){
  // Mutation observer: inject UI when Fill overlay appears
  function ensureUI(){
    const header = document.getElementById('fillDemoHeader');
    if (!header || document.getElementById('fillProgressWrap')) return !!header && !!document.getElementById('fillProgressWrap');
    // Progress + Jump
    const wrap = document.createElement('div');
    wrap.id = 'fillProgressWrap';
    wrap.style.cssText = 'margin-left:auto;display:flex;align-items:center;gap:8px;visibility:hidden;';
    const span = document.createElement('span');
    span.id = 'fillProgress';
    span.style.cssText = 'font-weight:700;color:#0b1b3a';
    const jump = document.createElement('button');
    jump.id = 'fillJumpBtn';
    jump.className = 'fill-btn';
    jump.style.padding = '8px 12px';
    jump.textContent = '跳转';
    wrap.appendChild(span); wrap.appendChild(jump);
    header.appendChild(wrap);

    // Save button next to 返回
    const backBtn = document.getElementById('fillCloseBtn');
    if (backBtn && !document.getElementById('fillSaveBtn')){
      const save = document.createElement('button');
      save.id = 'fillSaveBtn';
      save.className = 'fill-btn';
      save.style.marginLeft = '8px';
      save.textContent = '保存';
      backBtn.after(save);
      save.addEventListener('click', ()=>{
        try{
          const text = window.__FILL_SOURCE_TEXT__ || '';
          const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
          const idx = (typeof window.idx !== 'undefined') ? window.idx : 0;
          const total = (window.questions && window.questions.length) || 0;
          const payload = { sig, idx, total, ts: Date.now() };
          localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
          if (typeof showToast==='function') showToast('进度已保存：'+(idx+1)+'/'+total, 'success'); else alert('进度已保存');
        }catch(e){ console.warn(e); }
      });
    }

    // Jump panel
    if (!document.getElementById('fillJumpPanel')){
      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      const area = document.querySelector('.fill-area');
      if (area) area.appendChild(panel);
      jump.addEventListener('click', ()=>{
        panel.style.display = (panel.style.display==='grid' || panel.style.display==='block') ? 'none' : 'grid';
      });
    }
    return true;
  }

  // progress & jump helpers
  window.updateProgressUI = function(){
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    if (!show) return;
    const span = document.getElementById('fillProgress');
    const total = (window.questions && window.questions.length) || 0;
    const cur = (typeof window.idx !== 'undefined') ? window.idx + 1 : 1;
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total){
      panel.innerHTML = '';
      for (let i=1;i<=total;i++){
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  // Patch FillDemo APIs to keep progress up to date
  function patchAPIs(){
    if (!window.FillDemo) return;
    ['next','prev','render'].forEach(fn=>{
      const orig = window.FillDemo[fn];
      if (typeof orig === 'function'){
        window.FillDemo[fn] = function(){ const r = orig.apply(this, arguments); try{ updateProgressUI(); }catch(e){} return r; };
      }
    });
  }

  // Hook into startFillDemo to set level flag, source text, and resume if saved
  const originalStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    const isLevel = typeof textOpt === 'string' && textOpt.trim().length > 0;
    window.__FILL_IS_LEVEL__ = !!isLevel;
    if (isLevel) window.__FILL_SOURCE_TEXT__ = textOpt;
    // call original
    try{ originalStart && originalStart.apply(this, arguments); }catch(e){ console.warn(e); }
    // After initial render, inject UI & patch APIs
    setTimeout(()=>{
      ensureUI();
      patchAPIs();
      // resume progress if saved matches current dataset
      try{
        if (window.__FILL_IS_LEVEL__){
          const saveRaw = localStorage.getItem('FILL_L1_SAVE');
          if (saveRaw){
            const save = JSON.parse(saveRaw);
            const text = window.__FILL_SOURCE_TEXT__ || '';
            const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
            if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length){
              window.idx = save.idx;
              window.FillDemo && window.FillDemo.render && window.FillDemo.render();
              if (typeof showToast==='function') showToast('已从保存进度继续：'+(window.idx+1)+'/'+window.questions.length, 'success');
            }
          }
        }
      }catch(e){ console.warn(e); }
      updateProgressUI();
    }, 0);
  };

  // Observe DOM to inject when overlay is added
  const mo = new MutationObserver(()=>{ ensureUI(); });
  mo.observe(document.documentElement || document.body, { childList:true, subtree:true });

})();</script>


<!-- ==== Fill module: Progress+Jump+Save + Demo dataset (override) ==== -->
<script>
(function(){
  // 0) Embedded DEMO dataset (uploaded)
  window.__EMBEDDED_FILL__ = `第1题
旁边 里面 上面

句子1. 钥匙就在桌子 (    )，你没看到吗？ 
正确答案: 上面

句子2. 我的宿舍在学校食堂 (   )，吃饭很方便。
正确答案: 旁边

句子3.我把新买的羽绒服放进了衣柜 (    )。 
正确答案: 里面

答案解析（中文）
[句1] 桌子是平面，东西放在表面→选上面。
[句2] 宿舍和食堂只是挨着，不在对方里→选旁边。
[句3] 有“放进/进到”，说明进入容器内部→选里面。
技巧：看关键词——“平面→上”，“相邻→旁边”，“进/入→里”。

答案解析（英文）
[S1] A table is a flat surface; things sit on the surface → choose 上面 (“on top”).
[S2] The dorm and the cafeteria are next to each other, not one inside the other → choose 旁边 (“beside”).
[S3] “Put in/into” shows movement into a container → choose 里面 (“inside”).
Test tip:Spot the cues — flat surface → 上面 (on top); adjacent → 旁边 (beside); into → 里面 (inside).

答案解析（泰语）
[ประโยค1] โต๊ะเป็นพื้นราบ วางของบนผิวหน้า → เลือก 上面 (บน)
[ประโยค2] หอพักกับโรงอาหารอยู่ติดกัน ไม่ได้อยู่ภายในกัน → เลือก 旁边 (ข้างๆ)
[ประโยค3] “ใส่เข้า/นำเข้า” หมายถึงการเคลื่อนไหวเข้าไปในภาชนะ → เลือก 里面 (ข้างใน)
เคล็ดลับ: ดูคำบอกตำแหน่ง — พื้นราบ → 上面；ติดกัน → 旁边；เข้าไป → 里面。

答案解析（俄语）
[П1]Стол — плоская поверхность; вещи лежат на ней → 上面 («наверху/на»)
[П2]Общежитие и столовая просто рядом, не одно внутри другого → 旁边 («рядом»)
[П3]«Положить в/внутрь» указывает на движение внутрь контейнера → 里面 («внутри»)
Подсказка: плоская поверхность → 上面; рядом → 旁边; внутрь → 里面.

答案解析（老挝语）
[ປະໂຫຍກ1]ໂຕະເປັນພື້ນຮາບ ຂອງຢູ່ເທິງຜິວໜ້າ → ເລືອກ 上面 (ເທິງ)
[ປະໂຫຍກ2]ຫໍພັກກັບໂຮງອາຫານຢູ່ຕິດກັນ ບໍ່ໄດ້ຢູ່ພາຍໃນກັນ → ເລືອກ 旁边 (ຂ້າງ)
[ປະໂຫຍກ3]“ໃສ່ເຂົ້າ/ນຳເຂົ້າ” ຊີ້ການເຂົ້າໄປໃນພາຊະນະ → ເລືອກ 里面 (ຂ້າງໃນ)
ເຄັດລັບ: ສັງເກດຄຳບອກຕຳແໜ່ງ—ພື້ນຮາບ→上面；ຢູ່ຕິດ→旁边；ເຂົ້າໄປ→里面。


第2题
冷 暖和 凉快

句子1. 冬天到了，天气很 (  )，你要多穿衣服。 
正确答案: 冷

句子2. 秋天的晚上很 (   )，特别适合散步。 
正确答案: 凉快

句子3.穿上这件厚毛衣，全身都感觉很 (   )。 
正确答案: 暖和


答案解析（中文）
[句1] 冬天+“很”=低温 → 冷（cold）
[句2] 秋夜舒适微凉 → 凉快（cool/pleasant）
[句3] 穿厚衣体感升温 → 暖和（warm）
技巧：严寒→冷；微凉舒服→凉快；温暖→暖和


答案解析（英文）
[S1] Winter + “very” → low temp → 冷 (cold)
[S2] Autumn night, pleasantly cool → 凉快 (cool)
[S3] Thick sweater → feels 暖和 (warm)
Tip: severe cold→冷; pleasantly cool→凉快; warm→暖和


答案解析（泰语）
[1] หน้าหนาว + “มาก” = อุณหภูมิต่ำ → 冷 (หนาว)
[2] ค่ำในฤดูใบไม้ร่วง เย็นสบาย → 凉快 (เย็นสบาย)
[3] ใส่เสื้อหนาแล้วอบอุ่น → 暖和 (อบอุ่น)
เคล็ดลับ: หนาวจัด→冷; เย็นสบาย→凉快; อบอุ่น→暖和


答案解析（俄语）
[П1] Зима + «очень» → низкая температура → 冷 («холодно»)
[П2] Осенним вечером приятно прохладно → 凉快 («прохладно»)
[П3] Толстый свитер → ощущается 暖和 («тепло/тёплый»)
Подсказка: сильный холод→冷; приятная прохлада→凉快; тепло→暖和

答案解析（老挝语）
[1] ລະດູຫນາວ + “ຫຼາຍ” → ອຸນຫະພູມຕ່ຳ → 冷 (ໜາວ)
[2] ຄ່ຳລະດູໃບໄມ້ຫຼົ່ນ ເຢັນສະບາຍ → 凉快 (ເຢັນສະບາຍ)
[3] ໃສ່ເສື້ອໜາ ຮູ້ສຶກອົບອຸ່ນ → 暖和 (ອົບອຸ່ນ)
ເຄັດລັບ:ໜາວຫຼາຍ→冷; ເຢັນສະບາຍ→凉快; ອົບອຸ່ນ→暖和

第3题
每 又 套
句子1. 我昨天去商场买了一 (  )新家具。 
正确答案: 套

句子2. 我 (  )天早上都六点半起床。 
正确答案: 每

句子3.今天的作业没做完，我明天 (  )要早起做练习。 
正确答案: 又

答案解析（中文）
[句1] 家具成“套”购买 → 量词用 套（set）
[句2] 频率固定“每天” → 每（every）
[句3] 再次发生/又一次（常带“又要…”语气）→ 又（again）
技巧：量词→套；频率→每；重复→又

答案解析（英文）
[S1] Furniture bought as a set → classifier 套 (set)
[S2] Fixed frequency “every day” → 每 (every)
[S3] Repeated action (often “again”) → 又 (again)
Tip: classifier→套; frequency→每; repetition→又

答案解析（泰语）
[1] เฟอร์นิเจอร์ซื้อเป็น “ชุด” → ลักษณนาม 套 (ชุด)
[2] ความถี่ประจำ “ทุกวัน” → 每 (ทุก...)
[3] การเกิดซ้ำ/อีกครั้ง (มักมีน้ำเสียง “อีกแล้ว”) → 又 (อีก/อีกครั้ง)
เคล็ดลับ: ลักษณนาม→套; ความถี่→每; ซ้ำ/อีก→又

答案解析（俄语）
[П1] Мебель покупают комплектом → счётное слово 套 («набор/комплект»)
[П2] Регулярность «каждый день» → 每 («каждый»)
[П3] Повтор действия (часто с оттенком «опять») → 又 («опять/снова»)
Подсказка: классификатор→套; частотность→每; повтор→又

答案解析（老挝语）
[1] ເຟີນີເຈີຊື້ເປັນ “ຊຸດ” → ລັກສະນະນາມ 套 (ຊຸດ)
[2] ຄວາມຖີ່ປະຈຳ “ທຸກມື້” → 每 (ທຸກ...)
[3] ເກີດຊ້ຳ/ອີກຄັ້ງ (ມັກມີນ້ຳໃຈ “ອີກແລ້ວ”) → 又 (ອີກ/ອີກຄັ້ງ)
ເຄັດລັບ: ລັກສະນະນາມ→套; ຄວາມຖີ່→每; ຊ້ຳ→又`;

  // --- tolerant explain parser (supports 中文/英文/English/ไทย/Русский/ລາວ) ---
  window.parseExplainBlocks = function(text) {
    const out = [];
    const src = (text || '').replace(/^\uFEFF/, '');
    const blocks = src.split(/(?=^第\s*\d+\s*题\s*$)/m).filter(b => b.trim());
    for (const b of blocks) {
      const head = b.match(/^第\s*(\d+)\s*题/m);
      const idx = head ? parseInt(head[1], 10) : out.length + 1;
      const map = { zh: '', en: '', th: '', ru: '', lo: '' };
      const labels = [
        { key: 'zh', variants: ['中文','Chinese'] },
        { key: 'en', variants: ['英文','English'] },
        { key: 'th', variants: ['泰语','ไทย'] },
        { key: 'ru', variants: ['俄语','Русский'] },
        { key: 'lo', variants: ['老挝语','ລາວ'] },
      ];
      function headerRange(block, variant) {
        const patterns = [
          new RegExp('^\\s*答案解析（' + variant + '）\\s*$', 'm'),
          new RegExp('^\\s*答案' + variant + '解析\\s*$', 'm'),
          new RegExp('^\\s*解析（' + variant + '）\\s*$', 'm'),
        ];
        for (const r of patterns) { const m = r.exec(block); if (m) return { start: m.index, end: m.index + m[0].length }; }
        return null;
      }
      const headers = [];
      for (const { key, variants } of labels) {
        for (const v of variants) { const rng = headerRange(b, v); if (rng) { headers.push({ key, start: rng.start, end: rng.end }); break; } }
      }
      headers.sort((a,b)=>a.start-b.start);
      for (let i=0;i<headers.length;i++) {
        const h = headers[i];
        const nextStart = (i<headers.length-1)? headers[i+1].start : b.length;
        let body = b.slice(h.end, nextStart);
        body = body.replace(/^\s*\r?\n/, '');
        map[h.key] = body.trim();
      }
      // gentle zh/en swap heuristic
      const hasCJK = s => /[\u4e00-\u9fff]/.test(s||'');
      const hasLatin = s => /[A-Za-z]/.test(s||'');
      if (map.zh && !hasCJK(map.zh) && hasLatin(map.zh) && (!map.en || !map.en.trim())) { map.en = map.zh; map.zh = ''; }
      if (map.en && hasCJK(map.en) && (!map.zh || !map.zh.trim())) { map.zh = map.en; map.en = ''; }
      out[idx] = map;
    }
    return out;
  };

  // 1) Ensure header UI: Save, Progress, Jump (Save at left, then Progress, then Jump)
  function ensureHeaderUI() {
    const header = document.getElementById('fillDemoHeader');
    if (!header) return false;
    const closeBtn = document.getElementById('fillCloseBtn');
    if (!document.getElementById('fillSaveBtn')) {
      const save = document.createElement('button');
      save.id = 'fillSaveBtn';
      save.className = 'fill-btn';
      save.style.marginLeft = '8px';
      save.textContent = '保存';
      if (closeBtn) closeBtn.after(save); else header.appendChild(save);
      save.addEventListener('click', onSaveProgress);
    }
    if (!document.getElementById('fillProgressWrap')) {
      const wrap = document.createElement('div');
      wrap.id = 'fillProgressWrap';
      wrap.style.cssText = 'display:flex;align-items:center;gap:8px;margin-left:8px;visibility:hidden;';
      const span = document.createElement('span');
      span.id = 'fillProgress';
      span.style.cssText = 'font-weight:700;color:#0b1b3a';
      wrap.appendChild(span);
      if (closeBtn) document.getElementById('fillSaveBtn').after(wrap); else header.appendChild(wrap);
    }
    if (!document.getElementById('fillJumpBtn')) {
      const btn = document.createElement('button');
      btn.id = 'fillJumpBtn';
      btn.className = 'fill-btn';
      btn.style.padding = '8px 12px';
      btn.style.marginLeft = '8px';
      btn.textContent = '跳转';
      const wrap = document.getElementById('fillProgressWrap');
      (wrap || header).appendChild(btn);
      btn.addEventListener('click', ()=>{
        const panel = document.getElementById('fillJumpPanel');
        if (!panel) return;
        panel.style.display = (panel.style.display==='grid'||panel.style.display==='block') ? 'none':'grid';
      });
    }
    if (!document.getElementById('fillJumpPanel')) {
      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      const area = document.querySelector('.fill-area');
      if (area) area.appendChild(panel);
    }
    return true;
  }

  // 2) Progress / Jump helpers
  window.updateProgressUI = function() {
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    const saveBtn = document.getElementById('fillSaveBtn');
    if (saveBtn) saveBtn.style.display = show ? '' : 'none';
    const jumpBtn = document.getElementById('fillJumpBtn');
    if (jumpBtn) jumpBtn.style.display = show ? '' : 'none';
    if (!show) return;

    const total = (window.questions && window.questions.length) || 0;
    const cur = (typeof window.idx !== 'undefined') ? window.idx + 1 : 1;
    const span = document.getElementById('fillProgress');
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total) {
      panel.innerHTML='';
      for (let i=1;i<=total;i++) {
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55),0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  function onSaveProgress(){
    if (!window.__FILL_IS_LEVEL__) { if (typeof showToast==='function') showToast('保存仅用于 Level 游戏', 'info'); else alert('保存仅用于 Level 游戏'); return; }
    try {
      const text = window.__FILL_SOURCE_TEXT__ || '';
      const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
      const idx = (typeof window.idx !== 'undefined') ? window.idx : 0;
      const total = (window.questions && window.questions.length) || 0;
      const payload = { sig, idx, total, ts: Date.now() };
      localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
      if (typeof showToast==='function') showToast('Level1 进度已保存：'+(idx+1)+'/'+total, 'success'); else alert('已保存：'+(idx+1)+'/'+total);
    }catch(e){ console.warn(e); }
  }

  // 3) Hook startFillDemo to set flags, parse explains/questions, resume, and ensure UI
  const _origStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    try{
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const src = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      window.__FILL_SOURCE_TEXT__ = isLevel ? src : '';
      // parse explains for current dataset
      try { window.ExplainData = parseExplainBlocks(src); } catch(e){ console.warn('explain parse', e); }
      // call original (它会负责渲染)
      if (_origStart) _origStart.apply(this, arguments);
      // After first render: inject UI, patch progress, and resume if saved
      setTimeout(()=>{
        ensureHeaderUI();
        // Patch next/prev/render to刷新进度
        if (window.FillDemo) ['next','prev','render'].forEach(fn=>{
          const orig = window.FillDemo[fn];
          if (typeof orig==='function' && !orig.__patched){
            window.FillDemo[fn] = function(){ const r = orig.apply(this, arguments); try{ updateProgressUI(); }catch(e){} return r; };
            window.FillDemo[fn].__patched = true;
          }
        });
        // resume Level1 if signature matches
        if (window.__FILL_IS_LEVEL__) {
          try {
            const raw = localStorage.getItem('FILL_L1_SAVE');
            if (raw) {
              const save = JSON.parse(raw);
              const text = window.__FILL_SOURCE_TEXT__ || '';
              const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
              if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length) {
                window.idx = save.idx;
                window.FillDemo && window.FillDemo.render && window.FillDemo.render();
                if (typeof showToast==='function') showToast('已从保存进度继续：'+(window.idx+1)+'/'+window.questions.length, 'success');
              }
            }
          }catch(e){ console.warn(e); }
        }
        updateProgressUI();
      }, 0);
    }catch(e){ console.error(e); alert('选词填空启动失败'); }
  };

  // 4) 观察 DOM，保证头部 UI 被安插
  const mo = new MutationObserver(()=>{ ensureHeaderUI(); });
  mo.observe(document.documentElement||document.body, { childList:true, subtree:true });

})();
</script>


<script>
// === Fill Level Controls: startFillDemo + Progress/Jump/Save + Embedded Demo ===
(function(){"use strict";
  // Embedded demo dataset (always used by Demo mode)
  window.__EMBEDDED_FILL__ = `第1题
旁边 里面 上面

句子1. 钥匙就在桌子 (    )，你没看到吗？ 
正确答案: 上面

句子2. 我的宿舍在学校食堂 (   )，吃饭很方便。
正确答案: 旁边

句子3.我把新买的羽绒服放进了衣柜 (    )。 
正确答案: 里面

答案解析（中文）
[句1] 桌子是平面，东西放在表面→选上面。
[句2] 宿舍和食堂只是挨着，不在对方里→选旁边。
[句3] 有“放进/进到”，说明进入容器内部→选里面。
技巧：看关键词——“平面→上”，“相邻→旁边”，“进/入→里”。

答案解析（英文）
[S1] A table is a flat surface; things sit on the surface → choose 上面 (“on top”).
[S2] The dorm and the cafeteria are next to each other, not one inside the other → choose 旁边 (“beside”).
[S3] “Put in/into” shows movement into a container → choose 里面 (“inside”).
Test tip:Spot the cues — flat surface → 上面 (on top); adjacent → 旁边 (beside); into → 里面 (inside).

答案解析（泰语）
[ประโยค1] โต๊ะเป็นพื้นราบ วางของบนผิวหน้า → เลือก 上面 (บน)
[ประโยค2] หอพักกับโรงอาหารอยู่ติดกัน ไม่ได้อยู่ภายในกัน → เลือก 旁边 (ข้างๆ)
[ประโยค3] “ใส่เข้า/นำเข้า” หมายถึงการเคลื่อนไหวเข้าไปในภาชนะ → เลือก 里面 (ข้างใน)
เคล็ดลับ: ดูคำบอกตำแหน่ง — พื้นราบ → 上面；ติดกัน → 旁边；เข้าไป → 里面。

答案解析（俄语）
[П1]Стол — плоская поверхность; вещи лежат на ней → 上面 («наверху/на»)
[П2]Общежитие и столовая просто рядом, не одно внутри другого → 旁边 («рядом»)
[П3]«Положить в/внутрь» указывает на движение внутрь контейнера → 里面 («внутри»)
Подсказка: плоская поверхность → 上面; рядом → 旁边; внутрь → 里面.

答案解析（老挝语）
[ປະໂຫຍກ1]ໂຕະເປັນພື້ນຮາບ ຂອງຢູ່ເທິງຜິວໜ້າ → ເລືອກ 上面 (ເທິງ)
[ປະໂຫຍກ2]ຫໍພັກກັບໂຮງອາຫານຢູ່ຕິດກັນ ບໍ່ໄດ້ຢູ່ພາຍໃນກັນ → ເລືອກ 旁边 (ຂ້າງ)
[ປະໂຫຍກ3]“ໃສ່ເຂົ້າ/ນຳເຂົ້າ” ຊີ້ການເຂົ້າໄປໃນພາຊະນະ → ເລືອກ 里面 (ຂ້າງໃນ)
ເຄັດລັບ: ສັງເກດຄຳບອກຕຳແໜ່ງ—ພື້ນຮາບ→上面；ຢູ່ຕິດ→旁边；ເຂົ້າໄປ→里面。


第2题
冷 暖和 凉快

句子1. 冬天到了，天气很 (  )，你要多穿衣服。 
正确答案: 冷

句子2. 秋天的晚上很 (   )，特别适合散步。 
正确答案: 凉快

句子3.穿上这件厚毛衣，全身都感觉很 (   )。 
正确答案: 暖和


答案解析（中文）
[句1] 冬天+“很”=低温 → 冷（cold）
[句2] 秋夜舒适微凉 → 凉快（cool/pleasant）
[句3] 穿厚衣体感升温 → 暖和（warm）
技巧：严寒→冷；微凉舒服→凉快；温暖→暖和


答案解析（英文）
[S1] Winter + “very” → low temp → 冷 (cold)
[S2] Autumn night, pleasantly cool → 凉快 (cool)
[S3] Thick sweater → feels 暖和 (warm)
Tip: severe cold→冷; pleasantly cool→凉快; warm→暖和


答案解析（泰语）
[1] หน้าหนาว + “มาก” = อุณหภูมิต่ำ → 冷 (หนาว)
[2] ค่ำในฤดูใบไม้ร่วง เย็นสบาย → 凉快 (เย็นสบาย)
[3] ใส่เสื้อหนาแล้วอบอุ่น → 暖和 (อบอุ่น)
เคล็ดลับ: หนาวจัด→冷; เย็นสบาย→凉快; อบอุ่น→暖和


答案解析（俄语）
[П1] Зима + «очень» → низкая температура → 冷 («холодно»)
[П2] Осенним вечером приятно прохладно → 凉快 («прохладно»)
[П3] Толстый свитер → ощущается 暖和 («тепло/тёплый»)
Подсказка: сильный холод→冷; приятная прохлада→凉快; тепло→暖和

答案解析（老挝语）
[1] ລະດູຫນາວ + “ຫຼາຍ” → ອຸນຫະພູມຕ່ຳ → 冷 (ໜາວ)
[2] ຄ່ຳລະດູໃບໄມ້ຫຼົ່ນ ເຢັນສະບາຍ → 凉快 (ເຢັນສະບາຍ)
[3] ໃສ່ເສື້ອໜາ ຮູ້ສຶກອົບອຸ່ນ → 暖和 (ອົບອຸ່ນ)
ເຄັດລັບ:ໜາວຫຼາຍ→冷; ເຢັນສະບາຍ→凉快; ອົບອຸ່ນ→暖和

第3题
每 又 套
句子1. 我昨天去商场买了一 (  )新家具。 
正确答案: 套

句子2. 我 (  )天早上都六点半起床。 
正确答案: 每

句子3.今天的作业没做完，我明天 (  )要早起做练习。 
正确答案: 又

答案解析（中文）
[句1] 家具成“套”购买 → 量词用 套（set）
[句2] 频率固定“每天” → 每（every）
[句3] 再次发生/又一次（常带“又要…”语气）→ 又（again）
技巧：量词→套；频率→每；重复→又

答案解析（英文）
[S1] Furniture bought as a set → classifier 套 (set)
[S2] Fixed frequency “every day” → 每 (every)
[S3] Repeated action (often “again”) → 又 (again)
Tip: classifier→套; frequency→每; repetition→又

答案解析（泰语）
[1] เฟอร์นิเจอร์ซื้อเป็น “ชุด” → ลักษณนาม 套 (ชุด)
[2] ความถี่ประจำ “ทุกวัน” → 每 (ทุก...)
[3] การเกิดซ้ำ/อีกครั้ง (มักมีน้ำเสียง “อีกแล้ว”) → 又 (อีก/อีกครั้ง)
เคล็ดลับ: ลักษณนาม→套; ความถี่→每; ซ้ำ/อีก→又

答案解析（俄语）
[П1] Мебель покупают комплектом → счётное слово 套 («набор/комплект»)
[П2] Регулярность «каждый день» → 每 («каждый»)
[П3] Повтор действия (часто с оттенком «опять») → 又 («опять/снова»)
Подсказка: классификатор→套; частотность→每; повтор→又

答案解析（老挝语）
[1] ເຟີນີເຈີຊື້ເປັນ “ຊຸດ” → ລັກສະນະນາມ 套 (ຊຸດ)
[2] ຄວາມຖີ່ປະຈຳ “ທຸກມື້” → 每 (ທຸກ...)
[3] ເກີດຊ້ຳ/ອີກຄັ້ງ (ມັກມີນ້ຳໃຈ “ອີກແລ້ວ”) → 又 (ອີກ/ອີກຄັ້ງ)
ເຄັດລັບ: ລັກສະນະນາມ→套; ຄວາມຖີ່→每; ຊ້ຳ→又`;

  function el(id){ return document.getElementById(id); }
  function computeSig(text){ return text ? (text.length + '|' + text.slice(0,128)) : ''; }

  function updateProgressUI(){
    const prog = el('fillProgress');
    const save = el('fillSaveBtn');
    const jump = el('fillJumpBtn');
    const isLevel = !!window.__FILL_IS_LEVEL__;
    if (prog) prog.style.display = isLevel ? '' : 'none';
    if (save) save.style.display = isLevel ? '' : 'none';
    if (jump) jump.style.display = isLevel ? '' : 'none';
    if (!isLevel) return;
    try{ 
      const total = (window.questions && window.questions.length) || 0;
      const cur = (typeof window.idx !== 'undefined') ? (window.idx+1) : 1;
      if (prog) prog.textContent = cur + '/' + total;
    }catch(e){}
  }

  function ensureJumpGrid(){
    const panel = el('fillJumpPanel');
    if (!panel || !window.__FILL_IS_LEVEL__) return;
    const total = (window.questions && window.questions.length) || 0;
    if ((panel.dataset.built|0) === total) return;
    panel.innerHTML = '';
    for (let i=1;i<=total;i++){ 
      const b = document.createElement('button');
      b.className = 'jump-item';
      b.textContent = i;
      b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
      b.addEventListener('click', ()=>{ try{ window.idx = i-1; panel.style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); updateProgressUI(); }catch(e){} });
      panel.appendChild(b);
    }
    panel.dataset.built = String(total);
  }

  // Wire 'Jump' toggle
  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (t && t.id === 'fillJumpBtn'){ 
      const panel = el('fillJumpPanel');
      if (panel) { 
        if (panel.style.display==='grid' || panel.style.display==='block') panel.style.display='none'; 
        else { ensureJumpGrid(); panel.style.display='grid'; }
      }
    }
  });

  // Save button
  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (t && t.id === 'fillSaveBtn'){ 
      if (!window.__FILL_IS_LEVEL__) { (window.showToast?showToast('保存仅用于 Level 游戏 / Save is for Level mode only','info'):alert('保存仅用于 Level 游戏')); return; }
      try{ 
        const text = window.__FILL_SOURCE_TEXT__ || '';
        const payload = { sig: computeSig(text), idx: window.idx||0, total: (window.questions&&window.questions.length)||0, ts: Date.now() };
        localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
        (window.showToast?showToast('Level 1 进度已保存 / Progress saved: ' + (payload.idx+1) + '/' + payload.total, 'success'):alert('已保存 ' + (payload.idx+1) + '/' + payload.total));
      }catch(e){ console.warn(e); }
    }
  });

  // Our unified starter for Demo & Level
  window.startFillDemo = function(textOpt){
    try{ 
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const src = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      window.__FILL_SOURCE_TEXT__ = isLevel ? src : '';
      if (!src) { alert('未找到题库数据 / No dataset'); return; }
      try { window.__FILL_EXPLAINS__ = src; window.ExplainData = parseExplainBlocks?parseExplainBlocks(src):[]; } catch(e){ console.warn('explain parse', e); }
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') { window.FillDemo.startDemo(src); }
      setTimeout(()=>{
        if (window.__FILL_IS_LEVEL__) {
          try{ 
            const raw = localStorage.getItem('FILL_L1_SAVE');
            if (raw){ 
              const save = JSON.parse(raw);
              const sig = computeSig(src);
              if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length){ 
                window.idx = save.idx; window.FillDemo.render(); 
              }
            }
          }catch(e){}
        }
        updateProgressUI(); ensureJumpGrid();
        if (window.FillDemo){ 
          ['next','prev','render'].forEach(fn=>{ 
            const o = window.FillDemo[fn]; 
            if (typeof o==='function' && !o.__patched){
              window.FillDemo[fn] = function(){ const r = o.apply(this, arguments); updateProgressUI(); ensureJumpGrid(); return r; }; 
              window.FillDemo[fn].__patched = true;
            }
          });
        }
      }, 0);
    }catch(e){ console.error(e); alert('选词填空启动失败'); }
  };

  // Patch FillLevel.start to use startFillDemo(text)
  (function patchFillLevel(){
    try{
      const prev = window.FillLevel && window.FillLevel.start;
      if (!prev) return;
      window.FillLevel.start = async function(levelKey){
        if (levelKey === 'L1') {
          const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
          try{ 
            const res = await fetch(url, {cache:'no-store'});
            if (!res.ok) throw new Error('HTTP '+res.status);
            const text = await res.text();
            window.startFillDemo(text);
          }catch(e){ console.error(e); alert('Level 1 题库加载失败'); }
          try{ window.FillLevel.close && window.FillLevel.close(); }catch(e){}
          return;
        }
        return prev.apply(this, arguments);
      };
    }catch(e){ console.warn('patchFillLevel', e); }
  })();

})();</script>


<script>
(function(){
  function el(id){ return document.getElementById(id); }
  function sig(text){ return text ? (text.length + '|' + text.slice(0,128)) : ''; }

  window.updateProgressUI = function(){
    const isLevel = !!window.__FILL_IS_LEVEL__;
    const prog = el('fillProgress'), save = el('fillSaveBtn'), jump = el('fillJumpBtn');
    if (prog) prog.style.display = isLevel ? '' : 'none';
    if (save) save.style.display = isLevel ? '' : 'none';
    if (jump) jump.style.display = isLevel ? '' : 'none';
    if (!isLevel) return;
    const cur = (typeof window.__FILL_IDX__==='number'? window.__FILL_IDX__+1 : 1);
    const total = (typeof window.__FILL_TOTAL__==='number'? window.__FILL_TOTAL__ : 0);
    if (prog) prog.textContent = cur + '/' + total;
  };

  // Jump toggle and grid build
  function ensureJumpGrid(){
    const panel = el('fillJumpPanel');
    if (!panel || !window.__FILL_IS_LEVEL__) return;
    const total = window.__FILL_TOTAL__ || 0;
    if ((panel.dataset.built|0) === total) return;
    panel.innerHTML = '';
    for (let i=1;i<=total;i++){
      const b = document.createElement('button');
      b.textContent = i;
      b.className = 'jump-item';
      b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
      b.addEventListener('click', ()=>{ try{ window.FillDemo && FillDemo.goto && FillDemo.goto(i-1); panel.style.display='none'; }catch(e){} });
      panel.appendChild(b);
    }
    panel.dataset.built = String(total);
  }

  document.addEventListener('click', function(e){
    const t = e.target;
    if (t && t.id==='fillJumpBtn'){
      const panel = el('fillJumpPanel');
      if (!panel) return;
      if (panel.style.display==='grid' || panel.style.display==='block') panel.style.display='none';
      else { ensureJumpGrid(); panel.style.display='grid'; }
    }
    if (t && t.id==='fillSaveBtn'){
      if (!window.__FILL_IS_LEVEL__){ (window.showToast?showToast('保存仅用于 Level 游戏 / Save is for Level mode only','info'):alert('保存仅用于 Level 游戏')); return; }
      try{
        const text = window.__FILL_SOURCE_TEXT__ || '';
        const payload = { sig: sig(text), idx: window.__FILL_IDX__||0, total: window.__FILL_TOTAL__||0, ts: Date.now() };
        localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
        (window.showToast?showToast('Level 1 进度已保存 / Progress saved: ' + (payload.idx+1) + '/' + payload.total, 'success'):alert('已保存 ' + (payload.idx+1) + '/' + payload.total));
      }catch(e){ console.warn(e); }
    }
  });

  // Override startFillDemo to set flags and resume saved progress
  const _origStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
    window.__FILL_IS_LEVEL__ = !!isLevel;
    window.__FILL_SOURCE_TEXT__ = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
    try{ _origStart && _origStart.apply(this, arguments); }catch(e){ console.warn(e); }
    setTimeout(()=>{
      if (window.__FILL_IS_LEVEL__){
        try{
          const raw = localStorage.getItem('FILL_L1_SAVE');
          if (raw){
            const save = JSON.parse(raw);
            if (save.sig && save.sig === sig(window.__FILL_SOURCE_TEXT__) && typeof save.idx==='number'){
              window.FillDemo && FillDemo.goto && FillDemo.goto(save.idx);
              (window.showToast?showToast('已从保存进度继续：'+(save.idx+1)+'/'+(window.__FILL_TOTAL__||0),'success'):0);
            }
          }
        }catch(e){}
      }
      window.updateProgressUI && window.updateProgressUI();
    },0);
  };

  // Ensure Level1 loader uses startFillDemo(text)
  (function patchFillLevel(){
    try{
      const prev = window.FillLevel && window.FillLevel.start;
      if (!prev) return;
      window.FillLevel.start = async function(levelKey){
        if (levelKey==='L1'){
          const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
          try{
            const res = await fetch(url,{cache:'no-store'});
            if (!res.ok) throw new Error('HTTP '+res.status);
            const text = await res.text();
            window.startFillDemo(text);
          }catch(e){ console.error(e); alert('Level 1 题库加载失败'); }
          try{ window.FillLevel.close && window.FillLevel.close(); }catch(e){}
          return;
        }
        return prev.apply(this, arguments);
      };
    }catch(e){}
  })();

})();</script>










<script>
/* ==== Fill module: generic multi-language parser + reliable rendering ==== */
(function(){
  function splitQuestionBlocks(text){
    var s = String(text||'').replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
    var splitters = [
      /(?=^\s*第\s*\d+\s*题)/m,
      /(?=^[【\[]?\s*第\s*\d+\s*题\s*[】\]])/m,
      /(?=^\s*题\s*\d+)/m,
      /(?=^\s*Q\s*\d+)/mi
    ];
    for (var i=0;i<splitters.length;i++){
      var arr = s.split(splitters[i]).filter(function(b){ return b && b.trim(); });
      if (arr.length) return arr;
    }
    return [s];
  }

  // Map header labels to std codes
  function normLabel(lbl){
    lbl = String(lbl||'').trim();
    var x = lbl.toLowerCase();
    if (lbl.includes('中文') || x.includes('chinese')) return 'zh';
    if (lbl.includes('英文') || lbl.includes('英语') || x.includes('english')) return 'en';
    if (lbl.includes('法语') || x.includes('français') || x.includes('french')) return 'fr';
    if (lbl.includes('泰语') || x.includes('thai') || lbl.includes('ไทย')) return 'th';
    if (lbl.includes('俄语') || x.includes('russian') || lbl.includes('Рус')) return 'ru';
    if (lbl.includes('老挝') || x.includes('lao') || lbl.includes('ລາວ')) return 'lo';
    return null; // ignore other labels
  }

  function parseBlockAllLangs(block){
    var result = {zh:'',en:'',fr:'',th:'',ru:'',lo:''};
    // Find all "答案解析（xxx）" headers and segments
    var re = /答案解析[（(]\s*([^）)]+)\s*[）)]\s*[:：]?\s*/g;
    var m, lastIdx = 0, headers = [];
    while ((m = re.exec(block))){
      headers.push({label:m[1], start: m.index, after: re.lastIndex});
    }
    if (!headers.length) return result;
    for (var i=0;i<headers.length;i++){
      var h = headers[i];
      var end = (i+1<headers.length) ? headers[i+1].start : block.length;
      var segment = block.slice(h.after, end);
      var code = normLabel(h.label);
      if (!code) continue;
      // Trim trailing spaces/newlines
      segment = segment.replace(/^\s+|\s+$/g, '');
      if (segment) result[code] = segment;
    }
    return result;
  }

  function parseAll(text){
    var parts = splitQuestionBlocks(text);
    var out = [];
    for (var i=0;i<parts.length;i++){
      out.push(parseBlockAllLangs(parts[i]));
    }
    return out;
  }

  // Capture dataset when FillDemo starts (covers Demo与Level1，因为Level1最终也调用 startDemo(text))
  (function(){
    if (!window.FillDemo || typeof window.FillDemo.startDemo !== 'function') return;
    var _start = window.FillDemo.startDemo;
    window.FillDemo.startDemo = function(textOpt){
      var src = (typeof textOpt==='string' && textOpt.trim()) ? textOpt : (window.__FILL_OVERRIDE__ || window.__FILL_EXPLAINS__ || '');
      try{
        if (src){
          window.__FILL_SRC__ = src;
          window.__FILL_EXPLAINS__ = src;
          window.__FILL_EXPLAINS_PARSED__ = parseAll(src);
        }
      }catch(e){ console.warn('parseAll on start failed', e); }
      return _start.apply(window.FillDemo, arguments);
    };
  })();

  // Always render from parsed dataset for consistency
  (function(){
    var _origShow = window.showExplainPanelFor;
    if (typeof _origShow !== 'function') return;
    window.showExplainPanelFor = function(qIndex){
      _origShow(qIndex);
      try{
        var panel = document.getElementById('explainPanel');
        var body  = document.getElementById('explainBody');
        var dataList = window.__FILL_EXPLAINS_PARSED__;
        if (!Array.isArray(dataList) || !dataList.length){
          // final fallback
          dataList = [];
        }
        var data = dataList[qIndex] || {};

        function md2html(s){
          if(!s) return '';
          return String(s)
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/\*\*([\s\S]+?)\*\*/g,'<strong>$1</strong>');
        }

        var langs = ['zh','en','fr','th','ru','lo'];
        langs.forEach(function(l){
          var btn = panel && panel.querySelector('.explain-btn[data-lang="'+l+'"]');
          if (!btn) return;
          var txt = (data && data[l]) ? data[l] : '';
          var has = !!(txt && String(txt).trim().length);
          btn.disabled = !has;
          btn.onclick = function(){ body.innerHTML = has ? md2html(txt) : '（该语言暂无解析）'; };
        });

        // Always render a default based on parsed dataset
        var use = data.zh || data.en || data.fr || data.th || data.ru || data.lo || '';
        body.innerHTML = use ? md2html(use) : '（该题暂无解析）';
      }catch(e){ console.warn('explain render failed', e); }
    };
  })();
})();
</script>


<script>
/* ==== Force demo to fetch FR dataset ==== */
(function(){
  var DEMO_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%A1%AB%E7%A9%BA%E8%AF%95%E7%8E%A9-%E8%AF%95%E9%A2%98%E5%AF%BC%E5%85%A5%E6%A8%A1%E6%9D%BF-%E5%B8%A6%E8%A7%A3%E6%9E%90.txt";
  var _orig = window.startFillDemo;
  window.startFillDemo = async function(){
    try{ 
      var r = await fetch(DEMO_URL);
      if(!r.ok) throw new Error('HTTP '+r.status);
      var text = await r.text();
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function'){
        window.FillDemo.startDemo(text);
        // Demo should not show Level1 progress
        window.__FILL_IS_LEVEL__ = false;
        if (typeof window.updateProgressUI === 'function') window.updateProgressUI();
        return;
      }
    }catch(e){ console.warn('Demo fetch failed, fallback to original demo', e); }
    if (typeof _orig === 'function') return _orig();
  };
})();
</script>





<!-- SB START: Sentence-Building integrated v6 (bilingual toast; fixed multiline strings) -->
<style data-sb="css">
#sb-embed *{ box-sizing:border-box }
#sb-embed{ display:none; margin-top:14px; border-radius:22px; background:linear-gradient(180deg,#f9fbff,#edf4ff); color:#0f1430;
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
#sb-embed .sb-top{ padding:12px 14px; border-bottom:1px dashed rgba(12,22,44,.12); }
#sb-embed .sb-topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
#sb-embed .sb-ins{ font-weight:800; text-align:center }
#sb-embed .sb-ins small{ display:block; opacity:.9; margin-top:6px }
#sb-embed .sb-pool{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; padding:18px 16px 6px }
#sb-embed .sb-slot-wrap{ padding:12px 16px 10px }
#sb-embed .sb-slot{ min-height:72px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-start; border-radius:14px; background:linear-gradient(180deg,#ffffff,#eef5ff); box-shadow: inset 0 0 0 2px rgba(14,20,34,.12); padding:12px 14px; }
#sb-embed .sb-tile{ display:inline-flex; align-items:center; justify-content:center; text-align:center; padding:10px 12px; min-width:64px; border-radius:12px; cursor:grab; user-select:none; font-weight:900; color:#0b1220; border:2px solid rgba(0,0,0,.06); background:var(--tile-bg,linear-gradient(180deg,#fff,#eaf2ff)); box-shadow: var(--tile-shadow,0 10px 0 rgba(0,0,0,.18)), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; }
#sb-embed .sb-tile:active{ cursor:grabbing; transform:scale(0.98) translateY(2px); }
#sb-embed .sb-slot.dragging{ box-shadow: inset 0 0 0 2px #8ec5ff, 0 0 0 2px rgba(142,197,255,.25); }
#sb-embed .sb-shake{ animation:sbshake .25s ease } @keyframes sbshake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
#sb-embed .sb-flyback{ animation:sbflash .55s ease forwards } @keyframes sbflash{0%{opacity:1;filter:brightness(1)}50%{opacity:.35;filter:brightness(1.6)}100%{opacity:0;transform:scale(.96)}}
#sb-embed .sb-toolbar{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:8px 16px 16px; border-top:1px dashed rgba(12,22,44,.12) }
#sb-embed .sb-mini{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }
#sb-embed .primary{ outline:2px solid #0ea5e9 }
#sb-embed .sb-panel{ display:none; margin:10px 16px 16px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#eef4ff); box-shadow: inset 0 0 0 1px rgba(12,22,44,.12), 0 18px 54px rgba(0,0,0,.15); overflow:hidden }
#sb-embed .sb-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; padding:12px 12px; border-bottom:1px dashed rgba(12,22,44,.12) }
#sb-embed .sb-tabs{ display:flex; flex-wrap:wrap; gap:8px }
#sb-embed .sb-tab{ border:none; border-radius:10px; padding:8px 10px; font-weight:900; cursor:pointer; background:linear-gradient(180deg,#fff,#f0f5ff); box-shadow:0 8px 0 rgba(0,0,0,.12),0 16px 36px rgba(0,0,0,.12), inset 0 0 0 1px rgba(255,255,255,.7) }
#sb-embed .sb-tab.active{ outline:2px solid #0ea5e9 }
#sb-embed .sb-body{ padding:14px 14px 18px; max-height:360px; overflow:auto; font-size:14px; line-height:1.6; white-space:pre-wrap }
#sb-embed .sb-close{ border:none; border-radius:10px; padding:8px 10px; font-weight:900; cursor:pointer; background:linear-gradient(180deg,#fff,#f0f5ff) }
#sb-toast{ position:fixed; left:50%; top:14%; transform:translateX(-50%) translateY(-10px); z-index:9999; display:none;
  padding:10px 16px; border-radius:12px; font-weight:900; box-shadow:0 10px 26px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.75); }
#sb-toast.ok{ background:linear-gradient(180deg,#eafff3,#c9ffe3); color:#064e3b; outline:2px solid #34d399; }
#sb-toast.err{ background:linear-gradient(180deg,#ffecec,#ffdede); color:#7f1d1d; outline:2px solid #f87171; }
#sb-toast.show{ display:block; animation:sbtoast .9s ease forwards; }
@keyframes sbtoast{ 0%{ opacity:0; transform:translateX(-50%) translateY(-8px) scale(.98) } 15%{ opacity:1; transform:translateX(-50%) translateY(0) scale(1) } 85%{ opacity:1 } 100%{ opacity:0; transform:translateX(-50%) translateY(-6px) scale(.98) } }
#sb-levels{ display:none; margin-top:14px; padding:16px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#eef4ff); color:#0b1220; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08) }
#sb-levels .lv-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
#sb-levels .lv-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
#sb-levels .lv-btn{ border:none; cursor:pointer; padding:16px 12px; border-radius:14px; font-weight:900; box-shadow: 0 12px 0 rgba(0,0,0,.18), 0 20px 48px rgba(0,0,0,.22), inset 0 0 0 1px rgba(255,255,255,.8); background-image: linear-gradient(180deg, #ffffff, #eef4ff) }
#sb-levels .lv-btn[disabled]{ filter:grayscale(.2) opacity(.85); cursor:not-allowed }
</style>

<script data-sb="runtime">
(function(){
  const $ = (q,root=document)=> root.querySelector(q);
  const $$ = (q,root=document)=> Array.from(root.querySelectorAll(q));
  let menuRowEl = null;

  function modIsSentence(){
    const t = (document.getElementById('modTitle')?.textContent || '').trim();
    return t.includes('词语组句');
  }
  function findButtonsRow(btn){
    let el = btn;
    for(let i=0;i<6 && el;i++){
      const bts = el.querySelectorAll && el.querySelectorAll('button');
      if(bts && bts.length >= 2) return el;
      el = el.parentElement;
    }
    return null;
  }

  function hueStyle(idx){
    const h=(idx*67)%360, s=92, l1=97, l2=86;
    return {
      bg:`linear-gradient(180deg, hsl(${h} ${s}% ${l1}%), hsl(${h} ${s}% ${l2}%))`,
      sh:`0 10px 0 hsl(${h} 55% 40% / .28)`
    };
  }

  const BANK = [
    { idx:1, tokens:["来自","国家","你","哪个"], answerTokens:["你","来自","哪个","国家"], analysis:{
      "中文":`正确答案：你来自哪个国家。
“你”为主语；谓语“来自”表达来源；“哪个”作定语修饰“国家”，构成疑问宾语“哪个国家”，整体语序为主—谓—宾（疑问）。

技巧 / Tips：
找主语：确定“你”
定谓语：用“来自”表示来源
设疑问：把“哪个”放在“国家”前作定语
成句：主语 + 谓语 + 宾语（疑问）`,
      "英文":`The correct answer is ：你来自哪个国家
EN：Which country are you from?
In this sentence, “你” (you) is the subject; “来自” (are from) is the predicate; “哪个” (which) modifies “国家” (country) to form the interrogative object “哪个国家”. The order is “subject + predicate + interrogative object”.

Tips:
Identify the subject: “你”(you)
Choose the predicate: “来自”(are from) for origin
Build the question: put “哪个”(which) before “国家”(country)
Form: Subject + Predicate + Interrogative Object`,
      "法语":`The correct answer is ：你来自哪个国家
FR：De quel pays viens-tu ?
Ici, « 你 » (tu) est le sujet ; « 来自 » (venir de) est le prédicat ; « 哪个 » (quel) modifie « 国家 » (pays) pour former « 哪个国家 ». Ordre : sujet + prédicat + groupe interrogatif.

Tips :
Sujet : « 你 » ; Prédicat : « 来自 »
Interrogatif : placer « 哪个 » devant « 国家 »
Schéma : Sujet + Prédicat + Groupe interrogatif`,
      "泰语":`The correct answer is ：你来自哪个国家
TH：คุณมาจากประเทศไหน
ในประโยคนี้ “คุณ” เป็นประธาน; “มาจาก” เป็นกริยาบอกที่มา; “ไหน” ขยาย “ประเทศ” เป็น “ประเทศไหน” ตามลำดับ ประธาน + กริยา + กรรม(คำถาม)

Tips:
ระบุประธาน: “คุณ”
แสดงที่มา: ใช้ “มาจาก”
กำหนดคำถาม: ใส่ “ไหน” หน้า “ประเทศ”
โครง: ประธาน + กริยา + กรรม(คำถาม)`,
      "俄语":`The correct answer is ：你来自哪个国家
RU: Ты из какой страны? / Из какой ты страны?
«你» — подлежащее; «来自/из» — сказуемое происхождения; «哪个/какой» — определение к «国家/страна», образуя вопрос «какой страны».

Tips:
Подлежащее: «你»
Источник: сказуемое «来自/из»
Вопрос: «哪个/какой» перед «国家/страна»
Схема: Подлежащее + Сказуемое + Объект(вопрос)`,
      "老挝语":`The correct answer is ：你来自哪个国家
LO: ເຈົ້າມາຈາກປະເທດໃດ?
«你» ແມ່ນປະທານ; «来自» ແມ່ນກິລິຍາບອກທີ່ມາ; «哪个» ຂະຫຍາຍ «国家» ເປັນ «哪个国家».

Tips:
ປະທານ: «你» ; ກິລິຍາ: «来自»
ຖາມ: ໃສ່ «哪个» ໜ້າ «国家»
ໂຄງ: ປະທານ + ກິລິຍາ + ກຳ(ຄຳຖາມ)` } },
    { idx:2, tokens:["大学生","英国","的","我是","来"], answerTokens:["我是","英国","来","的","大学生"], analysis:{
      "中文":`正确答案：我是英国来的大学生。
“是”为系动词；“英国来的”为动词性短语充当定语，修饰中心名词“大学生”，表示“来自英国的”；整体结构为“主语+系表（表语含定语）”。

技巧 / Tips：
定主语：确定“我”
立系词：用“是”引出表语
加定语：将“英国来的”前置修饰“大学生”
成句：主语 + 系词 + 表语（含定语）`,
      "英文":`The correct answer is ：我是英国来的大学生
EN: I am a college student from the UK.
Here, “我是…” is a copular structure; “英国来的” (from the UK) is an attributive phrase modifying “大学生” (college student) to indicate origin.

Tips:
Subject + copula: “我 + 是 …”
Attributive of origin: put “英国来的” before “大学生”
Form: Subject + Copula + Predicate Noun (with attributive)`,
      "法语":`The correct answer is ：我是英国来的大学生
FR：Je suis un(e) étudiant(e) venu(e) du Royaume-Uni / originaire du Royaume-Uni.
Structure copulative « 我 + 是 … » ; « 英国来的 » modifie « 大学生 » pour marquer l’origine.

Tips :
Sujet + copule : « 我 + 是 … »
Origine : « 英国来的 » avant « 大学生 »
Schéma : Sujet + Copule + Nom du prédicat (avec épithète)`,
      "泰语":`The correct answer is ：我是英国来的大学生
TH: ฉันเป็นนักศึกษาที่มาจากสหราชอาณาจักร

Tips:
ประธาน + กริยาเชื่อม “เป็น”
วลีที่มา “จากอังกฤษ” ขยาย “นักศึกษา”
รูป: ประธาน + เป็น + นาม(มีส่วนขยาย)`,
      "俄语":`The correct answer is ：我是英国来的大学生
RU: Я студент из Великобритании.

Tips:
Связка: «я (есть)»
Происхождение: «из Великобритании» к «студент»
Схема: Подлежащее + Связка + Именная часть(с определением)`,
      "老挝语":`The correct answer is ：我是英国来的大学生
LO: ຂ້ອຍເປັນນັກສຶກສາທີ່ມາຈາກສະຫະລາຊອານາຈັກ.

Tips:
ໂຄງ: ປະທານ + ເປັນ + ນາມ(ມີສ່ວນຂະຫຍາຍ)
ບອກທີ່ມາ: “ທີ່ມາຈາກ…” ຂະຫຍາຍ “ນັກສຶກສາ”` } },
    { idx:3, tokens:["姐姐","两个","林娜","有"], answerTokens:["林娜","有","两个","姐姐"], analysis:{
      "中文":`正确答案：林娜有两个姐姐。
“林娜”为主语；“有”为表示“拥有/存在”的谓语动词；“两个姐姐”为“数词+量词+名词”的数量短语作宾语，语序自然顺畅。

技巧 / Tips：
找主语：确定“林娜”
明谓语：用“有”表“拥有”
配数量：数词+量词+名词（两个+姐姐）
成句：主语 + 谓语 + 宾语（数量短语）`,
      "英文":`The correct answer is ：林娜有两个姐姐
EN: Linna has two older sisters.

Tips:
Subject: “林娜”
Predicate: “有”(has)
Object: “两个姐姐”(two older sisters)`,
      "法语":`The correct answer is ：林娜有两个姐姐
FR：Linna a deux grandes sœurs.

Tips :
Sujet : « 林娜 » ; Verbe : « 有 »
Objet : « 两个姐姐 » (2 + CL + nom)
Schéma : Sujet + Verbe + Objet`,
      "泰语":`The correct answer is ：林娜有两个姐姐
TH: ลินน่ามีพี่สาวสองคน

Tips:
ประธาน: ลินน่า
กริยา: มี
กรรม: พี่สาวสองคน`,
      "俄语":`The correct answer is ：林娜有两个姐姐
RU: У Линны две старшие сестры.

Tips:
Подлежащее: «Линна»
Сказуемое: «имеет/есть» («有»)
Дополнение: «две старшие сестры»`,
      "老挝语":`The correct answer is ：林娜有两个姐姐
LO: ລິນນາມີພີ່ສາວສອງຄົນ.

Tips:
ປະທານ: ລິນນາ
ກິລິຍາ: ມີ
ກຳ: ພີ່ສາວສອງຄົນ` } },
    { idx:4, tokens:["很好吃","巧克力","送给","你","我的"], answerTokens:["你","送给","我的","巧克力","很好吃"], analysis:{
      "中文":`正确答案：你送给我的巧克力很好吃。
因为“你送给我的”是定语，修饰“巧克力”，表示巧克力的来源；
谓语“很好吃”放在最后，描述巧克力的状态，符合中文“修饰语+主语+谓语”的结构。

技巧 / Tips：
找主语：确定核心事物——“巧克力”
加定语：“你送给我的”放在“巧克力”前
放谓语：“很好吃”置于句末
定语 + 主语 + 谓语`,
      "英文":`The correct answer is ：你送给我的巧克力很好吃
EN：The chocolate you gave me is very delicious.
"你送给我的"(you gave me) is an attributive that modifies the subject "巧克力"(chocolate).
The predicate "很好吃"(is very delicious) is placed at the end.

Tips:
Subject: “巧克力”
Attributive: “你送给我的” before “巧克力”
Predicate: put “很好吃” at the end`,
      "法语":`The correct answer is ：你送给我的巧克力很好吃
FR：Le chocolat que tu m’as offert est délicieux.

Tips :
Sujet : « 巧克力 »
Épithète : « 你送给我的 » avant « 巧克力 »
Prédicat : « 很好吃 » en fin de phrase`,
      "泰语":`The correct answer is ：你送给我的巧克力很好吃
TH：ช็อกโกแลตที่คุณให้ฉันอร่อยมาก

Tips:
ประธาน: “巧克力”
ส่วนขยาย: “你送给我的” ไว้หน้า “巧克力”
ภาคแสดง: วาง “很好吃” ท้ายประโยค`,
      "俄语":`The correct answer is ：你送给我的巧克力很好吃
RU: Шоколад, который ты мне подарил(а), очень вкусный.

Tips:
Подлежащее: «巧克力»
Определение: «ты мне подарил» перед «巧克力»
Сказуемое: «очень вкусный» в конце`,
      "老挝语":`The correct answer is ：你送给我的巧克力很好吃
LO: ຊັອກໂກແລັດທີ່ເຈົ້າໃຫ້ຂ້ອຍ ແຊບຫຼາຍ

Tips:
ປະທານ: “巧克力”
ຄໍາຂະຫຍາຍ: “你送给我的” ຢູ່ໜ້າ “巧克力”
ພາກສະແດງ: “很好吃” ຢູ່ທ້າຍປະໂຫຍກ` } }
  ];

  function ensureMount(){
    const stage = document.getElementById('stage');
    if(!stage) return null;

    let embed = document.getElementById('sb-embed');
    if(!embed){
      embed = document.createElement('div');
      embed.id = 'sb-embed';
      embed.innerHTML = `
        <div class="sb-top">
          <div class="sb-topbar">
            <div style="font-weight:900;">词语组句 · 试玩游戏 / Sentence Building · Demo</div>
            <button class="sb-mini" id="sb-back">返回上一级 / Back</button>
          </div>
          <div class="sb-ins">
            <div>每题下方有若干个备选单词，请将这些单词组成一个通顺的句子，并按照顺序将这些单词拖动到下方的方框中，全部正确，可以进入下一题。</div>
            <small>There are several candidate words below each question. Please arrange them into a coherent sentence and drag them, in order, into the box below. If all are correct, you can proceed to the next question.</small>
          </div>
        </div>
        <div id="sb-toast" role="status" aria-live="polite"></div>
        <div class="sb-pool" id="sb-pool" aria-label="备选单词区"></div>
        <div class="sb-slot-wrap"><div class="sb-slot" id="sb-slot" aria-label="目标槽（拖入区域）"></div></div>
        <div class="sb-toolbar">
          <button class="sb-mini" id="sb-prev">&larr; 上一题 / Previous</button>
          <button class="sb-mini primary" id="sb-confirm">确定 Confirm?</button>
          <button class="sb-mini" id="sb-next">下一题 / Next &rarr;</button>
          <div style="font-weight:900; padding:10px 8px;">当前第 <span id="sb-cur">1</span> 题 / 总 <span id="sb-total">0</span> 题  |  EN：Question <span id="sb-cur-en">1</span> / <span id="sb-total-en">0</span></div>
        </div>
        <div class="sb-panel" id="sb-panel" aria-live="polite">
          <div class="sb-head">
            <div class="sb-tabs">
              <button class="sb-tab" data-lang="英文">英文English</button>
              <button class="sb-tab" data-lang="中文">中文Chinese</button>
              <button class="sb-tab" data-lang="法语">法语Français</button>
              <button class="sb-tab" data-lang="泰语">泰语Thai</button>
              <button class="sb-tab" data-lang="俄语">俄语Русский</button>
              <button class="sb-tab" data-lang="老挝语">老挝语Lao</button>
            </div>
            <button class="sb-close" id="sb-close">关闭 Close</button>
          </div>
          <div class="sb-body" id="sb-body">加载中…</div>
        </div>
      `;
      stage.appendChild(embed);
    }

    let lv = document.getElementById('sb-levels');
    if(!lv){
      lv = document.createElement('div');
      lv.id = 'sb-levels';
      lv.innerHTML = `
        <div class="lv-top">
          <div style="font-weight:900;">词语组句 · 请选择级别 / Sentence Building · Choose Level</div>
          <button class="sb-mini" id="sb-lv-back">返回上一级 / Back</button>
        </div>
        <div class="lv-grid">
          <button class="lv-btn" disabled title="Coming soon">Level 1</button>
          <button class="lv-btn" disabled title="Coming soon">Level 2</button>
          <button class="lv-btn" disabled title="Coming soon">Level 3</button>
          <button class="lv-btn" disabled title="Coming soon">Level 4</button>
        </div>
      `;
      stage.appendChild(lv);
    }
    return stage;
  }

  let idx = 0;
  function render(){
    const pool = document.getElementById('sb-pool');
    const slot = document.getElementById('sb-slot');
    const cur = document.getElementById('sb-cur');
    const curEn = document.getElementById('sb-cur-en');
    const tot = document.getElementById('sb-total');
    const totEn = document.getElementById('sb-total-en');

    const q = BANK[idx];
    pool.innerHTML=''; slot.innerHTML='';
    q.tokens.forEach((t,k)=>{
      const d=document.createElement('div');
      d.className='sb-tile'; d.textContent=t; d.setAttribute('draggable','true'); d.dataset.token=t;
      const sty = hueStyle(k); d.style.setProperty('--tile-bg', sty.bg); d.style.setProperty('--tile-shadow', sty.sh);
      d.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t); d.classList.add('dragging'); });
      d.addEventListener('dragend', ()=> d.classList.remove('dragging'));
      pool.appendChild(d);
    });

    cur.textContent = String(idx+1); curEn.textContent = String(idx+1);
    tot.textContent = String(BANK.length); totEn.textContent = String(BANK.length);
  }
  function seqInSlot(){ return Array.from(document.querySelectorAll('#sb-slot .sb-tile')).map(n=>n.dataset.token); }
  function flyBack(){
    const slot = document.getElementById('sb-slot');
    slot.classList.add('sb-shake');
    const ch=[...slot.children];
    ch.forEach(n=> n.classList.add('sb-flyback'));
    setTimeout(()=>{ ch.forEach(n=>{ n.classList.remove('sb-flyback'); document.getElementById('sb-pool').appendChild(n); }); slot.classList.remove('sb-shake'); }, 420);
  }
  function showPanel(lang='英文'){
    const p=document.getElementById('sb-panel'), body=document.getElementById('sb-body');
    document.querySelectorAll('#sb-embed .sb-tab').forEach(t=> t.classList.toggle('active', t.dataset.lang===lang));
    body.textContent = BANK[idx].analysis[lang] || '（无该语言解析 No analysis in this language）';
    p.style.display='block';
  }
  function showToast(msgCN, msgEN, ok=true){
    const el = document.getElementById('sb-toast');
    el.className = 'show ' + (ok ? 'ok' : 'err');
    el.textContent = (msgCN || '') + ' / ' + (msgEN || '');
    el.style.display='none'; void el.offsetWidth; el.style.display='';
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); }, 1100);
  }

  function hideMenuRow(btn){
    if(!menuRowEl) menuRowEl = findButtonsRow(btn);
    if(menuRowEl) menuRowEl.style.display = 'none';
  }
  function showMenuRow(){ if(menuRowEl) menuRowEl.style.display = ''; }

  document.addEventListener('click', function(ev){
    const id = (ev.target && ev.target.id) || '';
    if(!modIsSentence()) return;

    if(id==='actDemo'){
      ev.preventDefault();
      const stage = ensureMount(); if(!stage) return;
      hideMenuRow(ev.target);

      const slot = document.getElementById('sb-slot');
      const pool = document.getElementById('sb-pool');
      slot.addEventListener('dragover', e=>{ e.preventDefault(); slot.classList.add('dragging'); });
      slot.addEventListener('dragleave', ()=> slot.classList.remove('dragging'));
      slot.addEventListener('drop', e=>{
        e.preventDefault();
        const t = e.dataTransfer.getData('text/plain');
        const node = [...pool.children, ...slot.children].find(n=> n.dataset && n.dataset.token===t && n.classList.contains('sb-tile'));
        if(node){ slot.appendChild(node); }
        slot.classList.remove('dragging');
      });
      pool.addEventListener('dragover', e=> e.preventDefault());
      pool.addEventListener('drop', e=>{
        e.preventDefault();
        const t=e.dataTransfer.getData('text/plain');
        const node=[...pool.children, ...slot.children].find(n=> n.dataset && n.dataset.token===t && n.classList.contains('sb-tile'));
        if(node){ pool.appendChild(node); }
      });

      $('#sb-prev').onclick = ()=>{ if(idx>0){ idx--; render(); } };
      $('#sb-next').onclick = ()=>{ if(idx<BANK.length-1){ idx++; render(); } };
      $('#sb-confirm').onclick = ()=>{
        const seq = seqInSlot(), ans = BANK[idx].answerTokens;
        if(seq.length!==ans.length){ showToast('答错了','Incorrect!',false); flyBack(); return; }
        const ok = seq.every((t,i)=> t===ans[i]);
        if(!ok){ showToast('答错了','Incorrect!',false); flyBack(); return; }
        showToast('答对了','Correct!',true);
        setTimeout(()=> showPanel('英文'), 200);
      };
      $('#sb-close').onclick = ()=> $('#sb-panel').style.display='none';
      $('#sb-back').onclick = ()=>{ $('#sb-panel').style.display='none'; document.getElementById('sb-embed').style.display='none'; showMenuRow(); };
      $$('#sb-embed .sb-tab').forEach(tab=>{
        tab.onclick = ()=>{ $$('#sb-embed .sb-tab').forEach(x=> x.classList.remove('active')); tab.classList.add('active'); $('#sb-body').textContent = BANK[idx].analysis[tab.dataset.lang] || '（无该语言解析）'; };
      });

      document.getElementById('sb-levels').style.display='none';
      document.getElementById('sb-embed').style.display='block';
      idx=0; render();
      document.getElementById('sb-embed').scrollIntoView({behavior:'smooth', block:'center'});
    }

    if(id==='actStart'){
      ev.preventDefault();
      const stage = ensureMount(); if(!stage) return;
      hideMenuRow(ev.target);
      $('#sb-panel') && ($('#sb-panel').style.display='none');
      document.getElementById('sb-embed').style.display='none';
      const lv = document.getElementById('sb-levels');
      lv.style.display='block';
      $('#sb-lv-back').onclick = ()=>{ lv.style.display='none'; showMenuRow(); };
      lv.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }, true);
})();
</script>
<!-- SB END -->

</body>
</html>
