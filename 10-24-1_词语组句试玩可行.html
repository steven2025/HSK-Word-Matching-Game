<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSKå•è¯æ¸¸æˆ Â· HSK Word Game (Fixed v5)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2b;
      --neon1:#7afcff;
      --neon2:#b693ff;
      --neon3:#5cff9d;
      --btnDepth: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1000px 500px at 10% -20%, rgba(122,252,255,.12), transparent 60%),
                  radial-gradient(800px 400px at 90% 0%, rgba(182,147,255,.12), transparent 55%),
                  linear-gradient(180deg, #0b1220 0%, #0a0f1c 100%);
      color:#e9f1ff; overflow-x:hidden;
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 56px; }

    .hero{ position:relative; border-radius:18px; padding:32px 20px; margin-top:8px; margin-bottom:18px;
      background: linear-gradient(145deg, rgba(17,26,43,.92), rgba(15,23,39,.75));
      box-shadow: inset 0 0 0 1px rgba(122,252,255,.08), 0 30px 80px rgba(0,0,0,.45); overflow:hidden; }
    .hero::before{ content:""; position:absolute; inset:-2px; border-radius:20px;
      background: conic-gradient(from 210deg, rgba(122,252,255,.15), rgba(182,147,255,.18), rgba(92,255,157,.15), rgba(122,252,255,.15));
      filter: blur(26px); opacity:.55; pointer-events:none; mask: radial-gradient(120% 120% at 50% 0%, black 40%, transparent 55%); }
    .title-cn,.title-en{ text-align:center; margin:0; letter-spacing:2px; }
    .title-cn{ font-size:42px; font-weight:800; }
    .title-en{ font-size:28px; font-weight:700; opacity:.92; }
    .glowtext{ background: linear-gradient(90deg, #e9f1ff, #8ee7ff, #c4b5ff, #9bffcc, #e9f1ff); background-size:200% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hueMove 10s linear infinite, shimmer 3.6s ease-in-out infinite; text-shadow: 0 0 12px rgba(122,252,255,.15), 0 0 22px rgba(182,147,255,.12); }
    @keyframes hueMove{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
    @keyframes shimmer{ 0%,100%{filter:drop-shadow(0 0 0 rgba(0,0,0,0))} 50%{filter:drop-shadow(0 0 14px rgba(122,252,255,.35))} }

    .top-actions{ display:flex; gap:12px; align-items:center; padding:12px 4px 0; }
    .top-actions .spacer{ flex:1; }

    .btn{ --c1:var(--neon1); --c2:var(--neon2); position:relative; border:none; outline:none; cursor:pointer; user-select:none; font-weight:700; font-size:14px; letter-spacing:.3px; color:#0b1220; padding:12px 18px; border-radius:12px;
      background: linear-gradient(180deg, white, #dfe8ff);
      box-shadow: 0 var(--btnDepth) 0 rgba(0,0,0,.35), 0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.7), 0 0 0 1px rgba(122,252,255,.25), 0 0 24px rgba(182,147,255,.25);
      transition: transform .15s ease, box-shadow .15s ease;
      background-image: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,244,255,.95)), radial-gradient(120% 140% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(120% 140% at 110% 120%, var(--c2) 0%, transparent 45%);
    }
    .btn:hover{ transform:translateY(-3px); box-shadow: 0 calc(var(--btnDepth)+3px) 0 rgba(0,0,0,.36), 0 18px 36px rgba(0,0,0,.45), 0 0 36px rgba(122,252,255,.35); }
    .btn:active{ transform:translateY(2px); box-shadow: 0 calc(var(--btnDepth)-2px) 0 rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.35); }

    .sound-wrap{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .switch{ position:relative; width:54px; height:28px; background:#2a3652; border-radius:999px; cursor:pointer; box-shadow: inset 0 0 0 1px rgba(122,252,255,.2); }
    .switch::after{ content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background: linear-gradient(180deg, #fff, #e6eeff); box-shadow: 0 6px 12px rgba(0,0,0,.45); transition: left .2s ease; }
    .switch.on{ background: linear-gradient(90deg, rgba(122,252,255,.45), rgba(182,147,255,.45)); }
    .switch.on::after{ left:29px; }
    .volume{ accent-color:#7afcff; height:28px; }
    .label{ font-size:13px; opacity:.92; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:22px; margin-top:18px; }
    .grid .span2{ grid-column: span 2; }

    .card{ position:relative; border-radius:18px; padding:26px 24px; text-align:center; overflow:hidden; cursor:pointer; user-select:none; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 18px 60px rgba(0,0,0,.45); transition: transform .18s ease, box-shadow .18s ease, filter .18s ease; }
    .card:hover{ transform: translateY(-6px); filter:saturate(1.12); box-shadow: inset 0 0 0 1px rgba(122,252,255,.2), 0 24px 80px rgba(0,0,0,.55), 0 0 48px rgba(122,252,255,.28); }
    .card::before{ content:""; position:absolute; inset:0; background: radial-gradient(220px 120px at var(--mx,50%) var(--my,50%), rgba(122,252,255,.18), transparent 55%); pointer-events:none; transition: background .15s ease; }

    .cn{ font-size:26px; font-weight:800; margin-bottom:8px; text-shadow: 0 2px 0 rgba(0,0,0,.3), 0 0 18px rgba(122,252,255,.2); }
    .en{ font-size:16px; font-weight:700; opacity:.95; }

    .red{ background: linear-gradient(180deg, rgba(255,103,103,.15), rgba(255,103,103,.05)); }
    .green{ background: linear-gradient(180deg, rgba(76,252,169,.15), rgba(76,252,169,.05)); }
    .blue{ background: linear-gradient(180deg, rgba(91,157,255,.18), rgba(91,157,255,.06)); }
    .amber{ background: linear-gradient(180deg, rgba(255,199,95,.18), rgba(255,199,95,.06)); }
    .purple{ background: linear-gradient(180deg, rgba(208,143,255,.18), rgba(208,143,255,.06)); }
    .teal{ background: linear-gradient(180deg, rgba(86,236,255,.16), rgba(86,236,255,.06)); }

    .stage{ display:none; margin-top:18px; border-radius:20px; padding:28px 18px 34px; background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(235,243,255,.92)); color:#0e1422; box-shadow: inset 0 0 0 1px rgba(10,20,40,.08), 0 24px 80px rgba(0,0,0,.35); }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .module-title{ font-weight:900; font-size:28px; letter-spacing:.5px; background: linear-gradient(90deg, #1d2140, #193a59, #1d2140); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:none; }
    .subtitle{ font-size:14px; opacity:.7; }

    .stage-actions{ display:grid; grid-template-columns: repeat(3, 1fr); gap:22px; }
    
    .action-btn{ --c1:#00d4ff; --c2:#0077ff; color:#0a1020; font-weight:900; font-size:18px; padding:24px 18px; border-radius:18px; border:none; cursor:pointer; user-select:none; box-shadow: 0 14px 0 rgba(0,0,0,.25), 0 22px 54px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.7); background-image: linear-gradient(180deg, rgba(255,255,255,.94), rgba(242,248,255,.99)), radial-gradient(140% 160% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(140% 160% at 110% 120%, var(--c2) 0%, transparent 45%); transition: transform .15s ease, box-shadow .15s ease; }
    .action-btn:hover{ transform: translateY(-4px); box-shadow: 0 16px 0 rgba(0,0,0,.26), 0 26px 64px rgba(0,0,0,.35); }
    .action-btn:active{ transform: translateY(2px); box-shadow: 0 9px 0 rgba(0,0,0,.3), 0 18px 36px rgba(0,0,0,.32); }
    .act-demo{ --c1:#7afcff; --c2:#8ec5ff; }
    .act-import{ --c1:#ffd37a; --c2:#ffb36b; }

    .game{ position:relative; display:none; margin-top:18px; border-radius:22px; background: linear-gradient(180deg, #f9fbff, #edf4ff); color:#0f1430; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
    .game-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px 8px; border-bottom:1px dashed rgba(12,22,44,.12); }
    .game-left{ font-weight:900; font-size:18px; }
    .progress{ font-weight:800; font-size:14px; opacity:.85; }

    .lang-row{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px; }
    .lang-btn{ border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); transition:.15s; }
    .lang-btn.active{ outline:2px solid #0ea5e9; box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 22px 48px rgba(0,0,0,.22); }

    .jump{ display:flex; align-items:center; gap:8px; }
    .jump input{ width:86px; padding:8px 10px; border-radius:10px; border:1px solid rgba(12,22,44,.18); }

    .board{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; padding:18px; }
    .col{ display:grid; grid-template-rows: repeat(5, 64px); gap:12px; padding:12px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,245,255,.95)); box-shadow: inset 0 0 0 1px rgba(12,22,44,.08); }
    .col-cn{ --tileC:#ffb347; }
    .col-py{ --tileC:#7ee081; }
    .col-tr{ --tileC:#7ec8ff; }

    .tile{ display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; border-radius:12px; cursor:pointer; user-select:none; font-weight:900; color:#0b1220; background: linear-gradient(180deg, #fff, #eaf2ff); box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; border:2px solid rgba(0,0,0,.06); position:relative; z-index:0; }
    
/* Column-colored tiles (default, not only on click) */
.col-cn .tile{
  background: linear-gradient(180deg, #ffe0b3, #ffb347);
  color:#0b1220;
}
.col-py .tile{
  background: linear-gradient(180deg, #cfeedd, #7ee081);
  color:#0b1220;
}
.col-tr .tile{
  background: linear-gradient(180deg, #d8eeff, #7ec8ff);
  color:#0b1220;
}

/* Slightly stronger hover so color pops */
.col-cn .tile:hover, .col-py .tile:hover, .col-tr .tile:hover{
  filter: brightness(1.05) saturate(1.05);
}

/* Selected: brighten further and add subtle glow with column color */
.col-cn .tile.selected, .col-py .tile.selected, .col-tr .tile.selected{
  filter: brightness(1.2) saturate(1.15);
  box-shadow: 0 12px 0 rgba(0,0,0,.2), 0 26px 52px rgba(0,0,0,.25), 0 0 0 2px rgba(255,255,255,.9), 0 0 14px var(--tileC);
}
.tile::after{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 48px rgba(0,0,0,.12); opacity:.65; pointer-events:none; z-index:-1; }
    .tile:hover{ transform: translateY(-3px); box-shadow: 0 14px 0 rgba(0,0,0,.2), 0 28px 56px rgba(0,0,0,.26); }
    .tile.selected{ outline:3px solid var(--tileC); filter: brightness(1.25) saturate(1.2); }
    .tile.correct{ animation: flashOut .6s ease forwards; }
    .tile.wrong{ animation: shake .25s ease; }

    @keyframes flashOut{ 0%{ opacity:1; filter:brightness(1); } 50%{ opacity:.35; filter:brightness(1.6); } 100%{ opacity:0; transform: scale(.96); } }
    @keyframes shake{ 0%,100%{ transform:translateX(0); } 25%{ transform:translateX(-4px); } 75%{ transform:translateX(4px); } }

    .game-bottom{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px 20px; border-top:1px dashed rgba(12,22,44,.12); }
    .mini-btn{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }

    .finish-overlay{ display:none; position:absolute; inset:0; backdrop-filter: blur(4px); background: rgba(255,255,255,.6); align-items:center; justify-content:center; gap:14px; padding:16px; text-align:center; }
    .finish-overlay .btn{ font-size:16px; }

    .wrongpad{ position:fixed; right:18px; bottom:18px; width:320px; max-height:60vh; overflow:auto; 
  background:linear-gradient(180deg,#ffffff,#eef2ff); border-radius:14px; box-shadow: 0 18px 54px rgba(0,0,0,.35); 
  display:none; padding:14px; color:#0b1220; transition:all .25s ease; transform:scale(0.98); opacity:0; }
    .wrongpad h4{ margin:0 0 8px; }
    .wrongpad .witem{ 
  font-size:13px; padding:8px 10px; border-radius:10px; background:#f6f7ff; 
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.12); margin-bottom:8px; 
  border-left:4px solid #0077ff; font-weight:600; color:#0a1638; }

    @media (max-width: 900px){
      .stage-actions{ grid-template-columns: 1fr; }
      .board{ grid-template-columns: 1fr; }
      .col{ grid-template-rows: repeat(5, 58px); }
    }

    footer{ margin-top:28px; font-size:12px; opacity:.8; text-align:center; }
  .wrongpad.show{ transform:scale(1); opacity:1; } 
.tile.wrong{ animation: shake .25s ease; } 

/* Added for Start Game third button layout */
@media (max-width: 1100px){
  .stage-actions{ grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 700px){
  .stage-actions{ grid-template-columns: 1fr; }
}

/* Levels panel styling */
.levels-panel{ display:none; margin-top:16px; padding:16px; border-radius:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(238,244,255,.96));
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.08);
  color:#0b1220;
}
.levels-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.levels-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
@media (max-width: 700px){
  .levels-grid{ grid-template-columns: repeat(2, 1fr); }
}
.lv-btn{ border:none; cursor:pointer; padding:16px 12px; border-radius:14px; font-weight:900;
  box-shadow: 0 12px 0 rgba(0,0,0,.18), 0 20px 48px rgba(0,0,0,.22), inset 0 0 0 1px rgba(255,255,255,.8);
  background-image: linear-gradient(180deg, #ffffff, #eef4ff);
}


/* One-row lesson grid: 10 columns on wide screens, wraps on smaller widths */
.lessons-grid-10{ display:grid; grid-template-columns: repeat(10, 1fr); gap:12px; }
@media (max-width: 1400px){
  .lessons-grid-10{ grid-template-columns: repeat(5, 1fr); }
}
@media (max-width: 860px){
  .lessons-grid-10{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 560px){
  .lessons-grid-10{ grid-template-columns: repeat(2, 1fr); }
}


/* === Subflow (levels/lessons/game) UI cleanup === */
.subflow #btnRegister,
.subflow #btnLogin,
.subflow .sound-wrap { display: none !important; }

.levels-panel, .lessons-panel { max-width: 1200px; margin-left:auto; margin-right:auto; }
.levels-panel .levels-grid,
.lessons-panel .levels-grid { justify-items: center; }

/* One-row centered lessons grid */
.lessons-grid-10{ display:grid; grid-template-columns: repeat(10, 1fr); gap:12px; justify-items:center; }
@media (max-width: 1400px){
  .lessons-grid-10{ grid-template-columns: repeat(5, 1fr); }
}
@media (max-width: 860px){
  .lessons-grid-10{ grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 560px){
  .lessons-grid-10{ grid-template-columns: repeat(2, 1fr); }
}


.lang-chooser .mini-select{ padding:6px 8px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff; }


/* Center the levels/lessons panels */
#levelsPanel, #lessonsPanel{
  max-width: 1200px;
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 24px;
}
/* In single-view, ensure container centers content */
body.subflow section, body.subflow #app, body.subflow .container{
  margin-left:auto; margin-right:auto;
}

</style>
</head>
<body>
  <div class="container">
    <section class="hero" id="hero">
      <h1 class="title-cn glowtext">HSKå•è¯æ¸¸æˆ</h1>
      <h2 class="title-en glowtext">HSK Word Game</h2>
      <div class="top-actions">
        <div class="spacer"></div>
        <button class="btn" id="btnRegister" aria-haspopup="dialog">æ³¨å†Œ Register</button>
        <button class="btn" id="btnLogin" aria-haspopup="dialog">ç™»å½• Login</button>
        <div class="sound-wrap" title="éŸ³æ•ˆä¸éŸ³é‡">
          <span class="label">éŸ³æ•ˆ Sound</span>
          <div id="soundSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="éŸ³é‡ Volume" />
        </div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">è¯·é€‰æ‹©çº§åˆ« / Choose Level</div>
          <button class="mini-btn" id="levelsClose">å…³é—­ / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">åˆçº§1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">åˆçº§2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">ä¸­çº§1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">ä¸­çº§2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">é«˜çº§1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">é«˜çº§2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">åˆçº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 1 Â· Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">è¿”å›ä¸Šä¸€çº§ / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">ç¬¬1-3è¯¾<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">ç¬¬4-6è¯¾<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">ç¬¬7-9è¯¾<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">ç¬¬10-12è¯¾<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">ç¬¬13-15è¯¾<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">ç¬¬16-18è¯¾<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">ç¬¬19-21è¯¾<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">ç¬¬22-24è¯¾<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">ç¬¬25-27è¯¾<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">ç¬¬28-30è¯¾<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="grid" id="menu">
      <div class="card red" data-key="dev-cn">
        <div class="cn">å‘å±•æ±‰è¯­è¯æ±‡</div>
        <div class="en">Developing Chinese Vocabulary</div>
      </div>
      <div class="card green" data-key="hsk">
        <div class="cn">HSKè¯æ±‡</div>
        <div class="en">HSK Vocabulary</div>
      </div>
      <div class="card blue" data-key="fill">
        <div class="cn">é€‰è¯å¡«ç©º</div>
        <div class="en">Fill in the Blanks</div>
      </div>
      <div class="card amber" data-key="build">
        <div class="cn">è¯è¯­ç»„å¥</div>
        <div class="en">Sentence Building</div>
      </div>
      <div class="card purple" data-key="order">
        <div class="cn">å¥å­æ’åº</div>
        <div class="en">Sentence Ordering</div>
      </div>
      <div class="card teal" data-key="banks">
        <div class="cn">è·å–è¯åº“å’Œé¢˜åº“</div>
        <div class="en">Get Word & Question Banks</div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">è¯·é€‰æ‹©çº§åˆ« / Choose Level</div>
          <button class="mini-btn" id="levelsClose">å…³é—­ / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">åˆçº§1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">åˆçº§2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">ä¸­çº§1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">ä¸­çº§2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">é«˜çº§1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">é«˜çº§2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">åˆçº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 1 Â· Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">è¿”å›ä¸Šä¸€çº§ / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">ç¬¬1-3è¯¾<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">ç¬¬4-6è¯¾<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">ç¬¬7-9è¯¾<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">ç¬¬10-12è¯¾<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">ç¬¬13-15è¯¾<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">ç¬¬16-18è¯¾<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">ç¬¬19-21è¯¾<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">ç¬¬22-24è¯¾<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">ç¬¬25-27è¯¾<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">ç¬¬28-30è¯¾<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="game" id="gameDemo" aria-hidden="true">
      <div class="game-top">
        <div class="game-left">
          <span id="levelInfo">å…³å¡ï¼š<strong>1</strong></span>
          &nbsp;|&nbsp;
          <span class="progress">è¿›åº¦ <span id="passed">0</span>/<span id="total">0</span></span>
        </div>
        <div class="jump">
          <label>è·³å¾€ç¬¬ <input type="number" id="jumpInput" min="1" value="1" /> å…³</label>
          <button class="btn" id="jumpGo">Go</button>
        </div>
      </div>
      <div class="lang-row" id="langRow"></div>
      <div class="board" id="board">
        <div class="col col-cn" id="colCN" aria-label="ä¸­æ–‡åˆ—"></div>
        <div class="col col-py" id="colPY" aria-label="æ‹¼éŸ³åˆ—"></div>
        <div class="col col-tr" id="colTR" aria-label="ç¿»è¯‘åˆ—"></div>
      </div>
      <div class="game-bottom">
        <button class="mini-btn" id="btnTip">æç¤º / Tips</button>
        <button class="mini-btn" id="btnShuffle">é‡æ’åº / Reshuffle</button>
        <button class="mini-btn" id="btnSave">ä¿å­˜ / Save</button>
        <button class="mini-btn" id="btnBack">è¿”å›ä¸Šä¸€çº§ / Back</button>
        <button class="mini-btn" id="btnWrong">é”™è¯æœ¬ / Wrong Book</button>
      </div>
      <div class="finish-overlay" id="finish">
        <div id="finishText" style="font-weight:800; margin-bottom:8px;">æœ¬å…³å®Œæˆï¼</div>
        <div>
          <button class="btn" id="btnPrev">è¿”å›ä¸Šä¸€å…³</button>
          <button class="btn" id="btnNext">ç»§ç»­ä¸‹ä¸€å…³</button>
        </div>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">è¯·é€‰æ‹©çº§åˆ« / Choose Level</div>
          <button class="mini-btn" id="levelsClose">å…³é—­ / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">åˆçº§1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">åˆçº§2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">ä¸­çº§1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">ä¸­çº§2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">é«˜çº§1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">é«˜çº§2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">åˆçº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 1 Â· Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">è¿”å›ä¸Šä¸€çº§ / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">ç¬¬1-3è¯¾<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">ç¬¬4-6è¯¾<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">ç¬¬7-9è¯¾<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">ç¬¬10-12è¯¾<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">ç¬¬13-15è¯¾<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">ç¬¬16-18è¯¾<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">ç¬¬19-21è¯¾<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">ç¬¬22-24è¯¾<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">ç¬¬25-27è¯¾<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">ç¬¬28-30è¯¾<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <section class="stage" id="stage">
      <div class="stage-header">
        <div>
          <div class="module-title" id="modTitle">æ¨¡å—æ ‡é¢˜</div>
          <div class="subtitle" id="modSub">Module Subtitle</div>
        </div>
        <button class="btn" id="btnBackTop">è¿”å›ä¸»èœå• / Back</button>
      </div>
      <div class="stage-actions">
        <button class="action-btn" id="actStart" style="--c1:#9dffa8; --c2:#7ee081;">å¼€å§‹æ¸¸æˆ<br><small>Start Game</small></button>
        <button class="action-btn act-demo" id="actDemo">è¯•ç©æ¸¸æˆ<br><small>Demo (Built-in 20)</small></button>
        <button class="action-btn act-import" id="actImport">å¯¼å…¥è¯åº“ç©æ¸¸æˆ<br><small>Import & Play</small></button>
        <input id="fileImport" type="file" accept=".csv,.txt" style="display:none" />
        <button class="action-btn" id="btnClearTrial" style="display:none; --c1:#ff9aa2; --c2:#ff6f91;">æ¸…é™¤å¯¼å…¥è¯åº“<br><small>Clear Imported Bank</small></button>
      
      <div class="levels-panel" id="levelsPanel">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">è¯·é€‰æ‹©çº§åˆ« / Choose Level</div>
          <button class="mini-btn" id="levelsClose">å…³é—­ / Close</button>
        </div>
        <div class="levels-grid">
          <button class="lv-btn" data-level="beg1">åˆçº§1<br><small>Elementary 1</small></button>
          <button class="lv-btn" data-level="beg2">åˆçº§2<br><small>Elementary 2</small></button>
          <button class="lv-btn" data-level="int1">ä¸­çº§1<br><small>Intermediate 1</small></button>
          <button class="lv-btn" data-level="int2">ä¸­çº§2<br><small>Intermediate 2</small></button>
          <button class="lv-btn" data-level="adv1">é«˜çº§1<br><small>Advanced 1</small></button>
          <button class="lv-btn" data-level="adv2">é«˜çº§2<br><small>Advanced 2</small></button>
        </div>
      </div>

    
      <div class="levels-panel" id="lessonsPanel" style="display:none">
        <div class="levels-header">
          
<div class="lang-chooser" style="display:none" id="langChooser" style="display:flex; align-items:center; gap:8px;">
  <label for="langSelect" style="font-weight:700;">ç¿»è¯‘è¯­è¨€ / Translation</label>
  <select id="langSelect" class="mini-select">
    <option value="en">English</option>
    <option value="th">Thai</option>
    <option value="vi">Vietnamese</option>
    <option value="lo">Lao</option>
    <option value="fr">French</option>
    <option value="ja">Japanese</option>
    <option value="ko">Korean</option>
    <option value="ru">Russian</option>
    <option value="de">German</option>
    <option value="es">Spanish</option>
  </select>
</div>

          <div style="font-weight:900;">åˆçº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 1 Â· Choose Lessons</div>
          <button class="mini-btn" id="lessonsBack">è¿”å›ä¸Šä¸€çº§ / Back</button>
        </div>
        <div class="levels-grid lessons-grid-10">
          <button class="lv-btn lesson-btn" data-lesson="1-3">ç¬¬1-3è¯¾<br><small>Lesson 1-3</small></button>
          <button class="lv-btn lesson-btn" data-lesson="4-6">ç¬¬4-6è¯¾<br><small>Lesson 4-6</small></button>
          <button class="lv-btn lesson-btn" data-lesson="7-9">ç¬¬7-9è¯¾<br><small>Lesson 7-9</small></button>
          <button class="lv-btn lesson-btn" data-lesson="10-12">ç¬¬10-12è¯¾<br><small>Lesson 10-12</small></button>
          <button class="lv-btn lesson-btn" data-lesson="13-15">ç¬¬13-15è¯¾<br><small>Lesson 13-15</small></button>
          <button class="lv-btn lesson-btn" data-lesson="16-18">ç¬¬16-18è¯¾<br><small>Lesson 16-18</small></button>
          <button class="lv-btn lesson-btn" data-lesson="19-21">ç¬¬19-21è¯¾<br><small>Lesson 19-21</small></button>
          <button class="lv-btn lesson-btn" data-lesson="22-24">ç¬¬22-24è¯¾<br><small>Lesson 22-24</small></button>
          <button class="lv-btn lesson-btn" data-lesson="25-27">ç¬¬25-27è¯¾<br><small>Lesson 25-27</small></button>
          <button class="lv-btn lesson-btn" data-lesson="28-30">ç¬¬28-30è¯¾<br><small>Lesson 28-30</small></button>
        </div>
      </div>

    </div>
    </section>

    <footer>
      Copyright Held by: Mr. Yan Qinghua, Chongqing Technology and Business University (CTBU)<br/>
      Support by: Teaching and Research Section of TCFL, CTBU
    </footer>
  </div>

  <dialog id="dlgRegister">
    <form method="dialog" id="formRegister" style="min-width:300px">
      <h3>æ³¨å†Œ Register</h3>
      <label>ç”¨æˆ·å Username<br/>
        <input id="regName" required maxlength="24" />
      </label><br/><br/>
      <label>å¯†ç  Password<br/>
        <input id="regPass" type="password" required minlength="4" />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">å–æ¶ˆ Cancel</button>
        <button class="btn" value="default">æäº¤ Submit</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form method="dialog" id="formLogin" style="min-width:300px">
      <h3>ç™»å½• Login</h3>
      <label>ç”¨æˆ·å Username<br/>
        <input id="logName" required />
      </label><br/><br/>
      <label>å¯†ç  Password<br/>
        <input id="logPass" type="password" required />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">å–æ¶ˆ Cancel</button>
        <button class="btn" value="default">ç™»å½• Login</button>
      </menu>
    </form>
  </dialog>

  <div class="wrongpad" id="wrongPad">
    <h4>é”™è¯æœ¬ Wrong Book</h4>
    <div id="wrongList"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button class="mini-btn" id="wrongClose">å…³é—­ / Close</button>
      <button class="mini-btn" id="wrongClear">æ¸…ç©º / Clear</button>
    </div>
  </div>

  <div id="toastStack"></div>

  <script>

    // === Global Single-View Navigation (fix for showSection not defined) ===
    (function(){
      const VIEWS = ['menu','stage','levelsPanel','lessonsPanel','gameDemo'];
      window.showSection = function(id){
        VIEWS.forEach(function(k){
          var el = document.getElementById(k);
          if(el){ el.style.display = (k===id)?'block':'none'; }
        });
        if(id==='menu'){ document.body.classList.remove('subflow'); }
        else { document.body.classList.add('subflow'); }
      };
      // ensure menu shows by default if nothing else has chosen
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', function(){ try{ showSection('menu'); }catch(e){} });
      }else{
        try{ showSection('menu'); }catch(e){}
      }
    })();


    /* Shim */
    (function(){
      if(typeof window.Intercom!=="function"){
        const q=[]; const shim=function(){ q.push(arguments); };
        shim.q=q; shim.boot=function(){}; shim.shutdown=shim.show=shim.hide=shim.update=function(){};
        window.Intercom=shim;
      }
      window.notifyNavigation = window.notifyNavigation || function(){};
      window.notifyIntrinsicHeight = window.notifyIntrinsicHeight || function(){};
      window.__hostApi = window.__hostApi || {};
      ["notifyNavigation","notifyIntrinsicHeight"].forEach(k=>{
        if(typeof window.__hostApi[k]!=="function") window.__hostApi[k]=function(){};
      });
      window.addEventListener("unhandledrejection", function(e){
        const msg = (e && e.reason && (e.reason.stack||e.reason.message||e.reason)) || "";
        if(String(msg).match(/Intercom|Host API|notifyNavigation|notifyIntrinsicHeight/)) e.preventDefault();
      });
    })();

    const $ = (q)=>document.querySelector(q);

    /* ===== Users & Trial store ===== */
    const store = {
      get users(){ return JSON.parse(localStorage.getItem('hsk_users')||'{}'); },
      set users(v){ localStorage.setItem('hsk_users', JSON.stringify(v)); },
      get session(){ return JSON.parse(localStorage.getItem('hsk_session')||'null'); },
      set session(v){ localStorage.setItem('hsk_session', JSON.stringify(v)); },
      get trial(){ return JSON.parse(localStorage.getItem('dev_trial_words')||'null'); },
      set trial(v){ localStorage.setItem('dev_trial_words', JSON.stringify(v)); }
    };

    const btnRegister = $('#btnRegister');
    const btnLogin = $('#btnLogin');
    const dlgRegister = $('#dlgRegister');
    const dlgLogin = $('#dlgLogin');

    function safeShowModal(d){
      if(!d.open){ try{ d.showModal(); }catch{ d.setAttribute('open',''); } }
    }
    function safeClose(d){
      if(d.open){ try{ d.close(); }catch{ d.removeAttribute('open'); } }
    }

    function refreshAuthUI(){
      const s = store.session;
      if(s && s.username){
        btnRegister.textContent = `ğŸ‘‹ æ¬¢è¿ ${s.username}`;
        btnRegister.disabled = true;
        btnLogin.textContent = 'é€€å‡º Logout';
      }else{
        btnRegister.textContent = 'æ³¨å†Œ Register';
        btnRegister.disabled = false;
        btnLogin.textContent = 'ç™»å½• Login';
      }
    }

    btnRegister.addEventListener('click', ()=>{ if(!store.session) safeShowModal(dlgRegister); });
    btnLogin.addEventListener('click', ()=>{
      if(store.session){ store.session = null; refreshAuthUI(); showToast('å·²é€€å‡º / Logged out','success'); return; }
      safeShowModal(dlgLogin);
    });

    document.getElementById('formRegister').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#regName').value.trim();
      const pass = $('#regPass').value;
      if(!name || !pass) return;
      const users = store.users;
      if(users[name]){ showToast('ç”¨æˆ·åå·²å­˜åœ¨ / Username exists','error'); return; }
      users[name] = { password: pass };
      store.users = users;
      store.session = { username: name };
      safeClose(dlgRegister); refreshAuthUI();
      showToast('æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½• / Registered & Signed in','success');
    });

    document.getElementById('formLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#logName').value.trim();
      const pass = $('#logPass').value;
      const users = store.users;
      if(!users[name] || users[name].password !== pass){ showToast('ç”¨æˆ·æˆ–å¯†ç é”™è¯¯ / Invalid credentials','error'); return; }
      store.session = { username: name };
      safeClose(dlgLogin); refreshAuthUI();
      showToast('ç™»å½•æˆåŠŸ / Signed in','success');
    });

    refreshAuthUI();

    /* ===== Audio ===== */
    const soundSwitch = document.getElementById('soundSwitch');
    const volume = document.getElementById('volume');
    let audioCtx, masterGain, isOn = true;

    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volume.value || 0.6);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function applySwitchUI(){ soundSwitch.classList.toggle('on', isOn); soundSwitch.setAttribute('aria-checked', String(isOn)); }
    function toggleSound(){ isOn = !isOn; applySwitchUI(); }
    applySwitchUI();

    soundSwitch.addEventListener('click', ()=>{ ensureAudio(); toggleSound(); });
    soundSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); ensureAudio(); toggleSound(); } });
    volume.addEventListener('input', ()=>{ ensureAudio(); if(masterGain) masterGain.gain.value = Number(volume.value||0.6); });

    function playSfx(type='click'){
      if(!isOn) return;
      ensureAudio();
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = (type==='err') ? 'square' : 'sine';
      const cfg = {
        click: { f: 660, dur: 0.08 },
        ok:    { f: 880, dur: 0.14 },
        err:   { f: 180, dur: 0.18 },
        done:  { f: 520, dur: 0.24 },
        shuffle:{ f: 740, dur: 0.10 }
      }[type] || { f: 660, dur: 0.08 };
      osc.frequency.setValueAtTime(cfg.f, now);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + cfg.dur);
      osc.connect(gain).connect(masterGain);
      osc.start(now);
      osc.stop(now + cfg.dur + 0.02);
    }

    /* ===== Module Nav ===== */
    const menu = document.getElementById('menu');
    const stage = document.getElementById('stage');
    const modTitle = document.getElementById('modTitle');
    const modSub = document.getElementById('modSub');
    const btnBackTop = document.getElementById('btnBackTop');
    const actDemo = document.getElementById('actDemo');
    const actImport = document.getElementById('actImport');
    const fileImport = document.getElementById('fileImport');
    const btnClearTrial = document.getElementById('btnClearTrial');

    function openModule(key, titleCN, titleEN){
      modTitle.textContent = titleCN;
      modSub.textContent = titleEN;
      menu.style.display = 'none';
      stage.style.display = 'block';
      showToast('è¿›å…¥æ¨¡å—ï¼š' + titleCN, 'success');
      stage.dataset.key = key;
      btnClearTrial.style.display = store.trial ? 'inline-block':'none';
    }
    function backHome(){ stage.style.display='none'; menu.style.display='grid'; }

    document.querySelectorAll('#menu .card').forEach(c=>{
      c.addEventListener('mousemove',(e)=>{
        const r = c.getBoundingClientRect();
        const x = ((e.clientX - r.left)/r.width)*100;
        const y = ((e.clientY - r.top)/r.height)*100;
        c.style.setProperty('--mx', x+'%');
        c.style.setProperty('--my', y+'%');
      });
      c.addEventListener('click', ()=>{
        const key = c.getAttribute('data-key');
        if(key==='banks'){ showToast('â€œè·å–è¯åº“å’Œé¢˜åº“â€é¡µé¢ç¨åæä¾› / Coming soon','info'); return; }
        if(!store.session){ showToast('ä»¥æ¸¸å®¢æ¨¡å¼è¿›å…¥ã€‚å¯åœ¨å³ä¸Šè§’æ³¨å†Œ/ç™»å½•ä»¥ä¿å­˜è¿›åº¦ã€‚','info'); }
        const cn = c.querySelector('.cn').textContent.trim();
        const en = c.querySelector('.en').textContent.trim();
        playSfx('click'); openModule(key, cn, en);
      });
    });

    btnBackTop.addEventListener('click', backHome);

    
    actDemo.addEventListener('click', ()=>{
      playSfx('click');
      const key = stage.dataset.key;
      if(key === 'dev-cn'){
        showSection('gameDemo');
        initDemo(false); // original demo
        showToast('å‘å±•æ±‰è¯­Â·è¯•ç©ï¼ˆå†…ç½® 20 ä¸ªè¯ï¼‰å¼€å§‹','success');
      } else if (key === 'hsk'){
        startHSKDemo(); // reuse same engine with swapped dataset
      } else if (key === 'fill') { startFillDemo(); } else {
        showToast('ã€'+modTitle.textContent+'ã€‘è¯•ç©æ¨¡å¼å¯åŠ¨ / Demo startingâ€¦','info');
      }
    });
actImport.addEventListener('click', ()=>{
      playSfx('click'); fileImport.click();
    });

    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){
          showToast('å¯¼å…¥å¤±è´¥ï¼šæœªè§£æåˆ°æœ‰æ•ˆæ¡ç›®ã€‚','error'); return;
        }
        const uniq = [];
        const seen = new Set();
        for(const w of parsed){
          const k = (w.cn||'') + '|' + (w.py||'');
          if(!seen.has(k)){ seen.add(k); uniq.push(w); }
          if(uniq.length>=20) break;
        }
        if(uniq.length<5){
          showToast('å¯¼å…¥æ¡ç›®å¤ªå°‘ï¼Œè‡³å°‘éœ€è¦ 5 æ¡ã€‚','error'); return;
        }
        store.trial = uniq;
        btnClearTrial.style.display = 'inline-block';
        showToast(`æˆåŠŸå¯¼å…¥ ${uniq.length} æ¡ã€‚è¯¥è¯åº“å°†ç”¨äºâ€œå¯¼å…¥è¯åº“ç©æ¸¸æˆâ€æ¨¡å¼ã€‚`,'success');
      }catch(err){
        console.error(err);
        showToast('å¯¼å…¥å‡ºé”™ï¼šæ–‡ä»¶è¯»å–æˆ–è§£æå¤±è´¥ã€‚','error');
      }finally{
        fileImport.value = '';
      }
    });

    btnClearTrial.addEventListener('click', ()=>{
      store.trial = null;
      btnClearTrial.style.display = 'none';
      showToast('å·²æ¸…é™¤å¯¼å…¥è¯åº“ã€‚','success');
    });

    /* ===== Toast ===== */

    const actStart = document.getElementById('actStart');
    const levelsPanel = document.getElementById('levelsPanel');
    const levelsClose = document.getElementById('levelsClose');

    if (actStart){
      actStart.addEventListener('click', ()=>{
        if(stage.dataset.key === 'fill'){ FillLevel.open(); showToast && showToast('è¯·é€‰æ‹©çº§åˆ« / Choose a level','success'); return; }
        playSfx('click');
        if(stage.dataset.key !== 'dev-cn'){
          showToast('â€œå¼€å§‹æ¸¸æˆ / Start Gameâ€ç›®å‰ä»…ç”¨äºã€å‘å±•æ±‰è¯­è¯æ±‡ã€‘æ¨¡å—ã€‚','info');
          return;
        }
        showSection('levelsPanel');
        showToast('è¯·é€‰æ‹©çº§åˆ« / Choose a level','success');
      });
    }
    if (levelsClose){
      levelsClose.addEventListener('click', ()=>{
        levelsPanel.style.display = 'none';
      });
    }
    levelsPanel?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lv-btn');
      if(!btn) return;
      const lv = btn.getAttribute('data-level');
      playSfx('click');
      // Placeholder: future hookup to real datasets per level.
    // --- Start Game -> Levels -> Lessons wiring ---
    const lessonsPanel = document.getElementById('lessonsPanel');
    const lessonsBack = document.getElementById('lessonsBack');

    // Open lessons under Elementary 1
    levelsPanel?.addEventListener('click', (e)=>{
      const b = e.target.closest('.lv-btn');
      if(!b) return;
      const level = b.getAttribute('data-level');
      if(level==='beg1'){ // Elementary 1
        levelsPanel.style.display='none';
        lessonsPanel.style.display='block';
      }
    });

    lessonsBack?.addEventListener('click', ()=>{
      showSection('levelsPanel');
    });

    // Map of lesson -> raw file URL (we wire 1-3 now; others to be provided)
    const LESSON_URL = {
      "1-3": "https://raw.githubusercontent.com/steven2025/gif2025/43159a799eee708cb6cb85521d988b68160663e0/%E5%88%9D%E7%BA%A71-Lesson%201-3_multilingual.txt",
      "4-6": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A7%201-Lesson%204-6_multilingual.txt",
      "10-12": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2010-12_multilingual.txt",
      "13-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2013-15_multilingual.txt",
      "16-18": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2016-18_multilingual.txt",
      "19-21": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2019-21_multilingual.txt",
      "22-24": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2022-24_multilingual.txt",
      "25-27": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2025-27_multilingual.txt",
      "28-30": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%2028-30_multilingual.txt",
      "7-9": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A71-Lesson%207-9_multilingual.txt",
      "beg2-1-5": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%201-5_multilingual.txt",
      "beg2-11-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2011-15_multilingual.txt",
      "beg2-16-20": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2016-20_multilingual.txt",
      "beg2-21-25": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%2021-25_multilingual.txt",
      "beg2-6-10": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%88%9D%E7%BA%A72-Lesson%206-10_multilingual.txt",
      "int1-1-3": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson1-3_multilingual.txt",
      "int1-10-12": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson10-12_multilingual.txt",
      "int1-13-15": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson13-15_multilingual.txt",
      "int1-4-6": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson4-6_multilingual.txt",
      "int1-7-9": "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E4%B8%AD%E7%BA%A71-lesson7-9_multilingual.txt"
    };

    
    
    // === Unified Single-View Navigation ===
    const VIEWS = ['menu','stage','levelsPanel','lessonsPanel','gameDemo'];
    function showSection(id){
      VIEWS.forEach(k=>{ const el = document.getElementById(k); if(el) el.style.display = (k===id)?'block':'none'; });
      // hide header controls in any sub-level
      if(id==='menu'){ document.body.classList.remove('subflow'); }
      else { document.body.classList.add('subflow'); }
    }
    // Ensure on load we show menu only
    window.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('langChooser')?.remove(); showSection('menu'); });

// --- Subflow: hide welcome/logout/sound in levels/lessons/game ---

    // Language selection for translations in subflow
    const langSelect = document.getElementById('langSelect');
    if(langSelect){
      const saved = localStorage.getItem('trLang') || 'en';
      langSelect.value = saved;
      langSelect.addEventListener('change', ()=>{
        localStorage.setItem('trLang', langSelect.value);
        showToast('å·²åˆ‡æ¢ç¿»è¯‘è¯­è¨€ï¼š' + langSelect.options[langSelect.selectedIndex].text, 'info');
        // If a dataset is loaded, remap TR and refresh board
        if (Array.isArray(store.trial) && store.trial.length){
          const remapped = store.trial.map(o=>{
            const tr = (o[langSelect.value] && String(o[langSelect.value]).trim()) || o.en || o.tr || '';
            return Object.assign({}, o, { tr });
          });
          store.trial = remapped;
          if (typeof resetAndStartFromTrial === 'function'){
            resetAndStartFromTrial();
          }
        }
      });
    }

    // prefer user-chosen lang over detection
    function detectUILangCode(){
      const chosen = (document.getElementById('langSelect')?.value) || localStorage.getItem('trLang');
      if (chosen) return chosen.toLowerCase();
      // fallback detection map (unchanged below)
      const map = {
        cn:['ä¸­æ–‡','chinese','cn','zh','zh-cn','æ±‰è¯­','æ±‰å­—'],
        py:['æ‹¼éŸ³','pinyin','py'],
        en:['è‹±è¯­','english','en','eng'],
        th:['æ³°','thai','th','æ³°è¯­'],
        vi:['è¶Š','vietnamese','vi','è¶Šå—è¯­'],
        lo:['è€','lao','lo','è€æŒè¯­'],
        fr:['æ³•','french','fr','æ³•è¯­'],
        ja:['æ—¥','japanese','ja','æ—¥è¯­','æ—¥æœ¬è¯­'],
        ko:['éŸ©','korean','ko','éŸ©è¯­'],
        ru:['ä¿„','russian','ru','ä¿„è¯­'],
        de:['å¾·','german','de','å¾·è¯­'],
        es:['è¥¿','spanish','es','è¥¿è¯­','è¥¿ç­ç‰™è¯­']
      };
      const candidates = [
        (localStorage.getItem('uiLang')||''),
        (localStorage.getItem('lang')||''),
        (window.uiLang||''),
        (document.documentElement.getAttribute('lang')||''),
        (stage?.dataset?.lang||'')
      ].map(s=>String(s).toLowerCase().trim()).filter(Boolean);
      for(const raw of candidates){
        for(const code in map){
          if(map[code].some(k=>raw.includes(k))) return code;
        }
        if(map[raw]) return raw;
      }
      return 'en';
    }

    function enterSubflow(){ document.body.classList.add('subflow'); }

    function resetAndStartFromTrial(){
      if(!Array.isArray(store.trial) || !store.trial.length) return;
      // route to demo game engine with current trial
      stage.style.display='none';
      document.getElementById('gameDemo').style.display='block';
      initDemo(true);
    }
    
    function exitSubflow(){ document.body.classList.remove('subflow'); }

    // === Hook your existing language buttons ===
    const LANG_MAP = {
      'è‹±è¯­': 'en','English':'en',
      'æ³°è¯­':'th','Thai':'th',
      'è¶Šå—è¯­':'vi','Vietnamese':'vi',
      'è€æŒè¯­':'lo','Lao':'lo',
      'æ³•è¯­':'fr','French':'fr',
      'æ—¥è¯­':'ja','Japanese':'ja',
      'éŸ©è¯­':'ko','Korean':'ko',
      'ä¿„è¯­':'ru','Russian':'ru',
      'å¾·è¯­':'de','German':'de',
      'è¥¿ç­ç‰™è¯­':'es','Spanish':'es'
    };
    window.setTranslationLang = function(code){ try{ localStorage.setItem('trLang', code); }catch{} };
    document.addEventListener('click',(e)=>{
      const t = (e.target.closest('button, .btn, .card, .lang, [role="button"]')?.textContent||'').trim();
      for(const k in LANG_MAP){
        if(t.includes(k)){ localStorage.setItem('trLang', LANG_MAP[k]); break; }
      }
    }, true);


    // enter subflow when levels open
    if (actStart){
      actStart.addEventListener('click', ()=>{ enterSubflow(); });
    }
    // back button that returns to main stage should exit subflow (if exists)
    const stageBack = document.getElementById('stageBack');
    stageBack?.addEventListener('click', ()=>{ exitSubflow(); });

    // robust UI language detection for external wordbanks
    function detectUILangCode(){
      const map = {
        cn:['ä¸­æ–‡','chinese','cn','zh','zh-cn','æ±‰è¯­','æ±‰å­—'],
        py:['æ‹¼éŸ³','pinyin','py'],
        en:['è‹±è¯­','english','en','eng'],
        th:['æ³°','thai','th','æ³°è¯­'],
        vi:['è¶Š','vietnamese','vi','è¶Šå—è¯­'],
        lo:['è€','lao','lo','è€æŒè¯­'],
        fr:['æ³•','french','fr','æ³•è¯­'],
        ja:['æ—¥','japanese','ja','æ—¥è¯­','æ—¥æœ¬è¯­'],
        ko:['éŸ©','korean','ko','éŸ©è¯­'],
        ru:['ä¿„','russian','ru','ä¿„è¯­'],
        de:['å¾·','german','de','å¾·è¯­'],
        es:['è¥¿','spanish','es','è¥¿è¯­','è¥¿ç­ç‰™è¯­']
      };
      const candidates = [
        (localStorage.getItem('uiLang')||''),
        (localStorage.getItem('lang')||''),
        (window.uiLang||''),
        (document.documentElement.getAttribute('lang')||''),
        (stage?.dataset?.lang||'')
      ].map(s=>String(s).toLowerCase().trim()).filter(Boolean);

      for(const raw of candidates){
        for(const code in map){
          if(map[code].some(k=>raw.includes(k))) return code;
        }
        // direct code match
        if(map[raw]) return raw;
      }
      return 'en'; // fallback
    }

    function mapParsedToTarget(parsed){
      const code = detectUILangCode();
      return parsed.map(o=>{
        const tr = (o[code] && String(o[code]).trim()) || o.en || '';
        return Object.assign({}, o, { tr });
      });
    }

    async function startFromExternal(url){
      try{
        showToast('æ­£åœ¨åŠ è½½è¯åº“â€¦ / Loading word bankâ€¦','info');
        const resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok){ throw new Error('HTTP ' + resp.status); }
        const text = await resp.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){ throw new Error('No valid entries parsed'); }
        const patched = mapParsedToTarget(parsed);
        store.trial = patched;
        // enter game screen with imported dataset
        showSection('gameDemo');
        initDemo(true); enterSubflow();
        showToast('å·²åŠ è½½å¤–éƒ¨è¯åº“å¹¶å¼€å§‹æ¸¸æˆ / Loaded external word bank.','success');
      }catch(err){
        console.error(err);
        showToast('åŠ è½½å¤±è´¥ï¼š' + (err.message||err),'error');
      }
    }

    lessonsPanel?.addEventListener('click', (e)=>{
      const b = e.target.closest('.lesson-btn');
      if(!b) return;
      const key = b.getAttribute('data-lesson');
      playSfx('click');
      if(!LESSON_URL[key]){
        showToast('è¯¥è¯¾æ®µçš„è¯åº“ç¨åæ¥å…¥ / Coming soon for ' + key, 'info');
        return;
      }
      startFromExternal(LESSON_URL[key]);
    });

      showToast('å·²é€‰æ‹©ï¼š' + btn.textContent.replace(/\s+/g,'' ) + 'ï¼ˆå³å°†æ¥å…¥è¯åº“ï¼‰','success');
      // Keep panel open for now; you can hide it if preferred:
      // levelsPanel.style.display = 'none';
    });

    
function showToast(msg, type='info') {
  try {
    var t = (type || 'info').toString().toLowerCase();
    var message = (typeof msg === 'string') ? msg : String(msg);
    // Only show if it's error/warn or message contains allowed success keywords
    var allowLight = /(åŠ è½½æˆåŠŸ|ä¸Šä¼ æˆåŠŸ|ä¿å­˜æˆåŠŸ|æˆåŠŸ|å·²ä¿å­˜)/.test(message);
    if (t !== 'error' && t !== 'warn' && t !== 'warning' && !allowLight) {
      return;
    }
  } catch (e) {}
  var box = document.getElementById('toastBoxMini');
  if (!box) {
    box = document.createElement('div');
    box.id = 'toastBoxMini';
    box.style.position = 'fixed';
    box.style.left = '50%';
    box.style.top = '24px';
    box.style.transform = 'translateX(-50%)';
    box.style.maxWidth = '80%';
    box.style.padding = '10px 14px';
    box.style.borderRadius = '10px';
    box.style.backdropFilter = 'blur(6px)';
    box.style.boxShadow = '0 6px 18px rgba(0,0,0,.2)';
    box.style.fontSize = '14px';
    box.style.zIndex = '9999';
    box.style.background = 'rgba(0,0,0,.75)';
    box.style.color = '#fff';
    document.body.appendChild(box);
  }
  box.textContent = message;
  box.style.opacity = '1';
  if (window.__toastMiniTimer) clearTimeout(window.__toastMiniTimer);
  window.__toastMiniTimer = setTimeout(function () {
    box.style.opacity = '0';
  }, 1800);
}

    /* ===== Built-in Demo Data (your uploaded 20 words) ===== */
    const DEMO_TXT = `ä½ ,nÇ,you (singular),à¸„à¸¸à¸“,báº¡n,à»€àºˆàº»à»‰àº²,tu/vous,ã‚ãªãŸ,ë„ˆ/ë‹¹ì‹ ,Ñ‚Ñ‹,du,tÃº
å¥½,hÇo,good/fine/nice,à¸”à¸µ,tá»‘t,àº”àºµ,bon,ã„ã„,ì¢‹ì€,Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹,gut,bueno
ä½ ä»¬,nÇ men,you (plural),à¸à¸§à¸à¸„à¸¸à¸“,cÃ¡c báº¡n,àºàº§àºà»€àºˆàº»à»‰àº²,vous,ã‚ãªãŸãŸã¡,ë„ˆí¬/ë‹¹ì‹ ë“¤,Ğ²Ñ‹,ihr,vosotros/ustedes
è€å¸ˆ,lÇo shÄ«,teacher,à¸„à¸£à¸¹,giÃ¡o viÃªn,àº„àº¹,professeur/enseignant,å…ˆç”Ÿ,ì„ ìƒë‹˜,ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ,Lehrer,profesor/maestro
æ—©ä¸Š,zÇo shang,morning/early morning,à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²,buá»•i sÃ¡ng,àº•àº­àº™à»€àºŠàº»à»‰àº²,matin,æœ,ì•„ì¹¨,ÑƒÑ‚Ñ€Ğ¾,Morgen,maÃ±ana
æ˜¯,shÃ¬,be,à¸„à¸·à¸­,lÃ ,à»àº¡à»ˆàº™,Ãªtre,ã§ã™,ì´ë‹¤,Ğ±Ñ‹Ñ‚ÑŒ,sein,ser/estar
å›½,guÃ³,country/state/nation,à¸›à¸£à¸°à¹€à¸—à¸¨/à¸Šà¸²à¸•à¸´,quá»‘c gia,àº›àº°à»€àº—àº”,pays/Ã©tat/nation,å›½,ë‚˜ë¼/êµ­ê°€,ÑÑ‚Ñ€Ğ°Ğ½Ğ°/Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²Ğ¾,Land/Staat/Nation,paÃ­s/estado/naciÃ³n
äºº,rÃ©n,people/human being,à¸„à¸™,ngÆ°á»i,àº„àº»àº™,personne/humain,äºº,ì‚¬ëŒ,Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº/Ğ»ÑĞ´Ğ¸,Mensch/Person,persona/humano
æˆ‘,wÇ’,I/me,à¸‰à¸±à¸™,tÃ´i,àº‚à»‰àº­àº,je/moi,ç§,ë‚˜/ì €,Ñ,ich,yo
ä»–,tÄ,he/him,à¹€à¸‚à¸²,anh áº¥y,àº¥àº²àº§,il/lui,å½¼,ê·¸,Ğ¾Ğ½,er,Ã©l
è¯·é—®,qÇng wÃ¨n,excuse me/may I ask,à¸‚à¸­à¸–à¸²à¸¡,xin há»i,àº‚à»àº–àº²àº¡,excusez-moi/puis-je demander,ã™ã¿ã¾ã›ã‚“,ì‹¤ë¡€í•©ë‹ˆë‹¤/ì—¬ì­¤ë³´ê² ìŠµë‹ˆë‹¤,Ğ¸Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚Ğµ/Ğ¼Ğ¾Ğ³Ñƒ Ñ ÑĞ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ,entschuldigen Sie/darf ich fragen,disculpe/Â¿puedo preguntar?
ä»€ä¹ˆ,shÃ©n me,what,à¸­à¸°à¹„à¸£,gÃ¬,àº«àºàº±àº‡,quoi/que,ä½•,ë¬´ì—‡/ë­,Ñ‡Ñ‚Ğ¾,was,quÃ©
åå­—,mÃ­ng zi,name/given or personal name,à¸Šà¸·à¹ˆà¸­,tÃªn,àºŠàº·à»ˆ,nom,åå‰,ì´ë¦„,Ğ¸Ğ¼Ñ,Name,nombre
å§“,xÃ¬ng,be surnamed,à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥,há»,àºŠàº·à»ˆàºªàº°àºàº¸àº™,nom de famille,è‹—å­—/å§“,ì„±,Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ,Nachname,apellido
é«˜å…´,gÄo xÃ¬ng,glad/happy,à¸”à¸µà¹ƒà¸ˆ,vui má»«ng,àº”àºµà»ƒàºˆ,content/heureux,å¬‰ã—ã„,ê¸°ìœ,Ñ€Ğ°Ğ´/ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¹,froh/glÃ¼cklich,contento/feliz
å¤§å­¦ç”Ÿ,dÃ  xuÃ© shÄ“ng,college or university student,à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²,sinh viÃªn Ä‘áº¡i há»c,àº™àº±àºàºªàº¶àºàºªàº²àº¡àº°àº«àº²àº§àº´àº—àº°àºàº²à»„àº¥,Ã©tudiant universitaire,å¤§å­¦ç”Ÿ,ëŒ€í•™ìƒ,ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ¸Ñ‚ĞµÑ‚Ğ°,UniversitÃ¤tsstudent,estudiante universitario
å‡ ,jÇ,how many,à¸à¸µà¹ˆ,máº¥y,àºàºµà»ˆ,combien,ã„ãã¤,ëª‡,ÑĞºĞ¾Ğ»ÑŒĞºĞ¾,wie viele,cuÃ¡ntos
å·¥ä½œ,gÅng zuÃ²,job/work/task,à¸‡à¸²à¸™,cÃ´ng viá»‡c,àº§àº½àº,travail/emploi,ä»•äº‹,ì¼/ì‘ì—…,Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°,Arbeit/Job,trabajo/empleo
å¾‹å¸ˆ,lÇœ shÄ«,lawyer/attorney,à¸—à¸™à¸²à¸¢à¸„à¸§à¸²à¸¡,luáº­t sÆ°,àº—àº°àº™àº²àºàº„àº§àº²àº¡,avocat,å¼è­·å£«,ë³€í˜¸ì‚¬,Ğ°Ğ´Ğ²Ğ¾ĞºĞ°Ñ‚,Anwalt,abogado
åŒ»ç”Ÿ,yÄ«s hÄ“ng,doctor/medical practitioner,à¸«à¸¡à¸­/à¹à¸à¸—à¸¢à¹Œ,bÃ¡c sÄ©,àº«àº¡à»/à»àºàº”,mÃ©decin/docteur,åŒ»è€…,ì˜ì‚¬,Ğ²Ñ€Ğ°Ñ‡/Ğ´Ğ¾ĞºÑ‚Ğ¾Ñ€,Arzt,mÃ©dico/doctor`;

    
    

    // ===== Embedded HSK Trial Text (from uploaded HSKè¯•ç©å•è¯åº“.txt) =====
    const HSK_TXT = `é˜¿å§¨,Ä yÃ­,aunt,à¸›à¹‰à¸²,dÃ¬,àº›à»‰àº²,tante,ãŠã°,ì´ëª¨,Ñ‚Ñ‘Ñ‚Ñ,Tante,tÃ­a  
çŸ®,Çi,short,à¹€à¸•à¸µà¹‰à¸¢,tháº¥p,àº•à»ˆàº³,petit,ä½ã„,ì‘ì€,Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹,klein,bajo  
çˆ±å¥½,Ã i hÃ o,hobby,à¸‡à¸²à¸™à¸­à¸”à¸´à¹€à¸£à¸,sá»Ÿ thÃ­ch,àº„àº§àº²àº¡àº¡àº±àº,passe-temps,è¶£å‘³,ì·¨ë¯¸,Ñ…Ğ¾Ğ±Ğ±Ğ¸,Hobby,pasatiempo  
å®‰é™,Än jÃ¬ng,quiet,à¹€à¸‡à¸µà¸¢à¸š,yÃªn tÄ©nh,àº‡àº½àºš,calme,é™ã‹ãª,ì¡°ìš©í•œ,Ñ‚Ğ¸Ñ…Ğ¸Ğ¹,ruhig,tranquilo  
æŠŠ,bÇ,hold,à¸ˆà¸±à¸š,cáº§m,àº–àº´àº”,tenir,æŒã¤,ì¡ë‹¤,Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ,halten,sostener  
ç­,bÄn,class,à¸Šà¸±à¹‰à¸™à¹€à¸£à¸µà¸¢à¸™,lá»›p,àºŠàº±à»‰àº™àº®àº½àº™,classe,ã‚¯ãƒ©ã‚¹,ë°˜,ĞºĞ»Ğ°ÑÑ,Klasse,clase  
æ¬,bÄn,move,à¸¢à¹‰à¸²à¸¢,di chuyá»ƒn,àºà»‰àº²àº,dÃ©mÃ©nager,å¼•ã£è¶Šã™,ì´ì‚¬í•˜ë‹¤,Ğ¿ĞµÑ€ĞµĞµĞ·Ğ¶Ğ°Ñ‚ÑŒ,umziehen,mudar  
åŠ,bÃ n,half,à¸„à¸£à¸¶à¹ˆà¸‡,má»™t ná»­a,à»€àº„àº´à»ˆàº‡,moitiÃ©,åŠåˆ†,ë°˜,Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ğ¸Ğ½Ğ°,HÃ¤lfte,mitad  
åŠæ³•,bÃ n fÇ,way; method,à¸§à¸´à¸˜à¸µ,cÃ¡ch,àº§àº´àº—àºµ,mÃ©thode,æ–¹æ³•,ë°©ë²•,ÑĞ¿Ğ¾ÑĞ¾Ğ±,Methode,mÃ©todo  
åŠå…¬å®¤,bÃ n gÅng shÃ¬,office,à¸ªà¸³à¸™à¸±à¸à¸‡à¸²à¸™,vÄƒn phÃ²ng,àº«à»‰àº­àº‡àºàº²àº™,bureau,ã‚ªãƒ•ã‚£ã‚¹,ì‚¬ë¬´ì‹¤,Ğ¾Ñ„Ğ¸Ñ,BÃ¼ro,oficina  
å¸®å¿™,bÄng mÃ¡ng,help,à¸Šà¹ˆà¸§à¸¢,giÃºp Ä‘á»¡,àºŠà»ˆàº§àº,aider,æ‰‹ä¼ã†,ë„ì™€ì£¼ë‹¤,Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ÑŒ,helfen,ayudar  
åŒ…,bÄo,package; bag,à¸«à¹ˆà¸­,gÃ³i,àº«àº¸à»‰àº¡,paquet,åŒ…ã¿,í¬ì¥,Ğ¿Ğ°ĞºĞµÑ‚,Paket,paquete  
åŒ—æ–¹,bÄ›i fÄng,north,à¸—à¸´à¸¨à¹€à¸«à¸™à¸·à¸­,phÃ­a báº¯c,àº—àº´àº”à»€à»œàº·àº­,nord,åŒ—,ë¶ìª½,ÑĞµĞ²ĞµÑ€,Norden,norte  
é¼»å­,bÃ­ zi,nose,à¸ˆà¸¡à¸¹à¸,mÅ©i,àº”àº±àº‡,nez,é¼»,ì½”,Ğ½Ğ¾Ñ,Nase,nariz  
æ¯”è¾ƒ,bÇ jiÃ o,compare,à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š,so sÃ¡nh,àº›àº½àºšàº—àº½àºš,comparer,æ¯”è¼ƒã™ã‚‹,ë¹„êµí•˜ë‹¤,ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ,vergleichen,comparar  
æ¯”èµ›,bÇ sÃ i,match; competition,à¸à¸²à¸£à¹à¸‚à¹ˆà¸‡à¸‚à¸±à¸™,tráº­n Ä‘áº¥u,àºàº²àº™à»àº‚à»ˆàº‡àº‚àº±à¸™,match,è©¦åˆ,ê²½ê¸°,Ğ¼Ğ°Ñ‚Ñ‡,Wettkampf,partido  
ç¬”è®°æœ¬,bÇ jÃ¬ bÄ›n,notebook,à¸ªà¸¡à¸¸à¸”à¸šà¸±à¸™à¸—à¸¶à¸,sá»• tay,àºªàº°à»àº¸àº”àºšàº±àº™àº—àº¶àº,carnet,ãƒãƒ¼ãƒˆ,ê³µì±…,Ğ±Ğ»Ğ¾ĞºĞ½Ğ¾Ñ‚,Notizbuch,cuaderno  
å¿…é¡»,bÃ¬ xÅ«,must,à¸•à¹‰à¸­à¸‡,pháº£i,àº•à»‰àº­àº‡,devoir,å¿…é ˆ,í•„é¡»,Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½,mÃ¼ssen,deber  
å˜åŒ–,biÃ n huÃ ,change,à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡,thay Ä‘á»•i,àº›à»ˆàº½àº™à»àº›àº‡,changer,å¤‰åŒ–ã™ã‚‹,ë³€í™”í•˜ë‹¤,Ğ¼ĞµĞ½ÑÑ‚ÑŒÑÑ,Ã¤ndern,cambiar
é¢åŒ…,miÃ n bÄo,bread,à¸‚à¸™à¸¡à¸›à¸±à¸‡,bÃ¡nh mÃ¬,àº‚àº™àº»àº¡à¸›à¸±à¸‡,pain,ãƒ‘ãƒ³,ë¹µ,Ñ…Ğ»ĞµĞ±,Brot,pan`;
function parseDemo(txt){
      if(!txt) return [];
      // Normalize
      txt = txt.replace(/\uFEFF/g, '');               // BOM
      txt = txt.replace(/ï¼Œ|ï¼›|;/g, ',');              // CN comma/semicolon -> comma
      txt = txt.replace(/\t/g, ',');                  // tabs -> comma
      txt = txt.replace(/\r\n?/g, '\n');              // CRLF/LF -> LF
      txt = txt.replace(/\n{2,}/g, '\n');             // collapse blank lines
      const lines0 = txt.split(/\n/).map(s=>s.trim()).filter(Boolean);
      // Drop header if present
      const hasHeader = lines0.length && /(ä¸­æ–‡|æ±‰å­—|chinese|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en)\b/i.test(lines0[0]);
      const lines = hasHeader ? lines0.slice(1) : lines0;
      const out = [];
      for(const line of lines){
        // split on commas; keep empties
        const parts = line.split(',').map(s=>s.trim());
        if(parts.length < 3) continue;                         // need cn/py/en
        while(parts.length < 12) parts.push('');               // pad
        const [cn, py, en] = parts;
        if(!cn || !py || !en) continue;                        // require first 3
        for(let i=3;i<12;i++){ if(!parts[i]) parts[i]=en; }    // fallback to English
        const [th,vi,lo,fr,ja,ko,ru,de,es] = parts.slice(3,12);
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
      }
      return out;
    }


    const demoDataFull = parseDemo(DEMO_TXT);
    const BUILTIN_LIMIT = 20;
    const demoData = demoDataFull.slice(0, BUILTIN_LIMIT); // exactly 20

    // Language list (default English)
    const LANGS = [
      {code:'en', name:'è‹±è¯­ English',     idx:0, color:'#ffffff'},
      {code:'th', name:'æ³°è¯­ Thai',        idx:1, color:'#ffd37a'},
      {code:'vi', name:'è¶Šå—è¯­ Vietnamese',idx:2, color:'#7afcff'},
      {code:'lo', name:'è€æŒè¯­ Lao',       idx:3, color:'#8ec5ff'},
      {code:'fr', name:'æ³•è¯­ FranÃ§ais',    idx:4, color:'#d6b7ff'},
      {code:'ja', name:'æ—¥è¯­ æ—¥æœ¬èª',      idx:5, color:'#ff91a9'},
      {code:'ko', name:'éŸ©è¯­ í•œêµ­ì–´',      idx:6, color:'#9dffa8'},
      {code:'ru', name:'ä¿„è¯­ Ğ ÑƒÑÑĞºĞ¸Ğ¹',     idx:7, color:'#ffc7a5'},
      {code:'de', name:'å¾·è¯­ Deutsch',     idx:8, color:'#c6ffef'},
      {code:'es', name:'è¥¿ç­ç‰™è¯­ EspaÃ±ol', idx:9, color:'#fdd8ff'}
    ];

    
function parseTrial(text){
  if(!text) return [];
  var t = String(text)
    .replace(/\uFEFF/g,'')
    .replace(/\r\n?/g,'\n')
    .trim();
  var lines = t.split('\n').filter(Boolean);
  if (!lines.length) return [];

  var sep = ( (lines[0].match(/,/g)||[]).length >= (lines[0].match(/\t/g)||[]).length ) ? ',' : '\t';
  var split = function(s){ return s.split(sep).map(function(x){ return x.trim(); }); };

  var header = split(lines[0]).map(function(s){ return s.toLowerCase(); });
  var hasHeader = header.some(function(h){ return /ä¸­æ–‡|æ±‰å­—|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h); });
  var data = hasHeader ? lines.slice(1) : lines;

  var idx = { cn:0, py:1, en:2, th:3, vi:4, lo:5, fr:6, ja:7, ko:8, ru:9, de:10, es:11 };

  if(hasHeader){
    var map = {
      cn:['ä¸­æ–‡','æ±‰å­—','chinese','cn'],
      py:['æ‹¼éŸ³','pinyin','py'],
      en:['è‹±è¯­','english','en'],
      th:['æ³°','thai','th','æ³°è¯­'],
      vi:['è¶Š','vietnamese','vi','è¶Šå—'],
      lo:['è€','lao','lo','è€æŒ'],
      fr:['æ³•','french','fr','æ³•è¯­','franÃ§ais'],
      ja:['æ—¥','japanese','ja','æ—¥è¯­','æ—¥æœ¬'],
      ko:['éŸ©','korean','ko','éŸ©è¯­'],
      ru:['ä¿„','russian','ru','ä¿„è¯­'],
      de:['å¾·','german','de','å¾·è¯­','deutsch'],
      es:['è¥¿','spanish','es','è¥¿è¯­','è¥¿ç­ç‰™','espaÃ±ol']
    };
    Object.keys(map).forEach(function(k){
      var arr = map[k], found = -1;
      for (var a=0; a<arr.length; a++){
        var i = header.findIndex(function(h){ return h.indexOf(arr[a]) >= 0; });
        if(i>=0){ found = i; break; }
      }
      if(found>=0) idx[k]=found;
    });
  } else {
    var sample = split(data[0]);
    if (sample.length >= 12){
      idx = { cn:0, py:1, en:2, th:3, vi:4, lo:5, fr:6, ja:7, ko:8, ru:9, de:10, es:11 };
    }
  }

  var out = [];
  for (var li=0; li<data.length; li++){
    var p = split(data[li]);
    var rec = {
      cn: p[idx.cn]||p[0]||'',
      py: p[idx.py]||p[1]||'',
      en: p[idx.en]||p[2]||'',
      th: idx.th>=0 && idx.th<p.length ? (p[idx.th]||'') : '',
      vi: idx.vi>=0 && idx.vi<p.length ? (p[idx.vi]||'') : '',
      lo: idx.lo>=0 && idx.lo<p.length ? (p[idx.lo]||'') : '',
      fr: idx.fr>=0 && idx.fr<p.length ? (p[idx.fr]||'') : '',
      ja: idx.ja>=0 && idx.ja<p.length ? (p[idx.ja]||'') : '',
      ko: idx.ko>=0 && idx.ko<p.length ? (p[idx.ko]||'') : '',
      ru: idx.ru>=0 && idx.ru<p.length ? (p[idx.ru]||'') : '',
      de: idx.de>=0 && idx.de<p.length ? (p[idx.de]||'') : '',
      es: idx.es>=0 && idx.es<p.length ? (p[idx.es]||'') : ''
    };
    out.push(rec);
  }
  return out;
}


    
    // Build HSK demoData (reuse Developing-Chinese demo engine)
    function buildHSKDemoData(){
      // parse lines
      const rows = HSK_TXT.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!rows.length) return [];
      // detect header
      const header = rows[0].split(/[,	]/).map(s=>s.trim().toLowerCase());
      const hasHeader = header.some(h=>/ä¸­æ–‡|æ±‰å­—|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h));
      const lines = hasHeader ? rows.slice(1) : rows;
      const out = [];
      for(const line of lines.slice(0,20)){ // only need first 20 for demo
        const p = line.split(/[,	]/).map(s=>s.trim());
        const cn = p[0]||'';
        const py = p[1]||'';
        const en = p[2]||'';
        const th = p[3]||en, vi = p[4]||en, lo = p[5]||en,
              fr = p[6]||en, ja = p[7]||en, ko = p[8]||en,
              ru = p[9]||en, de = p[10]||en, es = p[11]||en;
        if(cn && py && en){
          out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
        }
      }
      return out;
    }


    let state = {
      level: 1,
      N: 5,
      maxLevels: 1,
      passed: Number(localStorage.getItem('dev_demo_passed')||0),
      total: demoData.length, // 20
      langIdx: 0, // default English
      choice: { cn:null, py:null, tr:null },
      tiles: { cn:[], py:[], tr:[] },
      mapping: {},
      wrongBook: JSON.parse(localStorage.getItem('dev_demo_wrong')||'[]'),
      matchedCount: 0,
      usingTrial: false,
      trialWords: []
    };

    
    
    
    function updateHudDisplay(){
      try{
        const wordsPlayed = Math.min(state.total, Math.max(0, (state.level-1)*state.N + (state.matchedCount||0)));
        const levelInfo = document.getElementById('levelInfo');
        const passedEl = document.getElementById('passed');
        const totalEl = document.getElementById('total');
        if(levelInfo){ levelInfo.innerHTML = 'å…³å¡ï¼š<strong>' + state.level + '/' + (state.maxLevels||1) + '</strong>'; }
        if(passedEl){ passedEl.textContent = wordsPlayed; }
        if(totalEl){ totalEl.textContent = state.total; }
      }catch(e){}
    }

    function getTransById(id, langIdx){
      // langIdx: 0=en, 1=th, 2=vi, 3=lo, 4=fr, 5=ja, 6=ko, 7=ru, 8=de, 9=es
      if(state.usingTrial){
        const w = state.trialWords && state.trialWords[id];
        if(w && w.langs){ return w.langs[langIdx] || w.langs[0] || ''; }
        return '';
      }else{
        const w = demoData && demoData[id];
        if(w && w[2]){ return w[2][langIdx] || w[2][0] || ''; }
        return '';
      }
    }


    
    // Swap helpers for HSK demo
    window.__demoDataBackup = null;
    function startHSKDemo(){
      const hskData = buildHSKDemoData();
      if(!hskData.length){ showToast('HSK è¯•ç©è¯åº“åŠ è½½å¤±è´¥','error'); return; }
      window.__demoDataBackup = demoData.slice();
      demoData.splice(0, demoData.length, ...hskData); // swap to HSK (no const reassignment)
      // launch using the same demo engine
      state.usingTrial = false; // force demo path
      state.level = 1;
      try{ state.langIdx = codeToIdx(localStorage.getItem('trLang')); }catch{}
      stage.style.display='none';
      document.getElementById('gameDemo').style.display='block';
      initDemo(false);
      showToast('HSKÂ·è¯•ç©ï¼ˆå†…åµŒ 20 è¯ï¼‰å¼€å§‹','success');
    }
    function endAnyDemo(){
      // restore demoData if it was swapped
      if(Array.isArray(window.__demoDataBackup)){
        demoData.splice(0, demoData.length, ...window.__demoDataBackup);
        window.__demoDataBackup = null;
      }
    }


    function ensureBoardPopulated(){
      const hasTiles = document.querySelectorAll('.tile').length > 0;
      if(!hasTiles){
        if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      }
    }


    function shade(hex, k){
      const c = hex.replace('#','');
      const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
      const rr = Math.round(r*k+255*(1-k)), gg = Math.round(g*k+255*(1-k)), bb = Math.round(b*k+255*(1-k));
      return `rgb(${rr},${gg},${bb})`;
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

    
    function codeToIdx(code){
      code = String(code||'').toLowerCase();
      const idx = LANGS.findIndex(L=>L.code===code);
      return idx>=0 ? idx : 0;
    }

    function buildLangRow(){
      const row = document.getElementById('langRow');
      row.innerHTML = '';
      LANGS.forEach(L=>{
        const b = document.createElement('button');
        b.className = 'lang-btn';
        b.style.backgroundImage = `linear-gradient(180deg,#fff,${shade(L.color,0.9)})`;
        b.textContent = L.name;
        if(L.idx===state.langIdx) b.classList.add('active');
        b.addEventListener('click', ()=>{
          state.langIdx = L.idx;
          document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          updateTransTexts();
        });
        row.appendChild(b);
      });
      row.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });
    }

    function initDemo(useTrial=false){
      // useTrial can be: false | true (imported) | 'HSK' (built-in HSK)
      state.trialSource = (useTrial==='HSK') ? 'hsk' : (useTrial? 'import':'none');
      state.usingTrial = !!useTrial;
      state.level = 1;
      try{ state.langIdx = codeToIdx(localStorage.getItem('trLang')); }catch{}
      document.getElementById('total').textContent = state.total;
      updateHudDisplay();
      // Safety re-render: if for any reason tiles didn't mount, force a render on next tick
      setTimeout(()=>{
        if(!document.querySelector('.tile')){
          if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
        }
      }, 0);

      document.getElementById('passed').textContent = state.passed;
      document.getElementById('levelInfo').innerHTML = 'å…³å¡ï¼š<strong>'+state.level+'</strong>';
      buildLangRow();
      // Prepare data source and totals
      if(useTrial==='HSK'){
        const parsedHSK = parseTrial(HSK_TXT) || [];
        state.trialWords = parsedHSK.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        makeRoundTrial();
        setTimeout(()=>{ renderBoard(); ensureBoardPopulated(); }, 0);
      }else if(!!useTrial){
        const tw = store.trial || [];
        const norm = tw.map(w=>{
          if(!w.langs){
            w.langs = LANGS.map(L=> (w[L.code]||'').trim ? (w[L.code]||'').trim() : (w[L.code]||''));
          }
          return w;
        });
        state.trialWords = norm.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        state.total = state.trialWords.length;
        updateHudDisplay();
      }else{
        state.total = demoData.length; // 20 built-in
      }
      document.getElementById('total').textContent = state.total;
      updateHudDisplay();
      if(useTrial){
        const tw = store.trial || [];
        const norm = tw.map(w=>{
          if(!w.langs){
            w.langs = LANGS.map(L=> (w[L.code]||'').trim ? (w[L.code]||'').trim() : (w[L.code]||''));
          }
          return w;
        });
        state.trialWords = norm.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        state.total = state.trialWords.length;
        updateHudDisplay();
        makeRoundTrial();
      }else{
        makeRoundBuiltin(); // built-in 4 groups of 5
      }
    }

    function makeRoundBuiltin(){
      const N = 5;
      const MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, 'è¯•ç©å•è¯å·²ç”¨å®Œï¼ˆå†…ç½® 20 ä¸ªï¼Œ4 å…³ï¼‰ã€‚');
        return;
      }
      const start = (state.level-1)*N; // fixed partition
      const slice = demoData.slice(start, start+N);
      const words = slice.map((w, idx)=>{
        const id = start+idx; // 0..19 stable id
        return { id, cn: w[0], py: w[1], tr: w[2][state.langIdx] };
      });
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      updateHudDisplay();
      renderBoard();
      setTimeout(ensureBoardPopulated, 0);
    }

    function makeRoundTrial(){
      const N = state.N;
      state.maxLevels = Math.ceil(state.trialWords.length / N);
      const MAX_LEVELS = state.maxLevels;
      if(state.level > MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, 'æœ¬å•å…ƒå·²å®Œæˆï¼Œå¯è¿›å…¥ä¸‹ä¸€ä¸ªå•å…ƒ / Unit complete! You can enter the next unit.');
        return;
      }
      const start = (state.level-1)*N;
      const slice = state.trialWords.slice(start, start+N);
      const words = slice.map((w)=>({ id:w.id, cn:w.cn, py:w.py, tr:(w.langs[state.langIdx]||w.langs[0]) }));
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      updateHudDisplay();
      renderBoard();
    }

    function renderBoard(){
      const cn = document.getElementById('colCN');
      const py = document.getElementById('colPY');
      const tr = document.getElementById('colTR');
      cn.innerHTML = py.innerHTML = tr.innerHTML = '';
      ['cn','py','tr'].forEach(kind=>{
        const col = kind==='cn'?cn:kind==='py'?py:tr;
        state.tiles[kind].forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tile'; el.textContent = t.text; el.dataset.id = t.id; el.dataset.kind = kind;
          el.addEventListener('click', ()=>onPick(el));
          col.appendChild(el);
        });
      });
      updateOverlay(false, 'æœ¬å…³å®Œæˆï¼');
      state.choice = {cn:null,py:null,tr:null};
    }

    function renderBoardEmpty(){
      ['colCN','colPY','colTR'].forEach(id=>{ document.getElementById(id).innerHTML=''; });
    }

    
    function updateTransTexts(){
      const trCol = document.getElementById('colTR');
      if(!trCol) return;
      const tiles = trCol.querySelectorAll('.tile');
      tiles.forEach(node=>{
        const id = Number(node.dataset.id);
        node.textContent = getTransById(id, state.langIdx);
      });
      state.tiles.tr = Array.from(trCol.querySelectorAll('.tile')).map(n=>({id:Number(n.dataset.id), text:n.textContent}));
    }



    function onPick(el){
      const kind = el.dataset.kind; const id = Number(el.dataset.id);
      if(el.classList.contains('selected')){ el.classList.remove('selected'); state.choice[kind]=null; return; }
      document.querySelectorAll(`.tile[data-kind="${kind}"]`).forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected'); state.choice[kind]=id;
      const {cn,py,tr} = state.choice;
      if(cn!==null && py!==null && tr!==null){
        const ok = (cn===py && py===tr);
        if(ok){
          playSfx('ok');
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${state.choice[k]}"]`);
            if(node){ node.classList.add('correct'); setTimeout(()=>node.remove(), 600); }
          });
          state.matchedCount += 1;
      updateHudDisplay();
          const targetCount = 5;
          if(state.matchedCount>=targetCount){
            state.passed += 1;
            localStorage.setItem('dev_demo_passed', state.passed);
            document.getElementById('passed').textContent = state.passed;
            setTimeout(()=>{ updateOverlay(true, 'æœ¬å…³å®Œæˆï¼'); playSfx('done'); }, 650);
          }
          state.choice = {cn:null,py:null,tr:null};
        }else{
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${state.choice[k]}"]`);
            if(node){ node.classList.add('wrong'); setTimeout(()=>node.classList.remove('wrong'), 260); }
          });
          playSfx('err');
          const anyId = cn ?? py ?? tr;
          if(Number.isFinite(anyId)){
            let wcn='', wpy='', wtr='';
            if(state.usingTrial){
              const w = state.trialWords[anyId]; if(w){ wcn=w.cn; wpy=w.py; wtr=w.langs[state.langIdx]||w.langs[0]; }
            }else{
              const w = demoData[anyId]; if(w){ wcn=w[0]; wpy=w[1]; wtr=w[2][state.langIdx]; }
            }
            if(wcn && wpy && wtr){
              const book = state.wrongBook || [];
              book.push({cn:wcn, py:wpy, tr:wtr, lang:state.langIdx});
              state.wrongBook = book;
              localStorage.setItem('dev_demo_wrong', JSON.stringify(book));
            }
          }
          showToast('é…å¯¹ä¸æ­£ç¡®ï¼Œè¯·é‡è¯• / Not a match','error');
        }
      }
    }

    function updateOverlay(show, text){
      const f = document.getElementById('finish');
      const t = document.getElementById('finishText');
      if(typeof text==='string') t.textContent = text;
      f.style.display = show? 'flex':'none';
    }

    // Bottom buttons
    document.getElementById('btnTip').addEventListener('click', ()=>{
      playSfx('click');
      // find one id that is still present in DOM across any column
      const idsInDOM = new Set(Array.from(document.querySelectorAll('.tile')).map(n=>Number(n.dataset.id)));
      if(!idsInDOM.size){ showToast('æ‰€æœ‰å•è¯å·²åŒ¹é…å®Œæˆ','info'); return; }
      // pick a random remaining id
      const arr = Array.from(idsInDOM); const pick = arr[Math.floor(Math.random()*arr.length)];
      // flash the correct triple
      ['cn','py','tr'].forEach(k=>{
        const node = document.querySelector(`.tile[data-kind="${k}"][data-id="${pick}"]`);
        if(node){
          node.classList.add('selected');
          node.style.boxShadow = `0 0 18px var(--tileC)`;
          setTimeout(()=>{ node.classList.remove('selected'); node.style.boxShadow=''; }, 1000);
        }
      });
      showToast('å·²ä¸ºä½ é«˜äº®ä¸€ä¸ªæ­£ç¡®ç»„åˆ','success');
    });
    document.getElementById('btnShuffle').addEventListener('click', ()=>{
      playSfx('shuffle'); ['cn','py','tr'].forEach(k=>{ state.tiles[k]=state.tiles[k].sort(()=>Math.random()-0.5); });
      renderBoard();
    });
    document.getElementById('btnSave').addEventListener('click', ()=>{
      localStorage.setItem('dev_demo_wrong', JSON.stringify(state.wrongBook));
      localStorage.setItem('dev_demo_passed', state.passed);
      playSfx('click'); showToast('è¿›åº¦å·²ä¿å­˜ / Progress saved','success');
    });
    document.getElementById('btnBack').addEventListener('click', ()=>{ endAnyDemo();
      playSfx('click');
      document.getElementById('gameDemo').style.display='none';
      stage.style.display='block';
    });

    document.getElementById('btnPrev').addEventListener('click', ()=>{
      if(state.level>1){ state.level--; }
      document.getElementById('levelInfo').innerHTML = 'å…³å¡ï¼š<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'æœ¬å…³å®Œæˆï¼');
    });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      state.level++;
      document.getElementById('levelInfo').innerHTML = 'å…³å¡ï¼š<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'æœ¬å…³å®Œæˆï¼');
      if(!state.usingTrial && state.level>4){ showToast('å†…ç½®è¯•ç©ä»… 4 å…³ï¼Œå…± 20 ä¸ªè¯ã€‚','info'); }
    });

    document.getElementById('jumpGo').addEventListener('click', ()=>{
      const v = parseInt(document.getElementById('jumpInput').value||'1',10);
      state.level = Math.max(1, Math.min(4, v)); // bound to 1..4 for built-in demo
      document.getElementById('levelInfo').innerHTML = 'å…³å¡ï¼š<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'æœ¬å…³å®Œæˆï¼');
    });

    // Wrong book
    const wrongPad = document.getElementById('wrongPad');
    document.getElementById('btnWrong').addEventListener('click', ()=>{ renderWrong(); wrongPad.style.display='block'; requestAnimationFrame(()=> wrongPad.classList.add('show')); });
    document.getElementById('wrongClose').addEventListener('click', ()=>{ wrongPad.classList.remove('show'); setTimeout(()=> wrongPad.style.display='none', 200); });
    document.getElementById('wrongClear').addEventListener('click', ()=>{ state.wrongBook=[]; localStorage.setItem('dev_demo_wrong','[]'); renderWrong(); });

    function renderWrong(){
      const list = document.getElementById('wrongList');
      list.innerHTML = '';
      if(!state.wrongBook.length){
        list.innerHTML = '<div class="witem">æš‚æ— è®°å½• / Empty</div>';
        return;
      }
      state.wrongBook.slice().reverse().forEach((it)=>{
        const d = document.createElement('div');
        d.className = 'witem';
        d.textContent = `${it.cn} ï½œ ${it.py} ï½œ ${it.tr}`;
        list.appendChild(d);
      });
    }
  </script>

<script>
// ã€1ã€‘å‘å±•æ±‰è¯­è¯æ±‡æŒ‰é’®é¡ºåºè°ƒæ•´
(function(){
  function reorderDevCnButtons(){
    const container = document.querySelector('#stage .stage-actions');
    const demo = document.getElementById('actDemo');
    const start = document.getElementById('actStart');
    const imp = document.getElementById('actImport');
    if(!container || !demo || !start || !imp) return;
    container.innerHTML = '';
    container.appendChild(demo);
    container.appendChild(start);
    container.appendChild(imp);
  }
  const oldOpen = window.openModule;
  if(typeof oldOpen === 'function'){
    window.openModule = function(key, cn, en){
      const r = oldOpen.apply(this, arguments);
      if(key === 'dev-cn') reorderDevCnButtons();
      return r;
    }
  }
})();
</script>

<script>
// ã€2ã€‘â€œå¼€å§‹æ¸¸æˆâ€â†’çº§åˆ«é€‰æ‹©é¡µ è¿”å›ä¸Šä¸€çº§
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('levelsClose');
  if(btn){
    btn.textContent = 'è¿”å›ä¸Šä¸€çº§ / Back';
    btn.onclick = (e)=>{
      e.preventDefault();
      if(typeof showSection === 'function') showSection('stage');
    };
  }
});
</script>

<script>
// ã€3ã€‘æ­£å¼æ¸¸æˆé¡µ â€œè¿”å›ä¸Šä¸€çº§â€ â†’ å›åˆ°è¯¾æ®µé€‰æ‹©
document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('btnBack');
  if(b){
    b.onclick = (e)=>{
      e.preventDefault();
      if(typeof showSection === 'function') showSection('lessonsPanel');
    };
  }
});
</script>


<script>
(function(){
  try {
    if (typeof console !== 'undefined') {
      console.log = function(){};
      console.debug = function(){};
    }
  } catch (e) {}
})();
</script>


<script>
(function(){
  function __buildLessonsFor(level){
    var panel = document.getElementById('lessonsPanel');
    if(!panel) return;
    var grid = panel.querySelector('.lessons-grid-10');
    if(!grid) return;
    var titleDiv = panel.querySelector('.levels-header div[style*="font-weight"]');
    function setTitle(txt){ if(titleDiv) titleDiv.textContent = txt; }

    if(level === 'beg1'){
      setTitle('åˆçº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 1 Â· Choose Lessons');
      return;
    }
    if(level === 'beg2'){
      setTitle('åˆçº§2 Â· è¯·é€‰æ‹©è¯¾æ®µ / Elementary 2 Â· Choose Lessons');
      grid.innerHTML = [
        '<button class="lv-btn lesson-btn" data-lesson="beg2-1-5">ç¬¬1-5è¯¾<br><small>Lesson 1-5</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-6-10">ç¬¬6-10è¯¾<br><small>Lesson 6-10</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-11-15">ç¬¬11-15è¯¾<br><small>Lesson 11-15</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-16-20">ç¬¬16-20è¯¾<br><small>Lesson 16-20</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="beg2-21-25">ç¬¬21-25è¯¾<br><small>Lesson 21-25</small></button>'
      ].join('\n');
      return;
    }
    if(level === 'int1'){
      setTitle('ä¸­çº§1 Â· è¯·é€‰æ‹©è¯¾æ®µ / Intermediate 1 Â· Choose Lessons');
      grid.innerHTML = [
        '<button class="lv-btn lesson-btn" data-lesson="int1-1-3">ç¬¬1-3è¯¾<br><small>Lesson 1-3</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-4-6">ç¬¬4-6è¯¾<br><small>Lesson 4-6</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-7-9">ç¬¬7-9è¯¾<br><small>Lesson 7-9</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-10-12">ç¬¬10-12è¯¾<br><small>Lesson 10-12</small></button>',
        '<button class="lv-btn lesson-btn" data-lesson="int1-13-15">ç¬¬13-15è¯¾<br><small>Lesson 13-15</small></button>'
      ].join('\n');
      return;
    }
  }
  // Attach once DOM is ready
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.lv-btn[data-level]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var level = btn.getAttribute('data-level');
        var levelsPanel = document.getElementById('levelsPanel');
        var lessonsPanel = document.getElementById('lessonsPanel');
        if(!level || !levelsPanel || !lessonsPanel) return;
        levelsPanel.style.display = 'none';
        lessonsPanel.style.display = 'block';
        __buildLessonsFor(level);
      });
    });
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP2: Strict router (HSK â†” Dev-CN isolation) === -->
<script id="hotfix-20251021-step2-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }
  function moduleKey(){ var s=$id('stage'); return (s&&s.dataset&&s.dataset.key)||''; }
  function isHSK(){ return moduleKey()==='hsk'; }

  // ---------- Ensure Step1 overlay exists (reuse if present) ----------
  function ensureOverlay(){
    var ov=$id('hskOverlay');
    if(ov) return ov;
    // build minimal overlay if step1 not present
    ov=document.createElement('div'); ov.id='hskOverlay'; ov.style.cssText='position:fixed;inset:0;background:rgba(2,8,23,.84);display:none;z-index:9999;backdrop-filter:blur(4px)';
    ov.innerHTML = ''
      + '<div class="panel" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1024px,92vw);padding:24px;border-radius:18px;background:linear-gradient(180deg,#f4f7fb,#e9eef6);box-shadow:0 20px 60px rgba(0,0,0,.35)">'
      + '  <div class="head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'
      + '    <div class="title" style="font-weight:900;font-size:20px">è¯·é€‰æ‹©HSKçº§åˆ« / Choose HSK Level</div>'
      + '    <button class="mini" id="hskOvClose" style="border:0;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer">è¿”å› / Back</button>'
      + '  </div>'
      + '  <div class="grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px">'
      + '    <button class="btn" data-hsk="1" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#f5fbff,#eaf2ff)">HSK 1</button>'
      + '    <button class="btn" data-hsk="2" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#fff7ea,#ffe9cc)">HSK 2</button>'
      + '    <button class="btn" data-hsk="3" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#effff3,#dbffe7)">HSK 3</button>'
      + '    <button class="btn" data-hsk="4" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#f7efff,#e9dbff)">HSK 4</button>'
      + '    <button class="btn" data-hsk="5" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#fff0f2,#ffd8df)">HSK 5</button>'
      + '    <button class="btn" data-hsk="6" style="border:0;border-radius:16px;padding:18px 14px;font-weight:800;cursor:pointer;background:linear-gradient(#edf6ff,#d8ebff)">HSK 6</button>'
      + '  </div>'
      + '</div>';
    (document.body||document.documentElement).appendChild(ov);
    ov.querySelector('#hskOvClose').addEventListener('click', function(){ ov.style.display='none'; }, true);

    var HSK_URLS = {
      "1":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt",
      "2":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK2-multilingual.txt",
      "3":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK3-multilingual.txt",
      "4":"https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK4_multilingual.txt"
    };
    ov.addEventListener('click', function(e){
      var b=e.target.closest('.btn'); if(!b) return;
      var lv=b.getAttribute('data-hsk');
      if(lv==='5'||lv==='6'){ toast('æ­£åœ¨å‡†å¤‡ä¸­â€¦ / Coming soonâ€¦','info'); return; }
      var url=HSK_URLS[lv];
      if(!url){ toast('æœªé…ç½®çš„çº§åˆ«ï¼šHSK'+lv,'error'); return; }
      window.__ctx='hsk';
      window.__lastGameContext='hsk';
      if(typeof window.startFromExternal==='function'){ window.startFromExternal(url); }
      else{
        (async function(u){
          try{
            toast('æ­£åœ¨åŠ è½½è¯åº“â€¦ / Loading word bankâ€¦','info');
            var r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
            var text=await r.text();
            if(typeof window.parseTrial!=='function'||typeof window.mapParsedToTarget!=='function')
              throw new Error('parseTrial/mapParsedToTarget missing');
            var parsed=window.parseTrial(text);
            var patched=window.mapParsedToTarget(parsed||[]);
            window.store=window.store||{}; window.store.trial=patched;
            if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
            else{ var st=$id('stage'), gd=$id('gameDemo'); if(st) st.style.display='none'; if(gd) gd.style.display='block'; if(typeof window.initDemo==='function'){ window.initDemo(true); } }
            ov.style.display='none';
            toast('HSK å·²å¼€å§‹ã€‚','success');
          }catch(err){ console.error(err); toast('åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error'); }
        })(url);
      }
    }, true);

    return ov;
  }
  function openOverlay(){ var ov=ensureOverlay(); ov.style.display='block'; }

  // ---------- Context tracking ----------
  document.addEventListener('DOMContentLoaded', function(){
    // When user interacts with Dev-CN panels, mark context
    var levels=$id('levelsPanel');
    if(levels){
      levels.addEventListener('click', function(e){
        var btn=e.target.closest('.lv-btn'); if(!btn) return;
        if(moduleKey()==='dev-cn'){ window.__ctx='dev-cn'; }
      }, true);
    }
    var lessons=$id('lessonsPanel');
    if(lessons){
      lessons.addEventListener('click', function(e){
        var btn=e.target.closest('.lesson-btn'); if(!btn) return;
        if(moduleKey()==='dev-cn'){ window.__ctx='dev-cn'; window.__lastGameContext='dev-cn'; }
      }, true);
    }

    // Start in HSK: open overlay and mark context
    document.addEventListener('click', function(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      if(isHSK()){
        e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        window.__ctx='hsk'; openOverlay();
      }
    }, true);

    // Back button: route according to context
    document.addEventListener('click', function(e){
      var back=e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__lastGameContext==='hsk' || window.__ctx==='hsk'){
        e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        openOverlay(); return;
      }
      if(window.__lastGameContext==='dev-cn' || window.__ctx==='dev-cn'){
        // let original handlers return to Dev-CN lessons/levels; do not cross to HSK
        window.__ctx='dev-cn';
      }
    }, true);
  });

  // ---------- Guard showSection to prevent cross-module jumps ----------
  (function(){
    var prev = window.showSection;
    window.showSection = function(id){
      try{
        if(window.__ctx==='hsk' && (id==='levelsPanel' || id==='lessonsPanel')){
          // Prevent entering Dev-CN panels while in HSK context
          openOverlay(); return;
        }
        if(window.__ctx==='dev-cn' && (id==='hskPanel' || id==='hskOverlay')){
          // Prevent entering HSK panels while in Dev-CN context
          id = (id==='hskPanel' || id==='hskOverlay') ? 'levelsPanel' : id;
        }
      }catch(_){}
      if(typeof prev==='function'){ return prev(id); }
      // fallback: show the requested panel
      var el=$id(id); if(el){ el.style.display='block'; }
    };
  })();
})();
</script>

<!-- === Hotfix 2025-10-21 STEP3: Wire HSK1 to game engine with robust starter === -->
<script id="hotfix-20251021-step3-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";

  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  async function startHSK1(){
    window.__ctx = 'hsk';
    window.__lastGameContext = 'hsk';
    // Try a set of known engine entry points
    try{
      if(typeof window.startFromExternal === 'function'){
        window.startFromExternal(HSK1_URL); return;
      }
      if(typeof window.startHSKDemo === 'function'){
        // try with URL, fall back to no-arg
        try{ window.startHSKDemo(HSK1_URL); return; }catch(_){ window.startHSKDemo(); return; }
      }
      if(typeof window.loadWordBankAndStart === 'function'){
        window.loadWordBankAndStart(HSK1_URL); return;
      }
      if(typeof window.startDemoFromExternal === 'function'){
        window.startDemoFromExternal(HSK1_URL); return;
      }
    }catch(err){
      console.warn('Primary engine calls failed, trying fallback...', err);
    }

    // Fallback: fetch + parseTrial/mapParsedToTarget + resetAndStartFromTrial
    try{
      toast('æ­£åœ¨åŠ è½½HSK1è¯åº“â€¦ / Loading HSK1â€¦','info');
      var resp = await fetch(HSK1_URL, {cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      var text = await resp.text();

      if(typeof window.parseTrial === 'function' && typeof window.mapParsedToTarget === 'function'){
        var parsed = window.parseTrial(text);
        var patched = window.mapParsedToTarget(parsed||[]);
        window.store = window.store || {};
        window.store.trial = patched;
        if(typeof window.resetAndStartFromTrial === 'function'){
          window.resetAndStartFromTrial();
        }else{
          var st=$id('stage'), gd=$id('gameDemo');
          if(st) st.style.display='none';
          if(gd) gd.style.display='block';
          if(typeof window.initDemo === 'function'){ window.initDemo(true); }
        }
        toast('HSK1 å·²å¯åŠ¨','success');
        return;
      }else{
        toast('ç¼ºå°‘è§£æå‡½æ•° parseTrial/mapParsedToTargetï¼›è¯·åœ¨æºç ä¸­æš´éœ²è¯¥å‡½æ•°æˆ–å‘Šè¯‰æˆ‘å‡½æ•°åä»¥ä¾¿æ¥å…¥ã€‚','error');
      }
    }catch(err){
      console.error(err);
      toast('HSK1 åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error');
    }
  }

  // Wire both the overlay and (if present) the hskPanel buttons for HSK1
  document.addEventListener('DOMContentLoaded', function(){
    function handler(e){
      var el = e.target.closest('[data-hsk="1"]');
      if(!el) return;
      // limit to HSK UIs
      var inOverlay = el.closest('#hskOverlay');
      var inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault();
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      e.stopPropagation();
      // hide overlay if visible
      var ov = $id('hskOverlay'); if(ov) ov.style.display='none';
      startHSK1();
    }
    document.addEventListener('click', handler, true);
    document.addEventListener('touchend', handler, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP4: HSK1 full import (no 20-cap) + back-loop fix === -->
<script id="hotfix-20251021-step4-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // 1) Provide a generic startFromExternal if missing, so we always use unlimited loader
  if(typeof window.startFromExternal !== 'function'){
    window.startFromExternal = async function(url){
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        toast('æ­£åœ¨åŠ è½½è¯åº“â€¦ / Loading word bankâ€¦','info');
        var resp = await fetch(url, {cache:'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        var text = await resp.text();
        if(typeof window.parseTrial!=='function' || typeof window.mapParsedToTarget!=='function')
          throw new Error('ç¼ºå°‘è§£æå‡½æ•° parseTrial/mapParsedToTarget');
        var parsed = window.parseTrial(text);
        var patched = window.mapParsedToTarget(parsed||[]);
        window.store = window.store || {};
        window.store.trial = patched;              // <-- full list, no slicing
        if(typeof window.resetAndStartFromTrial==='function'){
          window.resetAndStartFromTrial();        // engine will page by N across full list
        }else{
          var st=$id('stage'), gd=$id('gameDemo');
          if(st) st.style.display='none';
          if(gd) gd.style.display='block';
          if(typeof window.initDemo==='function'){ window.initDemo(true); }
        }
        toast('è¯åº“å·²åŠ è½½ï¼ˆ'+(patched.length||parsed.length)+' é¡¹ï¼‰','success');
      }catch(err){
        console.error(err); toast('åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error');
      }
    };
  }

  // 2) Override our Step3 startHSK1 to NEVER call startHSKDemoï¼ˆé‚£ä¸ªå‡½æ•°æœ‰20æ¡ä¸Šé™ï¼‰
  (function(){
    var oldAdd = document.addEventListener;
    // Replace the global click handler for [data-hsk="1"] with a dedicated one
    document.removeEventListener && document.removeEventListener('click', window.__step3HSK1Handler || function(){}, true);
    function handler(e){
      var el = e.target.closest('[data-hsk="1"]');
      if(!el) return;
      var inOverlay = el.closest('#hskOverlay'), inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
      // Always use startFromExternal (our robust one above or the app's own)
      if(typeof window.startFromExternal==='function'){ window.startFromExternal(HSK1_URL); }
    }
    document.addEventListener('click', handler, true);
    window.__step3HSK1Handler = handler;
  })();

  // 3) Optional: if a demo builder exists and slices to 20, replace it with an unlimited one
  if(typeof window.buildHSKDemoData === 'function'){
    try{
      var original = window.buildHSKDemoData;
      window.buildHSKDemoData = function(){
        try{
          var HSK_TXT = window.HSK_TXT || '';
          const rows = String(HSK_TXT).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          if(!rows.length) return [];
          const header = rows[0].split(/[,	]/).map(s=>s.trim().toLowerCase());
          const hasHeader = header.some(h=>/ä¸­æ–‡|æ±‰å­—|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h));
          const lines = hasHeader ? rows.slice(1) : rows;
          const out = [];
          for(const line of lines){ // <-- no .slice(0,20)
            const p = line.split(/[,	]/).map(s=>s.trim());
            const cn = p[0]||''; const py = p[1]||''; const en = p[2]||'';
            const th = p[3]||en, vi=p[4]||en, lo=p[5]||en, fr=p[6]||en, ja=p[7]||en, ko=p[8]||en, ru=p[9]||en, de=p[10]||en, es=p[11]||en;
            if(cn && py && en){ out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]); }
          }
          return out;
        }catch(_){
          return original(); // fallback to original if anything goes wrong
        }
      };
    }catch(_){}
  }

  // 4) Fix back-loop: when showing HSK menu, clear lastGameContext so another back won't reopen game
  function showHSKMenu(){
    var ov=$id('hskOverlay');
    if(ov){ ov.style.display='block'; }
    window.__ctx='hsk';
    window.__lastGameContext=null; // prevent back-loop
  }

  document.addEventListener('DOMContentLoaded', function(){
    // ensure overlay close buttons clear lastGameContext and don't bubble
    document.addEventListener('click', function(e){
      var close = e.target.closest('#hskOvClose,#hskBack');
      if(!close) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      showHSKMenu();
    }, true);

    // global back handler: if in HSK flow, return to menu and clear context to break loops
    document.addEventListener('click', function(e){
      var back = e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__ctx==='hsk' || window.__lastGameContext==='hsk'){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        showHSKMenu();
      }
    }, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP4b: Remove parseTrial dependency; unlimited via startHSKDemo === -->
<script id="hotfix-20251021-step4b-script">
(function(){
  var HSK1_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK1-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  function parseHSK(text){
    var rows = String(text).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!rows.length) return [];
    var sep = /\t/.test(rows[0]) ? '\t' : ',';
    var header = rows[0].split(sep).map(s=>s.trim().toLowerCase());
    var hasHeader = header.some(h=>/ä¸­æ–‡|æ±‰å­—|chinese|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h));
    var lines = hasHeader ? rows.slice(1) : rows;
    var out = [];
    for (var i=0;i<lines.length;i++){
      var cols = lines[i].split(sep).map(s=>s.trim());
      var cn = cols[0]||''; var py = cols[1]||''; var en = cols[2]||'';
      var th=cols[3]||en, vi=cols[4]||en, lo=cols[5]||en, fr=cols[6]||en, ja=cols[7]||en, ko=cols[8]||en, ru=cols[9]||en, de=cols[10]||en, es=cols[11]||en;
      if(cn && (py || en)){
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]); // shape used by demo builder
      }
    }
    return out;
  }

  async function robustStartFromURL(url){
    toast('æ­£åœ¨åŠ è½½è¯åº“â€¦ / Loading word bankâ€¦','info');
    var resp = await fetch(url, {cache:'no-store'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    var text = await resp.text();
    // Preferred path: startHSKDemo with our own unlimited builder
    if(typeof window.startHSKDemo === 'function'){
      window.HSK_TXT = text; // give raw text if demo uses it
      var parsed = parseHSK(text);
      window.buildHSKDemoData = function(){ return parsed; }; // unlimited
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        window.startHSKDemo(); // no cap, uses our parsed
        toast('HSK1 å·²å¯åŠ¨ï¼ˆ'+parsed.length+' æ¡ï¼‰','success');
        return;
      }catch(err){ console.warn('startHSKDemo failed', err); }
    }
    // Fallback path: if engine supports resetAndStartFromTrial, map our data
    var parsed2 = parseHSK(text);
    window.store = window.store || {};
    window.store.trial = parsed2; // many engines accept this basic shape
    if(typeof window.resetAndStartFromTrial === 'function'){
      window.__ctx='hsk'; window.__lastGameContext='hsk';
      window.resetAndStartFromTrial();
      toast('HSK1 å·²å¯åŠ¨ï¼ˆ'+parsed2.length+' æ¡ï¼‰','success');
      return;
    }
    // Last resort: toggle demo visibility
    var st=$id('stage'), gd=$id('gameDemo'); if(st) st.style.display='none'; if(gd) gd.style.display='block';
    if(typeof window.initDemo==='function'){ window.initDemo(true); }
    toast('HSK1 å·²å¯åŠ¨ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰','success');
  }

  // Replace/define startFromExternal to use the robust starter (no parseTrial dependency)
  window.startFromExternal = function(url){
    robustStartFromURL(url).catch(function(err){
      console.error(err);
      toast('åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error');
    });
  };
})();
</script>

<!-- === Hotfix 2025-10-21 STEP5: HSK Back fix + enable HSK2 === -->
<script id="hotfix-20251021-step5-script">
(function(){
  var HSK2_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK2-multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // 1) Stop any previous auto-open of HSK panel after returning to HSK stage.
  (function guardOpenHSKPanel(){
    var _orig = window.openHSKPanel;
    window.openHSKPanel = function(){
      if(window.__hsk_no_auto_open){ return; }
      if(typeof _orig === 'function'){ return _orig(); }
      // If there's no original, fall back to showing overlay if present
      var ov=$id('hskOverlay'); if(ov){ ov.style.display='block'; }
    };
  })();

  // 2) Make Back on overlay/panel go to HSK stage and disable auto-open once.
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;          // prevent back loop
    window.__hsk_no_auto_open=true;         // block auto-open on title
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Back buttons on overlay/panel
    document.addEventListener('click', function(e){
      var back = e.target.closest('#hskOvClose,#hskBack');
      if(!back) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }, true);

    // When user clicks "Start Game" again under HSK, re-enable auto-open
    document.addEventListener('click', function(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      var s=$id('stage'); var isHSK = s && s.dataset && s.dataset.key==='hsk';
      if(isHSK){ window.__hsk_no_auto_open=false; }
    }, true);

    // 3) Wire HSK2 button to robust starter (capture-phase to override older "Next step" handlers)
    function startHSK2(e){
      var el = e.target.closest('[data-hsk="2"]'); if(!el) return;
      // limit to HSK overlay/panel UIs
      var inOverlay = el.closest('#hskOverlay'), inPanel = el.closest('#hskPanel');
      if(!inOverlay && !inPanel) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      window.__ctx='hsk'; window.__lastGameContext='hsk';
      var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
      if(typeof window.startFromExternal==='function'){
        window.startFromExternal(HSK2_URL);
      }else{
        // If for some reason STEP4b wasn't injected, fallback minimal loader
        (async function(u){
          try{
            toast('æ­£åœ¨åŠ è½½HSK2â€¦ / Loading HSK2','info');
            var r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
            var t=await r.text();
            var rows=String(t).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            var sep=/\t/.test(rows[0])?'\t':',';
            var header=rows[0].split(sep).map(s=>s.trim().toLowerCase());
            var hasHeader=header.some(h=>/ä¸­æ–‡|æ±‰å­—|chinese|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h));
            var lines=hasHeader?rows.slice(1):rows;
            var parsed=[];
            for(var i=0;i<lines.length;i++){
              var c=lines[i].split(sep).map(s=>s.trim());
              var cn=c[0]||'', py=c[1]||'', en=c[2]||'';
              var th=c[3]||en, vi=c[4]||en, lo=c[5]||en, fr=c[6]||en, ja=c[7]||en, ko=c[8]||en, ru=c[9]||en, de=c[10]||en, es=c[11]||en;
              if(cn && (py||en)) parsed.push([cn,py,[en,th,vi,lo,fr,ja,ko,ru,de,es]]);
            }
            if(typeof window.startHSKDemo==='function'){
              window.HSK_TXT=t;
              window.buildHSKDemoData=function(){ return parsed; };
              window.startHSKDemo();
              toast('HSK2 å·²å¯åŠ¨ï¼ˆ'+parsed.length+' æ¡ï¼‰','success');
            }else{
              window.store=window.store||{}; window.store.trial=parsed;
              if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
              toast('HSK2 å·²å¯åŠ¨ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰','success');
            }
          }catch(err){ console.error(err); toast('åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error'); }
        })(HSK2_URL);
      }
    }
    document.addEventListener('click', startHSK2, true);
    document.addEventListener('touchend', startHSK2, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP6: Back button fix + enable HSK3 & HSK4 (unlimited) === -->
<style id="hotfix-20251021-step6-style">
#hskOverlay, #hskPanel { z-index: 9999 !important; }
#hskOverlay button, #hskPanel button { pointer-events: auto !important; }
</style>
<script id="hotfix-20251021-step6-script">
(function(){
  var HSK3_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK3-multilingual.txt";
  var HSK4_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/HSK4_multilingual.txt";
  function $id(id){ return document.getElementById(id); }
  function toast(m,t){ try{ window.showToast && showToast(m,t||'info'); }catch(e){ console.log(m);} }

  // ---- Robust back from overlay/panel to HSK stage (and DO NOT auto-open again) ----
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Make the Back button always work, regardless of id used in UI (hskOvClose or hskBack)
    function backHandler(e){
      var el = e.target.closest('#hskOvClose,#hskBack');
      if(!el) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
    document.addEventListener('click', backHandler, true);
    document.addEventListener('touchend', backHandler, true);

    // When HSK Start is clicked again, allow auto-open
    function startHandler(e){
      var start=e.target.closest('#actStart,.act-start,[data-action="start"],button.start,a.start');
      if(!start) return;
      var s=$id('stage'); var isHSK = s && s.dataset && s.dataset.key==='hsk';
      if(isHSK){ window.__hsk_no_auto_open=false; }
    }
    document.addEventListener('click', startHandler, true);

    // ---- Enable HSK3 and HSK4 (unlimited import like HSK1/2) ----
    async function robustStart(url){
      // Prefer previously defined robust startFromExternal (from step4b)
      if(typeof window.startFromExternal==='function'){
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
        return window.startFromExternal(url);
      }
      // Minimal fallback (if step4b not present)
      try{
        window.__ctx='hsk'; window.__lastGameContext='hsk';
        var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
        toast('æ­£åœ¨åŠ è½½è¯åº“â€¦','info');
        var r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
        var t=await r.text();
        var rows=String(t).split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        var sep=/\t/.test(rows[0])?'\t':',';
        var header=rows[0].split(sep).map(s=>s.trim().toLowerCase());
        var hasHeader=header.some(h=>/ä¸­æ–‡|æ±‰å­—|chinese|cn|æ‹¼éŸ³|pinyin|è‹±è¯­|english|en/.test(h));
        var lines=hasHeader?rows.slice(1):rows;
        var parsed=[];
        for(var i=0;i<lines.length;i++){
          var c=lines[i].split(sep).map(s=>s.trim());
          var cn=c[0]||'', py=c[1]||'', en=c[2]||'';
          var th=c[3]||en, vi=c[4]||en, lo=c[5]||en, fr=c[6]||en, ja=c[7]||en, ko=c[8]||en, ru=c[9]||en, de=c[10]||en, es=c[11]||en;
          if(cn && (py||en)) parsed.push([cn,py,[en,th,vi,lo,fr,ja,ko,ru,de,es]]);
        }
        if(typeof window.startHSKDemo==='function'){
          window.HSK_TXT=t;
          window.buildHSKDemoData=function(){ return parsed; };
          window.startHSKDemo();
          toast('å·²å¯åŠ¨ï¼ˆ'+parsed.length+' æ¡ï¼‰','success');
        }else{
          window.store=window.store||{}; window.store.trial=parsed;
          if(typeof window.resetAndStartFromTrial==='function'){ window.resetAndStartFromTrial(); }
          toast('å·²å¯åŠ¨ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰','success');
        }
      }catch(err){ console.error(err); toast('åŠ è½½å¤±è´¥ï¼š'+(err.message||err),'error'); }
    }

    function hsk34Handler(e){
      var btn3 = e.target.closest('[data-hsk="3"]');
      var btn4 = e.target.closest('[data-hsk="4"]');
      if(!btn3 && !btn4) return;
      // limit to overlay/panel only
      var scope = (btn3||btn4).closest('#hskOverlay,#hskPanel'); if(!scope) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      robustStart(btn3 ? HSK3_URL : HSK4_URL);
    }

    document.addEventListener('click', hsk34Handler, true);
    document.addEventListener('touchend', hsk34Handler, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP7: Back button hardening (text match) + outside click + ESC === -->
<style id="hotfix-20251021-step7-style">
#hskOverlay, #hskPanel { z-index: 99999 !important; }
#hskOverlay, #hskPanel { pointer-events: auto !important; }
#hskOverlay .panel { pointer-events: auto !important; }
</style>
<script id="hotfix-20251021-step7-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function isVisible(el){ if(!el) return false; var cs=getComputedStyle(el); return cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0'; }

  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Back by id (original buttons)
    function backById(e){
      var el = e.target.closest('#hskOvClose,#hskBack');
      if(!el) return;
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
    document.addEventListener('click', backById, true);
    document.addEventListener('touchend', backById, true);

    // 2) Back by text (in case id/class changed)
    function backByText(e){
      var btn = e.target.closest('#hskOverlay button, #hskPanel button');
      if(!btn) return;
      var label = (btn.innerText || btn.textContent || '').replace(/\s+/g,' ').trim();
      if(/^(è¿”å›|Back)\b/i.test(label)){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', backByText, true);

    // 3) Click outside panel to go back
    function outsideClick(e){
      var ov=$id('hskOverlay'); if(!ov || !isVisible(ov)) return;
      if(e.target === ov){ // clicked on the dim backdrop
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', outsideClick, true);

    // 4) ESC to go back
    document.addEventListener('keydown', function(e){
      if(e.key !== 'Escape') return;
      var ov=$id('hskOverlay'); var pn=$id('hskPanel');
      if(isVisible(ov) || isVisible(pn)){
        e.preventDefault(); e.stopPropagation();
        gotoHSKStage();
      }
    }, true);
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP8: Ultra-robust HSK Back === -->
<style id="hotfix-20251021-step8-style">
#hskOverlay, #hskPanel { z-index: 2147483647 !important; pointer-events:auto !important; }
#hskOverlay .panel, #hskPanel .levels-header { pointer-events:auto !important; }
#hskBack, #hskOvClose { pointer-events:auto !important; cursor:pointer !important; }
</style>
<script id="hotfix-20251021-step8-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function isVisible(el){ if(!el) return false; var cs=getComputedStyle(el); return cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0'; }
  function text(el){ return (el && (el.innerText||el.textContent)||'').replace(/\s+/g,' ').trim(); }
  function gotoHSKStage(){
    window.__ctx='hsk';
    window.__lastGameContext=null;
    window.__hsk_no_auto_open=true;
    try{ if(typeof window.showSection==='function'){ window.showSection('stage'); } }catch(_){}
    var ov=$id('hskOverlay'); if(ov) ov.style.display='none';
    var pn=$id('hskPanel'); if(pn) pn.style.display='none';
  }

  function bindBack(btn){
    if(!btn || btn.__hskBackBound) return;
    btn.__hskBackBound = true;
    btn.setAttribute('tabindex','0');
    btn.setAttribute('role','button');
    btn.style.pointerEvents='auto';
    var handler = function(e){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    };
    ['click','pointerdown','mousedown','touchend','keydown'].forEach(function(t){
      btn.addEventListener(t, function(e){
        if(t==='keydown' && !(e.key==='Enter' || e.key===' ')) return;
        handler(e);
      }, true);
    });
  }

  function scanAndBind(){
    var cand = [];
    var ov=$id('hskOverlay'), pn=$id('hskPanel');
    if(ov){
      cand = cand.concat([ov.querySelector('#hskBack'), ov.querySelector('#hskOvClose')]);
      // try header end button
      var headerBtn = ov.querySelector('.head button, .levels-header button');
      if(headerBtn) cand.push(headerBtn);
      // try any button whose text matches
      Array.prototype.forEach.call(ov.querySelectorAll('button, a, div'), function(el){
        var label = text(el);
        if(/^(è¿”å›|Back)\b/i.test(label)) cand.push(el);
      });
    }
    if(pn){
      cand = cand.concat([pn.querySelector('#hskBack'), pn.querySelector('#hskOvClose')]);
      var headerBtn2 = pn.querySelector('.head button, .levels-header button');
      if(headerBtn2) cand.push(headerBtn2);
      Array.prototype.forEach.call(pn.querySelectorAll('button, a, div'), function(el){
        var label = text(el);
        if(/^(è¿”å›|Back)\b/i.test(label)) cand.push(el);
      });
    }
    cand.forEach(bindBack);
  }

  // Global capture fallback (click anywhere on a "Back" labeled control)
  function globalBackByText(e){
    var target = e.target;
    var scope = target.closest && target.closest('#hskOverlay,#hskPanel');
    if(!scope) return;
    var el = target.closest('button, a, div, span');
    if(!el) return;
    var label = text(el);
    if(/^(è¿”å›|Back)\b/i.test(label)){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
      gotoHSKStage();
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    scanAndBind();
    document.addEventListener('click', globalBackByText, true);
    document.addEventListener('pointerdown', globalBackByText, true);
    document.addEventListener('touchend', globalBackByText, true);

    // Close by clicking outside panel or pressing ESC (keep from Step7)
    function outside(e){
      var ov=$id('hskOverlay'); if(!ov || !isVisible(ov)) return;
      if(e.target === ov){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        gotoHSKStage();
      }
    }
    document.addEventListener('click', outside, true);
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
        var ov=$id('hskOverlay'); var pn=$id('hskPanel');
        if(isVisible(ov) || isVisible(pn)){
          e.preventDefault(); e.stopPropagation();
          gotoHSKStage();
        }
      }
    }, true);

    // Observe DOM changes: if overlay/panel is rebuilt, re-bind
    var mo = new MutationObserver(function(){
      scanAndBind();
    });
    mo.observe(document.body, {subtree:true, childList:true});
  });
})();
</script>

<!-- === Hotfix 2025-10-21 STEP9: HSK Back 3D + Dev-CN trial return fix === -->
<style id="hotfix-20251021-step9-style">
/* 3D Back button */
.hsk-back-3d {
  --tiltX: 0deg; --tiltY: 0deg; --glowX: 50%; --glowY: 50%;
  position: relative;
  padding: 10px 14px;
  border-radius: 14px;
  font-weight: 900;
  background: linear-gradient(180deg,#fdfdfd,#efefef);
  border: 0;
  color: #111;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    inset 0 -1px 0 rgba(0,0,0,.06),
    0 10px 18px rgba(0,0,0,.18);
  transform: perspective(800px) rotateX(var(--tiltX)) rotateY(var(--tiltY)) translateZ(0);
  transition: transform .12s ease, box-shadow .2s ease;
  will-change: transform;
  cursor: pointer;
}
.hsk-back-3d::before{
  content:'';
  position:absolute; inset:-1px;
  border-radius: 14px;
  background: radial-gradient(600px 600px at var(--glowX) var(--glowY), rgba(255,255,255,.65), rgba(255,255,255,0) 40%);
  pointer-events: none;
  mix-blend-mode: screen;
  transition: opacity .12s ease;
  opacity: .6;
}
.hsk-back-3d:hover{ box-shadow:
    inset 0 1px 0 rgba(255,255,255,.9),
    inset 0 -1px 0 rgba(0,0,0,.06),
    0 16px 28px rgba(0,0,0,.24);
}
/* ensure clickable */
#hskBack, #hskOvClose{ pointer-events:auto !important; }
</style>
<script id="hotfix-20251021-step9-script">
(function(){
  function $id(id){ return document.getElementById(id); }
  function moduleKey(){ var s=$id('stage'); return (s && s.dataset && s.dataset.key) || ''; }

  // --- HSK Back button 3D + cursor reactive ---
  function upgradeBack3D(btn){
    if(!btn || btn.__hsk3D) return;
    btn.__hsk3D = true;
    btn.classList.add('hsk-back-3d');
    btn.addEventListener('pointermove', function(e){
      var r = btn.getBoundingClientRect();
      var x = (e.clientX - r.left) / r.width;
      var y = (e.clientY - r.top) / r.height;
      var tiltX = (0.5 - y) * 10;   // [-5, 5] deg
      var tiltY = (x - 0.5) * 12;   // [-6, 6] deg
      btn.style.setProperty('--tiltX', tiltX.toFixed(2) + 'deg');
      btn.style.setProperty('--tiltY', tiltY.toFixed(2) + 'deg');
      btn.style.setProperty('--glowX', (x*100).toFixed(1) + '%');
      btn.style.setProperty('--glowY', (y*100).toFixed(1) + '%');
    }, {passive:true});
    btn.addEventListener('pointerleave', function(){
      btn.style.setProperty('--tiltX', '0deg');
      btn.style.setProperty('--tiltY', '0deg');
      btn.style.setProperty('--glowX', '50%');
      btn.style.setProperty('--glowY', '50%');
    });
  }
  function scanBackButtons(){
    var cand = [];
    var ov=$id('hskOverlay'), pn=$id('hskPanel');
    if(ov){
      if(ov.querySelector) cand = cand.concat([ov.querySelector('#hskBack'), ov.querySelector('#hskOvClose')]);
      ov.querySelectorAll && ov.querySelectorAll('button').forEach(function(b){
        var t=(b.innerText||b.textContent||'').trim();
        if(/^è¿”å›|^Back/i.test(t)) cand.push(b);
      });
    }
    if(pn){
      if(pn.querySelector) cand = cand.concat([pn.querySelector('#hskBack'), pn.querySelector('#hskOvClose')]);
      pn.querySelectorAll && pn.querySelectorAll('button').forEach(function(b){
        var t=(b.innerText||b.textContent||'').trim();
        if(/^è¿”å›|^Back/i.test(t)) cand.push(b);
      });
    }
    cand.forEach(upgradeBack3D);
  }

  // --- Dev-CN: trial back returns to last-opened level lessons, not fixed beg1 ---
  function installDevCNGuards(){
    var levels = $id('levelsPanel');
    if(levels){
      levels.addEventListener('click', function(e){
        var btn = e.target.closest('.lv-btn'); if(!btn) return;
        if(moduleKey() === 'dev-cn'){
          window.__devcn_lastLevel = btn.getAttribute('data-level') || window.__devcn_lastLevel || 'beg1';
          window.__lastGameContext = 'dev-cn';
        }
      }, true);
    }
    var lessons = $id('lessonsPanel');
    if(lessons){
      lessons.addEventListener('click', function(e){
        var btn = e.target.closest('.lesson-btn'); if(!btn) return;
        if(moduleKey() === 'dev-cn'){
          window.__lastGameContext = 'dev-cn';
        }
      }, true);
    }

    // Back routing for Dev-CN: go to levelsPanel then auto-click last level
    function goBackDevCN(){
      try{ if(typeof window.showSection==='function'){ window.showSection('levelsPanel'); } }catch(_){}
      setTimeout(function(){
        var lv = window.__devcn_lastLevel || 'beg1';
        var panel = $id('levelsPanel');
        if(panel){
          var target = panel.querySelector('[data-level="'+lv+'"]') || panel.querySelector('[data-level="beg1"]');
          if(target && target.click) target.click();
        }
      }, 0);
    }

    document.addEventListener('click', function(e){
      var back = e.target.closest('#btnBack,#lessonsBack,.btn-back,.mini-btn#btnBack');
      if(!back) return;
      if(window.__lastGameContext === 'dev-cn'){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation && e.stopImmediatePropagation();
        goBackDevCN();
      }
    }, true);
  }

  document.addEventListener('DOMContentLoaded', function(){
    scanBackButtons();
    var mo = new MutationObserver(scanBackButtons);
    mo.observe(document.body, {subtree:true, childList:true});

    installDevCNGuards();
  });
})();
</script>

<!-- === Fill-in-the-Blank (Fill) â€” Overlay + Explain Drawer + Levels === -->
<style>
  #fillDemoScreen.fill-hidden{display:none}
  #fillDemoScreen{position:fixed;inset:0;background:rgba(10,14,25,.60);z-index:9999;display:flex;flex-direction:column;padding:16px;color:#0d1b2a;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial,sans-serif}
  #fillDemoHeader{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .fill-title{font-size:20px;font-weight:700;letter-spacing:.5px;color:#0b1b3a}
  .fill-controls{display:flex;gap:8px}
  .fill-btn{border:none;padding:10px 14px;border-radius:12px;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.5),0 6px 16px rgba(0,0,0,.20);color:#0b2545;transition:transform .06s ease, box-shadow .1s ease, background .2s ease}
  .fill-btn:hover{transform:translateY(-1px)}
  .fill-area{flex:1;display:flex;align-items:flex-start;justify-content:center;position:relative}
  #fillDemoArea{width:min(1000px,92vw);min-height:420px;border-radius:16px;padding:18px;background:linear-gradient(180deg,rgba(242,248,255,.96),rgba(224,236,255,.94)),radial-gradient(900px 500px at 20% -10%, rgba(120,160,255,.18), transparent 70%);box-shadow:0 20px 50px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.65)}
  .fill-hint{font-size:16px;color:#0b1b3a;margin:0 0 28px 2px;line-height:1.5;opacity:.92}
  .fill-sentence{display:flex;flex-direction:column;gap:10px;padding:12px 14px;background:#f0f6ff;border-radius:12px;margin-bottom:14px}
  .fill-choices{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .choice-pill{padding:10px 16px;border-radius:999px;background:#dbe6ff;color:#0b2545;cursor:pointer;user-select:none;border:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.60),inset 0 -1px 0 rgba(0,0,0,.10),0 10px 24px rgba(0,0,0,.15);transition:transform .12s ease,box-shadow .12s ease,filter .15s ease;will-change:transform,box-shadow;perspective:600px;transform-style:preserve-3d;font-size:16px}
  .choice-pill:hover{filter:brightness(1.06)}
  .tile-c0{background:linear-gradient(160deg,#4b7bff,#94b0ff)}
  .tile-c1{background:linear-gradient(160deg,#8c5bff,#c5adff)}
  .tile-c2{background:linear-gradient(160deg,#2cc8c3,#8fe7e4)}
  .tile-c3{background:linear-gradient(160deg,#ff8b4f,#ffc0a3)}
  .tile-c4{background:linear-gradient(160deg,#58d24f,#a6ebb0)}
  .tile-c5{background:linear-gradient(160deg,#ff5b94,#ffb3cc)}
  .drop-slot{display:inline-block;min-width:80px;padding:8px 12px;border-radius:8px;border:2px dashed #6e8fd6;color:#0b2545;margin:0 6px;background:#fff}
  .drop-slot.filled{background:#e8fff0;border-color:#4cd36a;color:#0b3a1b;box-shadow:inset 0 2px 0 rgba(255,255,255,.70),inset 0 -2px 0 rgba(0,0,0,.10)}
  .status-line{font-size:18px;opacity:.95;color:#0b1b3a}
  /* Drawer */
  #explainPanel{position:absolute;right:120px;top:12px;width:min(52vw,676px);height:50%;display:none;flex-direction:column;background:rgba(245,249,255,.92);backdrop-filter:blur(6px);border-left:1px solid rgba(10,40,120,.12);box-shadow:-10px 0 30px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.7);z-index:3;border-radius:14px}
  #explainHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;font-weight:700;color:#0b1b3a}
  #explainBody{flex:1;padding:12px 16px;overflow:auto;white-space:pre-wrap;color:#0b2545;line-height:1.6;font-size:15px}
  #explainFooter{display:flex;gap:10px;padding:8px 10px;justify-content:space-between;align-items:center;border-top:1px solid rgba(10,40,120,.12);background:linear-gradient(180deg,rgba(235,243,255,.85),rgba(225,238,255,.85));border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .explain-buttons{display:flex;gap:10px;flex-wrap:wrap}
  .explain-btn,.explain-close{border:none;padding:10px 14px;border-radius:12px;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.5),0 6px 16px rgba(0,0,0,.18);color:#0b2545;font-weight:600;transition:transform .06s ease,box-shadow .1s ease,background .2s ease,filter .15s ease}
  .explain-btn:hover,.explain-close:hover{transform:translateY(-1px);filter:brightness(1.04)}
  .explain-btn:disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
  /* Level Selector */
  #fillLevelScreen{position:fixed;inset:0;background:rgba(10,14,25,.55);z-index:9998;display:none;align-items:center;justify-content:center}
  #fillLevelBox{width:min(900px,92vw);padding:24px;border-radius:18px;background:linear-gradient(180deg,rgba(242,248,255,.97),rgba(224,236,255,.95));box-shadow:0 18px 50px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7)}
  #fillLevelTitle{font-size:20px;font-weight:800;letter-spacing:.6px;color:#0b1b3a;margin-bottom:12px;text-align:center}
  #fillLevels{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:14px}
  .level-btn{display:flex;align-items:center;justify-content:center;padding:18px;border:none;border-radius:16px;cursor:pointer;color:#0b1b3a;font-size:18px;font-weight:800;letter-spacing:.4px;box-shadow:inset 1px 1px 0 rgba(255,255,255,.6), 0 12px 28px rgba(0,0,0,.18);transition:transform .08s ease, filter .12s ease, box-shadow .12s ease}
  .level-btn:hover{transform:translateY(-2px);filter:brightness(1.05)}
  #L1{background:linear-gradient(160deg,#7ed957,#c8ffb4)}
  #L2{background:linear-gradient(160deg,#58c7ff,#b8e8ff)}
  #L3{background:linear-gradient(160deg,#a78bfa,#d7c6ff)}
  #L4{background:linear-gradient(160deg,#ff8fab,#ffd0db)}
  .level-btn.lv-disabled{opacity:.45;filter:grayscale(.3);pointer-events:auto}
  .level-btn.lv-disabled:after{content:' æœªå¼€æ”¾'; font-size:12px; margin-left:6px; opacity:.8}
  #fillLevelClose{margin-top:14px;display:block;margin-left:auto;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);color:#0b2545}
</style>

<div id="fillDemoScreen" class="fill-hidden" role="dialog" aria-modal="true">
  <div id="fillDemoHeader">
    <div class="fill-title">é€‰è¯å¡«ç©º Â· è¯•ç© DEMO</div>
    <div class="fill-controls">
      <button id="fillPrevBtn" class="fill-btn">ä¸Šä¸€é¢˜ / Prev</button>
      <button id="fillNextBtn" class="fill-btn">ä¸‹ä¸€é¢˜ / Next</button>
      <button id="fillCloseBtn" class="fill-btn">è¿”å› / Back</button>
      <button id="fillSaveBtn" class="fill-btn" style="margin-left:8px;display:none;">ä¿å­˜ / Save</button>
      <span id="fillProgress" style="margin-left:8px;font-weight:700;color:#0b1b3a;display:none;"></span>
      <button id="fillJumpBtn" class="fill-btn" style="margin-left:8px;display:none;">è·³è½¬ / Jump</button>
    </div>
  </div>
  <div class="fill-area">
    <div id="fillJumpPanel" style="position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px"></div>
    <div id="fillDemoArea"></div>
    <div id="explainPanel">
      <div id="explainHeader">
        <div>ç­”æ¡ˆè§£æ Â· Explanation</div>
        <div style="opacity:.7;font-size:12px">ä¸­æ–‡ / English / FranÃ§ais / à¹„à¸—à¸¢ / Ğ ÑƒÑÑĞºĞ¸Ğ¹ / àº¥àº²àº§</div>
      </div>
      <div id="explainBody">ï¼ˆæœ¬é¢˜ç­”å¯¹åå¯é€‰æ‹©è¯­è¨€æ˜¾ç¤ºè§£æï¼‰</div>
      <div id="explainFooter">
        <div class="explain-buttons">
          <button class="explain-btn" data-lang="zh">ä¸­æ–‡</button>
          <button class="explain-btn" data-lang="en">English</button>
          <button class="explain-btn" data-lang="fr">FranÃ§ais</button>
          <button class="explain-btn" data-lang="th">à¹„à¸—à¸¢</button>
          <button class="explain-btn" data-lang="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
          <button class="explain-btn" data-lang="lo">àº¥àº²àº§</button>
        </div>
        <button class="explain-close">å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<div id="fillLevelScreen">
  <div id="fillLevelBox">
    <div id="fillLevelTitle">é€‰è¯å¡«ç©º Â· å¼€å§‹æ¸¸æˆ / Start Game</div>
    <div id="fillLevels">
      <button id="L1" class="level-btn">Level 1</button>
      <button id="L2" class="level-btn">Level 2</button>
      <button id="L3" class="level-btn">Level 3</button>
      <button id="L4" class="level-btn">Level 4</button>
    </div>
    <button id="fillLevelClose">å…³é—­ Close</button>
  </div>
</div>

<script>
// ===== Parsing core =====

function parseFillDemoText(text) {
  const out = [];
  const cleaned = (text||'')
    .replace(/^\uFEFF/, '')
    .replace(/\r\n/g, '\n');

  // Split blocks by multiple possible heading styles:
  // "ç¬¬1é¢˜", "ã€ç¬¬1é¢˜ã€‘", "[ç¬¬1é¢˜]", "é¢˜1", "Q1"
  const trySplitters = [
    /(?=^ç¬¬\s*\d+\s*é¢˜)/m,
    /(?=^[ã€\[]?\s*ç¬¬\s*\d+\s*é¢˜\s*[ã€‘\]])/m,
    /(?=^é¢˜\s*\d+)/m,
    /(?=^Q\s*\d+)/mi
  ];

  let blocks = [];
  for (const re of trySplitters){
    blocks = cleaned.split(re).filter(b => b && b.trim());
    if (blocks.length) break;
  }
  if (!blocks.length) {
    // last resort: split by two or more blank lines, hope each block starts with choices
    blocks = cleaned.split(/\n{2,}(?=\S)/m).filter(b => b.trim());
  }

  for (const b of blocks) {
    const lines = b.trim().split('\n').map(s=>s.trim());
    if (lines.length < 3) continue;
    const choices = (lines[1] || '').split(/\s+/).filter(Boolean);
    const subs = [];
    for (let i=2;i<lines.length;i++) {
      const cur = lines[i];
      if (!cur) continue;
      if (/^(ç­”æ¡ˆè§£æï¼ˆ|\[?å¥\s*\d+\]?|æŠ€å·§[:ï¼š])/.test(cur)) break;
      if (/æ­£ç¡®ç­”æ¡ˆ[:ï¼š]/.test(cur)) {
        const ans = cur.split(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š]\s*/)[1]?.trim();
        if (ans && subs.length>0 && !subs[subs.length-1].answer) subs[subs.length-1].answer = ans;
        continue;
      }
      const m = cur.match(/^(?:\[?å¥\s*(\d+)\]?|å¥\s*(\d+)|\((\d+)\)|ï¼ˆ(\d+)ï¼‰)?\s*(.*)$/);
      if (!m) continue;
      const sentence = m[5] || cur;
      subs.push({ sentence, answer: '' });
    }
    // If the last line contains a combined answers line
    const ansLine = lines.find(l=>/^æ­£ç¡®ç­”æ¡ˆ[:ï¼š]/.test(l));
    if (ansLine) {
      const ans = ansLine.split(/æ­£ç¡®ç­”æ¡ˆ[:ï¼š]\s*/)[1] || '';
      const arr = ans.split(/\s+/).filter(Boolean);
      arr.forEach((a,i)=> { if (subs[i] && !subs[i].answer) subs[i].answer = a; });
    }
    out.push({ choices, subQuestions: subs });
  }
  return out;
}
let ExplainData = []; // will set on start

// ---- Fill Demo (global) ----
window.FillDemo = (() => {
  let questions = [];
  let idx = 0;
  function syncState(){ window.__FILL_IDX__ = idx; window.__FILL_TOTAL__ = (questions?questions.length:0); if (typeof window.updateProgressUI==='function') window.updateProgressUI(); }

  function enableTileFX(el){
    function onMove(e){ const r = el.getBoundingClientRect(); const px = (e.clientX - r.left)/r.width - 0.5; const py = (e.clientY - r.top)/r.height - 0.5; const rx = (-py*12).toFixed(2); const ry = (px*14).toFixed(2); el.style.transform = 'translateY(-2px) rotateX(' + rx + 'deg) rotateY(' + ry + 'deg)'; el.style.boxShadow = '0 18px 30px rgba(0,0,0,0.18)'; }
    function reset(){ el.style.transform = ''; el.style.boxShadow = '0 10px 24px rgba(0,0,0,0.15)'; }
    el.addEventListener('mousemove', onMove); el.addEventListener('mouseleave', reset);
  }

  function show() { document.getElementById('fillDemoScreen').classList.remove('fill-hidden'); }
  function hide() { document.getElementById('fillDemoScreen').classList.add('fill-hidden'); }

  function checkAllFilled(container){ const slots = Array.from(container.querySelectorAll('.fill-sentence .drop-slot')); return slots.length>0 && slots.every(s => s.classList.contains('filled')); }

  function render() { syncState();
    const area = document.getElementById('fillDemoArea'); area.innerHTML = '';
    const hint = document.createElement('div'); hint.className = 'fill-hint'; hint.innerHTML = 'è¯·å°†æ­£ç¡®çš„å•è¯ç‚¹å‡»åå¡«å…¥å¥å­ç©ºæ ¼ä¸­<br><span style="opacity:.85">Click the correct word to fill in the blank.</span>'; area.appendChild(hint);
    if (idx >= questions.length) { area.innerHTML += '<div style="text-align:center;padding:40px">æ‰€æœ‰è¯•ç©é¢˜ç›®å®Œæˆï¼</div>'; return; }
    const q = questions[idx];
    q.subQuestions.forEach((sub, sIdx) => {
      const box = document.createElement('div'); box.className = 'fill-sentence';
      const sentence = sub.sentence.replace(/[ï¼ˆ(]([^ï¼‰)]+)[ï¼‰)]/, '<span class="drop-slot"></span>');
      const sLine = document.createElement('div'); sLine.className = 'status-line'; sLine.innerHTML = sentence;
      const slotInit = sLine.querySelector('.drop-slot'); if (slotInit) { slotInit.dataset.ans = (sub.answer || '').trim(); }
      box.appendChild(sLine);
      const row = document.createElement('div'); row.className = 'fill-choices';
      q.choices.forEach((word, i) => { const pill = document.createElement('span'); pill.className = 'choice-pill tile-c' + (i % 6); pill.textContent = word; enableTileFX(pill);
        pill.addEventListener('click', () => { const slot = box.querySelector('.drop-slot:not(.filled)'); if (!slot) return; const target = (slot.dataset.ans || '').trim(); const chosen = (word || '').trim(); if (chosen === target) { slot.textContent = word; slot.classList.add('filled'); if (checkAllFilled(area)) showExplainPanelFor(idx+1); } else { sLine.style.animation = 'shake .15s linear 1'; setTimeout(()=> sLine.style.animation = '', 160); } });
        row.appendChild(pill); });
      box.appendChild(row); area.appendChild(box);
    });
  }

  function startDemo(textOpt) {
    try {
      const sourceText = (typeof textOpt==='string' && textOpt.trim()) ? textOpt : (window.__FILL_OVERRIDE__ || '');
      if (!sourceText) { alert('æœªæ‰¾åˆ°é¢˜åº“æ•°æ®'); return; }
      // refresh explanations from the same source
      try { window.__FILL_EXPLAINS__ = sourceText; ExplainData = parseExplainBlocks(sourceText); } catch(e){ console.warn('Explain parse fail', e); }
      questions = parseFillDemoText(sourceText);
      if (!questions || !questions.length) {
        console.warn('Fill Demo parse returned 0 questions.');
        alert('æœªè¯†åˆ«åˆ°é¢˜ç›®ï¼Œè¯·æ£€æŸ¥é¢˜åº“æ ¼å¼æ˜¯å¦å«æœ‰â€œç¬¬1é¢˜ / é¢˜1 / Q1â€ç­‰é¢˜å¤´ã€‚');
        return;
      }
      idx = 0; syncState(); show(); render();
    } catch (e) { console.error(e); alert('é€‰è¯å¡«ç©ºè¯•ç©åˆå§‹åŒ–å¤±è´¥'); }
  }
  function next() { if (idx < questions.length - 1) { idx++; syncState(); render(); } }
  function prev() { if (idx > 0) { idx--; syncState(); render(); } }
  function back() { hide(); }

  window.addEventListener('DOMContentLoaded', () => { const prevBtn = document.getElementById('fillPrevBtn'); const nextBtn = document.getElementById('fillNextBtn'); const closeBtn = document.getElementById('fillCloseBtn'); if (prevBtn) prevBtn.addEventListener('click', prev); if (nextBtn) nextBtn.addEventListener('click', next); if (closeBtn) closeBtn.addEventListener('click', back); });

  function goto(i){ if (!questions) return; i=Math.max(0,Math.min(i,questions.length-1)); idx=i; syncState(); render(); }
  return { startDemo, next, prev, back, render, goto };
})();

function ensureExplainData() { return ExplainData || []; }
function showExplainPanelFor(questionIndex) {
  const panel = document.getElementById('explainPanel');
  const body  = document.getElementById('explainBody');
  const area = document.getElementById('fillDemoArea');
  const first = area && area.querySelector('.fill-sentence');
  if (first) panel.style.top = (first.offsetTop + 8) + 'px';
  panel.style.display = 'flex';

  const dataAll = ensureExplainData();
  const data = dataAll[questionIndex] || {};
  function md2html(s){
    if(!s) return '';
    const esc = String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return esc.replace(/\*\*([\s\S]+?)\*\*/g,'<strong>$1</strong>');
  }
  const setText = (txt) => { body.innerHTML = md2html((txt && txt.trim()) ? txt : 'ï¼ˆè¯¥è¯­è¨€æš‚æ— è§£æï¼‰'); };

  const btns = panel.querySelectorAll('.explain-btn');
  btns.forEach(btn => {
    const lang = btn.dataset.lang;
    const has  = data && data[lang] && data[lang].trim().length > 0;
    btn.disabled = !has;
    btn.onclick = () => setText(data[lang] || '');
  });

  const defaultLang = (data.zh && 'zh') || (data.en && 'en') || (data.th && 'th') || (data.ru && 'ru') || (data.lo && 'lo') || null;
  if (defaultLang) { body.textContent = data[defaultLang]; } else { body.textContent = 'ï¼ˆè¯¥é¢˜æš‚æ— è§£æï¼‰'; }

  panel.querySelector('.explain-close').onclick = () => { panel.style.display = 'none'; };
}

// ---- Level selector logic ----
window.FillLevel = (function(){
  const scr = () => document.getElementById('fillLevelScreen');
  function open(){ scr().style.display='flex'; }
  function close(){ scr().style.display='none'; }
  async function start(levelKey){
    if (levelKey === 'L1'){
      const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') {
          window.FillDemo.startDemo(text);
        } else if (window.startFillDemo) {
          window.__FILL_OVERRIDE__ = text; window.startFillDemo();
        }
        close();
        if (typeof showToast==='function') showToast('Level 1 æ•°æ®å·²è½½å…¥', 'success');
      }catch(e){
        console.error(e);
        alert('Level 1 é¢˜åº“åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
      }
      return;
    }
    if (typeof showToast === 'function') showToast('Level 2/3/4 æš‚æœªå¼€æ”¾', 'info');
  }
  window.addEventListener('DOMContentLoaded', () => {
    ['L1','L2','L3','L4'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', () => start(id));
      if (id !== 'L1') { el.classList.add('lv-disabled'); el.setAttribute('aria-disabled','true'); }
    });
    const closeBtn = document.getElementById('fillLevelClose');
    if (closeBtn) closeBtn.addEventListener('click', close);
  });
  return { open, close, start };
})();

// ---- Safe starter ----
window.startFillDemo = function(){
  if (window.FillDemo && window.FillDemo.startDemo){
    // If there is default embedded dataset, you could set window.__FILL_OVERRIDE__ before calling this.
    if (!window.__FILL_OVERRIDE__){
      // fallback to Level1 loader
      (async function(){try{const r=await fetch('https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%A1%AB%E7%A9%BA%E8%AF%95%E7%8E%A9-%E8%AF%95%E9%A2%98%E5%AF%BC%E5%85%A5%E6%A8%A1%E6%9D%BF-%E5%B8%A6%E8%A7%A3%E6%9E%90.txt'); if(r.ok){ const t=await r.text(); window.__FILL_OVERRIDE__=t; window.FillDemo&&window.FillDemo.startDemo&&window.FillDemo.startDemo(t); return; } }catch(_e){ console.warn('Demo FR fetch failed, fallback to Level1', _e); } window.FillLevel && window.FillLevel.start && window.FillLevel.start('L1'); })();
      return;
    }
    window.FillDemo.startDemo(window.__FILL_OVERRIDE__);
  }
};
</script>
<!-- === End Fill-in-the-Blank (Fill) === -->


<!-- ==== Fill module: overrides & UI enhancements ==== -->
<script>
(function(){
  // 1) Embedded DEMO dataset (3 questions)
  if (!window.__EMBEDDED_FILL__) {
    window.__EMBEDDED_FILL__ = `ç¬¬1é¢˜
æ—è¾¹ é‡Œé¢ ä¸Šé¢

å¥å­1. é’¥åŒ™å°±åœ¨æ¡Œå­ (    )ï¼Œä½ æ²¡çœ‹åˆ°å—ï¼Ÿ 
æ­£ç¡®ç­”æ¡ˆ: ä¸Šé¢

å¥å­2. æˆ‘çš„å®¿èˆåœ¨å­¦æ ¡é£Ÿå ‚ (   )ï¼Œåƒé¥­å¾ˆæ–¹ä¾¿ã€‚
æ­£ç¡®ç­”æ¡ˆ: æ—è¾¹

å¥å­3.æˆ‘æŠŠæ–°ä¹°çš„ç¾½ç»’æœæ”¾è¿›äº†è¡£æŸœ (    )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: é‡Œé¢

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] æ¡Œå­æ˜¯å¹³é¢ï¼Œä¸œè¥¿æ”¾åœ¨è¡¨é¢â†’é€‰ä¸Šé¢ã€‚
[å¥2] å®¿èˆå’Œé£Ÿå ‚åªæ˜¯æŒ¨ç€ï¼Œä¸åœ¨å¯¹æ–¹é‡Œâ†’é€‰æ—è¾¹ã€‚
[å¥3] æœ‰â€œæ”¾è¿›/è¿›åˆ°â€ï¼Œè¯´æ˜è¿›å…¥å®¹å™¨å†…éƒ¨â†’é€‰é‡Œé¢ã€‚
æŠ€å·§ï¼šçœ‹å…³é”®è¯â€”â€”â€œå¹³é¢â†’ä¸Šâ€ï¼Œâ€œç›¸é‚»â†’æ—è¾¹â€ï¼Œâ€œè¿›/å…¥â†’é‡Œâ€ã€‚

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] A table is a flat surface; things sit on the surface â†’ choose ä¸Šé¢ (â€œon topâ€).
[S2] The dorm and the cafeteria are next to each other, not one inside the other â†’ choose æ—è¾¹ (â€œbesideâ€).
[S3] â€œPut in/intoâ€ shows movement into a container â†’ choose é‡Œé¢ (â€œinsideâ€).
Test tip:Spot the cues â€” flat surface â†’ ä¸Šé¢ (on top); adjacent â†’ æ—è¾¹ (beside); into â†’ é‡Œé¢ (inside).

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[à¸›à¸£à¸°à¹‚à¸¢à¸„1] à¹‚à¸•à¹Šà¸°à¹€à¸›à¹‡à¸™à¸à¸·à¹‰à¸™à¸£à¸²à¸š à¸§à¸²à¸‡à¸‚à¸­à¸‡à¸šà¸™à¸œà¸´à¸§à¸«à¸™à¹‰à¸² â†’ à¹€à¸¥à¸·à¸­à¸ ä¸Šé¢ (à¸šà¸™)
[à¸›à¸£à¸°à¹‚à¸¢à¸„2] à¸«à¸­à¸à¸±à¸à¸à¸±à¸šà¹‚à¸£à¸‡à¸­à¸²à¸«à¸²à¸£à¸­à¸¢à¸¹à¹ˆà¸•à¸´à¸”à¸à¸±à¸™ à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¸ à¸²à¸¢à¹ƒà¸™à¸à¸±à¸™ â†’ à¹€à¸¥à¸·à¸­à¸ æ—è¾¹ (à¸‚à¹‰à¸²à¸‡à¹†)
[à¸›à¸£à¸°à¹‚à¸¢à¸„3] â€œà¹ƒà¸ªà¹ˆà¹€à¸‚à¹‰à¸²/à¸™à¸³à¹€à¸‚à¹‰à¸²â€ à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¸ à¸²à¸Šà¸™à¸° â†’ à¹€à¸¥à¸·à¸­à¸ é‡Œé¢ (à¸‚à¹‰à¸²à¸‡à¹ƒà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸”à¸¹à¸„à¸³à¸šà¸­à¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ â€” à¸à¸·à¹‰à¸™à¸£à¸²à¸š â†’ ä¸Šé¢ï¼›à¸•à¸´à¸”à¸à¸±à¸™ â†’ æ—è¾¹ï¼›à¹€à¸‚à¹‰à¸²à¹„à¸› â†’ é‡Œé¢ã€‚

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1]Ğ¡Ñ‚Ğ¾Ğ» â€” Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ; Ğ²ĞµÑ‰Ğ¸ Ğ»ĞµĞ¶Ğ°Ñ‚ Ğ½Ğ° Ğ½ĞµĞ¹ â†’ ä¸Šé¢ (Â«Ğ½Ğ°Ğ²ĞµÑ€Ñ…Ñƒ/Ğ½Ğ°Â»)
[ĞŸ2]ĞĞ±Ñ‰ĞµĞ¶Ğ¸Ñ‚Ğ¸Ğµ Ğ¸ ÑÑ‚Ğ¾Ğ»Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ€ÑĞ´Ğ¾Ğ¼, Ğ½Ğµ Ğ¾Ğ´Ğ½Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ â†’ æ—è¾¹ (Â«Ñ€ÑĞ´Ğ¾Ğ¼Â»)
[ĞŸ3]Â«ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ²/Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒÂ» ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° â†’ é‡Œé¢ (Â«Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ â†’ ä¸Šé¢; Ñ€ÑĞ´Ğ¾Ğ¼ â†’ æ—è¾¹; Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ é‡Œé¢.

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[àº›àº°à»‚àº«àºàº1]à»‚àº•àº°à»€àº›àº±àº™àºàº·à»‰àº™àº®àº²àºš àº‚àº­àº‡àº¢àº¹à»ˆà»€àº—àº´àº‡àºœàº´àº§à»œà»‰àº² â†’ à»€àº¥àº·àº­àº ä¸Šé¢ (à»€àº—àº´àº‡)
[àº›àº°à»‚àº«àºàº2]àº«à»àºàº±àºàºàº±àºšà»‚àº®àº‡àº­àº²àº«àº²àº™àº¢àº¹à»ˆàº•àº´àº”àºàº±àº™ àºšà»à»ˆà»„àº”à»‰àº¢àº¹à»ˆàºàº²àºà»ƒàº™àºàº±àº™ â†’ à»€àº¥àº·àº­àº æ—è¾¹ (àº‚à»‰àº²àº‡)
[àº›àº°à»‚àº«àºàº3]â€œà»ƒàºªà»ˆà»€àº‚àº»à»‰àº²/àº™àº³à»€àº‚àº»à»‰àº²â€ àºŠàºµà»‰àºàº²àº™à»€àº‚àº»à»‰àº²à»„àº›à»ƒàº™àºàº²àºŠàº°àº™àº° â†’ à»€àº¥àº·àº­àº é‡Œé¢ (àº‚à»‰àº²àº‡à»ƒàº™)
à»€àº„àº±àº”àº¥àº±àºš: àºªàº±àº‡à»€àºàº”àº„àº³àºšàº­àºàº•àº³à»à»œà»ˆàº‡â€”àºàº·à»‰àº™àº®àº²àºšâ†’ä¸Šé¢ï¼›àº¢àº¹à»ˆàº•àº´àº”â†’æ—è¾¹ï¼›à»€àº‚àº»à»‰àº²à»„àº›â†’é‡Œé¢ã€‚


ç¬¬2é¢˜
å†· æš–å’Œ å‡‰å¿«

å¥å­1. å†¬å¤©åˆ°äº†ï¼Œå¤©æ°”å¾ˆ (  )ï¼Œä½ è¦å¤šç©¿è¡£æœã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å†·

å¥å­2. ç§‹å¤©çš„æ™šä¸Šå¾ˆ (   )ï¼Œç‰¹åˆ«é€‚åˆæ•£æ­¥ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å‡‰å¿«

å¥å­3.ç©¿ä¸Šè¿™ä»¶åšæ¯›è¡£ï¼Œå…¨èº«éƒ½æ„Ÿè§‰å¾ˆ (   )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å†¬å¤©+â€œå¾ˆâ€=ä½æ¸© â†’ å†·ï¼ˆcoldï¼‰
[å¥2] ç§‹å¤œèˆ’é€‚å¾®å‡‰ â†’ å‡‰å¿«ï¼ˆcool/pleasantï¼‰
[å¥3] ç©¿åšè¡£ä½“æ„Ÿå‡æ¸© â†’ æš–å’Œï¼ˆwarmï¼‰
æŠ€å·§ï¼šä¸¥å¯’â†’å†·ï¼›å¾®å‡‰èˆ’æœâ†’å‡‰å¿«ï¼›æ¸©æš–â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Winter + â€œveryâ€ â†’ low temp â†’ å†· (cold)
[S2] Autumn night, pleasantly cool â†’ å‡‰å¿« (cool)
[S3] Thick sweater â†’ feels æš–å’Œ (warm)
Tip: severe coldâ†’å†·; pleasantly coolâ†’å‡‰å¿«; warmâ†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¸«à¸™à¹‰à¸²à¸«à¸™à¸²à¸§ + â€œà¸¡à¸²à¸â€ = à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸•à¹ˆà¸³ â†’ å†· (à¸«à¸™à¸²à¸§)
[2] à¸„à¹ˆà¸³à¹ƒà¸™à¸¤à¸”à¸¹à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡ à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢ â†’ å‡‰å¿« (à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢)
[3] à¹ƒà¸ªà¹ˆà¹€à¸ªà¸·à¹‰à¸­à¸«à¸™à¸²à¹à¸¥à¹‰à¸§à¸­à¸šà¸­à¸¸à¹ˆà¸™ â†’ æš–å’Œ (à¸­à¸šà¸­à¸¸à¹ˆà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸«à¸™à¸²à¸§à¸ˆà¸±à¸”â†’å†·; à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢â†’å‡‰å¿«; à¸­à¸šà¸­à¸¸à¹ˆà¸™â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] Ğ—Ğ¸Ğ¼Ğ° + Â«Ğ¾Ñ‡ĞµĞ½ÑŒÂ» â†’ Ğ½Ğ¸Ğ·ĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° â†’ å†· (Â«Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Â»)
[ĞŸ2] ĞÑĞµĞ½Ğ½Ğ¸Ğ¼ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾ â†’ å‡‰å¿« (Â«Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾Â»)
[ĞŸ3] Ğ¢Ğ¾Ğ»ÑÑ‚Ñ‹Ğ¹ ÑĞ²Ğ¸Ñ‚ĞµÑ€ â†’ Ğ¾Ñ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ æš–å’Œ (Â«Ñ‚ĞµĞ¿Ğ»Ğ¾/Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ»Ğ¾Ğ´â†’å†·; Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ°â†’å‡‰å¿«; Ñ‚ĞµĞ¿Ğ»Ğ¾â†’æš–å’Œ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] àº¥àº°àº”àº¹àº«àº™àº²àº§ + â€œàº«àº¼àº²àºâ€ â†’ àº­àº¸àº™àº«àº°àºàº¹àº¡àº•à»ˆàº³ â†’ å†· (à»œàº²àº§)
[2] àº„à»ˆàº³àº¥àº°àº”àº¹à»ƒàºšà»„àº¡à»‰àº«àº¼àº»à»ˆàº™ à»€àº¢àº±àº™àºªàº°àºšàº²àº â†’ å‡‰å¿« (à»€àº¢àº±àº™àºªàº°àºšàº²àº)
[3] à»ƒàºªà»ˆà»€àºªàº·à»‰àº­à»œàº² àº®àº¹à»‰àºªàº¶àºàº­àº»àºšàº­àº¸à»ˆàº™ â†’ æš–å’Œ (àº­àº»àºšàº­àº¸à»ˆàº™)
à»€àº„àº±àº”àº¥àº±àºš:à»œàº²àº§àº«àº¼àº²àºâ†’å†·; à»€àº¢àº±àº™àºªàº°àºšàº²àºâ†’å‡‰å¿«; àº­àº»àºšàº­àº¸à»ˆàº™â†’æš–å’Œ

ç¬¬3é¢˜
æ¯ åˆ å¥—
å¥å­1. æˆ‘æ˜¨å¤©å»å•†åœºä¹°äº†ä¸€ (  )æ–°å®¶å…·ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å¥—

å¥å­2. æˆ‘ (  )å¤©æ—©ä¸Šéƒ½å…­ç‚¹åŠèµ·åºŠã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æ¯

å¥å­3.ä»Šå¤©çš„ä½œä¸šæ²¡åšå®Œï¼Œæˆ‘æ˜å¤© (  )è¦æ—©èµ·åšç»ƒä¹ ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: åˆ

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å®¶å…·æˆâ€œå¥—â€è´­ä¹° â†’ é‡è¯ç”¨ å¥—ï¼ˆsetï¼‰
[å¥2] é¢‘ç‡å›ºå®šâ€œæ¯å¤©â€ â†’ æ¯ï¼ˆeveryï¼‰
[å¥3] å†æ¬¡å‘ç”Ÿ/åˆä¸€æ¬¡ï¼ˆå¸¸å¸¦â€œåˆè¦â€¦â€è¯­æ°”ï¼‰â†’ åˆï¼ˆagainï¼‰
æŠ€å·§ï¼šé‡è¯â†’å¥—ï¼›é¢‘ç‡â†’æ¯ï¼›é‡å¤â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Furniture bought as a set â†’ classifier å¥— (set)
[S2] Fixed frequency â€œevery dayâ€ â†’ æ¯ (every)
[S3] Repeated action (often â€œagainâ€) â†’ åˆ (again)
Tip: classifierâ†’å¥—; frequencyâ†’æ¯; repetitionâ†’åˆ

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¹€à¸Ÿà¸­à¸£à¹Œà¸™à¸´à¹€à¸ˆà¸­à¸£à¹Œà¸‹à¸·à¹‰à¸­à¹€à¸›à¹‡à¸™ â€œà¸Šà¸¸à¸”â€ â†’ à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡ å¥— (à¸Šà¸¸à¸”)
[2] à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¸›à¸£à¸°à¸ˆà¸³ â€œà¸—à¸¸à¸à¸§à¸±à¸™â€ â†’ æ¯ (à¸—à¸¸à¸...)
[3] à¸à¸²à¸£à¹€à¸à¸´à¸”à¸‹à¹‰à¸³/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (à¸¡à¸±à¸à¸¡à¸µà¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡ â€œà¸­à¸µà¸à¹à¸¥à¹‰à¸§â€) â†’ åˆ (à¸­à¸µà¸/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡â†’å¥—; à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆâ†’æ¯; à¸‹à¹‰à¸³/à¸­à¸µà¸â†’åˆ

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] ĞœĞµĞ±ĞµĞ»ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ÑÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ¾Ğ¼ â†’ ÑÑ‡Ñ‘Ñ‚Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ å¥— (Â«Ğ½Ğ°Ğ±Ğ¾Ñ€/ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Â»)
[ĞŸ2] Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒÂ» â†’ æ¯ (Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹Â»)
[ĞŸ3] ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ñ‡Ğ°ÑÑ‚Ğ¾ Ñ Ğ¾Ñ‚Ñ‚ĞµĞ½ĞºĞ¾Ğ¼ Â«Ğ¾Ğ¿ÑÑ‚ÑŒÂ») â†’ åˆ (Â«Ğ¾Ğ¿ÑÑ‚ÑŒ/ÑĞ½Ğ¾Ğ²Ğ°Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€â†’å¥—; Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒâ†’æ¯; Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] à»€àºŸàºµàº™àºµà»€àºˆàºµàºŠàº·à»‰à»€àº›àº±àº™ â€œàºŠàº¸àº”â€ â†’ àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡ å¥— (àºŠàº¸àº”)
[2] àº„àº§àº²àº¡àº–àºµà»ˆàº›àº°àºˆàº³ â€œàº—àº¸àºàº¡àº·à»‰â€ â†’ æ¯ (àº—àº¸àº...)
[3] à»€àºàºµàº”àºŠà»‰àº³/àº­àºµàºàº„àº±à»‰àº‡ (àº¡àº±àºàº¡àºµàº™à»‰àº³à»ƒàºˆ â€œàº­àºµàºà»àº¥à»‰àº§â€) â†’ åˆ (àº­àºµàº/àº­àºµàºàº„àº±à»‰àº‡)
à»€àº„àº±àº”àº¥àº±àºš: àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡â†’å¥—; àº„àº§àº²àº¡àº–àºµà»ˆâ†’æ¯; àºŠà»‰àº³â†’åˆ`;
  }

  // 2) Tolerant explain parser
  window.parseExplainBlocks = function(text) {
    const out = [];
    const blocks = (text || '').replace(/^\uFEFF/,'').split(/(?=^ç¬¬\s*\d+\s*é¢˜\s*$)/m).filter(b => b.trim());
    for (const b of blocks) {
      const head = b.match(/^ç¬¬\s*(\d+)\s*é¢˜/m);
      const idx = head ? parseInt(head[1], 10) : out.length + 1;

      const map = { zh: '', en: '', th: '', ru: '', lo: '' };
      const labels = [
        { key: 'zh', variants: ['ä¸­æ–‡','Chinese'] },
        { key: 'en', variants: ['è‹±æ–‡','English'] },
        { key: 'th', variants: ['æ³°è¯­','à¹„à¸—à¸¢'] },
        { key: 'ru', variants: ['ä¿„è¯­','Ğ ÑƒÑÑĞºĞ¸Ğ¹'] },
        { key: 'lo', variants: ['è€æŒè¯­','àº¥àº²àº§'] },
      ];

      function headerRange(block, variant) {
        const patterns = [
          new RegExp('^\\s*ç­”æ¡ˆè§£æï¼ˆ' + variant + 'ï¼‰\\s*$', 'm'),
          new RegExp('^\\s*ç­”æ¡ˆ' + variant + 'è§£æ\\s*$', 'm'),
          new RegExp('^\\s*è§£æï¼ˆ' + variant + 'ï¼‰\\s*$', 'm')
        ];
        for (const r of patterns) {
          const m = r.exec(block);
          if (m) return { start: m.index, end: m.index + m[0].length };
        }
        return null;
      }

      const headers = [];
      for (const { key, variants } of labels) {
        for (const v of variants) {
          const rng = headerRange(b, v);
          if (rng) { headers.push({ key, start: rng.start, end: rng.end }); break; }
        }
      }
      headers.sort((a, c) => a.start - c.start);

      for (let i = 0; i < headers.length; i++) {
        const h = headers[i];
        const nextStart = (i < headers.length - 1) ? headers[i + 1].start : b.length;
        let body = b.slice(h.end, nextStart);
        body = body.replace(/^\s*\r?\n/, '');
        map[h.key] = body.trim();
      }

      // Heuristic zh/en swap
      const hasCJK = s => /[\u4e00-\u9fff]/.test(s||'');
      const hasLatin = s => /[A-Za-z]/.test(s||'');
      if (map.zh && !hasCJK(map.zh) && hasLatin(map.zh) && (!map.en || map.en.trim()==='')) { map.en = map.zh; map.zh = ''; }
      if (map.en && hasCJK(map.en) && (!map.zh || map.zh.trim()==='')) { map.zh = map.en; map.en = ''; }

      out[idx] = map;
    }
    return out;
  };

  // 3) Override startFillDemo: Demo uses embedded set; Level passes text explicitly.
  const _origShow = (window.FillDemo && window.FillDemo.render) ? window.FillDemo.render : null;
  window.__FILL_IS_LEVEL__ = false;
  window.startFillDemo = function(textOpt){
    try{
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length > 0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const sourceText = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      if (!sourceText) { alert('æœªæ‰¾åˆ°é¢˜åº“æ•°æ®'); return; }

      try { window.__FILL_EXPLAINS__ = sourceText; window.ExplainData = parseExplainBlocks(sourceText); } catch(e){ console.warn('Explain parse fail', e); }

      const qs = (window.parseFillDemoText ? window.parseFillDemoText(sourceText) : []);
      if (!qs || !qs.length) { alert('é¢˜åº“ä¸ºç©ºæˆ–æœªè¯†åˆ«ï¼Œè¯·æ£€æŸ¥é¢˜å¤´æ ¼å¼ï¼ˆç¬¬1é¢˜/é¢˜1/Q1ï¼‰'); return; }
      // Set globals used by FillDemo (depends on original code structure)
      window.questions = qs;
      window.idx = 0;

      // Show screen & render (use existing FillDemo API)
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') {
        // call the original start to reuse layout/bindings
        try { window.FillDemo.startDemo(sourceText); } catch(e) { console.warn(e); }
      }
      // Update progress UI after first render
      setTimeout(updateProgressUI, 0);
    }catch(e){ console.error(e); alert('é€‰è¯å¡«ç©ºåˆå§‹åŒ–å¤±è´¥'); }
  };

  // 4) Progress + Jump UI injection (only visible in Level mode)
  document.addEventListener('DOMContentLoaded', () => {
    const hdr = document.getElementById('fillDemoHeader');
    if (!hdr) return;
    if (!document.getElementById('fillProgressWrap')){
      const wrap = document.createElement('div');
      wrap.id = 'fillProgressWrap';
      wrap.style.cssText = 'margin-left:auto;display:flex;align-items:center;gap:8px;visibility:hidden;';
      const span = document.createElement('span');
      span.id = 'fillProgress';
      span.style.cssText = 'font-weight:700;color:#0b1b3a';
      const btn = document.createElement('button');
      btn.id = 'fillJumpBtn';
      btn.className = 'fill-btn';
      btn.style.padding = '8px 12px';
      btn.textContent = 'è·³è½¬';
      wrap.appendChild(span); wrap.appendChild(btn);
      hdr.appendChild(wrap);

      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      document.querySelector('.fill-area')?.appendChild(panel);
      btn.addEventListener('click', ()=>{
        panel.style.display = (panel.style.display==='grid' || panel.style.display==='block') ? 'none' : 'grid';
      });
    }
  });

  window.updateProgressUI = function(){
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    if (!show) return;
    const span = document.getElementById('fillProgress');
    const total = (typeof window.questions!=='undefined' && window.questions) ? window.questions.length : 0;
    const cur = (typeof window.idx!=='undefined' ? window.idx+1 : 1);
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total){
      panel.innerHTML='';
      for (let i=1;i<=total;i++){
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  // clear level flag on back (if original back exists it will still run)
  const backBtn = document.getElementById('fillCloseBtn');
  if (backBtn) backBtn.addEventListener('click', ()=>{ window.__FILL_IS_LEVEL__ = false; });

})();</script>


<!-- ==== Fill module: Progress+Jump+Save (append) ==== -->
<script>
(function(){
  // Mutation observer: inject UI when Fill overlay appears
  function ensureUI(){
    const header = document.getElementById('fillDemoHeader');
    if (!header || document.getElementById('fillProgressWrap')) return !!header && !!document.getElementById('fillProgressWrap');
    // Progress + Jump
    const wrap = document.createElement('div');
    wrap.id = 'fillProgressWrap';
    wrap.style.cssText = 'margin-left:auto;display:flex;align-items:center;gap:8px;visibility:hidden;';
    const span = document.createElement('span');
    span.id = 'fillProgress';
    span.style.cssText = 'font-weight:700;color:#0b1b3a';
    const jump = document.createElement('button');
    jump.id = 'fillJumpBtn';
    jump.className = 'fill-btn';
    jump.style.padding = '8px 12px';
    jump.textContent = 'è·³è½¬';
    wrap.appendChild(span); wrap.appendChild(jump);
    header.appendChild(wrap);

    // Save button next to è¿”å›
    const backBtn = document.getElementById('fillCloseBtn');
    if (backBtn && !document.getElementById('fillSaveBtn')){
      const save = document.createElement('button');
      save.id = 'fillSaveBtn';
      save.className = 'fill-btn';
      save.style.marginLeft = '8px';
      save.textContent = 'ä¿å­˜';
      backBtn.after(save);
      save.addEventListener('click', ()=>{
        try{
          const text = window.__FILL_SOURCE_TEXT__ || '';
          const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
          const idx = (typeof window.idx !== 'undefined') ? window.idx : 0;
          const total = (window.questions && window.questions.length) || 0;
          const payload = { sig, idx, total, ts: Date.now() };
          localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
          if (typeof showToast==='function') showToast('è¿›åº¦å·²ä¿å­˜ï¼š'+(idx+1)+'/'+total, 'success'); else alert('è¿›åº¦å·²ä¿å­˜');
        }catch(e){ console.warn(e); }
      });
    }

    // Jump panel
    if (!document.getElementById('fillJumpPanel')){
      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      const area = document.querySelector('.fill-area');
      if (area) area.appendChild(panel);
      jump.addEventListener('click', ()=>{
        panel.style.display = (panel.style.display==='grid' || panel.style.display==='block') ? 'none' : 'grid';
      });
    }
    return true;
  }

  // progress & jump helpers
  window.updateProgressUI = function(){
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    if (!show) return;
    const span = document.getElementById('fillProgress');
    const total = (window.questions && window.questions.length) || 0;
    const cur = (typeof window.idx !== 'undefined') ? window.idx + 1 : 1;
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total){
      panel.innerHTML = '';
      for (let i=1;i<=total;i++){
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  // Patch FillDemo APIs to keep progress up to date
  function patchAPIs(){
    if (!window.FillDemo) return;
    ['next','prev','render'].forEach(fn=>{
      const orig = window.FillDemo[fn];
      if (typeof orig === 'function'){
        window.FillDemo[fn] = function(){ const r = orig.apply(this, arguments); try{ updateProgressUI(); }catch(e){} return r; };
      }
    });
  }

  // Hook into startFillDemo to set level flag, source text, and resume if saved
  const originalStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    const isLevel = typeof textOpt === 'string' && textOpt.trim().length > 0;
    window.__FILL_IS_LEVEL__ = !!isLevel;
    if (isLevel) window.__FILL_SOURCE_TEXT__ = textOpt;
    // call original
    try{ originalStart && originalStart.apply(this, arguments); }catch(e){ console.warn(e); }
    // After initial render, inject UI & patch APIs
    setTimeout(()=>{
      ensureUI();
      patchAPIs();
      // resume progress if saved matches current dataset
      try{
        if (window.__FILL_IS_LEVEL__){
          const saveRaw = localStorage.getItem('FILL_L1_SAVE');
          if (saveRaw){
            const save = JSON.parse(saveRaw);
            const text = window.__FILL_SOURCE_TEXT__ || '';
            const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
            if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length){
              window.idx = save.idx;
              window.FillDemo && window.FillDemo.render && window.FillDemo.render();
              if (typeof showToast==='function') showToast('å·²ä»ä¿å­˜è¿›åº¦ç»§ç»­ï¼š'+(window.idx+1)+'/'+window.questions.length, 'success');
            }
          }
        }
      }catch(e){ console.warn(e); }
      updateProgressUI();
    }, 0);
  };

  // Observe DOM to inject when overlay is added
  const mo = new MutationObserver(()=>{ ensureUI(); });
  mo.observe(document.documentElement || document.body, { childList:true, subtree:true });

})();</script>


<!-- ==== Fill module: Progress+Jump+Save + Demo dataset (override) ==== -->
<script>
(function(){
  // 0) Embedded DEMO dataset (uploaded)
  window.__EMBEDDED_FILL__ = `ç¬¬1é¢˜
æ—è¾¹ é‡Œé¢ ä¸Šé¢

å¥å­1. é’¥åŒ™å°±åœ¨æ¡Œå­ (    )ï¼Œä½ æ²¡çœ‹åˆ°å—ï¼Ÿ 
æ­£ç¡®ç­”æ¡ˆ: ä¸Šé¢

å¥å­2. æˆ‘çš„å®¿èˆåœ¨å­¦æ ¡é£Ÿå ‚ (   )ï¼Œåƒé¥­å¾ˆæ–¹ä¾¿ã€‚
æ­£ç¡®ç­”æ¡ˆ: æ—è¾¹

å¥å­3.æˆ‘æŠŠæ–°ä¹°çš„ç¾½ç»’æœæ”¾è¿›äº†è¡£æŸœ (    )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: é‡Œé¢

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] æ¡Œå­æ˜¯å¹³é¢ï¼Œä¸œè¥¿æ”¾åœ¨è¡¨é¢â†’é€‰ä¸Šé¢ã€‚
[å¥2] å®¿èˆå’Œé£Ÿå ‚åªæ˜¯æŒ¨ç€ï¼Œä¸åœ¨å¯¹æ–¹é‡Œâ†’é€‰æ—è¾¹ã€‚
[å¥3] æœ‰â€œæ”¾è¿›/è¿›åˆ°â€ï¼Œè¯´æ˜è¿›å…¥å®¹å™¨å†…éƒ¨â†’é€‰é‡Œé¢ã€‚
æŠ€å·§ï¼šçœ‹å…³é”®è¯â€”â€”â€œå¹³é¢â†’ä¸Šâ€ï¼Œâ€œç›¸é‚»â†’æ—è¾¹â€ï¼Œâ€œè¿›/å…¥â†’é‡Œâ€ã€‚

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] A table is a flat surface; things sit on the surface â†’ choose ä¸Šé¢ (â€œon topâ€).
[S2] The dorm and the cafeteria are next to each other, not one inside the other â†’ choose æ—è¾¹ (â€œbesideâ€).
[S3] â€œPut in/intoâ€ shows movement into a container â†’ choose é‡Œé¢ (â€œinsideâ€).
Test tip:Spot the cues â€” flat surface â†’ ä¸Šé¢ (on top); adjacent â†’ æ—è¾¹ (beside); into â†’ é‡Œé¢ (inside).

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[à¸›à¸£à¸°à¹‚à¸¢à¸„1] à¹‚à¸•à¹Šà¸°à¹€à¸›à¹‡à¸™à¸à¸·à¹‰à¸™à¸£à¸²à¸š à¸§à¸²à¸‡à¸‚à¸­à¸‡à¸šà¸™à¸œà¸´à¸§à¸«à¸™à¹‰à¸² â†’ à¹€à¸¥à¸·à¸­à¸ ä¸Šé¢ (à¸šà¸™)
[à¸›à¸£à¸°à¹‚à¸¢à¸„2] à¸«à¸­à¸à¸±à¸à¸à¸±à¸šà¹‚à¸£à¸‡à¸­à¸²à¸«à¸²à¸£à¸­à¸¢à¸¹à¹ˆà¸•à¸´à¸”à¸à¸±à¸™ à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¸ à¸²à¸¢à¹ƒà¸™à¸à¸±à¸™ â†’ à¹€à¸¥à¸·à¸­à¸ æ—è¾¹ (à¸‚à¹‰à¸²à¸‡à¹†)
[à¸›à¸£à¸°à¹‚à¸¢à¸„3] â€œà¹ƒà¸ªà¹ˆà¹€à¸‚à¹‰à¸²/à¸™à¸³à¹€à¸‚à¹‰à¸²â€ à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¸ à¸²à¸Šà¸™à¸° â†’ à¹€à¸¥à¸·à¸­à¸ é‡Œé¢ (à¸‚à¹‰à¸²à¸‡à¹ƒà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸”à¸¹à¸„à¸³à¸šà¸­à¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ â€” à¸à¸·à¹‰à¸™à¸£à¸²à¸š â†’ ä¸Šé¢ï¼›à¸•à¸´à¸”à¸à¸±à¸™ â†’ æ—è¾¹ï¼›à¹€à¸‚à¹‰à¸²à¹„à¸› â†’ é‡Œé¢ã€‚

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1]Ğ¡Ñ‚Ğ¾Ğ» â€” Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ; Ğ²ĞµÑ‰Ğ¸ Ğ»ĞµĞ¶Ğ°Ñ‚ Ğ½Ğ° Ğ½ĞµĞ¹ â†’ ä¸Šé¢ (Â«Ğ½Ğ°Ğ²ĞµÑ€Ñ…Ñƒ/Ğ½Ğ°Â»)
[ĞŸ2]ĞĞ±Ñ‰ĞµĞ¶Ğ¸Ñ‚Ğ¸Ğµ Ğ¸ ÑÑ‚Ğ¾Ğ»Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ€ÑĞ´Ğ¾Ğ¼, Ğ½Ğµ Ğ¾Ğ´Ğ½Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ â†’ æ—è¾¹ (Â«Ñ€ÑĞ´Ğ¾Ğ¼Â»)
[ĞŸ3]Â«ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ²/Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒÂ» ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° â†’ é‡Œé¢ (Â«Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ â†’ ä¸Šé¢; Ñ€ÑĞ´Ğ¾Ğ¼ â†’ æ—è¾¹; Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ é‡Œé¢.

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[àº›àº°à»‚àº«àºàº1]à»‚àº•àº°à»€àº›àº±àº™àºàº·à»‰àº™àº®àº²àºš àº‚àº­àº‡àº¢àº¹à»ˆà»€àº—àº´àº‡àºœàº´àº§à»œà»‰àº² â†’ à»€àº¥àº·àº­àº ä¸Šé¢ (à»€àº—àº´àº‡)
[àº›àº°à»‚àº«àºàº2]àº«à»àºàº±àºàºàº±àºšà»‚àº®àº‡àº­àº²àº«àº²àº™àº¢àº¹à»ˆàº•àº´àº”àºàº±àº™ àºšà»à»ˆà»„àº”à»‰àº¢àº¹à»ˆàºàº²àºà»ƒàº™àºàº±àº™ â†’ à»€àº¥àº·àº­àº æ—è¾¹ (àº‚à»‰àº²àº‡)
[àº›àº°à»‚àº«àºàº3]â€œà»ƒàºªà»ˆà»€àº‚àº»à»‰àº²/àº™àº³à»€àº‚àº»à»‰àº²â€ àºŠàºµà»‰àºàº²àº™à»€àº‚àº»à»‰àº²à»„àº›à»ƒàº™àºàº²àºŠàº°àº™àº° â†’ à»€àº¥àº·àº­àº é‡Œé¢ (àº‚à»‰àº²àº‡à»ƒàº™)
à»€àº„àº±àº”àº¥àº±àºš: àºªàº±àº‡à»€àºàº”àº„àº³àºšàº­àºàº•àº³à»à»œà»ˆàº‡â€”àºàº·à»‰àº™àº®àº²àºšâ†’ä¸Šé¢ï¼›àº¢àº¹à»ˆàº•àº´àº”â†’æ—è¾¹ï¼›à»€àº‚àº»à»‰àº²à»„àº›â†’é‡Œé¢ã€‚


ç¬¬2é¢˜
å†· æš–å’Œ å‡‰å¿«

å¥å­1. å†¬å¤©åˆ°äº†ï¼Œå¤©æ°”å¾ˆ (  )ï¼Œä½ è¦å¤šç©¿è¡£æœã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å†·

å¥å­2. ç§‹å¤©çš„æ™šä¸Šå¾ˆ (   )ï¼Œç‰¹åˆ«é€‚åˆæ•£æ­¥ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å‡‰å¿«

å¥å­3.ç©¿ä¸Šè¿™ä»¶åšæ¯›è¡£ï¼Œå…¨èº«éƒ½æ„Ÿè§‰å¾ˆ (   )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å†¬å¤©+â€œå¾ˆâ€=ä½æ¸© â†’ å†·ï¼ˆcoldï¼‰
[å¥2] ç§‹å¤œèˆ’é€‚å¾®å‡‰ â†’ å‡‰å¿«ï¼ˆcool/pleasantï¼‰
[å¥3] ç©¿åšè¡£ä½“æ„Ÿå‡æ¸© â†’ æš–å’Œï¼ˆwarmï¼‰
æŠ€å·§ï¼šä¸¥å¯’â†’å†·ï¼›å¾®å‡‰èˆ’æœâ†’å‡‰å¿«ï¼›æ¸©æš–â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Winter + â€œveryâ€ â†’ low temp â†’ å†· (cold)
[S2] Autumn night, pleasantly cool â†’ å‡‰å¿« (cool)
[S3] Thick sweater â†’ feels æš–å’Œ (warm)
Tip: severe coldâ†’å†·; pleasantly coolâ†’å‡‰å¿«; warmâ†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¸«à¸™à¹‰à¸²à¸«à¸™à¸²à¸§ + â€œà¸¡à¸²à¸â€ = à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸•à¹ˆà¸³ â†’ å†· (à¸«à¸™à¸²à¸§)
[2] à¸„à¹ˆà¸³à¹ƒà¸™à¸¤à¸”à¸¹à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡ à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢ â†’ å‡‰å¿« (à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢)
[3] à¹ƒà¸ªà¹ˆà¹€à¸ªà¸·à¹‰à¸­à¸«à¸™à¸²à¹à¸¥à¹‰à¸§à¸­à¸šà¸­à¸¸à¹ˆà¸™ â†’ æš–å’Œ (à¸­à¸šà¸­à¸¸à¹ˆà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸«à¸™à¸²à¸§à¸ˆà¸±à¸”â†’å†·; à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢â†’å‡‰å¿«; à¸­à¸šà¸­à¸¸à¹ˆà¸™â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] Ğ—Ğ¸Ğ¼Ğ° + Â«Ğ¾Ñ‡ĞµĞ½ÑŒÂ» â†’ Ğ½Ğ¸Ğ·ĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° â†’ å†· (Â«Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Â»)
[ĞŸ2] ĞÑĞµĞ½Ğ½Ğ¸Ğ¼ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾ â†’ å‡‰å¿« (Â«Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾Â»)
[ĞŸ3] Ğ¢Ğ¾Ğ»ÑÑ‚Ñ‹Ğ¹ ÑĞ²Ğ¸Ñ‚ĞµÑ€ â†’ Ğ¾Ñ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ æš–å’Œ (Â«Ñ‚ĞµĞ¿Ğ»Ğ¾/Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ»Ğ¾Ğ´â†’å†·; Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ°â†’å‡‰å¿«; Ñ‚ĞµĞ¿Ğ»Ğ¾â†’æš–å’Œ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] àº¥àº°àº”àº¹àº«àº™àº²àº§ + â€œàº«àº¼àº²àºâ€ â†’ àº­àº¸àº™àº«àº°àºàº¹àº¡àº•à»ˆàº³ â†’ å†· (à»œàº²àº§)
[2] àº„à»ˆàº³àº¥àº°àº”àº¹à»ƒàºšà»„àº¡à»‰àº«àº¼àº»à»ˆàº™ à»€àº¢àº±àº™àºªàº°àºšàº²àº â†’ å‡‰å¿« (à»€àº¢àº±àº™àºªàº°àºšàº²àº)
[3] à»ƒàºªà»ˆà»€àºªàº·à»‰àº­à»œàº² àº®àº¹à»‰àºªàº¶àºàº­àº»àºšàº­àº¸à»ˆàº™ â†’ æš–å’Œ (àº­àº»àºšàº­àº¸à»ˆàº™)
à»€àº„àº±àº”àº¥àº±àºš:à»œàº²àº§àº«àº¼àº²àºâ†’å†·; à»€àº¢àº±àº™àºªàº°àºšàº²àºâ†’å‡‰å¿«; àº­àº»àºšàº­àº¸à»ˆàº™â†’æš–å’Œ

ç¬¬3é¢˜
æ¯ åˆ å¥—
å¥å­1. æˆ‘æ˜¨å¤©å»å•†åœºä¹°äº†ä¸€ (  )æ–°å®¶å…·ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å¥—

å¥å­2. æˆ‘ (  )å¤©æ—©ä¸Šéƒ½å…­ç‚¹åŠèµ·åºŠã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æ¯

å¥å­3.ä»Šå¤©çš„ä½œä¸šæ²¡åšå®Œï¼Œæˆ‘æ˜å¤© (  )è¦æ—©èµ·åšç»ƒä¹ ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: åˆ

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å®¶å…·æˆâ€œå¥—â€è´­ä¹° â†’ é‡è¯ç”¨ å¥—ï¼ˆsetï¼‰
[å¥2] é¢‘ç‡å›ºå®šâ€œæ¯å¤©â€ â†’ æ¯ï¼ˆeveryï¼‰
[å¥3] å†æ¬¡å‘ç”Ÿ/åˆä¸€æ¬¡ï¼ˆå¸¸å¸¦â€œåˆè¦â€¦â€è¯­æ°”ï¼‰â†’ åˆï¼ˆagainï¼‰
æŠ€å·§ï¼šé‡è¯â†’å¥—ï¼›é¢‘ç‡â†’æ¯ï¼›é‡å¤â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Furniture bought as a set â†’ classifier å¥— (set)
[S2] Fixed frequency â€œevery dayâ€ â†’ æ¯ (every)
[S3] Repeated action (often â€œagainâ€) â†’ åˆ (again)
Tip: classifierâ†’å¥—; frequencyâ†’æ¯; repetitionâ†’åˆ

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¹€à¸Ÿà¸­à¸£à¹Œà¸™à¸´à¹€à¸ˆà¸­à¸£à¹Œà¸‹à¸·à¹‰à¸­à¹€à¸›à¹‡à¸™ â€œà¸Šà¸¸à¸”â€ â†’ à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡ å¥— (à¸Šà¸¸à¸”)
[2] à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¸›à¸£à¸°à¸ˆà¸³ â€œà¸—à¸¸à¸à¸§à¸±à¸™â€ â†’ æ¯ (à¸—à¸¸à¸...)
[3] à¸à¸²à¸£à¹€à¸à¸´à¸”à¸‹à¹‰à¸³/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (à¸¡à¸±à¸à¸¡à¸µà¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡ â€œà¸­à¸µà¸à¹à¸¥à¹‰à¸§â€) â†’ åˆ (à¸­à¸µà¸/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡â†’å¥—; à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆâ†’æ¯; à¸‹à¹‰à¸³/à¸­à¸µà¸â†’åˆ

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] ĞœĞµĞ±ĞµĞ»ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ÑÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ¾Ğ¼ â†’ ÑÑ‡Ñ‘Ñ‚Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ å¥— (Â«Ğ½Ğ°Ğ±Ğ¾Ñ€/ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Â»)
[ĞŸ2] Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒÂ» â†’ æ¯ (Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹Â»)
[ĞŸ3] ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ñ‡Ğ°ÑÑ‚Ğ¾ Ñ Ğ¾Ñ‚Ñ‚ĞµĞ½ĞºĞ¾Ğ¼ Â«Ğ¾Ğ¿ÑÑ‚ÑŒÂ») â†’ åˆ (Â«Ğ¾Ğ¿ÑÑ‚ÑŒ/ÑĞ½Ğ¾Ğ²Ğ°Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€â†’å¥—; Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒâ†’æ¯; Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] à»€àºŸàºµàº™àºµà»€àºˆàºµàºŠàº·à»‰à»€àº›àº±àº™ â€œàºŠàº¸àº”â€ â†’ àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡ å¥— (àºŠàº¸àº”)
[2] àº„àº§àº²àº¡àº–àºµà»ˆàº›àº°àºˆàº³ â€œàº—àº¸àºàº¡àº·à»‰â€ â†’ æ¯ (àº—àº¸àº...)
[3] à»€àºàºµàº”àºŠà»‰àº³/àº­àºµàºàº„àº±à»‰àº‡ (àº¡àº±àºàº¡àºµàº™à»‰àº³à»ƒàºˆ â€œàº­àºµàºà»àº¥à»‰àº§â€) â†’ åˆ (àº­àºµàº/àº­àºµàºàº„àº±à»‰àº‡)
à»€àº„àº±àº”àº¥àº±àºš: àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡â†’å¥—; àº„àº§àº²àº¡àº–àºµà»ˆâ†’æ¯; àºŠà»‰àº³â†’åˆ`;

  // --- tolerant explain parser (supports ä¸­æ–‡/è‹±æ–‡/English/à¹„à¸—à¸¢/Ğ ÑƒÑÑĞºĞ¸Ğ¹/àº¥àº²àº§) ---
  window.parseExplainBlocks = function(text) {
    const out = [];
    const src = (text || '').replace(/^\uFEFF/, '');
    const blocks = src.split(/(?=^ç¬¬\s*\d+\s*é¢˜\s*$)/m).filter(b => b.trim());
    for (const b of blocks) {
      const head = b.match(/^ç¬¬\s*(\d+)\s*é¢˜/m);
      const idx = head ? parseInt(head[1], 10) : out.length + 1;
      const map = { zh: '', en: '', th: '', ru: '', lo: '' };
      const labels = [
        { key: 'zh', variants: ['ä¸­æ–‡','Chinese'] },
        { key: 'en', variants: ['è‹±æ–‡','English'] },
        { key: 'th', variants: ['æ³°è¯­','à¹„à¸—à¸¢'] },
        { key: 'ru', variants: ['ä¿„è¯­','Ğ ÑƒÑÑĞºĞ¸Ğ¹'] },
        { key: 'lo', variants: ['è€æŒè¯­','àº¥àº²àº§'] },
      ];
      function headerRange(block, variant) {
        const patterns = [
          new RegExp('^\\s*ç­”æ¡ˆè§£æï¼ˆ' + variant + 'ï¼‰\\s*$', 'm'),
          new RegExp('^\\s*ç­”æ¡ˆ' + variant + 'è§£æ\\s*$', 'm'),
          new RegExp('^\\s*è§£æï¼ˆ' + variant + 'ï¼‰\\s*$', 'm'),
        ];
        for (const r of patterns) { const m = r.exec(block); if (m) return { start: m.index, end: m.index + m[0].length }; }
        return null;
      }
      const headers = [];
      for (const { key, variants } of labels) {
        for (const v of variants) { const rng = headerRange(b, v); if (rng) { headers.push({ key, start: rng.start, end: rng.end }); break; } }
      }
      headers.sort((a,b)=>a.start-b.start);
      for (let i=0;i<headers.length;i++) {
        const h = headers[i];
        const nextStart = (i<headers.length-1)? headers[i+1].start : b.length;
        let body = b.slice(h.end, nextStart);
        body = body.replace(/^\s*\r?\n/, '');
        map[h.key] = body.trim();
      }
      // gentle zh/en swap heuristic
      const hasCJK = s => /[\u4e00-\u9fff]/.test(s||'');
      const hasLatin = s => /[A-Za-z]/.test(s||'');
      if (map.zh && !hasCJK(map.zh) && hasLatin(map.zh) && (!map.en || !map.en.trim())) { map.en = map.zh; map.zh = ''; }
      if (map.en && hasCJK(map.en) && (!map.zh || !map.zh.trim())) { map.zh = map.en; map.en = ''; }
      out[idx] = map;
    }
    return out;
  };

  // 1) Ensure header UI: Save, Progress, Jump (Save at left, then Progress, then Jump)
  function ensureHeaderUI() {
    const header = document.getElementById('fillDemoHeader');
    if (!header) return false;
    const closeBtn = document.getElementById('fillCloseBtn');
    if (!document.getElementById('fillSaveBtn')) {
      const save = document.createElement('button');
      save.id = 'fillSaveBtn';
      save.className = 'fill-btn';
      save.style.marginLeft = '8px';
      save.textContent = 'ä¿å­˜';
      if (closeBtn) closeBtn.after(save); else header.appendChild(save);
      save.addEventListener('click', onSaveProgress);
    }
    if (!document.getElementById('fillProgressWrap')) {
      const wrap = document.createElement('div');
      wrap.id = 'fillProgressWrap';
      wrap.style.cssText = 'display:flex;align-items:center;gap:8px;margin-left:8px;visibility:hidden;';
      const span = document.createElement('span');
      span.id = 'fillProgress';
      span.style.cssText = 'font-weight:700;color:#0b1b3a';
      wrap.appendChild(span);
      if (closeBtn) document.getElementById('fillSaveBtn').after(wrap); else header.appendChild(wrap);
    }
    if (!document.getElementById('fillJumpBtn')) {
      const btn = document.createElement('button');
      btn.id = 'fillJumpBtn';
      btn.className = 'fill-btn';
      btn.style.padding = '8px 12px';
      btn.style.marginLeft = '8px';
      btn.textContent = 'è·³è½¬';
      const wrap = document.getElementById('fillProgressWrap');
      (wrap || header).appendChild(btn);
      btn.addEventListener('click', ()=>{
        const panel = document.getElementById('fillJumpPanel');
        if (!panel) return;
        panel.style.display = (panel.style.display==='grid'||panel.style.display==='block') ? 'none':'grid';
      });
    }
    if (!document.getElementById('fillJumpPanel')) {
      const panel = document.createElement('div');
      panel.id = 'fillJumpPanel';
      panel.style.cssText = 'position:absolute;right:12px;top:52px;width:min(420px,60vw);max-height:60vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(245,249,255,.96);box-shadow:0 18px 40px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.65);display:none;grid-template-columns:repeat(8,1fr);gap:8px';
      const area = document.querySelector('.fill-area');
      if (area) area.appendChild(panel);
    }
    return true;
  }

  // 2) Progress / Jump helpers
  window.updateProgressUI = function() {
    const wrap = document.getElementById('fillProgressWrap');
    if (!wrap) return;
    const show = !!window.__FILL_IS_LEVEL__;
    wrap.style.visibility = show ? 'visible' : 'hidden';
    const saveBtn = document.getElementById('fillSaveBtn');
    if (saveBtn) saveBtn.style.display = show ? '' : 'none';
    const jumpBtn = document.getElementById('fillJumpBtn');
    if (jumpBtn) jumpBtn.style.display = show ? '' : 'none';
    if (!show) return;

    const total = (window.questions && window.questions.length) || 0;
    const cur = (typeof window.idx !== 'undefined') ? window.idx + 1 : 1;
    const span = document.getElementById('fillProgress');
    if (span) span.textContent = cur + '/' + total;

    const panel = document.getElementById('fillJumpPanel');
    if (panel && (Number(panel.dataset.built)||0) !== total) {
      panel.innerHTML='';
      for (let i=1;i<=total;i++) {
        const b = document.createElement('button');
        b.className = 'jump-item';
        b.textContent = i;
        b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55),0 6px 16px rgba(0,0,0,.18);cursor:pointer';
        b.addEventListener('click', ()=>{ try{ window.idx = i-1; document.getElementById('fillJumpPanel').style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); }catch(e){} });
        panel.appendChild(b);
      }
      panel.dataset.built = String(total);
    }
  };

  function onSaveProgress(){
    if (!window.__FILL_IS_LEVEL__) { if (typeof showToast==='function') showToast('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ', 'info'); else alert('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ'); return; }
    try {
      const text = window.__FILL_SOURCE_TEXT__ || '';
      const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
      const idx = (typeof window.idx !== 'undefined') ? window.idx : 0;
      const total = (window.questions && window.questions.length) || 0;
      const payload = { sig, idx, total, ts: Date.now() };
      localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
      if (typeof showToast==='function') showToast('Level1 è¿›åº¦å·²ä¿å­˜ï¼š'+(idx+1)+'/'+total, 'success'); else alert('å·²ä¿å­˜ï¼š'+(idx+1)+'/'+total);
    }catch(e){ console.warn(e); }
  }

  // 3) Hook startFillDemo to set flags, parse explains/questions, resume, and ensure UI
  const _origStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    try{
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const src = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      window.__FILL_SOURCE_TEXT__ = isLevel ? src : '';
      // parse explains for current dataset
      try { window.ExplainData = parseExplainBlocks(src); } catch(e){ console.warn('explain parse', e); }
      // call original (å®ƒä¼šè´Ÿè´£æ¸²æŸ“)
      if (_origStart) _origStart.apply(this, arguments);
      // After first render: inject UI, patch progress, and resume if saved
      setTimeout(()=>{
        ensureHeaderUI();
        // Patch next/prev/render toåˆ·æ–°è¿›åº¦
        if (window.FillDemo) ['next','prev','render'].forEach(fn=>{
          const orig = window.FillDemo[fn];
          if (typeof orig==='function' && !orig.__patched){
            window.FillDemo[fn] = function(){ const r = orig.apply(this, arguments); try{ updateProgressUI(); }catch(e){} return r; };
            window.FillDemo[fn].__patched = true;
          }
        });
        // resume Level1 if signature matches
        if (window.__FILL_IS_LEVEL__) {
          try {
            const raw = localStorage.getItem('FILL_L1_SAVE');
            if (raw) {
              const save = JSON.parse(raw);
              const text = window.__FILL_SOURCE_TEXT__ || '';
              const sig = text ? (text.length + '|' + text.slice(0,128)) : '';
              if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length) {
                window.idx = save.idx;
                window.FillDemo && window.FillDemo.render && window.FillDemo.render();
                if (typeof showToast==='function') showToast('å·²ä»ä¿å­˜è¿›åº¦ç»§ç»­ï¼š'+(window.idx+1)+'/'+window.questions.length, 'success');
              }
            }
          }catch(e){ console.warn(e); }
        }
        updateProgressUI();
      }, 0);
    }catch(e){ console.error(e); alert('é€‰è¯å¡«ç©ºå¯åŠ¨å¤±è´¥'); }
  };

  // 4) è§‚å¯Ÿ DOMï¼Œä¿è¯å¤´éƒ¨ UI è¢«å®‰æ’
  const mo = new MutationObserver(()=>{ ensureHeaderUI(); });
  mo.observe(document.documentElement||document.body, { childList:true, subtree:true });

})();
</script>


<script>
// === Fill Level Controls: startFillDemo + Progress/Jump/Save + Embedded Demo ===
(function(){"use strict";
  // Embedded demo dataset (always used by Demo mode)
  window.__EMBEDDED_FILL__ = `ç¬¬1é¢˜
æ—è¾¹ é‡Œé¢ ä¸Šé¢

å¥å­1. é’¥åŒ™å°±åœ¨æ¡Œå­ (    )ï¼Œä½ æ²¡çœ‹åˆ°å—ï¼Ÿ 
æ­£ç¡®ç­”æ¡ˆ: ä¸Šé¢

å¥å­2. æˆ‘çš„å®¿èˆåœ¨å­¦æ ¡é£Ÿå ‚ (   )ï¼Œåƒé¥­å¾ˆæ–¹ä¾¿ã€‚
æ­£ç¡®ç­”æ¡ˆ: æ—è¾¹

å¥å­3.æˆ‘æŠŠæ–°ä¹°çš„ç¾½ç»’æœæ”¾è¿›äº†è¡£æŸœ (    )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: é‡Œé¢

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] æ¡Œå­æ˜¯å¹³é¢ï¼Œä¸œè¥¿æ”¾åœ¨è¡¨é¢â†’é€‰ä¸Šé¢ã€‚
[å¥2] å®¿èˆå’Œé£Ÿå ‚åªæ˜¯æŒ¨ç€ï¼Œä¸åœ¨å¯¹æ–¹é‡Œâ†’é€‰æ—è¾¹ã€‚
[å¥3] æœ‰â€œæ”¾è¿›/è¿›åˆ°â€ï¼Œè¯´æ˜è¿›å…¥å®¹å™¨å†…éƒ¨â†’é€‰é‡Œé¢ã€‚
æŠ€å·§ï¼šçœ‹å…³é”®è¯â€”â€”â€œå¹³é¢â†’ä¸Šâ€ï¼Œâ€œç›¸é‚»â†’æ—è¾¹â€ï¼Œâ€œè¿›/å…¥â†’é‡Œâ€ã€‚

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] A table is a flat surface; things sit on the surface â†’ choose ä¸Šé¢ (â€œon topâ€).
[S2] The dorm and the cafeteria are next to each other, not one inside the other â†’ choose æ—è¾¹ (â€œbesideâ€).
[S3] â€œPut in/intoâ€ shows movement into a container â†’ choose é‡Œé¢ (â€œinsideâ€).
Test tip:Spot the cues â€” flat surface â†’ ä¸Šé¢ (on top); adjacent â†’ æ—è¾¹ (beside); into â†’ é‡Œé¢ (inside).

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[à¸›à¸£à¸°à¹‚à¸¢à¸„1] à¹‚à¸•à¹Šà¸°à¹€à¸›à¹‡à¸™à¸à¸·à¹‰à¸™à¸£à¸²à¸š à¸§à¸²à¸‡à¸‚à¸­à¸‡à¸šà¸™à¸œà¸´à¸§à¸«à¸™à¹‰à¸² â†’ à¹€à¸¥à¸·à¸­à¸ ä¸Šé¢ (à¸šà¸™)
[à¸›à¸£à¸°à¹‚à¸¢à¸„2] à¸«à¸­à¸à¸±à¸à¸à¸±à¸šà¹‚à¸£à¸‡à¸­à¸²à¸«à¸²à¸£à¸­à¸¢à¸¹à¹ˆà¸•à¸´à¸”à¸à¸±à¸™ à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¸ à¸²à¸¢à¹ƒà¸™à¸à¸±à¸™ â†’ à¹€à¸¥à¸·à¸­à¸ æ—è¾¹ (à¸‚à¹‰à¸²à¸‡à¹†)
[à¸›à¸£à¸°à¹‚à¸¢à¸„3] â€œà¹ƒà¸ªà¹ˆà¹€à¸‚à¹‰à¸²/à¸™à¸³à¹€à¸‚à¹‰à¸²â€ à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™à¸ à¸²à¸Šà¸™à¸° â†’ à¹€à¸¥à¸·à¸­à¸ é‡Œé¢ (à¸‚à¹‰à¸²à¸‡à¹ƒà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸”à¸¹à¸„à¸³à¸šà¸­à¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ â€” à¸à¸·à¹‰à¸™à¸£à¸²à¸š â†’ ä¸Šé¢ï¼›à¸•à¸´à¸”à¸à¸±à¸™ â†’ æ—è¾¹ï¼›à¹€à¸‚à¹‰à¸²à¹„à¸› â†’ é‡Œé¢ã€‚

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1]Ğ¡Ñ‚Ğ¾Ğ» â€” Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ; Ğ²ĞµÑ‰Ğ¸ Ğ»ĞµĞ¶Ğ°Ñ‚ Ğ½Ğ° Ğ½ĞµĞ¹ â†’ ä¸Šé¢ (Â«Ğ½Ğ°Ğ²ĞµÑ€Ñ…Ñƒ/Ğ½Ğ°Â»)
[ĞŸ2]ĞĞ±Ñ‰ĞµĞ¶Ğ¸Ñ‚Ğ¸Ğµ Ğ¸ ÑÑ‚Ğ¾Ğ»Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ€ÑĞ´Ğ¾Ğ¼, Ğ½Ğµ Ğ¾Ğ´Ğ½Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ â†’ æ—è¾¹ (Â«Ñ€ÑĞ´Ğ¾Ğ¼Â»)
[ĞŸ3]Â«ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ²/Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒÂ» ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° â†’ é‡Œé¢ (Â«Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: Ğ¿Ğ»Ğ¾ÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ…Ğ½Ğ¾ÑÑ‚ÑŒ â†’ ä¸Šé¢; Ñ€ÑĞ´Ğ¾Ğ¼ â†’ æ—è¾¹; Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ â†’ é‡Œé¢.

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[àº›àº°à»‚àº«àºàº1]à»‚àº•àº°à»€àº›àº±àº™àºàº·à»‰àº™àº®àº²àºš àº‚àº­àº‡àº¢àº¹à»ˆà»€àº—àº´àº‡àºœàº´àº§à»œà»‰àº² â†’ à»€àº¥àº·àº­àº ä¸Šé¢ (à»€àº—àº´àº‡)
[àº›àº°à»‚àº«àºàº2]àº«à»àºàº±àºàºàº±àºšà»‚àº®àº‡àº­àº²àº«àº²àº™àº¢àº¹à»ˆàº•àº´àº”àºàº±àº™ àºšà»à»ˆà»„àº”à»‰àº¢àº¹à»ˆàºàº²àºà»ƒàº™àºàº±àº™ â†’ à»€àº¥àº·àº­àº æ—è¾¹ (àº‚à»‰àº²àº‡)
[àº›àº°à»‚àº«àºàº3]â€œà»ƒàºªà»ˆà»€àº‚àº»à»‰àº²/àº™àº³à»€àº‚àº»à»‰àº²â€ àºŠàºµà»‰àºàº²àº™à»€àº‚àº»à»‰àº²à»„àº›à»ƒàº™àºàº²àºŠàº°àº™àº° â†’ à»€àº¥àº·àº­àº é‡Œé¢ (àº‚à»‰àº²àº‡à»ƒàº™)
à»€àº„àº±àº”àº¥àº±àºš: àºªàº±àº‡à»€àºàº”àº„àº³àºšàº­àºàº•àº³à»à»œà»ˆàº‡â€”àºàº·à»‰àº™àº®àº²àºšâ†’ä¸Šé¢ï¼›àº¢àº¹à»ˆàº•àº´àº”â†’æ—è¾¹ï¼›à»€àº‚àº»à»‰àº²à»„àº›â†’é‡Œé¢ã€‚


ç¬¬2é¢˜
å†· æš–å’Œ å‡‰å¿«

å¥å­1. å†¬å¤©åˆ°äº†ï¼Œå¤©æ°”å¾ˆ (  )ï¼Œä½ è¦å¤šç©¿è¡£æœã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å†·

å¥å­2. ç§‹å¤©çš„æ™šä¸Šå¾ˆ (   )ï¼Œç‰¹åˆ«é€‚åˆæ•£æ­¥ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å‡‰å¿«

å¥å­3.ç©¿ä¸Šè¿™ä»¶åšæ¯›è¡£ï¼Œå…¨èº«éƒ½æ„Ÿè§‰å¾ˆ (   )ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å†¬å¤©+â€œå¾ˆâ€=ä½æ¸© â†’ å†·ï¼ˆcoldï¼‰
[å¥2] ç§‹å¤œèˆ’é€‚å¾®å‡‰ â†’ å‡‰å¿«ï¼ˆcool/pleasantï¼‰
[å¥3] ç©¿åšè¡£ä½“æ„Ÿå‡æ¸© â†’ æš–å’Œï¼ˆwarmï¼‰
æŠ€å·§ï¼šä¸¥å¯’â†’å†·ï¼›å¾®å‡‰èˆ’æœâ†’å‡‰å¿«ï¼›æ¸©æš–â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Winter + â€œveryâ€ â†’ low temp â†’ å†· (cold)
[S2] Autumn night, pleasantly cool â†’ å‡‰å¿« (cool)
[S3] Thick sweater â†’ feels æš–å’Œ (warm)
Tip: severe coldâ†’å†·; pleasantly coolâ†’å‡‰å¿«; warmâ†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¸«à¸™à¹‰à¸²à¸«à¸™à¸²à¸§ + â€œà¸¡à¸²à¸â€ = à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´à¸•à¹ˆà¸³ â†’ å†· (à¸«à¸™à¸²à¸§)
[2] à¸„à¹ˆà¸³à¹ƒà¸™à¸¤à¸”à¸¹à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡ à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢ â†’ å‡‰å¿« (à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢)
[3] à¹ƒà¸ªà¹ˆà¹€à¸ªà¸·à¹‰à¸­à¸«à¸™à¸²à¹à¸¥à¹‰à¸§à¸­à¸šà¸­à¸¸à¹ˆà¸™ â†’ æš–å’Œ (à¸­à¸šà¸­à¸¸à¹ˆà¸™)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸«à¸™à¸²à¸§à¸ˆà¸±à¸”â†’å†·; à¹€à¸¢à¹‡à¸™à¸ªà¸šà¸²à¸¢â†’å‡‰å¿«; à¸­à¸šà¸­à¸¸à¹ˆà¸™â†’æš–å’Œ


ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] Ğ—Ğ¸Ğ¼Ğ° + Â«Ğ¾Ñ‡ĞµĞ½ÑŒÂ» â†’ Ğ½Ğ¸Ğ·ĞºĞ°Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° â†’ å†· (Â«Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Â»)
[ĞŸ2] ĞÑĞµĞ½Ğ½Ğ¸Ğ¼ Ğ²ĞµÑ‡ĞµÑ€Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾ â†’ å‡‰å¿« (Â«Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ½Ğ¾Â»)
[ĞŸ3] Ğ¢Ğ¾Ğ»ÑÑ‚Ñ‹Ğ¹ ÑĞ²Ğ¸Ñ‚ĞµÑ€ â†’ Ğ¾Ñ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ æš–å’Œ (Â«Ñ‚ĞµĞ¿Ğ»Ğ¾/Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ…Ğ¾Ğ»Ğ¾Ğ´â†’å†·; Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ…Ğ»Ğ°Ğ´Ğ°â†’å‡‰å¿«; Ñ‚ĞµĞ¿Ğ»Ğ¾â†’æš–å’Œ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] àº¥àº°àº”àº¹àº«àº™àº²àº§ + â€œàº«àº¼àº²àºâ€ â†’ àº­àº¸àº™àº«àº°àºàº¹àº¡àº•à»ˆàº³ â†’ å†· (à»œàº²àº§)
[2] àº„à»ˆàº³àº¥àº°àº”àº¹à»ƒàºšà»„àº¡à»‰àº«àº¼àº»à»ˆàº™ à»€àº¢àº±àº™àºªàº°àºšàº²àº â†’ å‡‰å¿« (à»€àº¢àº±àº™àºªàº°àºšàº²àº)
[3] à»ƒàºªà»ˆà»€àºªàº·à»‰àº­à»œàº² àº®àº¹à»‰àºªàº¶àºàº­àº»àºšàº­àº¸à»ˆàº™ â†’ æš–å’Œ (àº­àº»àºšàº­àº¸à»ˆàº™)
à»€àº„àº±àº”àº¥àº±àºš:à»œàº²àº§àº«àº¼àº²àºâ†’å†·; à»€àº¢àº±àº™àºªàº°àºšàº²àºâ†’å‡‰å¿«; àº­àº»àºšàº­àº¸à»ˆàº™â†’æš–å’Œ

ç¬¬3é¢˜
æ¯ åˆ å¥—
å¥å­1. æˆ‘æ˜¨å¤©å»å•†åœºä¹°äº†ä¸€ (  )æ–°å®¶å…·ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: å¥—

å¥å­2. æˆ‘ (  )å¤©æ—©ä¸Šéƒ½å…­ç‚¹åŠèµ·åºŠã€‚ 
æ­£ç¡®ç­”æ¡ˆ: æ¯

å¥å­3.ä»Šå¤©çš„ä½œä¸šæ²¡åšå®Œï¼Œæˆ‘æ˜å¤© (  )è¦æ—©èµ·åšç»ƒä¹ ã€‚ 
æ­£ç¡®ç­”æ¡ˆ: åˆ

ç­”æ¡ˆè§£æï¼ˆä¸­æ–‡ï¼‰
[å¥1] å®¶å…·æˆâ€œå¥—â€è´­ä¹° â†’ é‡è¯ç”¨ å¥—ï¼ˆsetï¼‰
[å¥2] é¢‘ç‡å›ºå®šâ€œæ¯å¤©â€ â†’ æ¯ï¼ˆeveryï¼‰
[å¥3] å†æ¬¡å‘ç”Ÿ/åˆä¸€æ¬¡ï¼ˆå¸¸å¸¦â€œåˆè¦â€¦â€è¯­æ°”ï¼‰â†’ åˆï¼ˆagainï¼‰
æŠ€å·§ï¼šé‡è¯â†’å¥—ï¼›é¢‘ç‡â†’æ¯ï¼›é‡å¤â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè‹±æ–‡ï¼‰
[S1] Furniture bought as a set â†’ classifier å¥— (set)
[S2] Fixed frequency â€œevery dayâ€ â†’ æ¯ (every)
[S3] Repeated action (often â€œagainâ€) â†’ åˆ (again)
Tip: classifierâ†’å¥—; frequencyâ†’æ¯; repetitionâ†’åˆ

ç­”æ¡ˆè§£æï¼ˆæ³°è¯­ï¼‰
[1] à¹€à¸Ÿà¸­à¸£à¹Œà¸™à¸´à¹€à¸ˆà¸­à¸£à¹Œà¸‹à¸·à¹‰à¸­à¹€à¸›à¹‡à¸™ â€œà¸Šà¸¸à¸”â€ â†’ à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡ å¥— (à¸Šà¸¸à¸”)
[2] à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆà¸›à¸£à¸°à¸ˆà¸³ â€œà¸—à¸¸à¸à¸§à¸±à¸™â€ â†’ æ¯ (à¸—à¸¸à¸...)
[3] à¸à¸²à¸£à¹€à¸à¸´à¸”à¸‹à¹‰à¸³/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡ (à¸¡à¸±à¸à¸¡à¸µà¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡ â€œà¸­à¸µà¸à¹à¸¥à¹‰à¸§â€) â†’ åˆ (à¸­à¸µà¸/à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡)
à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š: à¸¥à¸±à¸à¸©à¸“à¸™à¸²à¸¡â†’å¥—; à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆâ†’æ¯; à¸‹à¹‰à¸³/à¸­à¸µà¸â†’åˆ

ç­”æ¡ˆè§£æï¼ˆä¿„è¯­ï¼‰
[ĞŸ1] ĞœĞµĞ±ĞµĞ»ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ÑÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ¾Ğ¼ â†’ ÑÑ‡Ñ‘Ñ‚Ğ½Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ å¥— (Â«Ğ½Ğ°Ğ±Ğ¾Ñ€/ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Â»)
[ĞŸ2] Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒÂ» â†’ æ¯ (Â«ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹Â»)
[ĞŸ3] ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ñ‡Ğ°ÑÑ‚Ğ¾ Ñ Ğ¾Ñ‚Ñ‚ĞµĞ½ĞºĞ¾Ğ¼ Â«Ğ¾Ğ¿ÑÑ‚ÑŒÂ») â†’ åˆ (Â«Ğ¾Ğ¿ÑÑ‚ÑŒ/ÑĞ½Ğ¾Ğ²Ğ°Â»)
ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°: ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€â†’å¥—; Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒâ†’æ¯; Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€â†’åˆ

ç­”æ¡ˆè§£æï¼ˆè€æŒè¯­ï¼‰
[1] à»€àºŸàºµàº™àºµà»€àºˆàºµàºŠàº·à»‰à»€àº›àº±àº™ â€œàºŠàº¸àº”â€ â†’ àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡ å¥— (àºŠàº¸àº”)
[2] àº„àº§àº²àº¡àº–àºµà»ˆàº›àº°àºˆàº³ â€œàº—àº¸àºàº¡àº·à»‰â€ â†’ æ¯ (àº—àº¸àº...)
[3] à»€àºàºµàº”àºŠà»‰àº³/àº­àºµàºàº„àº±à»‰àº‡ (àº¡àº±àºàº¡àºµàº™à»‰àº³à»ƒàºˆ â€œàº­àºµàºà»àº¥à»‰àº§â€) â†’ åˆ (àº­àºµàº/àº­àºµàºàº„àº±à»‰àº‡)
à»€àº„àº±àº”àº¥àº±àºš: àº¥àº±àºàºªàº°àº™àº°àº™àº²àº¡â†’å¥—; àº„àº§àº²àº¡àº–àºµà»ˆâ†’æ¯; àºŠà»‰àº³â†’åˆ`;

  function el(id){ return document.getElementById(id); }
  function computeSig(text){ return text ? (text.length + '|' + text.slice(0,128)) : ''; }

  function updateProgressUI(){
    const prog = el('fillProgress');
    const save = el('fillSaveBtn');
    const jump = el('fillJumpBtn');
    const isLevel = !!window.__FILL_IS_LEVEL__;
    if (prog) prog.style.display = isLevel ? '' : 'none';
    if (save) save.style.display = isLevel ? '' : 'none';
    if (jump) jump.style.display = isLevel ? '' : 'none';
    if (!isLevel) return;
    try{ 
      const total = (window.questions && window.questions.length) || 0;
      const cur = (typeof window.idx !== 'undefined') ? (window.idx+1) : 1;
      if (prog) prog.textContent = cur + '/' + total;
    }catch(e){}
  }

  function ensureJumpGrid(){
    const panel = el('fillJumpPanel');
    if (!panel || !window.__FILL_IS_LEVEL__) return;
    const total = (window.questions && window.questions.length) || 0;
    if ((panel.dataset.built|0) === total) return;
    panel.innerHTML = '';
    for (let i=1;i<=total;i++){ 
      const b = document.createElement('button');
      b.className = 'jump-item';
      b.textContent = i;
      b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
      b.addEventListener('click', ()=>{ try{ window.idx = i-1; panel.style.display='none'; window.FillDemo && FillDemo.render && FillDemo.render(); updateProgressUI(); }catch(e){} });
      panel.appendChild(b);
    }
    panel.dataset.built = String(total);
  }

  // Wire 'Jump' toggle
  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (t && t.id === 'fillJumpBtn'){ 
      const panel = el('fillJumpPanel');
      if (panel) { 
        if (panel.style.display==='grid' || panel.style.display==='block') panel.style.display='none'; 
        else { ensureJumpGrid(); panel.style.display='grid'; }
      }
    }
  });

  // Save button
  document.addEventListener('click', function(ev){
    const t = ev.target;
    if (t && t.id === 'fillSaveBtn'){ 
      if (!window.__FILL_IS_LEVEL__) { (window.showToast?showToast('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ / Save is for Level mode only','info'):alert('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ')); return; }
      try{ 
        const text = window.__FILL_SOURCE_TEXT__ || '';
        const payload = { sig: computeSig(text), idx: window.idx||0, total: (window.questions&&window.questions.length)||0, ts: Date.now() };
        localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
        (window.showToast?showToast('Level 1 è¿›åº¦å·²ä¿å­˜ / Progress saved: ' + (payload.idx+1) + '/' + payload.total, 'success'):alert('å·²ä¿å­˜ ' + (payload.idx+1) + '/' + payload.total));
      }catch(e){ console.warn(e); }
    }
  });

  // Our unified starter for Demo & Level
  window.startFillDemo = function(textOpt){
    try{ 
      const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
      window.__FILL_IS_LEVEL__ = !!isLevel;
      const src = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
      window.__FILL_SOURCE_TEXT__ = isLevel ? src : '';
      if (!src) { alert('æœªæ‰¾åˆ°é¢˜åº“æ•°æ® / No dataset'); return; }
      try { window.__FILL_EXPLAINS__ = src; window.ExplainData = parseExplainBlocks?parseExplainBlocks(src):[]; } catch(e){ console.warn('explain parse', e); }
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function') { window.FillDemo.startDemo(src); }
      setTimeout(()=>{
        if (window.__FILL_IS_LEVEL__) {
          try{ 
            const raw = localStorage.getItem('FILL_L1_SAVE');
            if (raw){ 
              const save = JSON.parse(raw);
              const sig = computeSig(src);
              if (save.sig === sig && typeof save.idx === 'number' && window.questions && save.idx < window.questions.length){ 
                window.idx = save.idx; window.FillDemo.render(); 
              }
            }
          }catch(e){}
        }
        updateProgressUI(); ensureJumpGrid();
        if (window.FillDemo){ 
          ['next','prev','render'].forEach(fn=>{ 
            const o = window.FillDemo[fn]; 
            if (typeof o==='function' && !o.__patched){
              window.FillDemo[fn] = function(){ const r = o.apply(this, arguments); updateProgressUI(); ensureJumpGrid(); return r; }; 
              window.FillDemo[fn].__patched = true;
            }
          });
        }
      }, 0);
    }catch(e){ console.error(e); alert('é€‰è¯å¡«ç©ºå¯åŠ¨å¤±è´¥'); }
  };

  // Patch FillLevel.start to use startFillDemo(text)
  (function patchFillLevel(){
    try{
      const prev = window.FillLevel && window.FillLevel.start;
      if (!prev) return;
      window.FillLevel.start = async function(levelKey){
        if (levelKey === 'L1') {
          const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
          try{ 
            const res = await fetch(url, {cache:'no-store'});
            if (!res.ok) throw new Error('HTTP '+res.status);
            const text = await res.text();
            window.startFillDemo(text);
          }catch(e){ console.error(e); alert('Level 1 é¢˜åº“åŠ è½½å¤±è´¥'); }
          try{ window.FillLevel.close && window.FillLevel.close(); }catch(e){}
          return;
        }
        return prev.apply(this, arguments);
      };
    }catch(e){ console.warn('patchFillLevel', e); }
  })();

})();</script>


<script>
(function(){
  function el(id){ return document.getElementById(id); }
  function sig(text){ return text ? (text.length + '|' + text.slice(0,128)) : ''; }

  window.updateProgressUI = function(){
    const isLevel = !!window.__FILL_IS_LEVEL__;
    const prog = el('fillProgress'), save = el('fillSaveBtn'), jump = el('fillJumpBtn');
    if (prog) prog.style.display = isLevel ? '' : 'none';
    if (save) save.style.display = isLevel ? '' : 'none';
    if (jump) jump.style.display = isLevel ? '' : 'none';
    if (!isLevel) return;
    const cur = (typeof window.__FILL_IDX__==='number'? window.__FILL_IDX__+1 : 1);
    const total = (typeof window.__FILL_TOTAL__==='number'? window.__FILL_TOTAL__ : 0);
    if (prog) prog.textContent = cur + '/' + total;
  };

  // Jump toggle and grid build
  function ensureJumpGrid(){
    const panel = el('fillJumpPanel');
    if (!panel || !window.__FILL_IS_LEVEL__) return;
    const total = window.__FILL_TOTAL__ || 0;
    if ((panel.dataset.built|0) === total) return;
    panel.innerHTML = '';
    for (let i=1;i<=total;i++){
      const b = document.createElement('button');
      b.textContent = i;
      b.className = 'jump-item';
      b.style.cssText = 'padding:8px 10px;border:none;border-radius:10px;background:linear-gradient(145deg,#e6eeff,#ccdcff);box-shadow:inset 1px 1px 0 rgba(255,255,255,.55), 0 6px 16px rgba(0,0,0,.18);cursor:pointer';
      b.addEventListener('click', ()=>{ try{ window.FillDemo && FillDemo.goto && FillDemo.goto(i-1); panel.style.display='none'; }catch(e){} });
      panel.appendChild(b);
    }
    panel.dataset.built = String(total);
  }

  document.addEventListener('click', function(e){
    const t = e.target;
    if (t && t.id==='fillJumpBtn'){
      const panel = el('fillJumpPanel');
      if (!panel) return;
      if (panel.style.display==='grid' || panel.style.display==='block') panel.style.display='none';
      else { ensureJumpGrid(); panel.style.display='grid'; }
    }
    if (t && t.id==='fillSaveBtn'){
      if (!window.__FILL_IS_LEVEL__){ (window.showToast?showToast('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ / Save is for Level mode only','info'):alert('ä¿å­˜ä»…ç”¨äº Level æ¸¸æˆ')); return; }
      try{
        const text = window.__FILL_SOURCE_TEXT__ || '';
        const payload = { sig: sig(text), idx: window.__FILL_IDX__||0, total: window.__FILL_TOTAL__||0, ts: Date.now() };
        localStorage.setItem('FILL_L1_SAVE', JSON.stringify(payload));
        (window.showToast?showToast('Level 1 è¿›åº¦å·²ä¿å­˜ / Progress saved: ' + (payload.idx+1) + '/' + payload.total, 'success'):alert('å·²ä¿å­˜ ' + (payload.idx+1) + '/' + payload.total));
      }catch(e){ console.warn(e); }
    }
  });

  // Override startFillDemo to set flags and resume saved progress
  const _origStart = window.startFillDemo;
  window.startFillDemo = function(textOpt){
    const isLevel = typeof textOpt === 'string' && textOpt.trim().length>0;
    window.__FILL_IS_LEVEL__ = !!isLevel;
    window.__FILL_SOURCE_TEXT__ = isLevel ? textOpt : (window.__EMBEDDED_FILL__ || '');
    try{ _origStart && _origStart.apply(this, arguments); }catch(e){ console.warn(e); }
    setTimeout(()=>{
      if (window.__FILL_IS_LEVEL__){
        try{
          const raw = localStorage.getItem('FILL_L1_SAVE');
          if (raw){
            const save = JSON.parse(raw);
            if (save.sig && save.sig === sig(window.__FILL_SOURCE_TEXT__) && typeof save.idx==='number'){
              window.FillDemo && FillDemo.goto && FillDemo.goto(save.idx);
              (window.showToast?showToast('å·²ä»ä¿å­˜è¿›åº¦ç»§ç»­ï¼š'+(save.idx+1)+'/'+(window.__FILL_TOTAL__||0),'success'):0);
            }
          }
        }catch(e){}
      }
      window.updateProgressUI && window.updateProgressUI();
    },0);
  };

  // Ensure Level1 loader uses startFillDemo(text)
  (function patchFillLevel(){
    try{
      const prev = window.FillLevel && window.FillLevel.start;
      if (!prev) return;
      window.FillLevel.start = async function(levelKey){
        if (levelKey==='L1'){
          const url = 'https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/25-10-23%E6%96%B0-%E5%A1%AB%E7%A9%BA%E9%A2%98Level1-6%E8%AF%AD.txt';
          try{
            const res = await fetch(url,{cache:'no-store'});
            if (!res.ok) throw new Error('HTTP '+res.status);
            const text = await res.text();
            window.startFillDemo(text);
          }catch(e){ console.error(e); alert('Level 1 é¢˜åº“åŠ è½½å¤±è´¥'); }
          try{ window.FillLevel.close && window.FillLevel.close(); }catch(e){}
          return;
        }
        return prev.apply(this, arguments);
      };
    }catch(e){}
  })();

})();</script>










<script>
/* ==== Fill module: generic multi-language parser + reliable rendering ==== */
(function(){
  function splitQuestionBlocks(text){
    var s = String(text||'').replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');
    var splitters = [
      /(?=^\s*ç¬¬\s*\d+\s*é¢˜)/m,
      /(?=^[ã€\[]?\s*ç¬¬\s*\d+\s*é¢˜\s*[ã€‘\]])/m,
      /(?=^\s*é¢˜\s*\d+)/m,
      /(?=^\s*Q\s*\d+)/mi
    ];
    for (var i=0;i<splitters.length;i++){
      var arr = s.split(splitters[i]).filter(function(b){ return b && b.trim(); });
      if (arr.length) return arr;
    }
    return [s];
  }

  // Map header labels to std codes
  function normLabel(lbl){
    lbl = String(lbl||'').trim();
    var x = lbl.toLowerCase();
    if (lbl.includes('ä¸­æ–‡') || x.includes('chinese')) return 'zh';
    if (lbl.includes('è‹±æ–‡') || lbl.includes('è‹±è¯­') || x.includes('english')) return 'en';
    if (lbl.includes('æ³•è¯­') || x.includes('franÃ§ais') || x.includes('french')) return 'fr';
    if (lbl.includes('æ³°è¯­') || x.includes('thai') || lbl.includes('à¹„à¸—à¸¢')) return 'th';
    if (lbl.includes('ä¿„è¯­') || x.includes('russian') || lbl.includes('Ğ ÑƒÑ')) return 'ru';
    if (lbl.includes('è€æŒ') || x.includes('lao') || lbl.includes('àº¥àº²àº§')) return 'lo';
    return null; // ignore other labels
  }

  function parseBlockAllLangs(block){
    var result = {zh:'',en:'',fr:'',th:'',ru:'',lo:''};
    // Find all "ç­”æ¡ˆè§£æï¼ˆxxxï¼‰" headers and segments
    var re = /ç­”æ¡ˆè§£æ[ï¼ˆ(]\s*([^ï¼‰)]+)\s*[ï¼‰)]\s*[:ï¼š]?\s*/g;
    var m, lastIdx = 0, headers = [];
    while ((m = re.exec(block))){
      headers.push({label:m[1], start: m.index, after: re.lastIndex});
    }
    if (!headers.length) return result;
    for (var i=0;i<headers.length;i++){
      var h = headers[i];
      var end = (i+1<headers.length) ? headers[i+1].start : block.length;
      var segment = block.slice(h.after, end);
      var code = normLabel(h.label);
      if (!code) continue;
      // Trim trailing spaces/newlines
      segment = segment.replace(/^\s+|\s+$/g, '');
      if (segment) result[code] = segment;
    }
    return result;
  }

  function parseAll(text){
    var parts = splitQuestionBlocks(text);
    var out = [];
    for (var i=0;i<parts.length;i++){
      out.push(parseBlockAllLangs(parts[i]));
    }
    return out;
  }

  // Capture dataset when FillDemo starts (covers Demoä¸Level1ï¼Œå› ä¸ºLevel1æœ€ç»ˆä¹Ÿè°ƒç”¨ startDemo(text))
  (function(){
    if (!window.FillDemo || typeof window.FillDemo.startDemo !== 'function') return;
    var _start = window.FillDemo.startDemo;
    window.FillDemo.startDemo = function(textOpt){
      var src = (typeof textOpt==='string' && textOpt.trim()) ? textOpt : (window.__FILL_OVERRIDE__ || window.__FILL_EXPLAINS__ || '');
      try{
        if (src){
          window.__FILL_SRC__ = src;
          window.__FILL_EXPLAINS__ = src;
          window.__FILL_EXPLAINS_PARSED__ = parseAll(src);
        }
      }catch(e){ console.warn('parseAll on start failed', e); }
      return _start.apply(window.FillDemo, arguments);
    };
  })();

  // Always render from parsed dataset for consistency
  (function(){
    var _origShow = window.showExplainPanelFor;
    if (typeof _origShow !== 'function') return;
    window.showExplainPanelFor = function(qIndex){
      _origShow(qIndex);
      try{
        var panel = document.getElementById('explainPanel');
        var body  = document.getElementById('explainBody');
        var dataList = window.__FILL_EXPLAINS_PARSED__;
        if (!Array.isArray(dataList) || !dataList.length){
          // final fallback
          dataList = [];
        }
        var data = dataList[qIndex] || {};

        function md2html(s){
          if(!s) return '';
          return String(s)
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/\*\*([\s\S]+?)\*\*/g,'<strong>$1</strong>');
        }

        var langs = ['zh','en','fr','th','ru','lo'];
        langs.forEach(function(l){
          var btn = panel && panel.querySelector('.explain-btn[data-lang="'+l+'"]');
          if (!btn) return;
          var txt = (data && data[l]) ? data[l] : '';
          var has = !!(txt && String(txt).trim().length);
          btn.disabled = !has;
          btn.onclick = function(){ body.innerHTML = has ? md2html(txt) : 'ï¼ˆè¯¥è¯­è¨€æš‚æ— è§£æï¼‰'; };
        });

        // Always render a default based on parsed dataset
        var use = data.zh || data.en || data.fr || data.th || data.ru || data.lo || '';
        body.innerHTML = use ? md2html(use) : 'ï¼ˆè¯¥é¢˜æš‚æ— è§£æï¼‰';
      }catch(e){ console.warn('explain render failed', e); }
    };
  })();
})();
</script>


<script>
/* ==== Force demo to fetch FR dataset ==== */
(function(){
  var DEMO_URL = "https://raw.githubusercontent.com/steven2025/gif2025/refs/heads/main/%E5%A1%AB%E7%A9%BA%E8%AF%95%E7%8E%A9-%E8%AF%95%E9%A2%98%E5%AF%BC%E5%85%A5%E6%A8%A1%E6%9D%BF-%E5%B8%A6%E8%A7%A3%E6%9E%90.txt";
  var _orig = window.startFillDemo;
  window.startFillDemo = async function(){
    try{ 
      var r = await fetch(DEMO_URL);
      if(!r.ok) throw new Error('HTTP '+r.status);
      var text = await r.text();
      if (window.FillDemo && typeof window.FillDemo.startDemo === 'function'){
        window.FillDemo.startDemo(text);
        // Demo should not show Level1 progress
        window.__FILL_IS_LEVEL__ = false;
        if (typeof window.updateProgressUI === 'function') window.updateProgressUI();
        return;
      }
    }catch(e){ console.warn('Demo fetch failed, fallback to original demo', e); }
    if (typeof _orig === 'function') return _orig();
  };
})();
</script>





<!-- SB START: Sentence-Building integrated v6 (bilingual toast; fixed multiline strings) -->
<style data-sb="css">
#sb-embed *{ box-sizing:border-box }
#sb-embed{ display:none; margin-top:14px; border-radius:22px; background:linear-gradient(180deg,#f9fbff,#edf4ff); color:#0f1430;
  box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
#sb-embed .sb-top{ padding:12px 14px; border-bottom:1px dashed rgba(12,22,44,.12); }
#sb-embed .sb-topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
#sb-embed .sb-ins{ font-weight:800; text-align:center }
#sb-embed .sb-ins small{ display:block; opacity:.9; margin-top:6px }
#sb-embed .sb-pool{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; padding:18px 16px 6px }
#sb-embed .sb-slot-wrap{ padding:12px 16px 10px }
#sb-embed .sb-slot{ min-height:72px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-start; border-radius:14px; background:linear-gradient(180deg,#ffffff,#eef5ff); box-shadow: inset 0 0 0 2px rgba(14,20,34,.12); padding:12px 14px; }
#sb-embed .sb-tile{ display:inline-flex; align-items:center; justify-content:center; text-align:center; padding:10px 12px; min-width:64px; border-radius:12px; cursor:grab; user-select:none; font-weight:900; color:#0b1220; border:2px solid rgba(0,0,0,.06); background:var(--tile-bg,linear-gradient(180deg,#fff,#eaf2ff)); box-shadow: var(--tile-shadow,0 10px 0 rgba(0,0,0,.18)), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; }
#sb-embed .sb-tile:active{ cursor:grabbing; transform:scale(0.98) translateY(2px); }
#sb-embed .sb-slot.dragging{ box-shadow: inset 0 0 0 2px #8ec5ff, 0 0 0 2px rgba(142,197,255,.25); }
#sb-embed .sb-shake{ animation:sbshake .25s ease } @keyframes sbshake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
#sb-embed .sb-flyback{ animation:sbflash .55s ease forwards } @keyframes sbflash{0%{opacity:1;filter:brightness(1)}50%{opacity:.35;filter:brightness(1.6)}100%{opacity:0;transform:scale(.96)}}
#sb-embed .sb-toolbar{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:8px 16px 16px; border-top:1px dashed rgba(12,22,44,.12) }
#sb-embed .sb-mini{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }
#sb-embed .primary{ outline:2px solid #0ea5e9 }
#sb-embed .sb-panel{ display:none; margin:10px 16px 16px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#eef4ff); box-shadow: inset 0 0 0 1px rgba(12,22,44,.12), 0 18px 54px rgba(0,0,0,.15); overflow:hidden }
#sb-embed .sb-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; padding:12px 12px; border-bottom:1px dashed rgba(12,22,44,.12) }
#sb-embed .sb-tabs{ display:flex; flex-wrap:wrap; gap:8px }
#sb-embed .sb-tab{ border:none; border-radius:10px; padding:8px 10px; font-weight:900; cursor:pointer; background:linear-gradient(180deg,#fff,#f0f5ff); box-shadow:0 8px 0 rgba(0,0,0,.12),0 16px 36px rgba(0,0,0,.12), inset 0 0 0 1px rgba(255,255,255,.7) }
#sb-embed .sb-tab.active{ outline:2px solid #0ea5e9 }
#sb-embed .sb-body{ padding:14px 14px 18px; max-height:360px; overflow:auto; font-size:14px; line-height:1.6; white-space:pre-wrap }
#sb-embed .sb-close{ border:none; border-radius:10px; padding:8px 10px; font-weight:900; cursor:pointer; background:linear-gradient(180deg,#fff,#f0f5ff) }
#sb-toast{ position:fixed; left:50%; top:14%; transform:translateX(-50%) translateY(-10px); z-index:9999; display:none;
  padding:10px 16px; border-radius:12px; font-weight:900; box-shadow:0 10px 26px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.75); }
#sb-toast.ok{ background:linear-gradient(180deg,#eafff3,#c9ffe3); color:#064e3b; outline:2px solid #34d399; }
#sb-toast.err{ background:linear-gradient(180deg,#ffecec,#ffdede); color:#7f1d1d; outline:2px solid #f87171; }
#sb-toast.show{ display:block; animation:sbtoast .9s ease forwards; }
@keyframes sbtoast{ 0%{ opacity:0; transform:translateX(-50%) translateY(-8px) scale(.98) } 15%{ opacity:1; transform:translateX(-50%) translateY(0) scale(1) } 85%{ opacity:1 } 100%{ opacity:0; transform:translateX(-50%) translateY(-6px) scale(.98) } }
#sb-levels{ display:none; margin-top:14px; padding:16px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#eef4ff); color:#0b1220; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08) }
#sb-levels .lv-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
#sb-levels .lv-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
#sb-levels .lv-btn{ border:none; cursor:pointer; padding:16px 12px; border-radius:14px; font-weight:900; box-shadow: 0 12px 0 rgba(0,0,0,.18), 0 20px 48px rgba(0,0,0,.22), inset 0 0 0 1px rgba(255,255,255,.8); background-image: linear-gradient(180deg, #ffffff, #eef4ff) }
#sb-levels .lv-btn[disabled]{ filter:grayscale(.2) opacity(.85); cursor:not-allowed }
</style>

<script data-sb="runtime">
(function(){
  const $ = (q,root=document)=> root.querySelector(q);
  const $$ = (q,root=document)=> Array.from(root.querySelectorAll(q));
  let menuRowEl = null;

  function modIsSentence(){
    const t = (document.getElementById('modTitle')?.textContent || '').trim();
    return t.includes('è¯è¯­ç»„å¥');
  }
  function findButtonsRow(btn){
    let el = btn;
    for(let i=0;i<6 && el;i++){
      const bts = el.querySelectorAll && el.querySelectorAll('button');
      if(bts && bts.length >= 2) return el;
      el = el.parentElement;
    }
    return null;
  }

  function hueStyle(idx){
    const h=(idx*67)%360, s=92, l1=97, l2=86;
    return {
      bg:`linear-gradient(180deg, hsl(${h} ${s}% ${l1}%), hsl(${h} ${s}% ${l2}%))`,
      sh:`0 10px 0 hsl(${h} 55% 40% / .28)`
    };
  }

  const BANK = [
    { idx:1, tokens:["æ¥è‡ª","å›½å®¶","ä½ ","å“ªä¸ª"], answerTokens:["ä½ ","æ¥è‡ª","å“ªä¸ª","å›½å®¶"], analysis:{
      "ä¸­æ–‡":`æ­£ç¡®ç­”æ¡ˆï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶ã€‚
â€œä½ â€ä¸ºä¸»è¯­ï¼›è°“è¯­â€œæ¥è‡ªâ€è¡¨è¾¾æ¥æºï¼›â€œå“ªä¸ªâ€ä½œå®šè¯­ä¿®é¥°â€œå›½å®¶â€ï¼Œæ„æˆç–‘é—®å®¾è¯­â€œå“ªä¸ªå›½å®¶â€ï¼Œæ•´ä½“è¯­åºä¸ºä¸»â€”è°“â€”å®¾ï¼ˆç–‘é—®ï¼‰ã€‚

æŠ€å·§ / Tipsï¼š
æ‰¾ä¸»è¯­ï¼šç¡®å®šâ€œä½ â€
å®šè°“è¯­ï¼šç”¨â€œæ¥è‡ªâ€è¡¨ç¤ºæ¥æº
è®¾ç–‘é—®ï¼šæŠŠâ€œå“ªä¸ªâ€æ”¾åœ¨â€œå›½å®¶â€å‰ä½œå®šè¯­
æˆå¥ï¼šä¸»è¯­ + è°“è¯­ + å®¾è¯­ï¼ˆç–‘é—®ï¼‰`,
      "è‹±æ–‡":`The correct answer is ï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶
ENï¼šWhich country are you from?
In this sentence, â€œä½ â€ (you) is the subject; â€œæ¥è‡ªâ€ (are from) is the predicate; â€œå“ªä¸ªâ€ (which) modifies â€œå›½å®¶â€ (country) to form the interrogative object â€œå“ªä¸ªå›½å®¶â€. The order is â€œsubject + predicate + interrogative objectâ€.

Tips:
Identify the subject: â€œä½ â€(you)
Choose the predicate: â€œæ¥è‡ªâ€(are from) for origin
Build the question: put â€œå“ªä¸ªâ€(which) before â€œå›½å®¶â€(country)
Form: Subject + Predicate + Interrogative Object`,
      "æ³•è¯­":`The correct answer is ï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶
FRï¼šDe quel pays viens-tu ?
Ici, Â« ä½  Â» (tu) est le sujet ; Â« æ¥è‡ª Â» (venir de) est le prÃ©dicat ; Â« å“ªä¸ª Â» (quel) modifie Â« å›½å®¶ Â» (pays) pour former Â« å“ªä¸ªå›½å®¶ Â». Ordre : sujet + prÃ©dicat + groupe interrogatif.

Tips :
Sujet : Â« ä½  Â» ; PrÃ©dicat : Â« æ¥è‡ª Â»
Interrogatif : placer Â« å“ªä¸ª Â» devant Â« å›½å®¶ Â»
SchÃ©ma : Sujet + PrÃ©dicat + Groupe interrogatif`,
      "æ³°è¯­":`The correct answer is ï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶
THï¼šà¸„à¸¸à¸“à¸¡à¸²à¸ˆà¸²à¸à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸«à¸™
à¹ƒà¸™à¸›à¸£à¸°à¹‚à¸¢à¸„à¸™à¸µà¹‰ â€œà¸„à¸¸à¸“â€ à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¸˜à¸²à¸™; â€œà¸¡à¸²à¸ˆà¸²à¸â€ à¹€à¸›à¹‡à¸™à¸à¸£à¸´à¸¢à¸²à¸šà¸­à¸à¸—à¸µà¹ˆà¸¡à¸²; â€œà¹„à¸«à¸™â€ à¸‚à¸¢à¸²à¸¢ â€œà¸›à¸£à¸°à¹€à¸—à¸¨â€ à¹€à¸›à¹‡à¸™ â€œà¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸«à¸™â€ à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸š à¸›à¸£à¸°à¸˜à¸²à¸™ + à¸à¸£à¸´à¸¢à¸² + à¸à¸£à¸£à¸¡(à¸„à¸³à¸–à¸²à¸¡)

Tips:
à¸£à¸°à¸šà¸¸à¸›à¸£à¸°à¸˜à¸²à¸™: â€œà¸„à¸¸à¸“â€
à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸¡à¸²: à¹ƒà¸Šà¹‰ â€œà¸¡à¸²à¸ˆà¸²à¸â€
à¸à¸³à¸«à¸™à¸”à¸„à¸³à¸–à¸²à¸¡: à¹ƒà¸ªà¹ˆ â€œà¹„à¸«à¸™â€ à¸«à¸™à¹‰à¸² â€œà¸›à¸£à¸°à¹€à¸—à¸¨â€
à¹‚à¸„à¸£à¸‡: à¸›à¸£à¸°à¸˜à¸²à¸™ + à¸à¸£à¸´à¸¢à¸² + à¸à¸£à¸£à¸¡(à¸„à¸³à¸–à¸²à¸¡)`,
      "ä¿„è¯­":`The correct answer is ï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶
RU: Ğ¢Ñ‹ Ğ¸Ğ· ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹? / Ğ˜Ğ· ĞºĞ°ĞºĞ¾Ğ¹ Ñ‚Ñ‹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹?
Â«ä½ Â» â€” Ğ¿Ğ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ; Â«æ¥è‡ª/Ğ¸Ğ·Â» â€” ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ; Â«å“ªä¸ª/ĞºĞ°ĞºĞ¾Ğ¹Â» â€” Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğº Â«å›½å®¶/ÑÑ‚Ñ€Ğ°Ğ½Ğ°Â», Ğ¾Ğ±Ñ€Ğ°Ğ·ÑƒÑ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Â«ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹Â».

Tips:
ĞŸĞ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ: Â«ä½ Â»
Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ Â«æ¥è‡ª/Ğ¸Ğ·Â»
Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ: Â«å“ªä¸ª/ĞºĞ°ĞºĞ¾Ğ¹Â» Ğ¿ĞµÑ€ĞµĞ´ Â«å›½å®¶/ÑÑ‚Ñ€Ğ°Ğ½Ğ°Â»
Ğ¡Ñ…ĞµĞ¼Ğ°: ĞŸĞ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ + Ğ¡ĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ + ĞĞ±ÑŠĞµĞºÑ‚(Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ)`,
      "è€æŒè¯­":`The correct answer is ï¼šä½ æ¥è‡ªå“ªä¸ªå›½å®¶
LO: à»€àºˆàº»à»‰àº²àº¡àº²àºˆàº²àºàº›àº°à»€àº—àº”à»ƒàº”?
Â«ä½ Â» à»àº¡à»ˆàº™àº›àº°àº—àº²àº™; Â«æ¥è‡ªÂ» à»àº¡à»ˆàº™àºàº´àº¥àº´àºàº²àºšàº­àºàº—àºµà»ˆàº¡àº²; Â«å“ªä¸ªÂ» àº‚àº°àº«àºàº²àº Â«å›½å®¶Â» à»€àº›àº±àº™ Â«å“ªä¸ªå›½å®¶Â».

Tips:
àº›àº°àº—àº²àº™: Â«ä½ Â» ; àºàº´àº¥àº´àºàº²: Â«æ¥è‡ªÂ»
àº–àº²àº¡: à»ƒàºªà»ˆ Â«å“ªä¸ªÂ» à»œà»‰àº² Â«å›½å®¶Â»
à»‚àº„àº‡: àº›àº°àº—àº²àº™ + àºàº´àº¥àº´àºàº² + àºàº³(àº„àº³àº–àº²àº¡)` } },
    { idx:2, tokens:["å¤§å­¦ç”Ÿ","è‹±å›½","çš„","æˆ‘æ˜¯","æ¥"], answerTokens:["æˆ‘æ˜¯","è‹±å›½","æ¥","çš„","å¤§å­¦ç”Ÿ"], analysis:{
      "ä¸­æ–‡":`æ­£ç¡®ç­”æ¡ˆï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿã€‚
â€œæ˜¯â€ä¸ºç³»åŠ¨è¯ï¼›â€œè‹±å›½æ¥çš„â€ä¸ºåŠ¨è¯æ€§çŸ­è¯­å……å½“å®šè¯­ï¼Œä¿®é¥°ä¸­å¿ƒåè¯â€œå¤§å­¦ç”Ÿâ€ï¼Œè¡¨ç¤ºâ€œæ¥è‡ªè‹±å›½çš„â€ï¼›æ•´ä½“ç»“æ„ä¸ºâ€œä¸»è¯­+ç³»è¡¨ï¼ˆè¡¨è¯­å«å®šè¯­ï¼‰â€ã€‚

æŠ€å·§ / Tipsï¼š
å®šä¸»è¯­ï¼šç¡®å®šâ€œæˆ‘â€
ç«‹ç³»è¯ï¼šç”¨â€œæ˜¯â€å¼•å‡ºè¡¨è¯­
åŠ å®šè¯­ï¼šå°†â€œè‹±å›½æ¥çš„â€å‰ç½®ä¿®é¥°â€œå¤§å­¦ç”Ÿâ€
æˆå¥ï¼šä¸»è¯­ + ç³»è¯ + è¡¨è¯­ï¼ˆå«å®šè¯­ï¼‰`,
      "è‹±æ–‡":`The correct answer is ï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿ
EN: I am a college student from the UK.
Here, â€œæˆ‘æ˜¯â€¦â€ is a copular structure; â€œè‹±å›½æ¥çš„â€ (from the UK) is an attributive phrase modifying â€œå¤§å­¦ç”Ÿâ€ (college student) to indicate origin.

Tips:
Subject + copula: â€œæˆ‘ + æ˜¯ â€¦â€
Attributive of origin: put â€œè‹±å›½æ¥çš„â€ before â€œå¤§å­¦ç”Ÿâ€
Form: Subject + Copula + Predicate Noun (with attributive)`,
      "æ³•è¯­":`The correct answer is ï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿ
FRï¼šJe suis un(e) Ã©tudiant(e) venu(e) du Royaume-Uni / originaire du Royaume-Uni.
Structure copulative Â« æˆ‘ + æ˜¯ â€¦ Â» ; Â« è‹±å›½æ¥çš„ Â» modifie Â« å¤§å­¦ç”Ÿ Â» pour marquer lâ€™origine.

Tips :
Sujet + copule : Â« æˆ‘ + æ˜¯ â€¦ Â»
Origine : Â« è‹±å›½æ¥çš„ Â» avant Â« å¤§å­¦ç”Ÿ Â»
SchÃ©ma : Sujet + Copule + Nom du prÃ©dicat (avec Ã©pithÃ¨te)`,
      "æ³°è¯­":`The correct answer is ï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿ
TH: à¸‰à¸±à¸™à¹€à¸›à¹‡à¸™à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¸—à¸µà¹ˆà¸¡à¸²à¸ˆà¸²à¸à¸ªà¸«à¸£à¸²à¸Šà¸­à¸²à¸“à¸²à¸ˆà¸±à¸à¸£

Tips:
à¸›à¸£à¸°à¸˜à¸²à¸™ + à¸à¸£à¸´à¸¢à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡ â€œà¹€à¸›à¹‡à¸™â€
à¸§à¸¥à¸µà¸—à¸µà¹ˆà¸¡à¸² â€œà¸ˆà¸²à¸à¸­à¸±à¸‡à¸à¸¤à¸©â€ à¸‚à¸¢à¸²à¸¢ â€œà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²â€
à¸£à¸¹à¸›: à¸›à¸£à¸°à¸˜à¸²à¸™ + à¹€à¸›à¹‡à¸™ + à¸™à¸²à¸¡(à¸¡à¸µà¸ªà¹ˆà¸§à¸™à¸‚à¸¢à¸²à¸¢)`,
      "ä¿„è¯­":`The correct answer is ï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿ
RU: Ğ¯ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ¸Ğ· Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğ¸.

Tips:
Ğ¡Ğ²ÑĞ·ĞºĞ°: Â«Ñ (ĞµÑÑ‚ÑŒ)Â»
ĞŸÑ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ: Â«Ğ¸Ğ· Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğ¸Â» Ğº Â«ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Â»
Ğ¡Ñ…ĞµĞ¼Ğ°: ĞŸĞ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ + Ğ¡Ğ²ÑĞ·ĞºĞ° + Ğ˜Ğ¼ĞµĞ½Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ(Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼)`,
      "è€æŒè¯­":`The correct answer is ï¼šæˆ‘æ˜¯è‹±å›½æ¥çš„å¤§å­¦ç”Ÿ
LO: àº‚à»‰àº­àºà»€àº›àº±àº™àº™àº±àºàºªàº¶àºàºªàº²àº—àºµà»ˆàº¡àº²àºˆàº²àºàºªàº°àº«àº°àº¥àº²àºŠàº­àº²àº™àº²àºˆàº±àº.

Tips:
à»‚àº„àº‡: àº›àº°àº—àº²àº™ + à»€àº›àº±àº™ + àº™àº²àº¡(àº¡àºµàºªà»ˆàº§àº™àº‚àº°àº«àºàº²àº)
àºšàº­àºàº—àºµà»ˆàº¡àº²: â€œàº—àºµà»ˆàº¡àº²àºˆàº²àºâ€¦â€ àº‚àº°àº«àºàº²àº â€œàº™àº±àºàºªàº¶àºàºªàº²â€` } },
    { idx:3, tokens:["å§å§","ä¸¤ä¸ª","æ—å¨œ","æœ‰"], answerTokens:["æ—å¨œ","æœ‰","ä¸¤ä¸ª","å§å§"], analysis:{
      "ä¸­æ–‡":`æ­£ç¡®ç­”æ¡ˆï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§ã€‚
â€œæ—å¨œâ€ä¸ºä¸»è¯­ï¼›â€œæœ‰â€ä¸ºè¡¨ç¤ºâ€œæ‹¥æœ‰/å­˜åœ¨â€çš„è°“è¯­åŠ¨è¯ï¼›â€œä¸¤ä¸ªå§å§â€ä¸ºâ€œæ•°è¯+é‡è¯+åè¯â€çš„æ•°é‡çŸ­è¯­ä½œå®¾è¯­ï¼Œè¯­åºè‡ªç„¶é¡ºç•…ã€‚

æŠ€å·§ / Tipsï¼š
æ‰¾ä¸»è¯­ï¼šç¡®å®šâ€œæ—å¨œâ€
æ˜è°“è¯­ï¼šç”¨â€œæœ‰â€è¡¨â€œæ‹¥æœ‰â€
é…æ•°é‡ï¼šæ•°è¯+é‡è¯+åè¯ï¼ˆä¸¤ä¸ª+å§å§ï¼‰
æˆå¥ï¼šä¸»è¯­ + è°“è¯­ + å®¾è¯­ï¼ˆæ•°é‡çŸ­è¯­ï¼‰`,
      "è‹±æ–‡":`The correct answer is ï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§
EN: Linna has two older sisters.

Tips:
Subject: â€œæ—å¨œâ€
Predicate: â€œæœ‰â€(has)
Object: â€œä¸¤ä¸ªå§å§â€(two older sisters)`,
      "æ³•è¯­":`The correct answer is ï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§
FRï¼šLinna a deux grandes sÅ“urs.

Tips :
Sujet : Â« æ—å¨œ Â» ; Verbe : Â« æœ‰ Â»
Objet : Â« ä¸¤ä¸ªå§å§ Â» (2 + CL + nom)
SchÃ©ma : Sujet + Verbe + Objet`,
      "æ³°è¯­":`The correct answer is ï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§
TH: à¸¥à¸´à¸™à¸™à¹ˆà¸²à¸¡à¸µà¸à¸µà¹ˆà¸ªà¸²à¸§à¸ªà¸­à¸‡à¸„à¸™

Tips:
à¸›à¸£à¸°à¸˜à¸²à¸™: à¸¥à¸´à¸™à¸™à¹ˆà¸²
à¸à¸£à¸´à¸¢à¸²: à¸¡à¸µ
à¸à¸£à¸£à¸¡: à¸à¸µà¹ˆà¸ªà¸²à¸§à¸ªà¸­à¸‡à¸„à¸™`,
      "ä¿„è¯­":`The correct answer is ï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§
RU: Ğ£ Ğ›Ğ¸Ğ½Ğ½Ñ‹ Ğ´Ğ²Ğµ ÑÑ‚Ğ°Ñ€ÑˆĞ¸Ğµ ÑĞµÑÑ‚Ñ€Ñ‹.

Tips:
ĞŸĞ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ: Â«Ğ›Ğ¸Ğ½Ğ½Ğ°Â»
Ğ¡ĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ: Â«Ğ¸Ğ¼ĞµĞµÑ‚/ĞµÑÑ‚ÑŒÂ» (Â«æœ‰Â»)
Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ: Â«Ğ´Ğ²Ğµ ÑÑ‚Ğ°Ñ€ÑˆĞ¸Ğµ ÑĞµÑÑ‚Ñ€Ñ‹Â»`,
      "è€æŒè¯­":`The correct answer is ï¼šæ—å¨œæœ‰ä¸¤ä¸ªå§å§
LO: àº¥àº´àº™àº™àº²àº¡àºµàºàºµà»ˆàºªàº²àº§àºªàº­àº‡àº„àº»àº™.

Tips:
àº›àº°àº—àº²àº™: àº¥àº´àº™àº™àº²
àºàº´àº¥àº´àºàº²: àº¡àºµ
àºàº³: àºàºµà»ˆàºªàº²àº§àºªàº­àº‡àº„àº»àº™` } },
    { idx:4, tokens:["å¾ˆå¥½åƒ","å·§å…‹åŠ›","é€ç»™","ä½ ","æˆ‘çš„"], answerTokens:["ä½ ","é€ç»™","æˆ‘çš„","å·§å…‹åŠ›","å¾ˆå¥½åƒ"], analysis:{
      "ä¸­æ–‡":`æ­£ç¡®ç­”æ¡ˆï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒã€‚
å› ä¸ºâ€œä½ é€ç»™æˆ‘çš„â€æ˜¯å®šè¯­ï¼Œä¿®é¥°â€œå·§å…‹åŠ›â€ï¼Œè¡¨ç¤ºå·§å…‹åŠ›çš„æ¥æºï¼›
è°“è¯­â€œå¾ˆå¥½åƒâ€æ”¾åœ¨æœ€åï¼Œæè¿°å·§å…‹åŠ›çš„çŠ¶æ€ï¼Œç¬¦åˆä¸­æ–‡â€œä¿®é¥°è¯­+ä¸»è¯­+è°“è¯­â€çš„ç»“æ„ã€‚

æŠ€å·§ / Tipsï¼š
æ‰¾ä¸»è¯­ï¼šç¡®å®šæ ¸å¿ƒäº‹ç‰©â€”â€”â€œå·§å…‹åŠ›â€
åŠ å®šè¯­ï¼šâ€œä½ é€ç»™æˆ‘çš„â€æ”¾åœ¨â€œå·§å…‹åŠ›â€å‰
æ”¾è°“è¯­ï¼šâ€œå¾ˆå¥½åƒâ€ç½®äºå¥æœ«
å®šè¯­ + ä¸»è¯­ + è°“è¯­`,
      "è‹±æ–‡":`The correct answer is ï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒ
ENï¼šThe chocolate you gave me is very delicious.
"ä½ é€ç»™æˆ‘çš„"(you gave me) is an attributive that modifies the subject "å·§å…‹åŠ›"(chocolate).
The predicate "å¾ˆå¥½åƒ"(is very delicious) is placed at the end.

Tips:
Subject: â€œå·§å…‹åŠ›â€
Attributive: â€œä½ é€ç»™æˆ‘çš„â€ before â€œå·§å…‹åŠ›â€
Predicate: put â€œå¾ˆå¥½åƒâ€ at the end`,
      "æ³•è¯­":`The correct answer is ï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒ
FRï¼šLe chocolat que tu mâ€™as offert est dÃ©licieux.

Tips :
Sujet : Â« å·§å…‹åŠ› Â»
Ã‰pithÃ¨te : Â« ä½ é€ç»™æˆ‘çš„ Â» avant Â« å·§å…‹åŠ› Â»
PrÃ©dicat : Â« å¾ˆå¥½åƒ Â» en fin de phrase`,
      "æ³°è¯­":`The correct answer is ï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒ
THï¼šà¸Šà¹‡à¸­à¸à¹‚à¸à¹à¸¥à¸•à¸—à¸µà¹ˆà¸„à¸¸à¸“à¹ƒà¸«à¹‰à¸‰à¸±à¸™à¸­à¸£à¹ˆà¸­à¸¢à¸¡à¸²à¸

Tips:
à¸›à¸£à¸°à¸˜à¸²à¸™: â€œå·§å…‹åŠ›â€
à¸ªà¹ˆà¸§à¸™à¸‚à¸¢à¸²à¸¢: â€œä½ é€ç»™æˆ‘çš„â€ à¹„à¸§à¹‰à¸«à¸™à¹‰à¸² â€œå·§å…‹åŠ›â€
à¸ à¸²à¸„à¹à¸ªà¸”à¸‡: à¸§à¸²à¸‡ â€œå¾ˆå¥½åƒâ€ à¸—à¹‰à¸²à¸¢à¸›à¸£à¸°à¹‚à¸¢à¸„`,
      "ä¿„è¯­":`The correct answer is ï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒ
RU: Ğ¨Ğ¾ĞºĞ¾Ğ»Ğ°Ğ´, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ‚Ñ‹ Ğ¼Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»(Ğ°), Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ²ĞºÑƒÑĞ½Ñ‹Ğ¹.

Tips:
ĞŸĞ¾Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰ĞµĞµ: Â«å·§å…‹åŠ›Â»
ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ: Â«Ñ‚Ñ‹ Ğ¼Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¸Ğ»Â» Ğ¿ĞµÑ€ĞµĞ´ Â«å·§å…‹åŠ›Â»
Ğ¡ĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾Ğµ: Â«Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ²ĞºÑƒÑĞ½Ñ‹Ğ¹Â» Ğ² ĞºĞ¾Ğ½Ñ†Ğµ`,
      "è€æŒè¯­":`The correct answer is ï¼šä½ é€ç»™æˆ‘çš„å·§å…‹åŠ›å¾ˆå¥½åƒ
LO: àºŠàº±àº­àºà»‚àºà»àº¥àº±àº”àº—àºµà»ˆà»€àºˆàº»à»‰àº²à»ƒàº«à»‰àº‚à»‰àº­àº à»àºŠàºšàº«àº¼àº²àº

Tips:
àº›àº°àº—àº²àº™: â€œå·§å…‹åŠ›â€
àº„à»àº²àº‚àº°àº«àºàº²àº: â€œä½ é€ç»™æˆ‘çš„â€ àº¢àº¹à»ˆà»œà»‰àº² â€œå·§å…‹åŠ›â€
àºàº²àºàºªàº°à»àº”àº‡: â€œå¾ˆå¥½åƒâ€ àº¢àº¹à»ˆàº—à»‰àº²àºàº›àº°à»‚àº«àºàº` } }
  ];

  function ensureMount(){
    const stage = document.getElementById('stage');
    if(!stage) return null;

    let embed = document.getElementById('sb-embed');
    if(!embed){
      embed = document.createElement('div');
      embed.id = 'sb-embed';
      embed.innerHTML = `
        <div class="sb-top">
          <div class="sb-topbar">
            <div style="font-weight:900;">è¯è¯­ç»„å¥ Â· è¯•ç©æ¸¸æˆ / Sentence Building Â· Demo</div>
            <button class="sb-mini" id="sb-back">è¿”å›ä¸Šä¸€çº§ / Back</button>
          </div>
          <div class="sb-ins">
            <div>æ¯é¢˜ä¸‹æ–¹æœ‰è‹¥å¹²ä¸ªå¤‡é€‰å•è¯ï¼Œè¯·å°†è¿™äº›å•è¯ç»„æˆä¸€ä¸ªé€šé¡ºçš„å¥å­ï¼Œå¹¶æŒ‰ç…§é¡ºåºå°†è¿™äº›å•è¯æ‹–åŠ¨åˆ°ä¸‹æ–¹çš„æ–¹æ¡†ä¸­ï¼Œå…¨éƒ¨æ­£ç¡®ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€é¢˜ã€‚</div>
            <small>There are several candidate words below each question. Please arrange them into a coherent sentence and drag them, in order, into the box below. If all are correct, you can proceed to the next question.</small>
          </div>
        </div>
        <div id="sb-toast" role="status" aria-live="polite"></div>
        <div class="sb-pool" id="sb-pool" aria-label="å¤‡é€‰å•è¯åŒº"></div>
        <div class="sb-slot-wrap"><div class="sb-slot" id="sb-slot" aria-label="ç›®æ ‡æ§½ï¼ˆæ‹–å…¥åŒºåŸŸï¼‰"></div></div>
        <div class="sb-toolbar">
          <button class="sb-mini" id="sb-prev">&larr; ä¸Šä¸€é¢˜ / Previous</button>
          <button class="sb-mini primary" id="sb-confirm">ç¡®å®š Confirm?</button>
          <button class="sb-mini" id="sb-next">ä¸‹ä¸€é¢˜ / Next &rarr;</button>
          <div style="font-weight:900; padding:10px 8px;">å½“å‰ç¬¬ <span id="sb-cur">1</span> é¢˜ / æ€» <span id="sb-total">0</span> é¢˜  |  ENï¼šQuestion <span id="sb-cur-en">1</span> / <span id="sb-total-en">0</span></div>
        </div>
        <div class="sb-panel" id="sb-panel" aria-live="polite">
          <div class="sb-head">
            <div class="sb-tabs">
              <button class="sb-tab" data-lang="è‹±æ–‡">è‹±æ–‡English</button>
              <button class="sb-tab" data-lang="ä¸­æ–‡">ä¸­æ–‡Chinese</button>
              <button class="sb-tab" data-lang="æ³•è¯­">æ³•è¯­FranÃ§ais</button>
              <button class="sb-tab" data-lang="æ³°è¯­">æ³°è¯­Thai</button>
              <button class="sb-tab" data-lang="ä¿„è¯­">ä¿„è¯­Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
              <button class="sb-tab" data-lang="è€æŒè¯­">è€æŒè¯­Lao</button>
            </div>
            <button class="sb-close" id="sb-close">å…³é—­ Close</button>
          </div>
          <div class="sb-body" id="sb-body">åŠ è½½ä¸­â€¦</div>
        </div>
      `;
      stage.appendChild(embed);
    }

    let lv = document.getElementById('sb-levels');
    if(!lv){
      lv = document.createElement('div');
      lv.id = 'sb-levels';
      lv.innerHTML = `
        <div class="lv-top">
          <div style="font-weight:900;">è¯è¯­ç»„å¥ Â· è¯·é€‰æ‹©çº§åˆ« / Sentence Building Â· Choose Level</div>
          <button class="sb-mini" id="sb-lv-back">è¿”å›ä¸Šä¸€çº§ / Back</button>
        </div>
        <div class="lv-grid">
          <button class="lv-btn" disabled title="Coming soon">Level 1</button>
          <button class="lv-btn" disabled title="Coming soon">Level 2</button>
          <button class="lv-btn" disabled title="Coming soon">Level 3</button>
          <button class="lv-btn" disabled title="Coming soon">Level 4</button>
        </div>
      `;
      stage.appendChild(lv);
    }
    return stage;
  }

  let idx = 0;
  function render(){
    const pool = document.getElementById('sb-pool');
    const slot = document.getElementById('sb-slot');
    const cur = document.getElementById('sb-cur');
    const curEn = document.getElementById('sb-cur-en');
    const tot = document.getElementById('sb-total');
    const totEn = document.getElementById('sb-total-en');

    const q = BANK[idx];
    pool.innerHTML=''; slot.innerHTML='';
    q.tokens.forEach((t,k)=>{
      const d=document.createElement('div');
      d.className='sb-tile'; d.textContent=t; d.setAttribute('draggable','true'); d.dataset.token=t;
      const sty = hueStyle(k); d.style.setProperty('--tile-bg', sty.bg); d.style.setProperty('--tile-shadow', sty.sh);
      d.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t); d.classList.add('dragging'); });
      d.addEventListener('dragend', ()=> d.classList.remove('dragging'));
      pool.appendChild(d);
    });

    cur.textContent = String(idx+1); curEn.textContent = String(idx+1);
    tot.textContent = String(BANK.length); totEn.textContent = String(BANK.length);
  }
  function seqInSlot(){ return Array.from(document.querySelectorAll('#sb-slot .sb-tile')).map(n=>n.dataset.token); }
  function flyBack(){
    const slot = document.getElementById('sb-slot');
    slot.classList.add('sb-shake');
    const ch=[...slot.children];
    ch.forEach(n=> n.classList.add('sb-flyback'));
    setTimeout(()=>{ ch.forEach(n=>{ n.classList.remove('sb-flyback'); document.getElementById('sb-pool').appendChild(n); }); slot.classList.remove('sb-shake'); }, 420);
  }
  function showPanel(lang='è‹±æ–‡'){
    const p=document.getElementById('sb-panel'), body=document.getElementById('sb-body');
    document.querySelectorAll('#sb-embed .sb-tab').forEach(t=> t.classList.toggle('active', t.dataset.lang===lang));
    body.textContent = BANK[idx].analysis[lang] || 'ï¼ˆæ— è¯¥è¯­è¨€è§£æ No analysis in this languageï¼‰';
    p.style.display='block';
  }
  function showToast(msgCN, msgEN, ok=true){
    const el = document.getElementById('sb-toast');
    el.className = 'show ' + (ok ? 'ok' : 'err');
    el.textContent = (msgCN || '') + ' / ' + (msgEN || '');
    el.style.display='none'; void el.offsetWidth; el.style.display='';
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); }, 1100);
  }

  function hideMenuRow(btn){
    if(!menuRowEl) menuRowEl = findButtonsRow(btn);
    if(menuRowEl) menuRowEl.style.display = 'none';
  }
  function showMenuRow(){ if(menuRowEl) menuRowEl.style.display = ''; }

  document.addEventListener('click', function(ev){
    const id = (ev.target && ev.target.id) || '';
    if(!modIsSentence()) return;

    if(id==='actDemo'){
      ev.preventDefault();
      const stage = ensureMount(); if(!stage) return;
      hideMenuRow(ev.target);

      const slot = document.getElementById('sb-slot');
      const pool = document.getElementById('sb-pool');
      slot.addEventListener('dragover', e=>{ e.preventDefault(); slot.classList.add('dragging'); });
      slot.addEventListener('dragleave', ()=> slot.classList.remove('dragging'));
      slot.addEventListener('drop', e=>{
        e.preventDefault();
        const t = e.dataTransfer.getData('text/plain');
        const node = [...pool.children, ...slot.children].find(n=> n.dataset && n.dataset.token===t && n.classList.contains('sb-tile'));
        if(node){ slot.appendChild(node); }
        slot.classList.remove('dragging');
      });
      pool.addEventListener('dragover', e=> e.preventDefault());
      pool.addEventListener('drop', e=>{
        e.preventDefault();
        const t=e.dataTransfer.getData('text/plain');
        const node=[...pool.children, ...slot.children].find(n=> n.dataset && n.dataset.token===t && n.classList.contains('sb-tile'));
        if(node){ pool.appendChild(node); }
      });

      $('#sb-prev').onclick = ()=>{ if(idx>0){ idx--; render(); } };
      $('#sb-next').onclick = ()=>{ if(idx<BANK.length-1){ idx++; render(); } };
      $('#sb-confirm').onclick = ()=>{
        const seq = seqInSlot(), ans = BANK[idx].answerTokens;
        if(seq.length!==ans.length){ showToast('ç­”é”™äº†','Incorrect!',false); flyBack(); return; }
        const ok = seq.every((t,i)=> t===ans[i]);
        if(!ok){ showToast('ç­”é”™äº†','Incorrect!',false); flyBack(); return; }
        showToast('ç­”å¯¹äº†','Correct!',true);
        setTimeout(()=> showPanel('è‹±æ–‡'), 200);
      };
      $('#sb-close').onclick = ()=> $('#sb-panel').style.display='none';
      $('#sb-back').onclick = ()=>{ $('#sb-panel').style.display='none'; document.getElementById('sb-embed').style.display='none'; showMenuRow(); };
      $$('#sb-embed .sb-tab').forEach(tab=>{
        tab.onclick = ()=>{ $$('#sb-embed .sb-tab').forEach(x=> x.classList.remove('active')); tab.classList.add('active'); $('#sb-body').textContent = BANK[idx].analysis[tab.dataset.lang] || 'ï¼ˆæ— è¯¥è¯­è¨€è§£æï¼‰'; };
      });

      document.getElementById('sb-levels').style.display='none';
      document.getElementById('sb-embed').style.display='block';
      idx=0; render();
      document.getElementById('sb-embed').scrollIntoView({behavior:'smooth', block:'center'});
    }

    if(id==='actStart'){
      ev.preventDefault();
      const stage = ensureMount(); if(!stage) return;
      hideMenuRow(ev.target);
      $('#sb-panel') && ($('#sb-panel').style.display='none');
      document.getElementById('sb-embed').style.display='none';
      const lv = document.getElementById('sb-levels');
      lv.style.display='block';
      $('#sb-lv-back').onclick = ()=>{ lv.style.display='none'; showMenuRow(); };
      lv.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }, true);
})();
</script>
<!-- SB END -->

</body>
</html>
